import{A as $,B as lt,C as Me,D as Uu,E as y_,F as Fs,G as ne,H as ht,I as Ba,J as Bu,K as vt,L as xn,M as gr,N as qa,O as v_,P as Rt,Q as Le,a as O,b as si,c as Oa,d as c_,e as u_,f as Ge,g as Fa,h as Vs,i as Fu,j as h_,k as Lt,l as Mu,m as Ma,n as d_,o as f_,p as La,q as ke,r as p_,s as g_,t as yt,u as Pn,v as Ua,w as Os,x as Lu,y as m_,z as __}from"./chunk-5P6ALUPZ.js";import{l as Va}from"./chunk-5OVQF42F.js";import{A as Ns,B as Ds,I as ka,Ia as Rn,K as t_,N as Na,O as pr,P as n_,Q as Du,S as r_,T as Da,U as rn,V as Vu,X as i_,Y as s_,aa as Sn,ba as Cn,c as In,da as qe,f as Zm,fa as W,ha as o_,hb as Mt,i as ri,j as e_,kc as a_,l as fr,lc as l_,m as ii,ma as bn,n as An,o as Ft,s as Ie,tc as Ou}from"./chunk-RBD7S4WU.js";import{a as ni,b as ks,g as Nu,h as x}from"./chunk-SIAVTO45.js";var vA="firebase",wA="10.12.5";Rt(vA,wA,"app");var on=new a_("ANGULARFIRE2_VERSION");var EA=(n,e)=>{let t=e?[e]:v_(),r=[];return t.forEach(i=>{i.container.getProvider(n).instances.forEach(o=>{r.includes(o)||r.push(o)})}),r},sn=class{constructor(){return EA(TA)}},TA="app-check";function qu(){}var Ga=class{zone;delegate;constructor(e,t=e_){this.zone=e,this.delegate=t}now(){return this.delegate.now()}schedule(e,t,r){let i=this.zone,s=function(o){i.runGuarded(()=>{e.apply(this,[o])})};return this.delegate.schedule(s,t,r)}},Gu=class{zone;task=null;constructor(e){this.zone=e}call(e,t){let r=this.unscheduleTask.bind(this);return this.task=this.zone.run(()=>Zone.current.scheduleMacroTask("firebaseZoneBlock",qu,{},qu,qu)),t.pipe(i_({next:r,complete:r,error:r})).subscribe(e).add(r)}unscheduleTask(){setTimeout(()=>{this.task!=null&&this.task.state==="scheduled"&&(this.task.invoke(),this.task=null)},10)}},oi=(()=>{class n{ngZone;outsideAngular;insideAngular;constructor(t){this.ngZone=t,this.outsideAngular=t.runOutsideAngular(()=>new Ga(Zone.current)),this.insideAngular=t.run(()=>new Ga(Zone.current,ri)),globalThis.\u0275AngularFireScheduler||=this}static \u0275fac=function(r){return new(r||n)(W(Mt))};static \u0275prov=Sn({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();function IA(){let n=globalThis.\u0275AngularFireScheduler;if(!n)throw new Error(`Either AngularFireModule has not been provided in your AppModule (this can be done manually or implictly using
provideFirebaseApp) or you're calling an AngularFire method outside of an NgModule (which is not supported).`);return n}function Ce(n){return AA(IA())(n)}function AA(n){return function(t){return t=t.lift(new Gu(n.ngZone)),t.pipe(ii(n.outsideAngular),fr(n.insideAngular))}}var SA="firebase",CA="10.12.5";Le.registerVersion(SA,CA,"app-compat");var bA=["ngOnDestroy"],E_=(n,e,t,r={})=>new Proxy(n,{get:(i,s)=>t.runOutsideAngular(()=>{if(n[s])return r?.spy?.get&&r.spy.get(s,n[s]),n[s];if(bA.indexOf(s)>-1)return()=>{};let o=e.toPromise().then(a=>{let c=a?.[s];return typeof c=="function"?c.bind(a):c?.then?c.then(u=>t.run(()=>u)):t.run(()=>c)});return new Proxy(()=>{},{get:(a,c)=>o[c],apply:(a,c,u)=>o.then(d=>{let p=d?.(...u);return r?.spy?.apply&&r.spy.apply(s,u,p),p})})})});var za=class{constructor(e){return e}},kn=new qe("angularfire2.app.options"),Nn=new qe("angularfire2.app.name");function mr(n,e,t){let r=typeof t=="string"&&t||"[DEFAULT]",i=typeof t=="object"&&t||{};i.name=i.name||r;let o=Le.apps.filter(a=>a&&a.name===i.name)[0]||e.runOutsideAngular(()=>Le.initializeApp(n,i));try{if(JSON.stringify(n)!==JSON.stringify(o.options)){let a=!!module.hot;RA("error",`${o.name} Firebase App already initialized with different options${a?", you may need to reload as Firebase is not HMR aware.":"."}`)}}catch{}return new za(o)}var RA=(n,...e)=>{Ou()&&typeof console<"u"&&console[n](...e)},PA={provide:za,useFactory:mr,deps:[kn,Mt,[new o_,Nn]]},NP=(()=>{class n{static initializeApp(t,r){return{ngModule:n,providers:[{provide:kn,useValue:t},{provide:Nn,useValue:r}]}}constructor(t){Le.registerVersion("angularfire",on.full,"core"),Le.registerVersion("angularfire",on.full,"app-compat"),Le.registerVersion("angular",l_.full,t.toString())}static \u0275fac=function(r){return new(r||n)(W(Rn))};static \u0275mod=bn({type:n});static \u0275inj=Cn({providers:[PA]})}return n})();function ai(n,e,t,r,i){let[,s,o]=globalThis.\u0275AngularfireInstanceCache.find(a=>a[0]===n)||[];if(s)return xA(i,o)||(w_("error",`${e} was already initialized on the ${t} Firebase App with different settings.${kA?" You may need to reload as Firebase is not HMR aware.":""}`),w_("warn",{is:i,was:o})),s;{let a=r();return globalThis.\u0275AngularfireInstanceCache.push([n,a,i]),a}}function xA(n,e){try{return n.toString()===e.toString()}catch{return n===e}}var kA=typeof module<"u"&&!!module.hot,w_=(n,...e)=>{Ou()&&typeof console<"u"&&console[n](...e)};globalThis.\u0275AngularfireInstanceCache||=[];var NA=new Map,DA={activated:!1,tokenObservers:[]},VA={initialized:!1,enabled:!1};function Pt(n){return NA.get(n)||Object.assign({},DA)}function R_(){return VA}var OA="https://content-firebaseappcheck.googleapis.com/v1";var FA="exchangeDebugToken",T_={OFFSET_DURATION:5*60*1e3,RETRIAL_MIN_WAIT:30*1e3,RETRIAL_MAX_WAIT:16*60*1e3},GP=24*60*60*1e3;var Ku=class{constructor(e,t,r,i,s){if(this.operation=e,this.retryPolicy=t,this.getWaitDuration=r,this.lowerBound=i,this.upperBound=s,this.pending=null,this.nextErrorWaitInterval=i,i>s)throw new Error("Proactive refresh lower bound greater than upper bound!")}start(){this.nextErrorWaitInterval=this.lowerBound,this.process(!0).catch(()=>{})}stop(){this.pending&&(this.pending.reject("cancelled"),this.pending=null)}isRunning(){return!!this.pending}process(e){return x(this,null,function*(){this.stop();try{this.pending=new Ge,this.pending.promise.catch(t=>{}),yield MA(this.getNextRun(e)),this.pending.resolve(),yield this.pending.promise,this.pending=new Ge,this.pending.promise.catch(t=>{}),yield this.operation(),this.pending.resolve(),yield this.pending.promise,this.process(!0).catch(()=>{})}catch(t){this.retryPolicy(t)?this.process(!1).catch(()=>{}):this.stop()}})}getNextRun(e){if(e)return this.nextErrorWaitInterval=this.lowerBound,this.getWaitDuration();{let t=this.nextErrorWaitInterval;return this.nextErrorWaitInterval*=2,this.nextErrorWaitInterval>this.upperBound&&(this.nextErrorWaitInterval=this.upperBound),t}}};function MA(n){return new Promise(e=>{setTimeout(e,n)})}var LA={"already-initialized":"You have already called initializeAppCheck() for FirebaseApp {$appName} with different options. To avoid this error, call initializeAppCheck() with the same options as when it was originally called. This will return the already initialized instance.","use-before-activation":"App Check is being used before initializeAppCheck() is called for FirebaseApp {$appName}. Call initializeAppCheck() before instantiating other Firebase services.","fetch-network-error":"Fetch failed to connect to a network. Check Internet connection. Original error: {$originalErrorMessage}.","fetch-parse-error":"Fetch client could not parse response. Original error: {$originalErrorMessage}.","fetch-status-error":"Fetch server returned an HTTP error status. HTTP status: {$httpStatus}.","storage-open":"Error thrown when opening storage. Original error: {$originalErrorMessage}.","storage-get":"Error thrown when reading from storage. Original error: {$originalErrorMessage}.","storage-set":"Error thrown when writing to storage. Original error: {$originalErrorMessage}.","recaptcha-error":"ReCAPTCHA error.",throttled:"Requests throttled due to {$httpStatus} error. Attempts allowed again after {$time}"},Dn=new f_("appCheck","AppCheck",LA);function P_(n){if(!Pt(n).activated)throw Dn.create("use-before-activation",{appName:n.name})}function x_(r,i){return x(this,arguments,function*({url:n,body:e},t){let s={"Content-Type":"application/json"},o=t.getImmediate({optional:!0});if(o){let y=yield o.getHeartbeatsHeader();y&&(s["X-Firebase-Client"]=y)}let a={method:"POST",body:JSON.stringify(e),headers:s},c;try{c=yield fetch(n,a)}catch(y){throw Dn.create("fetch-network-error",{originalErrorMessage:y?.message})}if(c.status!==200)throw Dn.create("fetch-status-error",{httpStatus:c.status});let u;try{u=yield c.json()}catch(y){throw Dn.create("fetch-parse-error",{originalErrorMessage:y?.message})}let d=u.ttl.match(/^([\d.]+)(s)$/);if(!d||!d[2]||isNaN(Number(d[1])))throw Dn.create("fetch-parse-error",{originalErrorMessage:`ttl field (timeToLive) is not in standard Protobuf Duration format: ${u.ttl}`});let p=Number(d[1])*1e3,g=Date.now();return{token:u.token,expireTimeMillis:g+p,issuedAtTimeMillis:g}})}function k_(n,e){let{projectId:t,appId:r,apiKey:i}=n.options;return{url:`${OA}/projects/${t}/apps/${r}:${FA}?key=${i}`,body:{debug_token:e}}}var UA="firebase-app-check-database",BA=1,Wu="firebase-app-check-store";var Ka=null;function qA(){return Ka||(Ka=new Promise((n,e)=>{try{let t=indexedDB.open(UA,BA);t.onsuccess=r=>{n(r.target.result)},t.onerror=r=>{var i;e(Dn.create("storage-open",{originalErrorMessage:(i=r.target.error)===null||i===void 0?void 0:i.message}))},t.onupgradeneeded=r=>{let i=r.target.result;switch(r.oldVersion){case 0:i.createObjectStore(Wu,{keyPath:"compositeKey"})}}}catch(t){e(Dn.create("storage-open",{originalErrorMessage:t?.message}))}}),Ka)}function GA(n,e){return jA(zA(n),e)}function jA(n,e){return x(this,null,function*(){let r=(yield qA()).transaction(Wu,"readwrite"),s=r.objectStore(Wu).put({compositeKey:n,value:e});return new Promise((o,a)=>{s.onsuccess=c=>{o()},r.onerror=c=>{var u;a(Dn.create("storage-set",{originalErrorMessage:(u=c.target.error)===null||u===void 0?void 0:u.message}))}})})}function zA(n){return`${n.options.appId}-${n.name}`}var $u=new xn("@firebase/app-check");function zu(n,e){return Ma()?GA(n,e).catch(t=>{$u.warn(`Failed to write token to IndexedDB. Error: ${t}`)}):Promise.resolve()}function N_(){return R_().enabled}function D_(){return x(this,null,function*(){let n=R_();if(n.enabled&&n.token)return n.token.promise;throw Error(`
            Can't get debug token in production mode.
        `)})}var KA={error:"UNKNOWN_ERROR"};function WA(n){return Oa.encodeString(JSON.stringify(n),!1)}function Qu(n,e=!1){return x(this,null,function*(){let t=n.app;P_(t);let r=Pt(t),i=r.token,s;if(i&&!Ms(i)&&(r.token=void 0,i=void 0),!i){let c=yield r.cachedTokenPromise;c&&(Ms(c)?i=c:yield zu(t,void 0))}if(!e&&i&&Ms(i))return{token:i.token};let o=!1;if(N_()){r.exchangeTokenPromise||(r.exchangeTokenPromise=x_(k_(t,yield D_()),n.heartbeatServiceProvider).finally(()=>{r.exchangeTokenPromise=void 0}),o=!0);let c=yield r.exchangeTokenPromise;return yield zu(t,c),r.token=c,{token:c.token}}try{r.exchangeTokenPromise||(r.exchangeTokenPromise=r.provider.getToken().finally(()=>{r.exchangeTokenPromise=void 0}),o=!0),i=yield Pt(t).exchangeTokenPromise}catch(c){c.code==="appCheck/throttled"?$u.warn(c.message):$u.error(c),s=c}let a;return i?s?Ms(i)?a={token:i.token,internalError:s}:a=A_(s):(a={token:i.token},r.token=i,yield zu(t,i)):a=A_(s),o&&YA(t,a),a})}function $A(n){return x(this,null,function*(){let e=n.app;P_(e);let{provider:t}=Pt(e);if(N_()){let r=yield D_(),{token:i}=yield x_(k_(e,r),n.heartbeatServiceProvider);return{token:i}}else{let{token:r}=yield t.getToken();return{token:r}}})}function QA(n,e,t,r){let{app:i}=n,s=Pt(i),o={next:t,error:r,type:e};if(s.tokenObservers=[...s.tokenObservers,o],s.token&&Ms(s.token)){let a=s.token;Promise.resolve().then(()=>{t({token:a.token}),I_(n)}).catch(()=>{})}s.cachedTokenPromise.then(()=>I_(n))}function V_(n,e){let t=Pt(n),r=t.tokenObservers.filter(i=>i.next!==e);r.length===0&&t.tokenRefresher&&t.tokenRefresher.isRunning()&&t.tokenRefresher.stop(),t.tokenObservers=r}function I_(n){let{app:e}=n,t=Pt(e),r=t.tokenRefresher;r||(r=HA(n),t.tokenRefresher=r),!r.isRunning()&&t.isTokenAutoRefreshEnabled&&r.start()}function HA(n){let{app:e}=n;return new Ku(()=>x(this,null,function*(){let t=Pt(e),r;if(t.token?r=yield Qu(n,!0):r=yield Qu(n),r.error)throw r.error;if(r.internalError)throw r.internalError}),()=>!0,()=>{let t=Pt(e);if(t.token){let r=t.token.issuedAtTimeMillis+(t.token.expireTimeMillis-t.token.issuedAtTimeMillis)*.5+3e5,i=t.token.expireTimeMillis-5*60*1e3;return r=Math.min(r,i),Math.max(0,r-Date.now())}else return 0},T_.RETRIAL_MIN_WAIT,T_.RETRIAL_MAX_WAIT)}function YA(n,e){let t=Pt(n).tokenObservers;for(let r of t)try{r.type==="EXTERNAL"&&e.error!=null?r.error(e.error):r.next(e)}catch{}}function Ms(n){return n.expireTimeMillis-Date.now()>0}function A_(n){return{token:WA(KA),error:n}}var Hu=class{constructor(e,t){this.app=e,this.heartbeatServiceProvider=t}_delete(){let{tokenObservers:e}=Pt(this.app);for(let t of e)V_(this.app,t.next);return Promise.resolve()}};function JA(n,e){return new Hu(n,e)}function XA(n){return{getToken:e=>Qu(n,e),getLimitedUseToken:()=>$A(n),addTokenListener:e=>QA(n,"INTERNAL",e),removeTokenListener:e=>V_(n.app,e)}}var ZA="@firebase/app-check",eS="0.8.7";var tS="app-check",S_="app-check-internal";function nS(){gr(new ht(tS,n=>{let e=n.getProvider("app").getImmediate(),t=n.getProvider("heartbeat");return JA(e,t)},"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback((n,e,t)=>{n.getProvider(S_).initialize()})),gr(new ht(S_,n=>{let e=n.getProvider("app-check").getImmediate();return XA(e)},"PUBLIC").setInstantiationMode("EXPLICIT")),Rt(ZA,eS)}nS();var rS=["localhost","0.0.0.0","127.0.0.1"],ex=typeof window<"u"&&rS.includes(window.location.hostname);var Ls=new qe("angularfire2.auth.use-emulator"),Us=new qe("angularfire2.auth.settings"),Bs=new qe("angularfire2.auth.tenant-id"),qs=new qe("angularfire2.auth.langugage-code"),Gs=new qe("angularfire2.auth.use-device-language"),js=new qe("angularfire.auth.persistence"),zs=(n,e,t,r,i,s,o,a)=>ai(`${n.name}.auth`,"AngularFireAuth",n.name,()=>{let c=e.runOutsideAngular(()=>n.auth());if(t&&c.useEmulator(...t),r&&(c.tenantId=r),c.languageCode=i,s&&c.useDeviceLanguage(),o)for(let[u,d]of Object.entries(o))c.settings[u]=d;return a&&c.setPersistence(a),c},[t,r,i,s,o,a]),Ks=(()=>{class n{authState;idToken;user;idTokenResult;credential;constructor(t,r,i,s,o,a,c,u,d,p,g,y){let S=new Zm,k=Ft(void 0).pipe(fr(o.outsideAngular),rn(()=>s.runOutsideAngular(()=>import("./chunk-W6BA42BG.js"))),Ie(()=>mr(t,s,r)),Ie(N=>zs(N,s,a,u,d,p,c,g)),Du({bufferSize:1,refCount:!1}));if(Va(i))this.authState=this.user=this.idToken=this.idTokenResult=this.credential=Ft(null);else{k.pipe(t_()).subscribe();let N=k.pipe(rn(F=>F.getRedirectResult().then(K=>K,()=>null)),Ce,Du({bufferSize:1,refCount:!1})),q=k.pipe(rn(F=>new In(K=>({unsubscribe:s.runOutsideAngular(()=>F.onAuthStateChanged(Q=>K.next(Q),Q=>K.error(Q),()=>K.complete()))})))),G=k.pipe(rn(F=>new In(K=>({unsubscribe:s.runOutsideAngular(()=>F.onIdTokenChanged(Q=>K.next(Q),Q=>K.error(Q),()=>K.complete()))}))));this.authState=N.pipe(Vu(q),ii(o.outsideAngular),fr(o.insideAngular)),this.user=N.pipe(Vu(G),ii(o.outsideAngular),fr(o.insideAngular)),this.idToken=this.user.pipe(rn(F=>F?An(F.getIdToken()):Ft(null))),this.idTokenResult=this.user.pipe(rn(F=>F?An(F.getIdTokenResult()):Ft(null))),this.credential=Ns(N,S,this.authState.pipe(Ds(F=>!F))).pipe(Ie(F=>F?.user?F:null),ii(o.outsideAngular),fr(o.insideAngular))}return E_(this,k,s,{spy:{apply:(N,q,G)=>{(N.startsWith("signIn")||N.startsWith("createUser"))&&G.then(F=>S.next(F))}}})}static \u0275fac=function(r){return new(r||n)(W(kn),W(Nn,8),W(Rn),W(Mt),W(oi),W(Ls,8),W(Us,8),W(Bs,8),W(qs,8),W(Gs,8),W(js,8),W(sn,8))};static \u0275prov=Sn({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),mx=(()=>{class n{constructor(){Le.registerVersion("angularfire",on.full,"auth-compat")}static \u0275fac=function(r){return new(r||n)};static \u0275mod=bn({type:n});static \u0275inj=Cn({providers:[Ks]})}return n})();var F_=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},M_={};var Vn,Ju;(function(){var n;function e(E,_){function w(){}w.prototype=_.prototype,E.D=_.prototype,E.prototype=new w,E.prototype.constructor=E,E.C=function(T,I,C){for(var v=Array(arguments.length-2),en=2;en<arguments.length;en++)v[en-2]=arguments[en];return _.prototype[I].apply(T,v)}}function t(){this.blockSize=-1}function r(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}e(r,t),r.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function i(E,_,w){w||(w=0);var T=Array(16);if(typeof _=="string")for(var I=0;16>I;++I)T[I]=_.charCodeAt(w++)|_.charCodeAt(w++)<<8|_.charCodeAt(w++)<<16|_.charCodeAt(w++)<<24;else for(I=0;16>I;++I)T[I]=_[w++]|_[w++]<<8|_[w++]<<16|_[w++]<<24;_=E.g[0],w=E.g[1],I=E.g[2];var C=E.g[3],v=_+(C^w&(I^C))+T[0]+3614090360&4294967295;_=w+(v<<7&4294967295|v>>>25),v=C+(I^_&(w^I))+T[1]+3905402710&4294967295,C=_+(v<<12&4294967295|v>>>20),v=I+(w^C&(_^w))+T[2]+606105819&4294967295,I=C+(v<<17&4294967295|v>>>15),v=w+(_^I&(C^_))+T[3]+3250441966&4294967295,w=I+(v<<22&4294967295|v>>>10),v=_+(C^w&(I^C))+T[4]+4118548399&4294967295,_=w+(v<<7&4294967295|v>>>25),v=C+(I^_&(w^I))+T[5]+1200080426&4294967295,C=_+(v<<12&4294967295|v>>>20),v=I+(w^C&(_^w))+T[6]+2821735955&4294967295,I=C+(v<<17&4294967295|v>>>15),v=w+(_^I&(C^_))+T[7]+4249261313&4294967295,w=I+(v<<22&4294967295|v>>>10),v=_+(C^w&(I^C))+T[8]+1770035416&4294967295,_=w+(v<<7&4294967295|v>>>25),v=C+(I^_&(w^I))+T[9]+2336552879&4294967295,C=_+(v<<12&4294967295|v>>>20),v=I+(w^C&(_^w))+T[10]+4294925233&4294967295,I=C+(v<<17&4294967295|v>>>15),v=w+(_^I&(C^_))+T[11]+2304563134&4294967295,w=I+(v<<22&4294967295|v>>>10),v=_+(C^w&(I^C))+T[12]+1804603682&4294967295,_=w+(v<<7&4294967295|v>>>25),v=C+(I^_&(w^I))+T[13]+4254626195&4294967295,C=_+(v<<12&4294967295|v>>>20),v=I+(w^C&(_^w))+T[14]+2792965006&4294967295,I=C+(v<<17&4294967295|v>>>15),v=w+(_^I&(C^_))+T[15]+1236535329&4294967295,w=I+(v<<22&4294967295|v>>>10),v=_+(I^C&(w^I))+T[1]+4129170786&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^I&(_^w))+T[6]+3225465664&4294967295,C=_+(v<<9&4294967295|v>>>23),v=I+(_^w&(C^_))+T[11]+643717713&4294967295,I=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(I^C))+T[0]+3921069994&4294967295,w=I+(v<<20&4294967295|v>>>12),v=_+(I^C&(w^I))+T[5]+3593408605&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^I&(_^w))+T[10]+38016083&4294967295,C=_+(v<<9&4294967295|v>>>23),v=I+(_^w&(C^_))+T[15]+3634488961&4294967295,I=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(I^C))+T[4]+3889429448&4294967295,w=I+(v<<20&4294967295|v>>>12),v=_+(I^C&(w^I))+T[9]+568446438&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^I&(_^w))+T[14]+3275163606&4294967295,C=_+(v<<9&4294967295|v>>>23),v=I+(_^w&(C^_))+T[3]+4107603335&4294967295,I=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(I^C))+T[8]+1163531501&4294967295,w=I+(v<<20&4294967295|v>>>12),v=_+(I^C&(w^I))+T[13]+2850285829&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^I&(_^w))+T[2]+4243563512&4294967295,C=_+(v<<9&4294967295|v>>>23),v=I+(_^w&(C^_))+T[7]+1735328473&4294967295,I=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(I^C))+T[12]+2368359562&4294967295,w=I+(v<<20&4294967295|v>>>12),v=_+(w^I^C)+T[5]+4294588738&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^I)+T[8]+2272392833&4294967295,C=_+(v<<11&4294967295|v>>>21),v=I+(C^_^w)+T[11]+1839030562&4294967295,I=C+(v<<16&4294967295|v>>>16),v=w+(I^C^_)+T[14]+4259657740&4294967295,w=I+(v<<23&4294967295|v>>>9),v=_+(w^I^C)+T[1]+2763975236&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^I)+T[4]+1272893353&4294967295,C=_+(v<<11&4294967295|v>>>21),v=I+(C^_^w)+T[7]+4139469664&4294967295,I=C+(v<<16&4294967295|v>>>16),v=w+(I^C^_)+T[10]+3200236656&4294967295,w=I+(v<<23&4294967295|v>>>9),v=_+(w^I^C)+T[13]+681279174&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^I)+T[0]+3936430074&4294967295,C=_+(v<<11&4294967295|v>>>21),v=I+(C^_^w)+T[3]+3572445317&4294967295,I=C+(v<<16&4294967295|v>>>16),v=w+(I^C^_)+T[6]+76029189&4294967295,w=I+(v<<23&4294967295|v>>>9),v=_+(w^I^C)+T[9]+3654602809&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^I)+T[12]+3873151461&4294967295,C=_+(v<<11&4294967295|v>>>21),v=I+(C^_^w)+T[15]+530742520&4294967295,I=C+(v<<16&4294967295|v>>>16),v=w+(I^C^_)+T[2]+3299628645&4294967295,w=I+(v<<23&4294967295|v>>>9),v=_+(I^(w|~C))+T[0]+4096336452&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~I))+T[7]+1126891415&4294967295,C=_+(v<<10&4294967295|v>>>22),v=I+(_^(C|~w))+T[14]+2878612391&4294967295,I=C+(v<<15&4294967295|v>>>17),v=w+(C^(I|~_))+T[5]+4237533241&4294967295,w=I+(v<<21&4294967295|v>>>11),v=_+(I^(w|~C))+T[12]+1700485571&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~I))+T[3]+2399980690&4294967295,C=_+(v<<10&4294967295|v>>>22),v=I+(_^(C|~w))+T[10]+4293915773&4294967295,I=C+(v<<15&4294967295|v>>>17),v=w+(C^(I|~_))+T[1]+2240044497&4294967295,w=I+(v<<21&4294967295|v>>>11),v=_+(I^(w|~C))+T[8]+1873313359&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~I))+T[15]+4264355552&4294967295,C=_+(v<<10&4294967295|v>>>22),v=I+(_^(C|~w))+T[6]+2734768916&4294967295,I=C+(v<<15&4294967295|v>>>17),v=w+(C^(I|~_))+T[13]+1309151649&4294967295,w=I+(v<<21&4294967295|v>>>11),v=_+(I^(w|~C))+T[4]+4149444226&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~I))+T[11]+3174756917&4294967295,C=_+(v<<10&4294967295|v>>>22),v=I+(_^(C|~w))+T[2]+718787259&4294967295,I=C+(v<<15&4294967295|v>>>17),v=w+(C^(I|~_))+T[9]+3951481745&4294967295,E.g[0]=E.g[0]+_&4294967295,E.g[1]=E.g[1]+(I+(v<<21&4294967295|v>>>11))&4294967295,E.g[2]=E.g[2]+I&4294967295,E.g[3]=E.g[3]+C&4294967295}r.prototype.u=function(E,_){_===void 0&&(_=E.length);for(var w=_-this.blockSize,T=this.B,I=this.h,C=0;C<_;){if(I==0)for(;C<=w;)i(this,E,C),C+=this.blockSize;if(typeof E=="string"){for(;C<_;)if(T[I++]=E.charCodeAt(C++),I==this.blockSize){i(this,T),I=0;break}}else for(;C<_;)if(T[I++]=E[C++],I==this.blockSize){i(this,T),I=0;break}}this.h=I,this.o+=_},r.prototype.v=function(){var E=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);E[0]=128;for(var _=1;_<E.length-8;++_)E[_]=0;var w=8*this.o;for(_=E.length-8;_<E.length;++_)E[_]=w&255,w/=256;for(this.u(E),E=Array(16),_=w=0;4>_;++_)for(var T=0;32>T;T+=8)E[w++]=this.g[_]>>>T&255;return E};function s(E,_){var w=a;return Object.prototype.hasOwnProperty.call(w,E)?w[E]:w[E]=_(E)}function o(E,_){this.h=_;for(var w=[],T=!0,I=E.length-1;0<=I;I--){var C=E[I]|0;T&&C==_||(w[I]=C,T=!1)}this.g=w}var a={};function c(E){return-128<=E&&128>E?s(E,function(_){return new o([_|0],0>_?-1:0)}):new o([E|0],0>E?-1:0)}function u(E){if(isNaN(E)||!isFinite(E))return p;if(0>E)return N(u(-E));for(var _=[],w=1,T=0;E>=w;T++)_[T]=E/w|0,w*=4294967296;return new o(_,0)}function d(E,_){if(E.length==0)throw Error("number format error: empty string");if(_=_||10,2>_||36<_)throw Error("radix out of range: "+_);if(E.charAt(0)=="-")return N(d(E.substring(1),_));if(0<=E.indexOf("-"))throw Error('number format error: interior "-" character');for(var w=u(Math.pow(_,8)),T=p,I=0;I<E.length;I+=8){var C=Math.min(8,E.length-I),v=parseInt(E.substring(I,I+C),_);8>C?(C=u(Math.pow(_,C)),T=T.j(C).add(u(v))):(T=T.j(w),T=T.add(u(v)))}return T}var p=c(0),g=c(1),y=c(16777216);n=o.prototype,n.m=function(){if(k(this))return-N(this).m();for(var E=0,_=1,w=0;w<this.g.length;w++){var T=this.i(w);E+=(0<=T?T:4294967296+T)*_,_*=4294967296}return E},n.toString=function(E){if(E=E||10,2>E||36<E)throw Error("radix out of range: "+E);if(S(this))return"0";if(k(this))return"-"+N(this).toString(E);for(var _=u(Math.pow(E,6)),w=this,T="";;){var I=K(w,_).g;w=q(w,I.j(_));var C=((0<w.g.length?w.g[0]:w.h)>>>0).toString(E);if(w=I,S(w))return C+T;for(;6>C.length;)C="0"+C;T=C+T}},n.i=function(E){return 0>E?0:E<this.g.length?this.g[E]:this.h};function S(E){if(E.h!=0)return!1;for(var _=0;_<E.g.length;_++)if(E.g[_]!=0)return!1;return!0}function k(E){return E.h==-1}n.l=function(E){return E=q(this,E),k(E)?-1:S(E)?0:1};function N(E){for(var _=E.g.length,w=[],T=0;T<_;T++)w[T]=~E.g[T];return new o(w,~E.h).add(g)}n.abs=function(){return k(this)?N(this):this},n.add=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],T=0,I=0;I<=_;I++){var C=T+(this.i(I)&65535)+(E.i(I)&65535),v=(C>>>16)+(this.i(I)>>>16)+(E.i(I)>>>16);T=v>>>16,C&=65535,v&=65535,w[I]=v<<16|C}return new o(w,w[w.length-1]&-2147483648?-1:0)};function q(E,_){return E.add(N(_))}n.j=function(E){if(S(this)||S(E))return p;if(k(this))return k(E)?N(this).j(N(E)):N(N(this).j(E));if(k(E))return N(this.j(N(E)));if(0>this.l(y)&&0>E.l(y))return u(this.m()*E.m());for(var _=this.g.length+E.g.length,w=[],T=0;T<2*_;T++)w[T]=0;for(T=0;T<this.g.length;T++)for(var I=0;I<E.g.length;I++){var C=this.i(T)>>>16,v=this.i(T)&65535,en=E.i(I)>>>16,ds=E.i(I)&65535;w[2*T+2*I]+=v*ds,G(w,2*T+2*I),w[2*T+2*I+1]+=C*ds,G(w,2*T+2*I+1),w[2*T+2*I+1]+=v*en,G(w,2*T+2*I+1),w[2*T+2*I+2]+=C*en,G(w,2*T+2*I+2)}for(T=0;T<_;T++)w[T]=w[2*T+1]<<16|w[2*T];for(T=_;T<2*_;T++)w[T]=0;return new o(w,0)};function G(E,_){for(;(E[_]&65535)!=E[_];)E[_+1]+=E[_]>>>16,E[_]&=65535,_++}function F(E,_){this.g=E,this.h=_}function K(E,_){if(S(_))throw Error("division by zero");if(S(E))return new F(p,p);if(k(E))return _=K(N(E),_),new F(N(_.g),N(_.h));if(k(_))return _=K(E,N(_)),new F(N(_.g),_.h);if(30<E.g.length){if(k(E)||k(_))throw Error("slowDivide_ only works with positive integers.");for(var w=g,T=_;0>=T.l(E);)w=Q(w),T=Q(T);var I=H(w,1),C=H(T,1);for(T=H(T,2),w=H(w,2);!S(T);){var v=C.add(T);0>=v.l(E)&&(I=I.add(w),C=v),T=H(T,1),w=H(w,1)}return _=q(E,I.j(_)),new F(I,_)}for(I=p;0<=E.l(_);){for(w=Math.max(1,Math.floor(E.m()/_.m())),T=Math.ceil(Math.log(w)/Math.LN2),T=48>=T?1:Math.pow(2,T-48),C=u(w),v=C.j(_);k(v)||0<v.l(E);)w-=T,C=u(w),v=C.j(_);S(C)&&(C=g),I=I.add(C),E=q(E,v)}return new F(I,E)}n.A=function(E){return K(this,E).h},n.and=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],T=0;T<_;T++)w[T]=this.i(T)&E.i(T);return new o(w,this.h&E.h)},n.or=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],T=0;T<_;T++)w[T]=this.i(T)|E.i(T);return new o(w,this.h|E.h)},n.xor=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],T=0;T<_;T++)w[T]=this.i(T)^E.i(T);return new o(w,this.h^E.h)};function Q(E){for(var _=E.g.length+1,w=[],T=0;T<_;T++)w[T]=E.i(T)<<1|E.i(T-1)>>>31;return new o(w,E.h)}function H(E,_){var w=_>>5;_%=32;for(var T=E.g.length-w,I=[],C=0;C<T;C++)I[C]=0<_?E.i(C+w)>>>_|E.i(C+w+1)<<32-_:E.i(C+w);return new o(I,E.h)}r.prototype.digest=r.prototype.v,r.prototype.reset=r.prototype.s,r.prototype.update=r.prototype.u,Ju=M_.Md5=r,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=u,o.fromString=d,Vn=M_.Integer=o}).apply(typeof F_<"u"?F_:typeof self<"u"?self:typeof window<"u"?window:{});var Wa=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},an={};var Xu,Zu,li,eh,Ws,$a,th,nh,rh;(function(){var n,e=typeof Object.defineProperties=="function"?Object.defineProperty:function(l,h,f){return l==Array.prototype||l==Object.prototype||(l[h]=f.value),l};function t(l){l=[typeof globalThis=="object"&&globalThis,l,typeof window=="object"&&window,typeof self=="object"&&self,typeof Wa=="object"&&Wa];for(var h=0;h<l.length;++h){var f=l[h];if(f&&f.Math==Math)return f}throw Error("Cannot find global object")}var r=t(this);function i(l,h){if(h)e:{var f=r;l=l.split(".");for(var m=0;m<l.length-1;m++){var A=l[m];if(!(A in f))break e;f=f[A]}l=l[l.length-1],m=f[l],h=h(m),h!=m&&h!=null&&e(f,l,{configurable:!0,writable:!0,value:h})}}function s(l,h){l instanceof String&&(l+="");var f=0,m=!1,A={next:function(){if(!m&&f<l.length){var P=f++;return{value:h(P,l[P]),done:!1}}return m=!0,{done:!0,value:void 0}}};return A[Symbol.iterator]=function(){return A},A}i("Array.prototype.values",function(l){return l||function(){return s(this,function(h,f){return f})}});var o=o||{},a=this||self;function c(l){var h=typeof l;return h=h!="object"?h:l?Array.isArray(l)?"array":h:"null",h=="array"||h=="object"&&typeof l.length=="number"}function u(l){var h=typeof l;return h=="object"&&l!=null||h=="function"}function d(l,h,f){return l.call.apply(l.bind,arguments)}function p(l,h,f){if(!l)throw Error();if(2<arguments.length){var m=Array.prototype.slice.call(arguments,2);return function(){var A=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(A,m),l.apply(h,A)}}return function(){return l.apply(h,arguments)}}function g(l,h,f){return g=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?d:p,g.apply(null,arguments)}function y(l,h){var f=Array.prototype.slice.call(arguments,1);return function(){var m=f.slice();return m.push.apply(m,arguments),l.apply(this,m)}}function S(l,h){function f(){}f.prototype=h.prototype,l.aa=h.prototype,l.prototype=new f,l.prototype.constructor=l,l.Qb=function(m,A,P){for(var M=Array(arguments.length-2),he=2;he<arguments.length;he++)M[he-2]=arguments[he];return h.prototype[A].apply(m,M)}}function k(l){let h=l.length;if(0<h){let f=Array(h);for(let m=0;m<h;m++)f[m]=l[m];return f}return[]}function N(l,h){for(let f=1;f<arguments.length;f++){let m=arguments[f];if(c(m)){let A=l.length||0,P=m.length||0;l.length=A+P;for(let M=0;M<P;M++)l[A+M]=m[M]}else l.push(m)}}class q{constructor(h,f){this.i=h,this.j=f,this.h=0,this.g=null}get(){let h;return 0<this.h?(this.h--,h=this.g,this.g=h.next,h.next=null):h=this.i(),h}}function G(l){return/^[\s\xa0]*$/.test(l)}function F(){var l=a.navigator;return l&&(l=l.userAgent)?l:""}function K(l){return K[" "](l),l}K[" "]=function(){};var Q=F().indexOf("Gecko")!=-1&&!(F().toLowerCase().indexOf("webkit")!=-1&&F().indexOf("Edge")==-1)&&!(F().indexOf("Trident")!=-1||F().indexOf("MSIE")!=-1)&&F().indexOf("Edge")==-1;function H(l,h,f){for(let m in l)h.call(f,l[m],m,l)}function E(l,h){for(let f in l)h.call(void 0,l[f],f,l)}function _(l){let h={};for(let f in l)h[f]=l[f];return h}let w="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function T(l,h){let f,m;for(let A=1;A<arguments.length;A++){m=arguments[A];for(f in m)l[f]=m[f];for(let P=0;P<w.length;P++)f=w[P],Object.prototype.hasOwnProperty.call(m,f)&&(l[f]=m[f])}}function I(l){var h=1;l=l.split(":");let f=[];for(;0<h&&l.length;)f.push(l.shift()),h--;return l.length&&f.push(l.join(":")),f}function C(l){a.setTimeout(()=>{throw l},0)}function v(){var l=au;let h=null;return l.g&&(h=l.g,l.g=l.g.next,l.g||(l.h=null),h.next=null),h}class en{constructor(){this.h=this.g=null}add(h,f){let m=ds.get();m.set(h,f),this.h?this.h.next=m:this.g=m,this.h=m}}var ds=new q(()=>new UI,l=>l.reset());class UI{constructor(){this.next=this.g=this.h=null}set(h,f){this.h=h,this.g=f,this.next=null}reset(){this.next=this.g=this.h=null}}let fs,ps=!1,au=new en,Xg=()=>{let l=a.Promise.resolve(void 0);fs=()=>{l.then(BI)}};var BI=()=>{for(var l;l=v();){try{l.h.call(l.g)}catch(f){C(f)}var h=ds;h.j(l),100>h.h&&(h.h++,l.next=h.g,h.g=l)}ps=!1};function vn(){this.s=this.s,this.C=this.C}vn.prototype.s=!1,vn.prototype.ma=function(){this.s||(this.s=!0,this.N())},vn.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function $e(l,h){this.type=l,this.g=this.target=h,this.defaultPrevented=!1}$e.prototype.h=function(){this.defaultPrevented=!0};var qI=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var l=!1,h=Object.defineProperty({},"passive",{get:function(){l=!0}});try{let f=()=>{};a.addEventListener("test",f,h),a.removeEventListener("test",f,h)}catch{}return l}();function gs(l,h){if($e.call(this,l?l.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,l){var f=this.type=l.type,m=l.changedTouches&&l.changedTouches.length?l.changedTouches[0]:null;if(this.target=l.target||l.srcElement,this.g=h,h=l.relatedTarget){if(Q){e:{try{K(h.nodeName);var A=!0;break e}catch{}A=!1}A||(h=null)}}else f=="mouseover"?h=l.fromElement:f=="mouseout"&&(h=l.toElement);this.relatedTarget=h,m?(this.clientX=m.clientX!==void 0?m.clientX:m.pageX,this.clientY=m.clientY!==void 0?m.clientY:m.pageY,this.screenX=m.screenX||0,this.screenY=m.screenY||0):(this.clientX=l.clientX!==void 0?l.clientX:l.pageX,this.clientY=l.clientY!==void 0?l.clientY:l.pageY,this.screenX=l.screenX||0,this.screenY=l.screenY||0),this.button=l.button,this.key=l.key||"",this.ctrlKey=l.ctrlKey,this.altKey=l.altKey,this.shiftKey=l.shiftKey,this.metaKey=l.metaKey,this.pointerId=l.pointerId||0,this.pointerType=typeof l.pointerType=="string"?l.pointerType:GI[l.pointerType]||"",this.state=l.state,this.i=l,l.defaultPrevented&&gs.aa.h.call(this)}}S(gs,$e);var GI={2:"touch",3:"pen",4:"mouse"};gs.prototype.h=function(){gs.aa.h.call(this);var l=this.i;l.preventDefault?l.preventDefault():l.returnValue=!1};var ms="closure_listenable_"+(1e6*Math.random()|0),jI=0;function zI(l,h,f,m,A){this.listener=l,this.proxy=null,this.src=h,this.type=f,this.capture=!!m,this.ha=A,this.key=++jI,this.da=this.fa=!1}function pa(l){l.da=!0,l.listener=null,l.proxy=null,l.src=null,l.ha=null}function ga(l){this.src=l,this.g={},this.h=0}ga.prototype.add=function(l,h,f,m,A){var P=l.toString();l=this.g[P],l||(l=this.g[P]=[],this.h++);var M=cu(l,h,m,A);return-1<M?(h=l[M],f||(h.fa=!1)):(h=new zI(h,this.src,P,!!m,A),h.fa=f,l.push(h)),h};function lu(l,h){var f=h.type;if(f in l.g){var m=l.g[f],A=Array.prototype.indexOf.call(m,h,void 0),P;(P=0<=A)&&Array.prototype.splice.call(m,A,1),P&&(pa(h),l.g[f].length==0&&(delete l.g[f],l.h--))}}function cu(l,h,f,m){for(var A=0;A<l.length;++A){var P=l[A];if(!P.da&&P.listener==h&&P.capture==!!f&&P.ha==m)return A}return-1}var uu="closure_lm_"+(1e6*Math.random()|0),hu={};function Zg(l,h,f,m,A){if(m&&m.once)return tm(l,h,f,m,A);if(Array.isArray(h)){for(var P=0;P<h.length;P++)Zg(l,h[P],f,m,A);return null}return f=gu(f),l&&l[ms]?l.K(h,f,u(m)?!!m.capture:!!m,A):em(l,h,f,!1,m,A)}function em(l,h,f,m,A,P){if(!h)throw Error("Invalid event type");var M=u(A)?!!A.capture:!!A,he=fu(l);if(he||(l[uu]=he=new ga(l)),f=he.add(h,f,m,M,P),f.proxy)return f;if(m=KI(),f.proxy=m,m.src=l,m.listener=f,l.addEventListener)qI||(A=M),A===void 0&&(A=!1),l.addEventListener(h.toString(),m,A);else if(l.attachEvent)l.attachEvent(rm(h.toString()),m);else if(l.addListener&&l.removeListener)l.addListener(m);else throw Error("addEventListener and attachEvent are unavailable.");return f}function KI(){function l(f){return h.call(l.src,l.listener,f)}let h=WI;return l}function tm(l,h,f,m,A){if(Array.isArray(h)){for(var P=0;P<h.length;P++)tm(l,h[P],f,m,A);return null}return f=gu(f),l&&l[ms]?l.L(h,f,u(m)?!!m.capture:!!m,A):em(l,h,f,!0,m,A)}function nm(l,h,f,m,A){if(Array.isArray(h))for(var P=0;P<h.length;P++)nm(l,h[P],f,m,A);else m=u(m)?!!m.capture:!!m,f=gu(f),l&&l[ms]?(l=l.i,h=String(h).toString(),h in l.g&&(P=l.g[h],f=cu(P,f,m,A),-1<f&&(pa(P[f]),Array.prototype.splice.call(P,f,1),P.length==0&&(delete l.g[h],l.h--)))):l&&(l=fu(l))&&(h=l.g[h.toString()],l=-1,h&&(l=cu(h,f,m,A)),(f=-1<l?h[l]:null)&&du(f))}function du(l){if(typeof l!="number"&&l&&!l.da){var h=l.src;if(h&&h[ms])lu(h.i,l);else{var f=l.type,m=l.proxy;h.removeEventListener?h.removeEventListener(f,m,l.capture):h.detachEvent?h.detachEvent(rm(f),m):h.addListener&&h.removeListener&&h.removeListener(m),(f=fu(h))?(lu(f,l),f.h==0&&(f.src=null,h[uu]=null)):pa(l)}}}function rm(l){return l in hu?hu[l]:hu[l]="on"+l}function WI(l,h){if(l.da)l=!0;else{h=new gs(h,this);var f=l.listener,m=l.ha||l.src;l.fa&&du(l),l=f.call(m,h)}return l}function fu(l){return l=l[uu],l instanceof ga?l:null}var pu="__closure_events_fn_"+(1e9*Math.random()>>>0);function gu(l){return typeof l=="function"?l:(l[pu]||(l[pu]=function(h){return l.handleEvent(h)}),l[pu])}function Qe(){vn.call(this),this.i=new ga(this),this.M=this,this.F=null}S(Qe,vn),Qe.prototype[ms]=!0,Qe.prototype.removeEventListener=function(l,h,f,m){nm(this,l,h,f,m)};function et(l,h){var f,m=l.F;if(m)for(f=[];m;m=m.F)f.push(m);if(l=l.M,m=h.type||h,typeof h=="string")h=new $e(h,l);else if(h instanceof $e)h.target=h.target||l;else{var A=h;h=new $e(m,l),T(h,A)}if(A=!0,f)for(var P=f.length-1;0<=P;P--){var M=h.g=f[P];A=ma(M,m,!0,h)&&A}if(M=h.g=l,A=ma(M,m,!0,h)&&A,A=ma(M,m,!1,h)&&A,f)for(P=0;P<f.length;P++)M=h.g=f[P],A=ma(M,m,!1,h)&&A}Qe.prototype.N=function(){if(Qe.aa.N.call(this),this.i){var l=this.i,h;for(h in l.g){for(var f=l.g[h],m=0;m<f.length;m++)pa(f[m]);delete l.g[h],l.h--}}this.F=null},Qe.prototype.K=function(l,h,f,m){return this.i.add(String(l),h,!1,f,m)},Qe.prototype.L=function(l,h,f,m){return this.i.add(String(l),h,!0,f,m)};function ma(l,h,f,m){if(h=l.i.g[String(h)],!h)return!0;h=h.concat();for(var A=!0,P=0;P<h.length;++P){var M=h[P];if(M&&!M.da&&M.capture==f){var he=M.listener,Ke=M.ha||M.src;M.fa&&lu(l.i,M),A=he.call(Ke,m)!==!1&&A}}return A&&!m.defaultPrevented}function im(l,h,f){if(typeof l=="function")f&&(l=g(l,f));else if(l&&typeof l.handleEvent=="function")l=g(l.handleEvent,l);else throw Error("Invalid listener argument");return 2147483647<Number(h)?-1:a.setTimeout(l,h||0)}function sm(l){l.g=im(()=>{l.g=null,l.i&&(l.i=!1,sm(l))},l.l);let h=l.h;l.h=null,l.m.apply(null,h)}class $I extends vn{constructor(h,f){super(),this.m=h,this.l=f,this.h=null,this.i=!1,this.g=null}j(h){this.h=arguments,this.g?this.i=!0:sm(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function _s(l){vn.call(this),this.h=l,this.g={}}S(_s,vn);var om=[];function am(l){H(l.g,function(h,f){this.g.hasOwnProperty(f)&&du(h)},l),l.g={}}_s.prototype.N=function(){_s.aa.N.call(this),am(this)},_s.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var mu=a.JSON.stringify,QI=a.JSON.parse,HI=class{stringify(l){return a.JSON.stringify(l,void 0)}parse(l){return a.JSON.parse(l,void 0)}};function _u(){}_u.prototype.h=null;function lm(l){return l.h||(l.h=l.i())}function cm(){}var ys={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function yu(){$e.call(this,"d")}S(yu,$e);function vu(){$e.call(this,"c")}S(vu,$e);var cr={},um=null;function _a(){return um=um||new Qe}cr.La="serverreachability";function hm(l){$e.call(this,cr.La,l)}S(hm,$e);function vs(l){let h=_a();et(h,new hm(h))}cr.STAT_EVENT="statevent";function dm(l,h){$e.call(this,cr.STAT_EVENT,l),this.stat=h}S(dm,$e);function tt(l){let h=_a();et(h,new dm(h,l))}cr.Ma="timingevent";function fm(l,h){$e.call(this,cr.Ma,l),this.size=h}S(fm,$e);function ws(l,h){if(typeof l!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){l()},h)}function Es(){this.g=!0}Es.prototype.xa=function(){this.g=!1};function YI(l,h,f,m,A,P){l.info(function(){if(l.g)if(P)for(var M="",he=P.split("&"),Ke=0;Ke<he.length;Ke++){var ae=he[Ke].split("=");if(1<ae.length){var He=ae[0];ae=ae[1];var Ye=He.split("_");M=2<=Ye.length&&Ye[1]=="type"?M+(He+"="+ae+"&"):M+(He+"=redacted&")}}else M=null;else M=P;return"XMLHTTP REQ ("+m+") [attempt "+A+"]: "+h+`
`+f+`
`+M})}function JI(l,h,f,m,A,P,M){l.info(function(){return"XMLHTTP RESP ("+m+") [ attempt "+A+"]: "+h+`
`+f+`
`+P+" "+M})}function Xr(l,h,f,m){l.info(function(){return"XMLHTTP TEXT ("+h+"): "+ZI(l,f)+(m?" "+m:"")})}function XI(l,h){l.info(function(){return"TIMEOUT: "+h})}Es.prototype.info=function(){};function ZI(l,h){if(!l.g)return h;if(!h)return null;try{var f=JSON.parse(h);if(f){for(l=0;l<f.length;l++)if(Array.isArray(f[l])){var m=f[l];if(!(2>m.length)){var A=m[1];if(Array.isArray(A)&&!(1>A.length)){var P=A[0];if(P!="noop"&&P!="stop"&&P!="close")for(var M=1;M<A.length;M++)A[M]=""}}}}return mu(f)}catch{return h}}var ya={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},pm={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},wu;function va(){}S(va,_u),va.prototype.g=function(){return new XMLHttpRequest},va.prototype.i=function(){return{}},wu=new va;function wn(l,h,f,m){this.j=l,this.i=h,this.l=f,this.R=m||1,this.U=new _s(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new gm}function gm(){this.i=null,this.g="",this.h=!1}var mm={},Eu={};function Tu(l,h,f){l.L=1,l.v=Ia(tn(h)),l.m=f,l.P=!0,_m(l,null)}function _m(l,h){l.F=Date.now(),wa(l),l.A=tn(l.v);var f=l.A,m=l.R;Array.isArray(m)||(m=[String(m)]),km(f.i,"t",m),l.C=0,f=l.j.J,l.h=new gm,l.g=Hm(l.j,f?h:null,!l.m),0<l.O&&(l.M=new $I(g(l.Y,l,l.g),l.O)),h=l.U,f=l.g,m=l.ca;var A="readystatechange";Array.isArray(A)||(A&&(om[0]=A.toString()),A=om);for(var P=0;P<A.length;P++){var M=Zg(f,A[P],m||h.handleEvent,!1,h.h||h);if(!M)break;h.g[M.key]=M}h=l.H?_(l.H):{},l.m?(l.u||(l.u="POST"),h["Content-Type"]="application/x-www-form-urlencoded",l.g.ea(l.A,l.u,l.m,h)):(l.u="GET",l.g.ea(l.A,l.u,null,h)),vs(),YI(l.i,l.u,l.A,l.l,l.R,l.m)}wn.prototype.ca=function(l){l=l.target;let h=this.M;h&&nn(l)==3?h.j():this.Y(l)},wn.prototype.Y=function(l){try{if(l==this.g)e:{let Ye=nn(this.g);var h=this.g.Ba();let ti=this.g.Z();if(!(3>Ye)&&(Ye!=3||this.g&&(this.h.h||this.g.oa()||Lm(this.g)))){this.J||Ye!=4||h==7||(h==8||0>=ti?vs(3):vs(2)),Iu(this);var f=this.g.Z();this.X=f;t:if(ym(this)){var m=Lm(this.g);l="";var A=m.length,P=nn(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){ur(this),Ts(this);var M="";break t}this.h.i=new a.TextDecoder}for(h=0;h<A;h++)this.h.h=!0,l+=this.h.i.decode(m[h],{stream:!(P&&h==A-1)});m.length=0,this.h.g+=l,this.C=0,M=this.h.g}else M=this.g.oa();if(this.o=f==200,JI(this.i,this.u,this.A,this.l,this.R,Ye,f),this.o){if(this.T&&!this.K){t:{if(this.g){var he,Ke=this.g;if((he=Ke.g?Ke.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!G(he)){var ae=he;break t}}ae=null}if(f=ae)Xr(this.i,this.l,f,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Au(this,f);else{this.o=!1,this.s=3,tt(12),ur(this),Ts(this);break e}}if(this.P){f=!0;let bt;for(;!this.J&&this.C<M.length;)if(bt=eA(this,M),bt==Eu){Ye==4&&(this.s=4,tt(14),f=!1),Xr(this.i,this.l,null,"[Incomplete Response]");break}else if(bt==mm){this.s=4,tt(15),Xr(this.i,this.l,M,"[Invalid Chunk]"),f=!1;break}else Xr(this.i,this.l,bt,null),Au(this,bt);if(ym(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Ye!=4||M.length!=0||this.h.h||(this.s=1,tt(16),f=!1),this.o=this.o&&f,!f)Xr(this.i,this.l,M,"[Invalid Chunked Response]"),ur(this),Ts(this);else if(0<M.length&&!this.W){this.W=!0;var He=this.j;He.g==this&&He.ba&&!He.M&&(He.j.info("Great, no buffering proxy detected. Bytes received: "+M.length),xu(He),He.M=!0,tt(11))}}else Xr(this.i,this.l,M,null),Au(this,M);Ye==4&&ur(this),this.o&&!this.J&&(Ye==4?Km(this.j,this):(this.o=!1,wa(this)))}else _A(this.g),f==400&&0<M.indexOf("Unknown SID")?(this.s=3,tt(12)):(this.s=0,tt(13)),ur(this),Ts(this)}}}catch{}finally{}};function ym(l){return l.g?l.u=="GET"&&l.L!=2&&l.j.Ca:!1}function eA(l,h){var f=l.C,m=h.indexOf(`
`,f);return m==-1?Eu:(f=Number(h.substring(f,m)),isNaN(f)?mm:(m+=1,m+f>h.length?Eu:(h=h.slice(m,m+f),l.C=m+f,h)))}wn.prototype.cancel=function(){this.J=!0,ur(this)};function wa(l){l.S=Date.now()+l.I,vm(l,l.I)}function vm(l,h){if(l.B!=null)throw Error("WatchDog timer not null");l.B=ws(g(l.ba,l),h)}function Iu(l){l.B&&(a.clearTimeout(l.B),l.B=null)}wn.prototype.ba=function(){this.B=null;let l=Date.now();0<=l-this.S?(XI(this.i,this.A),this.L!=2&&(vs(),tt(17)),ur(this),this.s=2,Ts(this)):vm(this,this.S-l)};function Ts(l){l.j.G==0||l.J||Km(l.j,l)}function ur(l){Iu(l);var h=l.M;h&&typeof h.ma=="function"&&h.ma(),l.M=null,am(l.U),l.g&&(h=l.g,l.g=null,h.abort(),h.ma())}function Au(l,h){try{var f=l.j;if(f.G!=0&&(f.g==l||Su(f.h,l))){if(!l.K&&Su(f.h,l)&&f.G==3){try{var m=f.Da.g.parse(h)}catch{m=null}if(Array.isArray(m)&&m.length==3){var A=m;if(A[0]==0){e:if(!f.u){if(f.g)if(f.g.F+3e3<l.F)Ra(f),Ca(f);else break e;Pu(f),tt(18)}}else f.za=A[1],0<f.za-f.T&&37500>A[2]&&f.F&&f.v==0&&!f.C&&(f.C=ws(g(f.Za,f),6e3));if(1>=Tm(f.h)&&f.ca){try{f.ca()}catch{}f.ca=void 0}}else dr(f,11)}else if((l.K||f.g==l)&&Ra(f),!G(h))for(A=f.Da.g.parse(h),h=0;h<A.length;h++){let ae=A[h];if(f.T=ae[0],ae=ae[1],f.G==2)if(ae[0]=="c"){f.K=ae[1],f.ia=ae[2];let He=ae[3];He!=null&&(f.la=He,f.j.info("VER="+f.la));let Ye=ae[4];Ye!=null&&(f.Aa=Ye,f.j.info("SVER="+f.Aa));let ti=ae[5];ti!=null&&typeof ti=="number"&&0<ti&&(m=1.5*ti,f.L=m,f.j.info("backChannelRequestTimeoutMs_="+m)),m=f;let bt=l.g;if(bt){let xa=bt.g?bt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(xa){var P=m.h;P.g||xa.indexOf("spdy")==-1&&xa.indexOf("quic")==-1&&xa.indexOf("h2")==-1||(P.j=P.l,P.g=new Set,P.h&&(Cu(P,P.h),P.h=null))}if(m.D){let ku=bt.g?bt.g.getResponseHeader("X-HTTP-Session-Id"):null;ku&&(m.ya=ku,me(m.I,m.D,ku))}}f.G=3,f.l&&f.l.ua(),f.ba&&(f.R=Date.now()-l.F,f.j.info("Handshake RTT: "+f.R+"ms")),m=f;var M=l;if(m.qa=Qm(m,m.J?m.ia:null,m.W),M.K){Im(m.h,M);var he=M,Ke=m.L;Ke&&(he.I=Ke),he.B&&(Iu(he),wa(he)),m.g=M}else jm(m);0<f.i.length&&ba(f)}else ae[0]!="stop"&&ae[0]!="close"||dr(f,7);else f.G==3&&(ae[0]=="stop"||ae[0]=="close"?ae[0]=="stop"?dr(f,7):Ru(f):ae[0]!="noop"&&f.l&&f.l.ta(ae),f.v=0)}}vs(4)}catch{}}var tA=class{constructor(l,h){this.g=l,this.map=h}};function wm(l){this.l=l||10,a.PerformanceNavigationTiming?(l=a.performance.getEntriesByType("navigation"),l=0<l.length&&(l[0].nextHopProtocol=="hq"||l[0].nextHopProtocol=="h2")):l=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=l?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Em(l){return l.h?!0:l.g?l.g.size>=l.j:!1}function Tm(l){return l.h?1:l.g?l.g.size:0}function Su(l,h){return l.h?l.h==h:l.g?l.g.has(h):!1}function Cu(l,h){l.g?l.g.add(h):l.h=h}function Im(l,h){l.h&&l.h==h?l.h=null:l.g&&l.g.has(h)&&l.g.delete(h)}wm.prototype.cancel=function(){if(this.i=Am(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let l of this.g.values())l.cancel();this.g.clear()}};function Am(l){if(l.h!=null)return l.i.concat(l.h.D);if(l.g!=null&&l.g.size!==0){let h=l.i;for(let f of l.g.values())h=h.concat(f.D);return h}return k(l.i)}function nA(l){if(l.V&&typeof l.V=="function")return l.V();if(typeof Map<"u"&&l instanceof Map||typeof Set<"u"&&l instanceof Set)return Array.from(l.values());if(typeof l=="string")return l.split("");if(c(l)){for(var h=[],f=l.length,m=0;m<f;m++)h.push(l[m]);return h}h=[],f=0;for(m in l)h[f++]=l[m];return h}function rA(l){if(l.na&&typeof l.na=="function")return l.na();if(!l.V||typeof l.V!="function"){if(typeof Map<"u"&&l instanceof Map)return Array.from(l.keys());if(!(typeof Set<"u"&&l instanceof Set)){if(c(l)||typeof l=="string"){var h=[];l=l.length;for(var f=0;f<l;f++)h.push(f);return h}h=[],f=0;for(let m in l)h[f++]=m;return h}}}function Sm(l,h){if(l.forEach&&typeof l.forEach=="function")l.forEach(h,void 0);else if(c(l)||typeof l=="string")Array.prototype.forEach.call(l,h,void 0);else for(var f=rA(l),m=nA(l),A=m.length,P=0;P<A;P++)h.call(void 0,m[P],f&&f[P],l)}var Cm=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function iA(l,h){if(l){l=l.split("&");for(var f=0;f<l.length;f++){var m=l[f].indexOf("="),A=null;if(0<=m){var P=l[f].substring(0,m);A=l[f].substring(m+1)}else P=l[f];h(P,A?decodeURIComponent(A.replace(/\+/g," ")):"")}}}function hr(l){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,l instanceof hr){this.h=l.h,Ea(this,l.j),this.o=l.o,this.g=l.g,Ta(this,l.s),this.l=l.l;var h=l.i,f=new Ss;f.i=h.i,h.g&&(f.g=new Map(h.g),f.h=h.h),bm(this,f),this.m=l.m}else l&&(h=String(l).match(Cm))?(this.h=!1,Ea(this,h[1]||"",!0),this.o=Is(h[2]||""),this.g=Is(h[3]||"",!0),Ta(this,h[4]),this.l=Is(h[5]||"",!0),bm(this,h[6]||"",!0),this.m=Is(h[7]||"")):(this.h=!1,this.i=new Ss(null,this.h))}hr.prototype.toString=function(){var l=[],h=this.j;h&&l.push(As(h,Rm,!0),":");var f=this.g;return(f||h=="file")&&(l.push("//"),(h=this.o)&&l.push(As(h,Rm,!0),"@"),l.push(encodeURIComponent(String(f)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),f=this.s,f!=null&&l.push(":",String(f))),(f=this.l)&&(this.g&&f.charAt(0)!="/"&&l.push("/"),l.push(As(f,f.charAt(0)=="/"?aA:oA,!0))),(f=this.i.toString())&&l.push("?",f),(f=this.m)&&l.push("#",As(f,cA)),l.join("")};function tn(l){return new hr(l)}function Ea(l,h,f){l.j=f?Is(h,!0):h,l.j&&(l.j=l.j.replace(/:$/,""))}function Ta(l,h){if(h){if(h=Number(h),isNaN(h)||0>h)throw Error("Bad port number "+h);l.s=h}else l.s=null}function bm(l,h,f){h instanceof Ss?(l.i=h,uA(l.i,l.h)):(f||(h=As(h,lA)),l.i=new Ss(h,l.h))}function me(l,h,f){l.i.set(h,f)}function Ia(l){return me(l,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),l}function Is(l,h){return l?h?decodeURI(l.replace(/%25/g,"%2525")):decodeURIComponent(l):""}function As(l,h,f){return typeof l=="string"?(l=encodeURI(l).replace(h,sA),f&&(l=l.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),l):null}function sA(l){return l=l.charCodeAt(0),"%"+(l>>4&15).toString(16)+(l&15).toString(16)}var Rm=/[#\/\?@]/g,oA=/[#\?:]/g,aA=/[#\?]/g,lA=/[#\?@]/g,cA=/#/g;function Ss(l,h){this.h=this.g=null,this.i=l||null,this.j=!!h}function En(l){l.g||(l.g=new Map,l.h=0,l.i&&iA(l.i,function(h,f){l.add(decodeURIComponent(h.replace(/\+/g," ")),f)}))}n=Ss.prototype,n.add=function(l,h){En(this),this.i=null,l=Zr(this,l);var f=this.g.get(l);return f||this.g.set(l,f=[]),f.push(h),this.h+=1,this};function Pm(l,h){En(l),h=Zr(l,h),l.g.has(h)&&(l.i=null,l.h-=l.g.get(h).length,l.g.delete(h))}function xm(l,h){return En(l),h=Zr(l,h),l.g.has(h)}n.forEach=function(l,h){En(this),this.g.forEach(function(f,m){f.forEach(function(A){l.call(h,A,m,this)},this)},this)},n.na=function(){En(this);let l=Array.from(this.g.values()),h=Array.from(this.g.keys()),f=[];for(let m=0;m<h.length;m++){let A=l[m];for(let P=0;P<A.length;P++)f.push(h[m])}return f},n.V=function(l){En(this);let h=[];if(typeof l=="string")xm(this,l)&&(h=h.concat(this.g.get(Zr(this,l))));else{l=Array.from(this.g.values());for(let f=0;f<l.length;f++)h=h.concat(l[f])}return h},n.set=function(l,h){return En(this),this.i=null,l=Zr(this,l),xm(this,l)&&(this.h-=this.g.get(l).length),this.g.set(l,[h]),this.h+=1,this},n.get=function(l,h){return l?(l=this.V(l),0<l.length?String(l[0]):h):h};function km(l,h,f){Pm(l,h),0<f.length&&(l.i=null,l.g.set(Zr(l,h),k(f)),l.h+=f.length)}n.toString=function(){if(this.i)return this.i;if(!this.g)return"";let l=[],h=Array.from(this.g.keys());for(var f=0;f<h.length;f++){var m=h[f];let P=encodeURIComponent(String(m)),M=this.V(m);for(m=0;m<M.length;m++){var A=P;M[m]!==""&&(A+="="+encodeURIComponent(String(M[m]))),l.push(A)}}return this.i=l.join("&")};function Zr(l,h){return h=String(h),l.j&&(h=h.toLowerCase()),h}function uA(l,h){h&&!l.j&&(En(l),l.i=null,l.g.forEach(function(f,m){var A=m.toLowerCase();m!=A&&(Pm(this,m),km(this,A,f))},l)),l.j=h}function hA(l,h){let f=new Es;if(a.Image){let m=new Image;m.onload=y(Tn,f,"TestLoadImage: loaded",!0,h,m),m.onerror=y(Tn,f,"TestLoadImage: error",!1,h,m),m.onabort=y(Tn,f,"TestLoadImage: abort",!1,h,m),m.ontimeout=y(Tn,f,"TestLoadImage: timeout",!1,h,m),a.setTimeout(function(){m.ontimeout&&m.ontimeout()},1e4),m.src=l}else h(!1)}function dA(l,h){let f=new Es,m=new AbortController,A=setTimeout(()=>{m.abort(),Tn(f,"TestPingServer: timeout",!1,h)},1e4);fetch(l,{signal:m.signal}).then(P=>{clearTimeout(A),P.ok?Tn(f,"TestPingServer: ok",!0,h):Tn(f,"TestPingServer: server error",!1,h)}).catch(()=>{clearTimeout(A),Tn(f,"TestPingServer: error",!1,h)})}function Tn(l,h,f,m,A){try{A&&(A.onload=null,A.onerror=null,A.onabort=null,A.ontimeout=null),m(f)}catch{}}function fA(){this.g=new HI}function pA(l,h,f){let m=f||"";try{Sm(l,function(A,P){let M=A;u(A)&&(M=mu(A)),h.push(m+P+"="+encodeURIComponent(M))})}catch(A){throw h.push(m+"type="+encodeURIComponent("_badmap")),A}}function Cs(l){this.l=l.Ub||null,this.j=l.eb||!1}S(Cs,_u),Cs.prototype.g=function(){return new Aa(this.l,this.j)},Cs.prototype.i=function(l){return function(){return l}}({});function Aa(l,h){Qe.call(this),this.D=l,this.o=h,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}S(Aa,Qe),n=Aa.prototype,n.open=function(l,h){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=l,this.A=h,this.readyState=1,Rs(this)},n.send=function(l){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;let h={headers:this.u,method:this.B,credentials:this.m,cache:void 0};l&&(h.body=l),(this.D||a).fetch(new Request(this.A,h)).then(this.Sa.bind(this),this.ga.bind(this))},n.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,bs(this)),this.readyState=0},n.Sa=function(l){if(this.g&&(this.l=l,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=l.headers,this.readyState=2,Rs(this)),this.g&&(this.readyState=3,Rs(this),this.g)))if(this.responseType==="arraybuffer")l.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in l){if(this.j=l.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Nm(this)}else l.text().then(this.Ra.bind(this),this.ga.bind(this))};function Nm(l){l.j.read().then(l.Pa.bind(l)).catch(l.ga.bind(l))}n.Pa=function(l){if(this.g){if(this.o&&l.value)this.response.push(l.value);else if(!this.o){var h=l.value?l.value:new Uint8Array(0);(h=this.v.decode(h,{stream:!l.done}))&&(this.response=this.responseText+=h)}l.done?bs(this):Rs(this),this.readyState==3&&Nm(this)}},n.Ra=function(l){this.g&&(this.response=this.responseText=l,bs(this))},n.Qa=function(l){this.g&&(this.response=l,bs(this))},n.ga=function(){this.g&&bs(this)};function bs(l){l.readyState=4,l.l=null,l.j=null,l.v=null,Rs(l)}n.setRequestHeader=function(l,h){this.u.append(l,h)},n.getResponseHeader=function(l){return this.h&&this.h.get(l.toLowerCase())||""},n.getAllResponseHeaders=function(){if(!this.h)return"";let l=[],h=this.h.entries();for(var f=h.next();!f.done;)f=f.value,l.push(f[0]+": "+f[1]),f=h.next();return l.join(`\r
`)};function Rs(l){l.onreadystatechange&&l.onreadystatechange.call(l)}Object.defineProperty(Aa.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(l){this.m=l?"include":"same-origin"}});function Dm(l){let h="";return H(l,function(f,m){h+=m,h+=":",h+=f,h+=`\r
`}),h}function bu(l,h,f){e:{for(m in f){var m=!1;break e}m=!0}m||(f=Dm(f),typeof l=="string"?f!=null&&encodeURIComponent(String(f)):me(l,h,f))}function Te(l){Qe.call(this),this.headers=new Map,this.o=l||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}S(Te,Qe);var gA=/^https?$/i,mA=["POST","PUT"];n=Te.prototype,n.Ha=function(l){this.J=l},n.ea=function(l,h,f,m){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+l);h=h?h.toUpperCase():"GET",this.D=l,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():wu.g(),this.v=this.o?lm(this.o):lm(wu),this.g.onreadystatechange=g(this.Ea,this);try{this.B=!0,this.g.open(h,String(l),!0),this.B=!1}catch(P){Vm(this,P);return}if(l=f||"",f=new Map(this.headers),m)if(Object.getPrototypeOf(m)===Object.prototype)for(var A in m)f.set(A,m[A]);else if(typeof m.keys=="function"&&typeof m.get=="function")for(let P of m.keys())f.set(P,m.get(P));else throw Error("Unknown input type for opt_headers: "+String(m));m=Array.from(f.keys()).find(P=>P.toLowerCase()=="content-type"),A=a.FormData&&l instanceof a.FormData,!(0<=Array.prototype.indexOf.call(mA,h,void 0))||m||A||f.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[P,M]of f)this.g.setRequestHeader(P,M);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Mm(this),this.u=!0,this.g.send(l),this.u=!1}catch(P){Vm(this,P)}};function Vm(l,h){l.h=!1,l.g&&(l.j=!0,l.g.abort(),l.j=!1),l.l=h,l.m=5,Om(l),Sa(l)}function Om(l){l.A||(l.A=!0,et(l,"complete"),et(l,"error"))}n.abort=function(l){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=l||7,et(this,"complete"),et(this,"abort"),Sa(this))},n.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Sa(this,!0)),Te.aa.N.call(this)},n.Ea=function(){this.s||(this.B||this.u||this.j?Fm(this):this.bb())},n.bb=function(){Fm(this)};function Fm(l){if(l.h&&typeof o<"u"&&(!l.v[1]||nn(l)!=4||l.Z()!=2)){if(l.u&&nn(l)==4)im(l.Ea,0,l);else if(et(l,"readystatechange"),nn(l)==4){l.h=!1;try{let M=l.Z();e:switch(M){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var h=!0;break e;default:h=!1}var f;if(!(f=h)){var m;if(m=M===0){var A=String(l.D).match(Cm)[1]||null;!A&&a.self&&a.self.location&&(A=a.self.location.protocol.slice(0,-1)),m=!gA.test(A?A.toLowerCase():"")}f=m}if(f)et(l,"complete"),et(l,"success");else{l.m=6;try{var P=2<nn(l)?l.g.statusText:""}catch{P=""}l.l=P+" ["+l.Z()+"]",Om(l)}}finally{Sa(l)}}}}function Sa(l,h){if(l.g){Mm(l);let f=l.g,m=l.v[0]?()=>{}:null;l.g=null,l.v=null,h||et(l,"ready");try{f.onreadystatechange=m}catch{}}}function Mm(l){l.I&&(a.clearTimeout(l.I),l.I=null)}n.isActive=function(){return!!this.g};function nn(l){return l.g?l.g.readyState:0}n.Z=function(){try{return 2<nn(this)?this.g.status:-1}catch{return-1}},n.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},n.Oa=function(l){if(this.g){var h=this.g.responseText;return l&&h.indexOf(l)==0&&(h=h.substring(l.length)),QI(h)}};function Lm(l){try{if(!l.g)return null;if("response"in l.g)return l.g.response;switch(l.H){case"":case"text":return l.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in l.g)return l.g.mozResponseArrayBuffer}return null}catch{return null}}function _A(l){let h={};l=(l.g&&2<=nn(l)&&l.g.getAllResponseHeaders()||"").split(`\r
`);for(let m=0;m<l.length;m++){if(G(l[m]))continue;var f=I(l[m]);let A=f[0];if(f=f[1],typeof f!="string")continue;f=f.trim();let P=h[A]||[];h[A]=P,P.push(f)}E(h,function(m){return m.join(", ")})}n.Ba=function(){return this.m},n.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function Ps(l,h,f){return f&&f.internalChannelParams&&f.internalChannelParams[l]||h}function Um(l){this.Aa=0,this.i=[],this.j=new Es,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Ps("failFast",!1,l),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Ps("baseRetryDelayMs",5e3,l),this.cb=Ps("retryDelaySeedMs",1e4,l),this.Wa=Ps("forwardChannelMaxRetries",2,l),this.wa=Ps("forwardChannelRequestTimeoutMs",2e4,l),this.pa=l&&l.xmlHttpFactory||void 0,this.Xa=l&&l.Tb||void 0,this.Ca=l&&l.useFetchStreams||!1,this.L=void 0,this.J=l&&l.supportsCrossDomainXhr||!1,this.K="",this.h=new wm(l&&l.concurrentRequestLimit),this.Da=new fA,this.P=l&&l.fastHandshake||!1,this.O=l&&l.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=l&&l.Rb||!1,l&&l.xa&&this.j.xa(),l&&l.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&l&&l.detectBufferingProxy||!1,this.ja=void 0,l&&l.longPollingTimeout&&0<l.longPollingTimeout&&(this.ja=l.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}n=Um.prototype,n.la=8,n.G=1,n.connect=function(l,h,f,m){tt(0),this.W=l,this.H=h||{},f&&m!==void 0&&(this.H.OSID=f,this.H.OAID=m),this.F=this.X,this.I=Qm(this,null,this.W),ba(this)};function Ru(l){if(Bm(l),l.G==3){var h=l.U++,f=tn(l.I);if(me(f,"SID",l.K),me(f,"RID",h),me(f,"TYPE","terminate"),xs(l,f),h=new wn(l,l.j,h),h.L=2,h.v=Ia(tn(f)),f=!1,a.navigator&&a.navigator.sendBeacon)try{f=a.navigator.sendBeacon(h.v.toString(),"")}catch{}!f&&a.Image&&(new Image().src=h.v,f=!0),f||(h.g=Hm(h.j,null),h.g.ea(h.v)),h.F=Date.now(),wa(h)}$m(l)}function Ca(l){l.g&&(xu(l),l.g.cancel(),l.g=null)}function Bm(l){Ca(l),l.u&&(a.clearTimeout(l.u),l.u=null),Ra(l),l.h.cancel(),l.s&&(typeof l.s=="number"&&a.clearTimeout(l.s),l.s=null)}function ba(l){if(!Em(l.h)&&!l.s){l.s=!0;var h=l.Ga;fs||Xg(),ps||(fs(),ps=!0),au.add(h,l),l.B=0}}function yA(l,h){return Tm(l.h)>=l.h.j-(l.s?1:0)?!1:l.s?(l.i=h.D.concat(l.i),!0):l.G==1||l.G==2||l.B>=(l.Va?0:l.Wa)?!1:(l.s=ws(g(l.Ga,l,h),Wm(l,l.B)),l.B++,!0)}n.Ga=function(l){if(this.s)if(this.s=null,this.G==1){if(!l){this.U=Math.floor(1e5*Math.random()),l=this.U++;let A=new wn(this,this.j,l),P=this.o;if(this.S&&(P?(P=_(P),T(P,this.S)):P=this.S),this.m!==null||this.O||(A.H=P,P=null),this.P)e:{for(var h=0,f=0;f<this.i.length;f++){t:{var m=this.i[f];if("__data__"in m.map&&(m=m.map.__data__,typeof m=="string")){m=m.length;break t}m=void 0}if(m===void 0)break;if(h+=m,4096<h){h=f;break e}if(h===4096||f===this.i.length-1){h=f+1;break e}}h=1e3}else h=1e3;h=Gm(this,A,h),f=tn(this.I),me(f,"RID",l),me(f,"CVER",22),this.D&&me(f,"X-HTTP-Session-Id",this.D),xs(this,f),P&&(this.O?h="headers="+encodeURIComponent(String(Dm(P)))+"&"+h:this.m&&bu(f,this.m,P)),Cu(this.h,A),this.Ua&&me(f,"TYPE","init"),this.P?(me(f,"$req",h),me(f,"SID","null"),A.T=!0,Tu(A,f,null)):Tu(A,f,h),this.G=2}}else this.G==3&&(l?qm(this,l):this.i.length==0||Em(this.h)||qm(this))};function qm(l,h){var f;h?f=h.l:f=l.U++;let m=tn(l.I);me(m,"SID",l.K),me(m,"RID",f),me(m,"AID",l.T),xs(l,m),l.m&&l.o&&bu(m,l.m,l.o),f=new wn(l,l.j,f,l.B+1),l.m===null&&(f.H=l.o),h&&(l.i=h.D.concat(l.i)),h=Gm(l,f,1e3),f.I=Math.round(.5*l.wa)+Math.round(.5*l.wa*Math.random()),Cu(l.h,f),Tu(f,m,h)}function xs(l,h){l.H&&H(l.H,function(f,m){me(h,m,f)}),l.l&&Sm({},function(f,m){me(h,m,f)})}function Gm(l,h,f){f=Math.min(l.i.length,f);var m=l.l?g(l.l.Na,l.l,l):null;e:{var A=l.i;let P=-1;for(;;){let M=["count="+f];P==-1?0<f?(P=A[0].g,M.push("ofs="+P)):P=0:M.push("ofs="+P);let he=!0;for(let Ke=0;Ke<f;Ke++){let ae=A[Ke].g,He=A[Ke].map;if(ae-=P,0>ae)P=Math.max(0,A[Ke].g-100),he=!1;else try{pA(He,M,"req"+ae+"_")}catch{m&&m(He)}}if(he){m=M.join("&");break e}}}return l=l.i.splice(0,f),h.D=l,m}function jm(l){if(!l.g&&!l.u){l.Y=1;var h=l.Fa;fs||Xg(),ps||(fs(),ps=!0),au.add(h,l),l.v=0}}function Pu(l){return l.g||l.u||3<=l.v?!1:(l.Y++,l.u=ws(g(l.Fa,l),Wm(l,l.v)),l.v++,!0)}n.Fa=function(){if(this.u=null,zm(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var l=2*this.R;this.j.info("BP detection timer enabled: "+l),this.A=ws(g(this.ab,this),l)}},n.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,tt(10),Ca(this),zm(this))};function xu(l){l.A!=null&&(a.clearTimeout(l.A),l.A=null)}function zm(l){l.g=new wn(l,l.j,"rpc",l.Y),l.m===null&&(l.g.H=l.o),l.g.O=0;var h=tn(l.qa);me(h,"RID","rpc"),me(h,"SID",l.K),me(h,"AID",l.T),me(h,"CI",l.F?"0":"1"),!l.F&&l.ja&&me(h,"TO",l.ja),me(h,"TYPE","xmlhttp"),xs(l,h),l.m&&l.o&&bu(h,l.m,l.o),l.L&&(l.g.I=l.L);var f=l.g;l=l.ia,f.L=1,f.v=Ia(tn(h)),f.m=null,f.P=!0,_m(f,l)}n.Za=function(){this.C!=null&&(this.C=null,Ca(this),Pu(this),tt(19))};function Ra(l){l.C!=null&&(a.clearTimeout(l.C),l.C=null)}function Km(l,h){var f=null;if(l.g==h){Ra(l),xu(l),l.g=null;var m=2}else if(Su(l.h,h))f=h.D,Im(l.h,h),m=1;else return;if(l.G!=0){if(h.o)if(m==1){f=h.m?h.m.length:0,h=Date.now()-h.F;var A=l.B;m=_a(),et(m,new fm(m,f)),ba(l)}else jm(l);else if(A=h.s,A==3||A==0&&0<h.X||!(m==1&&yA(l,h)||m==2&&Pu(l)))switch(f&&0<f.length&&(h=l.h,h.i=h.i.concat(f)),A){case 1:dr(l,5);break;case 4:dr(l,10);break;case 3:dr(l,6);break;default:dr(l,2)}}}function Wm(l,h){let f=l.Ta+Math.floor(Math.random()*l.cb);return l.isActive()||(f*=2),f*h}function dr(l,h){if(l.j.info("Error code "+h),h==2){var f=g(l.fb,l),m=l.Xa;let A=!m;m=new hr(m||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||Ea(m,"https"),Ia(m),A?hA(m.toString(),f):dA(m.toString(),f)}else tt(2);l.G=0,l.l&&l.l.sa(h),$m(l),Bm(l)}n.fb=function(l){l?(this.j.info("Successfully pinged google.com"),tt(2)):(this.j.info("Failed to ping google.com"),tt(1))};function $m(l){if(l.G=0,l.ka=[],l.l){let h=Am(l.h);(h.length!=0||l.i.length!=0)&&(N(l.ka,h),N(l.ka,l.i),l.h.i.length=0,k(l.i),l.i.length=0),l.l.ra()}}function Qm(l,h,f){var m=f instanceof hr?tn(f):new hr(f);if(m.g!="")h&&(m.g=h+"."+m.g),Ta(m,m.s);else{var A=a.location;m=A.protocol,h=h?h+"."+A.hostname:A.hostname,A=+A.port;var P=new hr(null);m&&Ea(P,m),h&&(P.g=h),A&&Ta(P,A),f&&(P.l=f),m=P}return f=l.D,h=l.ya,f&&h&&me(m,f,h),me(m,"VER",l.la),xs(l,m),m}function Hm(l,h,f){if(h&&!l.J)throw Error("Can't create secondary domain capable XhrIo object.");return h=l.Ca&&!l.pa?new Te(new Cs({eb:f})):new Te(l.pa),h.Ha(l.J),h}n.isActive=function(){return!!this.l&&this.l.isActive(this)};function Ym(){}n=Ym.prototype,n.ua=function(){},n.ta=function(){},n.sa=function(){},n.ra=function(){},n.isActive=function(){return!0},n.Na=function(){};function Pa(){}Pa.prototype.g=function(l,h){return new ut(l,h)};function ut(l,h){Qe.call(this),this.g=new Um(h),this.l=l,this.h=h&&h.messageUrlParams||null,l=h&&h.messageHeaders||null,h&&h.clientProtocolHeaderRequired&&(l?l["X-Client-Protocol"]="webchannel":l={"X-Client-Protocol":"webchannel"}),this.g.o=l,l=h&&h.initMessageHeaders||null,h&&h.messageContentType&&(l?l["X-WebChannel-Content-Type"]=h.messageContentType:l={"X-WebChannel-Content-Type":h.messageContentType}),h&&h.va&&(l?l["X-WebChannel-Client-Profile"]=h.va:l={"X-WebChannel-Client-Profile":h.va}),this.g.S=l,(l=h&&h.Sb)&&!G(l)&&(this.g.m=l),this.v=h&&h.supportsCrossDomainXhr||!1,this.u=h&&h.sendRawJson||!1,(h=h&&h.httpSessionIdParam)&&!G(h)&&(this.g.D=h,l=this.h,l!==null&&h in l&&(l=this.h,h in l&&delete l[h])),this.j=new ei(this)}S(ut,Qe),ut.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},ut.prototype.close=function(){Ru(this.g)},ut.prototype.o=function(l){var h=this.g;if(typeof l=="string"){var f={};f.__data__=l,l=f}else this.u&&(f={},f.__data__=mu(l),l=f);h.i.push(new tA(h.Ya++,l)),h.G==3&&ba(h)},ut.prototype.N=function(){this.g.l=null,delete this.j,Ru(this.g),delete this.g,ut.aa.N.call(this)};function Jm(l){yu.call(this),l.__headers__&&(this.headers=l.__headers__,this.statusCode=l.__status__,delete l.__headers__,delete l.__status__);var h=l.__sm__;if(h){e:{for(let f in h){l=f;break e}l=void 0}(this.i=l)&&(l=this.i,h=h!==null&&l in h?h[l]:void 0),this.data=h}else this.data=l}S(Jm,yu);function Xm(){vu.call(this),this.status=1}S(Xm,vu);function ei(l){this.g=l}S(ei,Ym),ei.prototype.ua=function(){et(this.g,"a")},ei.prototype.ta=function(l){et(this.g,new Jm(l))},ei.prototype.sa=function(l){et(this.g,new Xm)},ei.prototype.ra=function(){et(this.g,"b")},Pa.prototype.createWebChannel=Pa.prototype.g,ut.prototype.send=ut.prototype.o,ut.prototype.open=ut.prototype.m,ut.prototype.close=ut.prototype.close,rh=an.createWebChannelTransport=function(){return new Pa},nh=an.getStatEventTarget=function(){return _a()},th=an.Event=cr,$a=an.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},ya.NO_ERROR=0,ya.TIMEOUT=8,ya.HTTP_ERROR=6,Ws=an.ErrorCode=ya,pm.COMPLETE="complete",eh=an.EventType=pm,cm.EventType=ys,ys.OPEN="a",ys.CLOSE="b",ys.ERROR="c",ys.MESSAGE="d",Qe.prototype.listen=Qe.prototype.K,li=an.WebChannel=cm,Zu=an.FetchXmlHttpFactory=Cs,Te.prototype.listenOnce=Te.prototype.L,Te.prototype.getLastError=Te.prototype.Ka,Te.prototype.getLastErrorCode=Te.prototype.Ba,Te.prototype.getStatus=Te.prototype.Z,Te.prototype.getResponseJson=Te.prototype.Oa,Te.prototype.getResponseText=Te.prototype.oa,Te.prototype.send=Te.prototype.ea,Te.prototype.setWithCredentials=Te.prototype.Ha,Xu=an.XhrIo=Te}).apply(typeof Wa<"u"?Wa:typeof self<"u"?self:typeof window<"u"?window:{});var L_="@firebase/firestore";var Ve=class{constructor(e){this.uid=e}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}};Ve.UNAUTHENTICATED=new Ve(null),Ve.GOOGLE_CREDENTIALS=new Ve("google-credentials-uid"),Ve.FIRST_PARTY=new Ve("first-party-uid"),Ve.MOCK_USER=new Ve("mock-user");var Ui="10.12.5";var qn=new xn("@firebase/firestore");function fi(){return qn.logLevel}function Uy(n){qn.setLogLevel(n)}function V(n,...e){if(qn.logLevel<=vt.DEBUG){let t=e.map(cf);qn.debug(`Firestore (${Ui}): ${n}`,...t)}}function be(n,...e){if(qn.logLevel<=vt.ERROR){let t=e.map(cf);qn.error(`Firestore (${Ui}): ${n}`,...t)}}function Et(n,...e){if(qn.logLevel<=vt.WARN){let t=e.map(cf);qn.warn(`Firestore (${Ui}): ${n}`,...t)}}function cf(n){if(typeof n=="string")return n;try{return function(t){return JSON.stringify(t)}(n)}catch{return n}}function B(n="Unexpected state"){let e=`FIRESTORE (${Ui}) INTERNAL ASSERTION FAILED: `+n;throw be(e),new Error(e)}function j(n,e){n||B()}function By(n,e){n||B()}function L(n,e){return n}var R={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},D=class extends d_{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var Oe=class{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}};var il=class{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}},lh=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(Ve.UNAUTHENTICATED))}shutdown(){}},ch=class{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}},uh=class{constructor(e){this.t=e,this.currentUser=Ve.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let r=this.i,i=c=>this.i!==r?(r=this.i,t(c)):Promise.resolve(),s=new Oe;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Oe,e.enqueueRetryable(()=>i(this.currentUser))};let o=()=>{let c=s;e.enqueueRetryable(()=>x(this,null,function*(){yield c.promise,yield i(this.currentUser)}))},a=c=>{V("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=c,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(c=>a(c)),setTimeout(()=>{if(!this.auth){let c=this.t.getImmediate({optional:!0});c?a(c):(V("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Oe)}},0),o()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(r=>this.i!==e?(V("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):r?(j(typeof r.accessToken=="string"),new il(r.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){let e=this.auth&&this.auth.getUid();return j(e===null||typeof e=="string"),new Ve(e)}},hh=class{constructor(e,t,r){this.l=e,this.h=t,this.P=r,this.type="FirstParty",this.user=Ve.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},dh=class{constructor(e,t,r){this.l=e,this.h=t,this.P=r}getToken(){return Promise.resolve(new hh(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(Ve.FIRST_PARTY))}shutdown(){}invalidateToken(){}},fh=class{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},ph=class{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){let r=s=>{s.error!=null&&V("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);let o=s.token!==this.R;return this.R=s.token,V("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?t(s.token):Promise.resolve()};this.o=s=>{e.enqueueRetryable(()=>r(s))};let i=s=>{V("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){let s=this.A.getImmediate({optional:!0});s?i(s):V("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(t=>t?(j(typeof t.token=="string"),this.R=t.token,new fh(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}};function sS(n){let e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(n);if(e&&typeof e.getRandomValues=="function")e.getRandomValues(t);else for(let r=0;r<n;r++)t[r]=Math.floor(256*Math.random());return t}var sl=class{static newId(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length,r="";for(;r.length<20;){let i=sS(40);for(let s=0;s<i.length;++s)r.length<20&&i[s]<t&&(r+=e.charAt(i[s]%e.length))}return r}};function Y(n,e){return n<e?-1:n>e?1:0}function Ti(n,e,t){return n.length===e.length&&n.every((r,i)=>t(r,e[i]))}function qy(n){return n+"\0"}var we=class n{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new D(R.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new D(R.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new D(R.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new D(R.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return n.fromMillis(Date.now())}static fromDate(e){return n.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),r=Math.floor(1e6*(e-1e3*t));return new n(t,r)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Y(this.nanoseconds,e.nanoseconds):Y(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var z=class n{constructor(e){this.timestamp=e}static fromTimestamp(e){return new n(e)}static min(){return new n(new we(0,0))}static max(){return new n(new we(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var ol=class n{constructor(e,t,r){t===void 0?t=0:t>e.length&&B(),r===void 0?r=e.length-t:r>e.length-t&&B(),this.segments=e,this.offset=t,this.len=r}get length(){return this.len}isEqual(e){return n.comparator(this,e)===0}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof n?e.forEach(r=>{t.push(r)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=e===void 0?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return this.length===0}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,r=this.limit();t<r;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let r=Math.min(e.length,t.length);for(let i=0;i<r;i++){let s=e.get(i),o=t.get(i);if(s<o)return-1;if(s>o)return 1}return e.length<t.length?-1:e.length>t.length?1:0}},se=class n extends ol{construct(e,t,r){return new n(e,t,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let r of e){if(r.indexOf("//")>=0)throw new D(R.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);t.push(...r.split("/").filter(i=>i.length>0))}return new n(t)}static emptyPath(){return new n([])}},oS=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Re=class n extends ol{construct(e,t,r){return new n(e,t,r)}static isValidIdentifier(e){return oS.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),n.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new n(["__name__"])}static fromServerFormat(e){let t=[],r="",i=0,s=()=>{if(r.length===0)throw new D(R.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(r),r=""},o=!1;for(;i<e.length;){let a=e[i];if(a==="\\"){if(i+1===e.length)throw new D(R.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let c=e[i+1];if(c!=="\\"&&c!=="."&&c!=="`")throw new D(R.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=c,i+=2}else a==="`"?(o=!o,i++):a!=="."||o?(r+=a,i++):(s(),i++)}if(s(),o)throw new D(R.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new n(t)}static emptyPath(){return new n([])}};var U=class n{constructor(e){this.path=e}static fromPath(e){return new n(se.fromString(e))}static fromName(e){return new n(se.fromString(e).popFirst(5))}static empty(){return new n(se.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return e!==null&&se.comparator(this.path,e.path)===0}toString(){return this.path.toString()}static comparator(e,t){return se.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new n(new se(e.slice()))}};var Ii=class{constructor(e,t,r,i){this.indexId=e,this.collectionGroup=t,this.fields=r,this.indexState=i}};function gh(n){return n.fields.find(e=>e.kind===2)}function yr(n){return n.fields.filter(e=>e.kind!==2)}Ii.UNKNOWN_ID=-1;var vi=class{constructor(e,t){this.fieldPath=e,this.kind=t}};var io=class n{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new n(0,Tt.min())}};function Gy(n,e){let t=n.toTimestamp().seconds,r=n.toTimestamp().nanoseconds+1,i=z.fromTimestamp(r===1e9?new we(t+1,0):new we(t,r));return new Tt(i,U.empty(),e)}function jy(n){return new Tt(n.readTime,n.key,-1)}var Tt=class n{constructor(e,t,r){this.readTime=e,this.documentKey=t,this.largestBatchId=r}static min(){return new n(z.min(),U.empty(),-1)}static max(){return new n(z.max(),U.empty(),-1)}};function uf(n,e){let t=n.readTime.compareTo(e.readTime);return t!==0?t:(t=U.comparator(n.documentKey,e.documentKey),t!==0?t:Y(n.largestBatchId,e.largestBatchId))}var zy="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",al=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}};function Jn(n){return x(this,null,function*(){if(n.code!==R.FAILED_PRECONDITION||n.message!==zy)throw n;V("LocalStore","Unexpectedly lost primary lease")})}var b=class n{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&B(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new n((r,i)=>{this.nextCallback=s=>{this.wrapSuccess(e,s).next(r,i)},this.catchCallback=s=>{this.wrapFailure(t,s).next(r,i)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof n?t:n.resolve(t)}catch(t){return n.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):n.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):n.reject(t)}static resolve(e){return new n((t,r)=>{t(e)})}static reject(e){return new n((t,r)=>{r(e)})}static waitFor(e){return new n((t,r)=>{let i=0,s=0,o=!1;e.forEach(a=>{++i,a.next(()=>{++s,o&&s===i&&t()},c=>r(c))}),o=!0,s===i&&t()})}static or(e){let t=n.resolve(!1);for(let r of e)t=t.next(i=>i?n.resolve(i):r());return t}static forEach(e,t){let r=[];return e.forEach((i,s)=>{r.push(t.call(this,i,s))}),this.waitFor(r)}static mapArray(e,t){return new n((r,i)=>{let s=e.length,o=new Array(s),a=0;for(let c=0;c<s;c++){let u=c;t(e[u]).next(d=>{o[u]=d,++a,a===s&&r(o)},d=>i(d))}})}static doWhile(e,t){return new n((r,i)=>{let s=()=>{e()===!0?t().next(()=>{s()},i):r()};s()})}};var ll=class n{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new Oe,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new Ar(e,t.error)):this.V.resolve()},this.transaction.onerror=r=>{let i=hf(r.target.error);this.V.reject(new Ar(e,i))}}static open(e,t,r,i){try{return new n(t,e.transaction(i,r))}catch(s){throw new Ar(t,s)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(V("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let e=this.transaction;this.aborted||typeof e.commit!="function"||e.commit()}store(e){let t=this.transaction.objectStore(e);return new _h(t)}},Gn=class n{constructor(e,t,r){this.name=e,this.version=t,this.p=r,n.S(Vs())===12.2&&be("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return V("SimpleDb","Removing database:",e),vr(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!Ma())return!1;if(n.C())return!0;let e=Vs(),t=n.S(e),r=0<t&&t<10,i=Ky(e),s=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||s)}static C(){var e;return typeof process<"u"&&((e=process.__PRIVATE_env)===null||e===void 0?void 0:e.v)==="YES"}static F(e,t){return e.store(t)}static S(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),r=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(r)}M(e){return x(this,null,function*(){return this.db||(V("SimpleDb","Opening database:",this.name),this.db=yield new Promise((t,r)=>{let i=indexedDB.open(this.name,this.version);i.onsuccess=s=>{let o=s.target.result;t(o)},i.onblocked=()=>{r(new Ar(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=s=>{let o=s.target.error;o.name==="VersionError"?r(new D(R.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o.name==="InvalidStateError"?r(new D(R.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+o)):r(new Ar(e,o))},i.onupgradeneeded=s=>{V("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',s.oldVersion);let o=s.target.result;this.p.O(o,i.transaction,s.oldVersion,this.version).next(()=>{V("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=t=>this.N(t)),this.db})}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}runTransaction(e,t,r,i){return x(this,null,function*(){let s=t==="readonly",o=0;for(;;){++o;try{this.db=yield this.M(e);let a=ll.open(this.db,e,s?"readonly":"readwrite",r),c=i(a).next(u=>(a.g(),u)).catch(u=>(a.abort(u),b.reject(u))).toPromise();return c.catch(()=>{}),yield a.m,c}catch(a){let c=a,u=c.name!=="FirebaseError"&&o<3;if(V("SimpleDb","Transaction failed with error:",c.message,"Retrying:",u),this.close(),!u)return Promise.reject(c)}}})}close(){this.db&&this.db.close(),this.db=void 0}};function Ky(n){let e=n.match(/Android ([\d.]+)/i),t=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(t)}var mh=class{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return vr(this.B.delete())}},Ar=class extends D{constructor(e,t){super(R.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}};function Xn(n){return n.name==="IndexedDbTransactionError"}var _h=class{constructor(e){this.store=e}put(e,t){let r;return t!==void 0?(V("SimpleDb","PUT",this.store.name,e,t),r=this.store.put(t,e)):(V("SimpleDb","PUT",this.store.name,"<auto-key>",e),r=this.store.put(e)),vr(r)}add(e){return V("SimpleDb","ADD",this.store.name,e,e),vr(this.store.add(e))}get(e){return vr(this.store.get(e)).next(t=>(t===void 0&&(t=null),V("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return V("SimpleDb","DELETE",this.store.name,e),vr(this.store.delete(e))}count(){return V("SimpleDb","COUNT",this.store.name),vr(this.store.count())}U(e,t){let r=this.options(e,t),i=r.index?this.store.index(r.index):this.store;if(typeof i.getAll=="function"){let s=i.getAll(r.range);return new b((o,a)=>{s.onerror=c=>{a(c.target.error)},s.onsuccess=c=>{o(c.target.result)}})}{let s=this.cursor(r),o=[];return this.W(s,(a,c)=>{o.push(c)}).next(()=>o)}}G(e,t){let r=this.store.getAll(e,t===null?void 0:t);return new b((i,s)=>{r.onerror=o=>{s(o.target.error)},r.onsuccess=o=>{i(o.target.result)}})}j(e,t){V("SimpleDb","DELETE ALL",this.store.name);let r=this.options(e,t);r.H=!1;let i=this.cursor(r);return this.W(i,(s,o,a)=>a.delete())}J(e,t){let r;t?r=e:(r={},t=e);let i=this.cursor(r);return this.W(i,t)}Y(e){let t=this.cursor({});return new b((r,i)=>{t.onerror=s=>{let o=hf(s.target.error);i(o)},t.onsuccess=s=>{let o=s.target.result;o?e(o.primaryKey,o.value).next(a=>{a?o.continue():r()}):r()}})}W(e,t){let r=[];return new b((i,s)=>{e.onerror=o=>{s(o.target.error)},e.onsuccess=o=>{let a=o.target.result;if(!a)return void i();let c=new mh(a),u=t(a.primaryKey,a.value,c);if(u instanceof b){let d=u.catch(p=>(c.done(),b.reject(p)));r.push(d)}c.isDone?i():c.K===null?a.continue():a.continue(c.K)}}).next(()=>b.waitFor(r))}options(e,t){let r;return e!==void 0&&(typeof e=="string"?r=e:t=e),{index:r,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let r=this.store.index(e.index);return e.H?r.openKeyCursor(e.range,t):r.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}};function vr(n){return new b((e,t)=>{n.onsuccess=r=>{let i=r.target.result;e(i)},n.onerror=r=>{let i=hf(r.target.error);t(i)}})}var U_=!1;function hf(n){let e=Gn.S(Vs());if(e>=12.2&&e<13){let t="An internal error was encountered in the Indexed Database server";if(n.message.indexOf(t)>=0){let r=new D("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return U_||(U_=!0,setTimeout(()=>{throw r},0)),r}}return n}var yh=class{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return this.task!==null}X(e){V("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,()=>x(this,null,function*(){this.task=null;try{V("IndexBackfiller",`Documents written: ${yield this.Z.ee()}`)}catch(t){Xn(t)?V("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",t):yield Jn(t)}yield this.X(6e4)}))}},vh=class{constructor(e,t){this.localStore=e,this.persistence=t}ee(e=50){return x(this,null,function*(){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.te(t,e))})}te(e,t){let r=new Set,i=t,s=!0;return b.doWhile(()=>s===!0&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(o=>{if(o!==null&&!r.has(o))return V("IndexBackfiller",`Processing collection: ${o}`),this.ne(e,o,i).next(a=>{i-=a,r.add(o)});s=!1})).next(()=>t-i)}ne(e,t,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(i=>this.localStore.localDocuments.getNextDocuments(e,t,i,r).next(s=>{let o=s.changes;return this.localStore.indexManager.updateIndexEntries(e,o).next(()=>this.re(i,s)).next(a=>(V("IndexBackfiller",`Updating offset: ${a}`),this.localStore.indexManager.updateCollectionGroup(e,t,a))).next(()=>o.size)}))}re(e,t){let r=e;return t.changes.forEach((i,s)=>{let o=jy(s);uf(o,r)>0&&(r=o)}),new Tt(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}};var dt=(()=>{class n{constructor(t,r){this.previousValue=t,r&&(r.sequenceNumberHandler=i=>this.ie(i),this.se=i=>r.writeSequenceNumber(i))}ie(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){let t=++this.previousValue;return this.se&&this.se(t),t}}return n.oe=-1,n})();function bo(n){return n==null}function so(n){return n===0&&1/n==-1/0}function Wy(n){return typeof n=="number"&&Number.isInteger(n)&&!so(n)&&n<=Number.MAX_SAFE_INTEGER&&n>=Number.MIN_SAFE_INTEGER}function nt(n){let e="";for(let t=0;t<n.length;t++)e.length>0&&(e=B_(e)),e=aS(n.get(t),e);return B_(e)}function aS(n,e){let t=e,r=n.length;for(let i=0;i<r;i++){let s=n.charAt(i);switch(s){case"\0":t+="";break;case"":t+="";break;default:t+=s}}return t}function B_(n){return n+""}function Ut(n){let e=n.length;if(j(e>=2),e===2)return j(n.charAt(0)===""&&n.charAt(1)===""),se.emptyPath();let t=e-2,r=[],i="";for(let s=0;s<e;){let o=n.indexOf("",s);switch((o<0||o>t)&&B(),n.charAt(o+1)){case"":let a=n.substring(s,o),c;i.length===0?c=a:(i+=a,c=i,i=""),r.push(c);break;case"":i+=n.substring(s,o),i+="\0";break;case"":i+=n.substring(s,o+1);break;default:B()}s=o+2}return new se(r)}var q_=["userId","batchId"];function Xa(n,e){return[n,nt(e)]}function $y(n,e,t){return[n,nt(e),t]}var lS={},cS=["prefixPath","collectionGroup","readTime","documentId"],uS=["prefixPath","collectionGroup","documentId"],hS=["collectionGroup","readTime","prefixPath","documentId"],dS=["canonicalId","targetId"],fS=["targetId","path"],pS=["path","targetId"],gS=["collectionId","parent"],mS=["indexId","uid"],_S=["uid","sequenceNumber"],yS=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],vS=["indexId","uid","orderedDocumentKey"],wS=["userId","collectionPath","documentId"],ES=["userId","collectionPath","largestBatchId"],TS=["userId","collectionGroup","largestBatchId"],Qy=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],IS=[...Qy,"documentOverlays"],Hy=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Yy=Hy,df=[...Yy,"indexConfiguration","indexState","indexEntries"],AS=df,SS=[...df,"globals"];var oo=class extends al{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}};function Ue(n,e){let t=L(n);return Gn.F(t._e,e)}function G_(n){let e=0;for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e++;return e}function Fr(n,e){for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e(t,n[t])}function Jy(n){for(let e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}var _e=class n{constructor(e,t){this.comparator=e,this.root=t||qt.EMPTY}insert(e,t){return new n(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,qt.BLACK,null,null))}remove(e){return new n(this.comparator,this.root.remove(e,this.comparator).copy(null,null,qt.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let r=this.comparator(e,t.key);if(r===0)return t.value;r<0?t=t.left:r>0&&(t=t.right)}return null}indexOf(e){let t=0,r=this.root;for(;!r.isEmpty();){let i=this.comparator(e,r.key);if(i===0)return t+r.left.size;i<0?r=r.left:(t+=r.left.size+1,r=r.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,r)=>(e(t,r),!1))}toString(){let e=[];return this.inorderTraversal((t,r)=>(e.push(`${t}:${r}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new yi(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new yi(this.root,e,this.comparator,!1)}getReverseIterator(){return new yi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new yi(this.root,e,this.comparator,!0)}},yi=class{constructor(e,t,r,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?r(e.key,t):1,t&&i&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(s===0){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}},qt=class n{constructor(e,t,r,i,s){this.key=e,this.value=t,this.color=r??n.RED,this.left=i??n.EMPTY,this.right=s??n.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,r,i,s){return new n(e??this.key,t??this.value,r??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,r){let i=this,s=r(e,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(e,t,r),null):s===0?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,r)),i.fixUp()}removeMin(){if(this.left.isEmpty())return n.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let r,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),t(e,i.key)===0){if(i.right.isEmpty())return n.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){let e=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){let e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw B();let e=this.left.check();if(e!==this.right.check())throw B();return e+(this.isRed()?0:1)}};qt.EMPTY=null,qt.RED=!0,qt.BLACK=!1;qt.EMPTY=new class{constructor(){this.size=0}get key(){throw B()}get value(){throw B()}get color(){throw B()}get left(){throw B()}get right(){throw B()}copy(e,t,r,i,s){return this}insert(e,t,r){return new qt(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var de=class n{constructor(e){this.comparator=e,this.data=new _e(this.comparator)}has(e){return this.data.get(e)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,r)=>(e(t),!1))}forEachInRange(e,t){let r=this.data.getIteratorFrom(e[0]);for(;r.hasNext();){let i=r.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let r;for(r=t!==void 0?this.data.getIteratorFrom(t):this.data.getIterator();r.hasNext();)if(!e(r.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new cl(this.data.getIterator())}getIteratorFrom(e){return new cl(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(r=>{t=t.add(r)}),t}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.data.getIterator(),r=e.data.getIterator();for(;t.hasNext();){let i=t.getNext().key,s=r.getNext().key;if(this.comparator(i,s)!==0)return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new n(this.comparator);return t.data=e,t}},cl=class{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function ci(n){return n.hasNext()?n.getNext():void 0}var ft=class n{constructor(e){this.fields=e,e.sort(Re.comparator)}static empty(){return new n([])}unionWith(e){let t=new de(Re.comparator);for(let r of this.fields)t=t.add(r);for(let r of e)t=t.add(r);return new n(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Ti(this.fields,e.fields,(t,r)=>t.isEqual(r))}};var ul=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};function Xy(){return typeof atob<"u"}var xe=class n{constructor(e){this.binaryString=e}static fromBase64String(e){let t=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new ul("Invalid base64 string: "+s):s}}(e);return new n(t)}static fromUint8Array(e){let t=function(i){let s="";for(let o=0;o<i.length;++o)s+=String.fromCharCode(i[o]);return s}(e);return new n(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(t){return btoa(t)}(this.binaryString)}toUint8Array(){return function(t){let r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Y(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}};xe.EMPTY_BYTE_STRING=new xe("");var CS=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function un(n){if(j(!!n),typeof n=="string"){let e=0,t=CS.exec(n);if(j(!!t),t[1]){let i=t[1];i=(i+"000000000").substr(0,9),e=Number(i)}let r=new Date(n);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:Ae(n.seconds),nanos:Ae(n.nanos)}}function Ae(n){return typeof n=="number"?n:typeof n=="string"?Number(n):0}function jn(n){return typeof n=="string"?xe.fromBase64String(n):xe.fromUint8Array(n)}function ec(n){var e,t;return((t=(((e=n?.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||t===void 0?void 0:t.stringValue)==="server_timestamp"}function ff(n){let e=n.mapValue.fields.__previous_value__;return ec(e)?ff(e):e}function ao(n){let e=un(n.mapValue.fields.__local_write_time__.timestampValue);return new we(e.seconds,e.nanos)}var wh=class{constructor(e,t,r,i,s,o,a,c,u){this.databaseId=e,this.appId=t,this.persistenceKey=r,this.host=i,this.ssl=s,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=c,this.useFetchStreams=u}},zn=class n{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new n("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(e){return e instanceof n&&e.projectId===this.projectId&&e.database===this.database}};var Un={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Za={nullValue:"NULL_VALUE"};function Sr(n){return"nullValue"in n?0:"booleanValue"in n?1:"integerValue"in n||"doubleValue"in n?2:"timestampValue"in n?3:"stringValue"in n?5:"bytesValue"in n?6:"referenceValue"in n?7:"geoPointValue"in n?8:"arrayValue"in n?9:"mapValue"in n?ec(n)?4:Zy(n)?9007199254740991:10:B()}function zt(n,e){if(n===e)return!0;let t=Sr(n);if(t!==Sr(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return n.booleanValue===e.booleanValue;case 4:return ao(n).isEqual(ao(e));case 3:return function(i,s){if(typeof i.timestampValue=="string"&&typeof s.timestampValue=="string"&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;let o=un(i.timestampValue),a=un(s.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(n,e);case 5:return n.stringValue===e.stringValue;case 6:return function(i,s){return jn(i.bytesValue).isEqual(jn(s.bytesValue))}(n,e);case 7:return n.referenceValue===e.referenceValue;case 8:return function(i,s){return Ae(i.geoPointValue.latitude)===Ae(s.geoPointValue.latitude)&&Ae(i.geoPointValue.longitude)===Ae(s.geoPointValue.longitude)}(n,e);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return Ae(i.integerValue)===Ae(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){let o=Ae(i.doubleValue),a=Ae(s.doubleValue);return o===a?so(o)===so(a):isNaN(o)&&isNaN(a)}return!1}(n,e);case 9:return Ti(n.arrayValue.values||[],e.arrayValue.values||[],zt);case 10:return function(i,s){let o=i.mapValue.fields||{},a=s.mapValue.fields||{};if(G_(o)!==G_(a))return!1;for(let c in o)if(o.hasOwnProperty(c)&&(a[c]===void 0||!zt(o[c],a[c])))return!1;return!0}(n,e);default:return B()}}function lo(n,e){return(n.values||[]).find(t=>zt(t,e))!==void 0}function Kn(n,e){if(n===e)return 0;let t=Sr(n),r=Sr(e);if(t!==r)return Y(t,r);switch(t){case 0:case 9007199254740991:return 0;case 1:return Y(n.booleanValue,e.booleanValue);case 2:return function(s,o){let a=Ae(s.integerValue||s.doubleValue),c=Ae(o.integerValue||o.doubleValue);return a<c?-1:a>c?1:a===c?0:isNaN(a)?isNaN(c)?0:-1:1}(n,e);case 3:return j_(n.timestampValue,e.timestampValue);case 4:return j_(ao(n),ao(e));case 5:return Y(n.stringValue,e.stringValue);case 6:return function(s,o){let a=jn(s),c=jn(o);return a.compareTo(c)}(n.bytesValue,e.bytesValue);case 7:return function(s,o){let a=s.split("/"),c=o.split("/");for(let u=0;u<a.length&&u<c.length;u++){let d=Y(a[u],c[u]);if(d!==0)return d}return Y(a.length,c.length)}(n.referenceValue,e.referenceValue);case 8:return function(s,o){let a=Y(Ae(s.latitude),Ae(o.latitude));return a!==0?a:Y(Ae(s.longitude),Ae(o.longitude))}(n.geoPointValue,e.geoPointValue);case 9:return function(s,o){let a=s.values||[],c=o.values||[];for(let u=0;u<a.length&&u<c.length;++u){let d=Kn(a[u],c[u]);if(d)return d}return Y(a.length,c.length)}(n.arrayValue,e.arrayValue);case 10:return function(s,o){if(s===Un.mapValue&&o===Un.mapValue)return 0;if(s===Un.mapValue)return 1;if(o===Un.mapValue)return-1;let a=s.fields||{},c=Object.keys(a),u=o.fields||{},d=Object.keys(u);c.sort(),d.sort();for(let p=0;p<c.length&&p<d.length;++p){let g=Y(c[p],d[p]);if(g!==0)return g;let y=Kn(a[c[p]],u[d[p]]);if(y!==0)return y}return Y(c.length,d.length)}(n.mapValue,e.mapValue);default:throw B()}}function j_(n,e){if(typeof n=="string"&&typeof e=="string"&&n.length===e.length)return Y(n,e);let t=un(n),r=un(e),i=Y(t.seconds,r.seconds);return i!==0?i:Y(t.nanos,r.nanos)}function Ai(n){return Eh(n)}function Eh(n){return"nullValue"in n?"null":"booleanValue"in n?""+n.booleanValue:"integerValue"in n?""+n.integerValue:"doubleValue"in n?""+n.doubleValue:"timestampValue"in n?function(t){let r=un(t);return`time(${r.seconds},${r.nanos})`}(n.timestampValue):"stringValue"in n?n.stringValue:"bytesValue"in n?function(t){return jn(t).toBase64()}(n.bytesValue):"referenceValue"in n?function(t){return U.fromName(t).toString()}(n.referenceValue):"geoPointValue"in n?function(t){return`geo(${t.latitude},${t.longitude})`}(n.geoPointValue):"arrayValue"in n?function(t){let r="[",i=!0;for(let s of t.values||[])i?i=!1:r+=",",r+=Eh(s);return r+"]"}(n.arrayValue):"mapValue"in n?function(t){let r=Object.keys(t.fields||{}).sort(),i="{",s=!0;for(let o of r)s?s=!1:i+=",",i+=`${o}:${Eh(t.fields[o])}`;return i+"}"}(n.mapValue):B()}function Cr(n,e){return{referenceValue:`projects/${n.projectId}/databases/${n.database}/documents/${e.path.canonicalString()}`}}function Th(n){return!!n&&"integerValue"in n}function co(n){return!!n&&"arrayValue"in n}function z_(n){return!!n&&"nullValue"in n}function K_(n){return!!n&&"doubleValue"in n&&isNaN(Number(n.doubleValue))}function el(n){return!!n&&"mapValue"in n}function Zs(n){if(n.geoPointValue)return{geoPointValue:Object.assign({},n.geoPointValue)};if(n.timestampValue&&typeof n.timestampValue=="object")return{timestampValue:Object.assign({},n.timestampValue)};if(n.mapValue){let e={mapValue:{fields:{}}};return Fr(n.mapValue.fields,(t,r)=>e.mapValue.fields[t]=Zs(r)),e}if(n.arrayValue){let e={arrayValue:{values:[]}};for(let t=0;t<(n.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=Zs(n.arrayValue.values[t]);return e}return Object.assign({},n)}function Zy(n){return(((n.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}function bS(n){return"nullValue"in n?Za:"booleanValue"in n?{booleanValue:!1}:"integerValue"in n||"doubleValue"in n?{doubleValue:NaN}:"timestampValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in n?{stringValue:""}:"bytesValue"in n?{bytesValue:""}:"referenceValue"in n?Cr(zn.empty(),U.empty()):"geoPointValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in n?{arrayValue:{}}:"mapValue"in n?{mapValue:{}}:B()}function RS(n){return"nullValue"in n?{booleanValue:!1}:"booleanValue"in n?{doubleValue:NaN}:"integerValue"in n||"doubleValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in n?{stringValue:""}:"stringValue"in n?{bytesValue:""}:"bytesValue"in n?Cr(zn.empty(),U.empty()):"referenceValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in n?{arrayValue:{}}:"arrayValue"in n?{mapValue:{}}:"mapValue"in n?Un:B()}function W_(n,e){let t=Kn(n.value,e.value);return t!==0?t:n.inclusive&&!e.inclusive?-1:!n.inclusive&&e.inclusive?1:0}function $_(n,e){let t=Kn(n.value,e.value);return t!==0?t:n.inclusive&&!e.inclusive?1:!n.inclusive&&e.inclusive?-1:0}var Xe=class n{constructor(e){this.value=e}static empty(){return new n({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let r=0;r<e.length-1;++r)if(t=(t.mapValue.fields||{})[e.get(r)],!el(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Zs(t)}setAll(e){let t=Re.emptyPath(),r={},i=[];e.forEach((o,a)=>{if(!t.isImmediateParentOf(a)){let c=this.getFieldsMap(t);this.applyChanges(c,r,i),r={},i=[],t=a.popLast()}o?r[a.lastSegment()]=Zs(o):i.push(a.lastSegment())});let s=this.getFieldsMap(t);this.applyChanges(s,r,i)}delete(e){let t=this.field(e.popLast());el(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return zt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let r=0;r<e.length;++r){let i=t.mapValue.fields[e.get(r)];el(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(r)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,r){Fr(t,(i,s)=>e[i]=s);for(let i of r)delete e[i]}clone(){return new n(Zs(this.value))}};function ev(n){let e=[];return Fr(n.fields,(t,r)=>{let i=new Re([t]);if(el(r)){let s=ev(r.mapValue).fields;if(s.length===0)e.push(i);else for(let o of s)e.push(i.child(o))}else e.push(i)}),new ft(e)}var Fe=class n{constructor(e,t,r,i,s,o,a){this.key=e,this.documentType=t,this.version=r,this.readTime=i,this.createTime=s,this.data=o,this.documentState=a}static newInvalidDocument(e){return new n(e,0,z.min(),z.min(),z.min(),Xe.empty(),0)}static newFoundDocument(e,t,r,i){return new n(e,1,t,z.min(),r,i,0)}static newNoDocument(e,t){return new n(e,2,t,z.min(),z.min(),Xe.empty(),0)}static newUnknownDocument(e,t){return new n(e,3,t,z.min(),z.min(),Xe.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(z.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Xe.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Xe.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=z.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(e){return e instanceof n&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new n(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var Kt=class{constructor(e,t){this.position=e,this.inclusive=t}};function Q_(n,e,t){let r=0;for(let i=0;i<n.position.length;i++){let s=e[i],o=n.position[i];if(s.field.isKeyField()?r=U.comparator(U.fromName(o.referenceValue),t.key):r=Kn(o,t.data.field(s.field)),s.dir==="desc"&&(r*=-1),r!==0)break}return r}function H_(n,e){if(n===null)return e===null;if(e===null||n.inclusive!==e.inclusive||n.position.length!==e.position.length)return!1;for(let t=0;t<n.position.length;t++)if(!zt(n.position[t],e.position[t]))return!1;return!0}var br=class{constructor(e,t="asc"){this.field=e,this.dir=t}};function PS(n,e){return n.dir===e.dir&&n.field.isEqual(e.field)}var hl=class{},re=class n extends hl{constructor(e,t,r){super(),this.field=e,this.op=t,this.value=r}static create(e,t,r){return e.isKeyField()?t==="in"||t==="not-in"?this.createKeyFieldInFilter(e,t,r):new Sh(e,t,r):t==="array-contains"?new Rh(e,r):t==="in"?new dl(e,r):t==="not-in"?new Ph(e,r):t==="array-contains-any"?new xh(e,r):new n(e,t,r)}static createKeyFieldInFilter(e,t,r){return t==="in"?new Ch(e,r):new bh(e,r)}matches(e){let t=e.data.field(this.field);return this.op==="!="?t!==null&&this.matchesComparison(Kn(t,this.value)):t!==null&&Sr(this.value)===Sr(t)&&this.matchesComparison(Kn(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return e===0;case"!=":return e!==0;case">":return e>0;case">=":return e>=0;default:return B()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},ue=class n extends hl{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new n(e,t)}matches(e){return Si(this)?this.filters.find(t=>!t.matches(e))===void 0:this.filters.find(t=>t.matches(e))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}};function Si(n){return n.op==="and"}function Ih(n){return n.op==="or"}function pf(n){return tv(n)&&Si(n)}function tv(n){for(let e of n.filters)if(e instanceof ue)return!1;return!0}function Ah(n){if(n instanceof re)return n.field.canonicalString()+n.op.toString()+Ai(n.value);if(pf(n))return n.filters.map(e=>Ah(e)).join(",");{let e=n.filters.map(t=>Ah(t)).join(",");return`${n.op}(${e})`}}function nv(n,e){return n instanceof re?function(r,i){return i instanceof re&&r.op===i.op&&r.field.isEqual(i.field)&&zt(r.value,i.value)}(n,e):n instanceof ue?function(r,i){return i instanceof ue&&r.op===i.op&&r.filters.length===i.filters.length?r.filters.reduce((s,o,a)=>s&&nv(o,i.filters[a]),!0):!1}(n,e):void B()}function rv(n,e){let t=n.filters.concat(e);return ue.create(t,n.op)}function iv(n){return n instanceof re?function(t){return`${t.field.canonicalString()} ${t.op} ${Ai(t.value)}`}(n):n instanceof ue?function(t){return t.op.toString()+" {"+t.getFilters().map(iv).join(" ,")+"}"}(n):"Filter"}var Sh=class extends re{constructor(e,t,r){super(e,t,r),this.key=U.fromName(r.referenceValue)}matches(e){let t=U.comparator(e.key,this.key);return this.matchesComparison(t)}},Ch=class extends re{constructor(e,t){super(e,"in",t),this.keys=sv("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}},bh=class extends re{constructor(e,t){super(e,"not-in",t),this.keys=sv("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}};function sv(n,e){var t;return(((t=e.arrayValue)===null||t===void 0?void 0:t.values)||[]).map(r=>U.fromName(r.referenceValue))}var Rh=class extends re{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return co(t)&&lo(t.arrayValue,this.value)}},dl=class extends re{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return t!==null&&lo(this.value.arrayValue,t)}},Ph=class extends re{constructor(e,t){super(e,"not-in",t)}matches(e){if(lo(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return t!==null&&!lo(this.value.arrayValue,t)}},xh=class extends re{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!co(t)||!t.arrayValue.values)&&t.arrayValue.values.some(r=>lo(this.value.arrayValue,r))}};var kh=class{constructor(e,t=null,r=[],i=[],s=null,o=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=r,this.filters=i,this.limit=s,this.startAt=o,this.endAt=a,this.ue=null}};function Nh(n,e=null,t=[],r=[],i=null,s=null,o=null){return new kh(n,e,t,r,i,s,o)}function Rr(n){let e=L(n);if(e.ue===null){let t=e.path.canonicalString();e.collectionGroup!==null&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(r=>Ah(r)).join(","),t+="|ob:",t+=e.orderBy.map(r=>function(s){return s.field.canonicalString()+s.dir}(r)).join(","),bo(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(r=>Ai(r)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(r=>Ai(r)).join(",")),e.ue=t}return e.ue}function Ro(n,e){if(n.limit!==e.limit||n.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<n.orderBy.length;t++)if(!PS(n.orderBy[t],e.orderBy[t]))return!1;if(n.filters.length!==e.filters.length)return!1;for(let t=0;t<n.filters.length;t++)if(!nv(n.filters[t],e.filters[t]))return!1;return n.collectionGroup===e.collectionGroup&&!!n.path.isEqual(e.path)&&!!H_(n.startAt,e.startAt)&&H_(n.endAt,e.endAt)}function fl(n){return U.isDocumentKey(n.path)&&n.collectionGroup===null&&n.filters.length===0}function pl(n,e){return n.filters.filter(t=>t instanceof re&&t.field.isEqual(e))}function Y_(n,e,t){let r=Za,i=!0;for(let s of pl(n,e)){let o=Za,a=!0;switch(s.op){case"<":case"<=":o=bS(s.value);break;case"==":case"in":case">=":o=s.value;break;case">":o=s.value,a=!1;break;case"!=":case"not-in":o=Za}W_({value:r,inclusive:i},{value:o,inclusive:a})<0&&(r=o,i=a)}if(t!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){let o=t.position[s];W_({value:r,inclusive:i},{value:o,inclusive:t.inclusive})<0&&(r=o,i=t.inclusive);break}}return{value:r,inclusive:i}}function J_(n,e,t){let r=Un,i=!0;for(let s of pl(n,e)){let o=Un,a=!0;switch(s.op){case">=":case">":o=RS(s.value),a=!1;break;case"==":case"in":case"<=":o=s.value;break;case"<":o=s.value,a=!1;break;case"!=":case"not-in":o=Un}$_({value:r,inclusive:i},{value:o,inclusive:a})>0&&(r=o,i=a)}if(t!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){let o=t.position[s];$_({value:r,inclusive:i},{value:o,inclusive:t.inclusive})>0&&(r=o,i=t.inclusive);break}}return{value:r,inclusive:i}}var xt=class{constructor(e,t=null,r=[],i=[],s=null,o="F",a=null,c=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=r,this.filters=i,this.limit=s,this.limitType=o,this.startAt=a,this.endAt=c,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}};function ov(n,e,t,r,i,s,o,a){return new xt(n,e,t,r,i,s,o,a)}function Bi(n){return new xt(n)}function X_(n){return n.filters.length===0&&n.limit===null&&n.startAt==null&&n.endAt==null&&(n.explicitOrderBy.length===0||n.explicitOrderBy.length===1&&n.explicitOrderBy[0].field.isKeyField())}function gf(n){return n.collectionGroup!==null}function wi(n){let e=L(n);if(e.ce===null){e.ce=[];let t=new Set;for(let s of e.explicitOrderBy)e.ce.push(s),t.add(s.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new de(Re.comparator);return o.filters.forEach(c=>{c.getFlattenedFilters().forEach(u=>{u.isInequality()&&(a=a.add(u.field))})}),a})(e).forEach(s=>{t.has(s.canonicalString())||s.isKeyField()||e.ce.push(new br(s,r))}),t.has(Re.keyField().canonicalString())||e.ce.push(new br(Re.keyField(),r))}return e.ce}function rt(n){let e=L(n);return e.le||(e.le=xS(e,wi(n))),e.le}function xS(n,e){if(n.limitType==="F")return Nh(n.path,n.collectionGroup,e,n.filters,n.limit,n.startAt,n.endAt);{e=e.map(i=>{let s=i.dir==="desc"?"asc":"desc";return new br(i.field,s)});let t=n.endAt?new Kt(n.endAt.position,n.endAt.inclusive):null,r=n.startAt?new Kt(n.startAt.position,n.startAt.inclusive):null;return Nh(n.path,n.collectionGroup,e,n.filters,n.limit,t,r)}}function Dh(n,e){let t=n.filters.concat([e]);return new xt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),t,n.limit,n.limitType,n.startAt,n.endAt)}function gl(n,e,t){return new xt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),n.filters.slice(),e,t,n.startAt,n.endAt)}function Po(n,e){return Ro(rt(n),rt(e))&&n.limitType===e.limitType}function av(n){return`${Rr(rt(n))}|lt:${n.limitType}`}function pi(n){return`Query(target=${function(t){let r=t.path.canonicalString();return t.collectionGroup!==null&&(r+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(r+=`, filters: [${t.filters.map(i=>iv(i)).join(", ")}]`),bo(t.limit)||(r+=", limit: "+t.limit),t.orderBy.length>0&&(r+=`, orderBy: [${t.orderBy.map(i=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(i)).join(", ")}]`),t.startAt&&(r+=", startAt: ",r+=t.startAt.inclusive?"b:":"a:",r+=t.startAt.position.map(i=>Ai(i)).join(",")),t.endAt&&(r+=", endAt: ",r+=t.endAt.inclusive?"a:":"b:",r+=t.endAt.position.map(i=>Ai(i)).join(",")),`Target(${r})`}(rt(n))}; limitType=${n.limitType})`}function xo(n,e){return e.isFoundDocument()&&function(r,i){let s=i.key.path;return r.collectionGroup!==null?i.key.hasCollectionId(r.collectionGroup)&&r.path.isPrefixOf(s):U.isDocumentKey(r.path)?r.path.isEqual(s):r.path.isImmediateParentOf(s)}(n,e)&&function(r,i){for(let s of wi(r))if(!s.field.isKeyField()&&i.data.field(s.field)===null)return!1;return!0}(n,e)&&function(r,i){for(let s of r.filters)if(!s.matches(i))return!1;return!0}(n,e)&&function(r,i){return!(r.startAt&&!function(o,a,c){let u=Q_(o,a,c);return o.inclusive?u<=0:u<0}(r.startAt,wi(r),i)||r.endAt&&!function(o,a,c){let u=Q_(o,a,c);return o.inclusive?u>=0:u>0}(r.endAt,wi(r),i))}(n,e)}function lv(n){return n.collectionGroup||(n.path.length%2==1?n.path.lastSegment():n.path.get(n.path.length-2))}function cv(n){return(e,t)=>{let r=!1;for(let i of wi(n)){let s=kS(i,e,t);if(s!==0)return s;r=r||i.field.isKeyField()}return 0}}function kS(n,e,t){let r=n.field.isKeyField()?U.comparator(e.key,t.key):function(s,o,a){let c=o.data.field(s),u=a.data.field(s);return c!==null&&u!==null?Kn(c,u):B()}(n.field,e,t);switch(n.dir){case"asc":return r;case"desc":return-1*r;default:return B()}}var Wt=class{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r!==void 0){for(let[i,s]of r)if(this.equalsFn(i,e))return s}}has(e){return this.get(e)!==void 0}set(e,t){let r=this.mapKeyFn(e),i=this.inner[r];if(i===void 0)return this.inner[r]=[[e,t]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],e))return void(i[s]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r===void 0)return!1;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return r.length===1?delete this.inner[t]:r.splice(i,1),this.innerSize--,!0;return!1}forEach(e){Fr(this.inner,(t,r)=>{for(let[i,s]of r)e(i,s)})}isEmpty(){return Jy(this.inner)}size(){return this.innerSize}};var NS=new _e(U.comparator);function ct(){return NS}var uv=new _e(U.comparator);function Js(...n){let e=uv;for(let t of n)e=e.insert(t.key,t);return e}function hv(n){let e=uv;return n.forEach((t,r)=>e=e.insert(t,r.overlayedDocument)),e}function Bt(){return eo()}function dv(){return eo()}function eo(){return new Wt(n=>n.toString(),(n,e)=>n.isEqual(e))}var DS=new _e(U.comparator),VS=new de(U.comparator);function X(...n){let e=VS;for(let t of n)e=e.add(t);return e}var OS=new de(Y);function mf(){return OS}function fv(n,e){if(n.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:so(e)?"-0":e}}function pv(n){return{integerValue:""+n}}function gv(n,e){return Wy(e)?pv(e):fv(n,e)}var Ci=class{constructor(){this._=void 0}};function FS(n,e,t){return n instanceof Wn?function(i,s){let o={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&ec(s)&&(s=ff(s)),s&&(o.fields.__previous_value__=s),{mapValue:o}}(t,e):n instanceof hn?_v(n,e):n instanceof dn?yv(n,e):function(i,s){let o=mv(i,s),a=Z_(o)+Z_(i.Pe);return Th(o)&&Th(i.Pe)?pv(a):fv(i.serializer,a)}(n,e)}function MS(n,e,t){return n instanceof hn?_v(n,e):n instanceof dn?yv(n,e):t}function mv(n,e){return n instanceof $n?function(r){return Th(r)||function(s){return!!s&&"doubleValue"in s}(r)}(e)?e:{integerValue:0}:null}var Wn=class extends Ci{},hn=class extends Ci{constructor(e){super(),this.elements=e}};function _v(n,e){let t=vv(e);for(let r of n.elements)t.some(i=>zt(i,r))||t.push(r);return{arrayValue:{values:t}}}var dn=class extends Ci{constructor(e){super(),this.elements=e}};function yv(n,e){let t=vv(e);for(let r of n.elements)t=t.filter(i=>!zt(i,r));return{arrayValue:{values:t}}}var $n=class extends Ci{constructor(e,t){super(),this.serializer=e,this.Pe=t}};function Z_(n){return Ae(n.integerValue||n.doubleValue)}function vv(n){return co(n)&&n.arrayValue.values?n.arrayValue.values.slice():[]}var Pr=class{constructor(e,t){this.field=e,this.transform=t}};function LS(n,e){return n.field.isEqual(e.field)&&function(r,i){return r instanceof hn&&i instanceof hn||r instanceof dn&&i instanceof dn?Ti(r.elements,i.elements,zt):r instanceof $n&&i instanceof $n?zt(r.Pe,i.Pe):r instanceof Wn&&i instanceof Wn}(n.transform,e.transform)}var Vh=class{constructor(e,t){this.version=e,this.transformResults=t}},Se=class n{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new n}static exists(e){return new n(void 0,e)}static updateTime(e){return new n(e)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}};function tl(n,e){return n.updateTime!==void 0?e.isFoundDocument()&&e.version.isEqual(n.updateTime):n.exists===void 0||n.exists===e.isFoundDocument()}var bi=class{};function wv(n,e){if(!n.hasLocalMutations||e&&e.fields.length===0)return null;if(e===null)return n.isNoDocument()?new Hn(n.key,Se.none()):new Qn(n.key,n.data,Se.none());{let t=n.data,r=Xe.empty(),i=new de(Re.comparator);for(let s of e.fields)if(!i.has(s)){let o=t.field(s);o===null&&s.length>1&&(s=s.popLast(),o=t.field(s)),o===null?r.delete(s):r.set(s,o),i=i.add(s)}return new kt(n.key,r,new ft(i.toArray()),Se.none())}}function US(n,e,t){n instanceof Qn?function(i,s,o){let a=i.value.clone(),c=ty(i.fieldTransforms,s,o.transformResults);a.setAll(c),s.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(n,e,t):n instanceof kt?function(i,s,o){if(!tl(i.precondition,s))return void s.convertToUnknownDocument(o.version);let a=ty(i.fieldTransforms,s,o.transformResults),c=s.data;c.setAll(Ev(i)),c.setAll(a),s.convertToFoundDocument(o.version,c).setHasCommittedMutations()}(n,e,t):function(i,s,o){s.convertToNoDocument(o.version).setHasCommittedMutations()}(0,e,t)}function to(n,e,t,r){return n instanceof Qn?function(s,o,a,c){if(!tl(s.precondition,o))return a;let u=s.value.clone(),d=ny(s.fieldTransforms,c,o);return u.setAll(d),o.convertToFoundDocument(o.version,u).setHasLocalMutations(),null}(n,e,t,r):n instanceof kt?function(s,o,a,c){if(!tl(s.precondition,o))return a;let u=ny(s.fieldTransforms,c,o),d=o.data;return d.setAll(Ev(s)),d.setAll(u),o.convertToFoundDocument(o.version,d).setHasLocalMutations(),a===null?null:a.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(p=>p.field))}(n,e,t,r):function(s,o,a){return tl(s.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(n,e,t)}function BS(n,e){let t=null;for(let r of n.fieldTransforms){let i=e.data.field(r.field),s=mv(r.transform,i||null);s!=null&&(t===null&&(t=Xe.empty()),t.set(r.field,s))}return t||null}function ey(n,e){return n.type===e.type&&!!n.key.isEqual(e.key)&&!!n.precondition.isEqual(e.precondition)&&!!function(r,i){return r===void 0&&i===void 0||!(!r||!i)&&Ti(r,i,(s,o)=>LS(s,o))}(n.fieldTransforms,e.fieldTransforms)&&(n.type===0?n.value.isEqual(e.value):n.type!==1||n.data.isEqual(e.data)&&n.fieldMask.isEqual(e.fieldMask))}var Qn=class extends bi{constructor(e,t,r,i=[]){super(),this.key=e,this.value=t,this.precondition=r,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}},kt=class extends bi{constructor(e,t,r,i,s=[]){super(),this.key=e,this.data=t,this.fieldMask=r,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}};function Ev(n){let e=new Map;return n.fieldMask.fields.forEach(t=>{if(!t.isEmpty()){let r=n.data.field(t);e.set(t,r)}}),e}function ty(n,e,t){let r=new Map;j(n.length===t.length);for(let i=0;i<t.length;i++){let s=n[i],o=s.transform,a=e.data.field(s.field);r.set(s.field,MS(o,a,t[i]))}return r}function ny(n,e,t){let r=new Map;for(let i of n){let s=i.transform,o=t.data.field(i.field);r.set(i.field,FS(s,o,e))}return r}var Hn=class extends bi{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},uo=class extends bi{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var ho=class{constructor(e,t,r,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=r,this.mutations=i}applyToRemoteDocument(e,t){let r=t.mutationResults;for(let i=0;i<this.mutations.length;i++){let s=this.mutations[i];s.key.isEqual(e.key)&&US(s,e,r[i])}}applyToLocalView(e,t){for(let r of this.baseMutations)r.key.isEqual(e.key)&&(t=to(r,e,t,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(e.key)&&(t=to(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let r=dv();return this.mutations.forEach(i=>{let s=e.get(i.key),o=s.overlayedDocument,a=this.applyToLocalView(o,s.mutatedFields);a=t.has(i.key)?null:a;let c=wv(o,a);c!==null&&r.set(i.key,c),o.isValidDocument()||o.convertToNoDocument(z.min())}),r}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),X())}isEqual(e){return this.batchId===e.batchId&&Ti(this.mutations,e.mutations,(t,r)=>ey(t,r))&&Ti(this.baseMutations,e.baseMutations,(t,r)=>ey(t,r))}},Oh=class n{constructor(e,t,r,i){this.batch=e,this.commitVersion=t,this.mutationResults=r,this.docVersions=i}static from(e,t,r){j(e.mutations.length===r.length);let i=function(){return DS}(),s=e.mutations;for(let o=0;o<s.length;o++)i=i.insert(s[o].key,r[o].version);return new n(e,t,r,i)}};var fo=class{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return e!==null&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var Fh=class{constructor(e,t){this.count=e,this.unchangedNames=t}};var Ne,ie;function Tv(n){switch(n){default:return B();case R.CANCELLED:case R.UNKNOWN:case R.DEADLINE_EXCEEDED:case R.RESOURCE_EXHAUSTED:case R.INTERNAL:case R.UNAVAILABLE:case R.UNAUTHENTICATED:return!1;case R.INVALID_ARGUMENT:case R.NOT_FOUND:case R.ALREADY_EXISTS:case R.PERMISSION_DENIED:case R.FAILED_PRECONDITION:case R.ABORTED:case R.OUT_OF_RANGE:case R.UNIMPLEMENTED:case R.DATA_LOSS:return!0}}function Iv(n){if(n===void 0)return be("GRPC error has no .code"),R.UNKNOWN;switch(n){case Ne.OK:return R.OK;case Ne.CANCELLED:return R.CANCELLED;case Ne.UNKNOWN:return R.UNKNOWN;case Ne.DEADLINE_EXCEEDED:return R.DEADLINE_EXCEEDED;case Ne.RESOURCE_EXHAUSTED:return R.RESOURCE_EXHAUSTED;case Ne.INTERNAL:return R.INTERNAL;case Ne.UNAVAILABLE:return R.UNAVAILABLE;case Ne.UNAUTHENTICATED:return R.UNAUTHENTICATED;case Ne.INVALID_ARGUMENT:return R.INVALID_ARGUMENT;case Ne.NOT_FOUND:return R.NOT_FOUND;case Ne.ALREADY_EXISTS:return R.ALREADY_EXISTS;case Ne.PERMISSION_DENIED:return R.PERMISSION_DENIED;case Ne.FAILED_PRECONDITION:return R.FAILED_PRECONDITION;case Ne.ABORTED:return R.ABORTED;case Ne.OUT_OF_RANGE:return R.OUT_OF_RANGE;case Ne.UNIMPLEMENTED:return R.UNIMPLEMENTED;case Ne.DATA_LOSS:return R.DATA_LOSS;default:return B()}}(ie=Ne||(Ne={}))[ie.OK=0]="OK",ie[ie.CANCELLED=1]="CANCELLED",ie[ie.UNKNOWN=2]="UNKNOWN",ie[ie.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",ie[ie.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",ie[ie.NOT_FOUND=5]="NOT_FOUND",ie[ie.ALREADY_EXISTS=6]="ALREADY_EXISTS",ie[ie.PERMISSION_DENIED=7]="PERMISSION_DENIED",ie[ie.UNAUTHENTICATED=16]="UNAUTHENTICATED",ie[ie.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",ie[ie.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",ie[ie.ABORTED=10]="ABORTED",ie[ie.OUT_OF_RANGE=11]="OUT_OF_RANGE",ie[ie.UNIMPLEMENTED=12]="UNIMPLEMENTED",ie[ie.INTERNAL=13]="INTERNAL",ie[ie.UNAVAILABLE=14]="UNAVAILABLE",ie[ie.DATA_LOSS=15]="DATA_LOSS";var ry=null;function Av(){return new TextEncoder}var qS=new Vn([4294967295,4294967295],0);function iy(n){let e=Av().encode(n),t=new Ju;return t.update(e),new Uint8Array(t.digest())}function sy(n){let e=new DataView(n.buffer),t=e.getUint32(0,!0),r=e.getUint32(4,!0),i=e.getUint32(8,!0),s=e.getUint32(12,!0);return[new Vn([t,r],0),new Vn([i,s],0)]}var Mh=class n{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new Ir(`Invalid padding: ${t}`);if(r<0)throw new Ir(`Invalid hash count: ${r}`);if(e.length>0&&this.hashCount===0)throw new Ir(`Invalid hash count: ${r}`);if(e.length===0&&t!==0)throw new Ir(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=Vn.fromNumber(this.Ie)}Ee(e,t,r){let i=e.add(t.multiply(Vn.fromNumber(r)));return i.compare(qS)===1&&(i=new Vn([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(e){return(this.bitmap[Math.floor(e/8)]&1<<e%8)!=0}mightContain(e){if(this.Ie===0)return!1;let t=iy(e),[r,i]=sy(t);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);if(!this.de(o))return!1}return!0}static create(e,t,r){let i=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),o=new n(s,i,t);return r.forEach(a=>o.insert(a)),o}insert(e){if(this.Ie===0)return;let t=iy(e),[r,i]=sy(t);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);this.Ae(o)}}Ae(e){let t=Math.floor(e/8),r=e%8;this.bitmap[t]|=1<<r}},Ir=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};var po=class n{constructor(e,t,r,i,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=r,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,r){let i=new Map;return i.set(e,go.createSynthesizedTargetChangeForCurrentChange(e,t,r)),new n(z.min(),i,new _e(Y),ct(),X())}},go=class n{constructor(e,t,r,i,s){this.resumeToken=e,this.current=t,this.addedDocuments=r,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,r){return new n(r,t,X(),X(),X())}};var Ei=class{constructor(e,t,r,i){this.Re=e,this.removedTargetIds=t,this.key=r,this.Ve=i}},ml=class{constructor(e,t){this.targetId=e,this.me=t}},_l=class{constructor(e,t,r=xe.EMPTY_BYTE_STRING,i=null){this.state=e,this.targetIds=t,this.resumeToken=r,this.cause=i}},yl=class{constructor(){this.fe=0,this.ge=ay(),this.pe=xe.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}Ce(){let e=X(),t=X(),r=X();return this.ge.forEach((i,s)=>{switch(s){case 0:e=e.add(i);break;case 2:t=t.add(i);break;case 1:r=r.add(i);break;default:B()}}),new go(this.pe,this.ye,e,t,r)}ve(){this.we=!1,this.ge=ay()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,j(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}},Lh=class{constructor(e){this.Le=e,this.Be=new Map,this.ke=ct(),this.qe=oy(),this.Qe=new _e(Y)}Ke(e){for(let t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(let t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,t=>{let r=this.Ge(t);switch(e.state){case 0:this.ze(t)&&r.De(e.resumeToken);break;case 1:r.Oe(),r.Se||r.ve(),r.De(e.resumeToken);break;case 2:r.Oe(),r.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(r.Ne(),r.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),r.De(e.resumeToken));break;default:B()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach((r,i)=>{this.ze(i)&&t(i)})}He(e){let t=e.targetId,r=e.me.count,i=this.Je(t);if(i){let s=i.target;if(fl(s))if(r===0){let o=new U(s.path);this.Ue(t,o,Fe.newNoDocument(o,z.min()))}else j(r===1);else{let o=this.Ye(t);if(o!==r){let a=this.Ze(e),c=a?this.Xe(a,e,o):1;if(c!==0){this.je(t);let u=c===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,u)}ry?.et(function(d,p,g,y,S){var k,N,q,G,F,K;let Q={localCacheCount:d,existenceFilterCount:p.count,databaseId:g.database,projectId:g.projectId},H=p.unchangedNames;return H&&(Q.bloomFilter={applied:S===0,hashCount:(k=H?.hashCount)!==null&&k!==void 0?k:0,bitmapLength:(G=(q=(N=H?.bits)===null||N===void 0?void 0:N.bitmap)===null||q===void 0?void 0:q.length)!==null&&G!==void 0?G:0,padding:(K=(F=H?.bits)===null||F===void 0?void 0:F.padding)!==null&&K!==void 0?K:0,mightContain:E=>{var _;return(_=y?.mightContain(E))!==null&&_!==void 0&&_}}),Q}(o,e.me,this.Le.tt(),a,c))}}}}Ze(e){let t=e.me.unchangedNames;if(!t||!t.bits)return null;let{bits:{bitmap:r="",padding:i=0},hashCount:s=0}=t,o,a;try{o=jn(r).toUint8Array()}catch(c){if(c instanceof ul)return Et("Decoding the base64 bloom filter in existence filter failed ("+c.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw c}try{a=new Mh(o,i,s)}catch(c){return Et(c instanceof Ir?"BloomFilter error: ":"Applying bloom filter failed: ",c),null}return a.Ie===0?null:a}Xe(e,t,r){return t.me.count===r-this.nt(e,t.targetId)?0:2}nt(e,t){let r=this.Le.getRemoteKeysForTarget(t),i=0;return r.forEach(s=>{let o=this.Le.tt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${s.path.canonicalString()}`;e.mightContain(a)||(this.Ue(t,s,null),i++)}),i}rt(e){let t=new Map;this.Be.forEach((s,o)=>{let a=this.Je(o);if(a){if(s.current&&fl(a.target)){let c=new U(a.target.path);this.ke.get(c)!==null||this.it(o,c)||this.Ue(o,c,Fe.newNoDocument(c,e))}s.be&&(t.set(o,s.Ce()),s.ve())}});let r=X();this.qe.forEach((s,o)=>{let a=!0;o.forEachWhile(c=>{let u=this.Je(c);return!u||u.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(r=r.add(s))}),this.ke.forEach((s,o)=>o.setReadTime(e));let i=new po(e,t,this.Qe,this.ke,r);return this.ke=ct(),this.qe=oy(),this.Qe=new _e(Y),i}$e(e,t){if(!this.ze(e))return;let r=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,r),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,r){if(!this.ze(e))return;let i=this.Ge(e);this.it(e,t)?i.Fe(t,1):i.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),r&&(this.ke=this.ke.insert(t,r))}removeTarget(e){this.Be.delete(e)}Ye(e){let t=this.Ge(e).Ce();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new yl,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new de(Y),this.qe=this.qe.insert(e,t)),t}ze(e){let t=this.Je(e)!==null;return t||V("WatchChangeAggregator","Detected inactive target",e),t}Je(e){let t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new yl),this.Le.getRemoteKeysForTarget(e).forEach(t=>{this.Ue(e,t,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}};function oy(){return new _e(U.comparator)}function ay(){return new _e(U.comparator)}var GS={asc:"ASCENDING",desc:"DESCENDING"},jS={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},zS={and:"AND",or:"OR"},Uh=class{constructor(e,t){this.databaseId=e,this.useProto3Json=t}};function Bh(n,e){return n.useProto3Json||bo(e)?e:{value:e}}function Ri(n,e){return n.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Sv(n,e){return n.useProto3Json?e.toBase64():e.toUint8Array()}function KS(n,e){return Ri(n,e.toTimestamp())}function Pe(n){return j(!!n),z.fromTimestamp(function(t){let r=un(t);return new we(r.seconds,r.nanos)}(n))}function _f(n,e){return qh(n,e).canonicalString()}function qh(n,e){let t=function(i){return new se(["projects",i.projectId,"databases",i.database])}(n).child("documents");return e===void 0?t:t.child(e)}function Cv(n){let e=se.fromString(n);return j(Fv(e)),e}function mo(n,e){return _f(n.databaseId,e.path)}function Gt(n,e){let t=Cv(e);if(t.get(1)!==n.databaseId.projectId)throw new D(R.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+n.databaseId.projectId);if(t.get(3)!==n.databaseId.database)throw new D(R.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+n.databaseId.database);return new U(Pv(t))}function bv(n,e){return _f(n.databaseId,e)}function Rv(n){let e=Cv(n);return e.length===4?se.emptyPath():Pv(e)}function Gh(n){return new se(["projects",n.databaseId.projectId,"databases",n.databaseId.database]).canonicalString()}function Pv(n){return j(n.length>4&&n.get(4)==="documents"),n.popFirst(5)}function ly(n,e,t){return{name:mo(n,e),fields:t.value.mapValue.fields}}function xv(n,e,t){let r=Gt(n,e.name),i=Pe(e.updateTime),s=e.createTime?Pe(e.createTime):z.min(),o=new Xe({mapValue:{fields:e.fields}}),a=Fe.newFoundDocument(r,i,s,o);return t&&a.setHasCommittedMutations(),t?a.setHasCommittedMutations():a}function WS(n,e){return"found"in e?function(r,i){j(!!i.found),i.found.name,i.found.updateTime;let s=Gt(r,i.found.name),o=Pe(i.found.updateTime),a=i.found.createTime?Pe(i.found.createTime):z.min(),c=new Xe({mapValue:{fields:i.found.fields}});return Fe.newFoundDocument(s,o,a,c)}(n,e):"missing"in e?function(r,i){j(!!i.missing),j(!!i.readTime);let s=Gt(r,i.missing),o=Pe(i.readTime);return Fe.newNoDocument(s,o)}(n,e):B()}function $S(n,e){let t;if("targetChange"in e){e.targetChange;let r=function(u){return u==="NO_CHANGE"?0:u==="ADD"?1:u==="REMOVE"?2:u==="CURRENT"?3:u==="RESET"?4:B()}(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],s=function(u,d){return u.useProto3Json?(j(d===void 0||typeof d=="string"),xe.fromBase64String(d||"")):(j(d===void 0||d instanceof Buffer||d instanceof Uint8Array),xe.fromUint8Array(d||new Uint8Array))}(n,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(u){let d=u.code===void 0?R.UNKNOWN:Iv(u.code);return new D(d,u.message||"")}(o);t=new _l(r,i,s,a||null)}else if("documentChange"in e){e.documentChange;let r=e.documentChange;r.document,r.document.name,r.document.updateTime;let i=Gt(n,r.document.name),s=Pe(r.document.updateTime),o=r.document.createTime?Pe(r.document.createTime):z.min(),a=new Xe({mapValue:{fields:r.document.fields}}),c=Fe.newFoundDocument(i,s,o,a),u=r.targetIds||[],d=r.removedTargetIds||[];t=new Ei(u,d,c.key,c)}else if("documentDelete"in e){e.documentDelete;let r=e.documentDelete;r.document;let i=Gt(n,r.document),s=r.readTime?Pe(r.readTime):z.min(),o=Fe.newNoDocument(i,s),a=r.removedTargetIds||[];t=new Ei([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;let r=e.documentRemove;r.document;let i=Gt(n,r.document),s=r.removedTargetIds||[];t=new Ei([],s,i,null)}else{if(!("filter"in e))return B();{e.filter;let r=e.filter;r.targetId;let{count:i=0,unchangedNames:s}=r,o=new Fh(i,s),a=r.targetId;t=new ml(a,o)}}return t}function _o(n,e){let t;if(e instanceof Qn)t={update:ly(n,e.key,e.value)};else if(e instanceof Hn)t={delete:mo(n,e.key)};else if(e instanceof kt)t={update:ly(n,e.key,e.data),updateMask:ZS(e.fieldMask)};else{if(!(e instanceof uo))return B();t={verify:mo(n,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map(r=>function(s,o){let a=o.transform;if(a instanceof Wn)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof hn)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof dn)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof $n)return{fieldPath:o.field.canonicalString(),increment:a.Pe};throw B()}(0,r))),e.precondition.isNone||(t.currentDocument=function(i,s){return s.updateTime!==void 0?{updateTime:KS(i,s.updateTime)}:s.exists!==void 0?{exists:s.exists}:B()}(n,e.precondition)),t}function jh(n,e){let t=e.currentDocument?function(s){return s.updateTime!==void 0?Se.updateTime(Pe(s.updateTime)):s.exists!==void 0?Se.exists(s.exists):Se.none()}(e.currentDocument):Se.none(),r=e.updateTransforms?e.updateTransforms.map(i=>function(o,a){let c=null;if("setToServerValue"in a)j(a.setToServerValue==="REQUEST_TIME"),c=new Wn;else if("appendMissingElements"in a){let d=a.appendMissingElements.values||[];c=new hn(d)}else if("removeAllFromArray"in a){let d=a.removeAllFromArray.values||[];c=new dn(d)}else"increment"in a?c=new $n(o,a.increment):B();let u=Re.fromServerFormat(a.fieldPath);return new Pr(u,c)}(n,i)):[];if(e.update){e.update.name;let i=Gt(n,e.update.name),s=new Xe({mapValue:{fields:e.update.fields}});if(e.updateMask){let o=function(c){let u=c.fieldPaths||[];return new ft(u.map(d=>Re.fromServerFormat(d)))}(e.updateMask);return new kt(i,s,o,t,r)}return new Qn(i,s,t,r)}if(e.delete){let i=Gt(n,e.delete);return new Hn(i,t)}if(e.verify){let i=Gt(n,e.verify);return new uo(i,t)}return B()}function QS(n,e){return n&&n.length>0?(j(e!==void 0),n.map(t=>function(i,s){let o=i.updateTime?Pe(i.updateTime):Pe(s);return o.isEqual(z.min())&&(o=Pe(s)),new Vh(o,i.transformResults||[])}(t,e))):[]}function kv(n,e){return{documents:[bv(n,e.path)]}}function Nv(n,e){let t={structuredQuery:{}},r=e.path,i;e.collectionGroup!==null?(i=r,t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(i=r.popLast(),t.structuredQuery.from=[{collectionId:r.lastSegment()}]),t.parent=bv(n,i);let s=function(u){if(u.length!==0)return Ov(ue.create(u,"and"))}(e.filters);s&&(t.structuredQuery.where=s);let o=function(u){if(u.length!==0)return u.map(d=>function(g){return{field:gi(g.field),direction:YS(g.dir)}}(d))}(e.orderBy);o&&(t.structuredQuery.orderBy=o);let a=Bh(n,e.limit);return a!==null&&(t.structuredQuery.limit=a),e.startAt&&(t.structuredQuery.startAt=function(u){return{before:u.inclusive,values:u.position}}(e.startAt)),e.endAt&&(t.structuredQuery.endAt=function(u){return{before:!u.inclusive,values:u.position}}(e.endAt)),{_t:t,parent:i}}function Dv(n){let e=Rv(n.parent),t=n.structuredQuery,r=t.from?t.from.length:0,i=null;if(r>0){j(r===1);let d=t.from[0];d.allDescendants?i=d.collectionId:e=e.child(d.collectionId)}let s=[];t.where&&(s=function(p){let g=Vv(p);return g instanceof ue&&pf(g)?g.getFilters():[g]}(t.where));let o=[];t.orderBy&&(o=function(p){return p.map(g=>function(S){return new br(mi(S.field),function(N){switch(N){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(S.direction))}(g))}(t.orderBy));let a=null;t.limit&&(a=function(p){let g;return g=typeof p=="object"?p.value:p,bo(g)?null:g}(t.limit));let c=null;t.startAt&&(c=function(p){let g=!!p.before,y=p.values||[];return new Kt(y,g)}(t.startAt));let u=null;return t.endAt&&(u=function(p){let g=!p.before,y=p.values||[];return new Kt(y,g)}(t.endAt)),ov(e,i,o,s,a,"F",c,u)}function HS(n,e){let t=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return B()}}(e.purpose);return t==null?null:{"goog-listen-tags":t}}function Vv(n){return n.unaryFilter!==void 0?function(t){switch(t.unaryFilter.op){case"IS_NAN":let r=mi(t.unaryFilter.field);return re.create(r,"==",{doubleValue:NaN});case"IS_NULL":let i=mi(t.unaryFilter.field);return re.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let s=mi(t.unaryFilter.field);return re.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let o=mi(t.unaryFilter.field);return re.create(o,"!=",{nullValue:"NULL_VALUE"});default:return B()}}(n):n.fieldFilter!==void 0?function(t){return re.create(mi(t.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return B()}}(t.fieldFilter.op),t.fieldFilter.value)}(n):n.compositeFilter!==void 0?function(t){return ue.create(t.compositeFilter.filters.map(r=>Vv(r)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return B()}}(t.compositeFilter.op))}(n):B()}function YS(n){return GS[n]}function JS(n){return jS[n]}function XS(n){return zS[n]}function gi(n){return{fieldPath:n.canonicalString()}}function mi(n){return Re.fromServerFormat(n.fieldPath)}function Ov(n){return n instanceof re?function(t){if(t.op==="=="){if(K_(t.value))return{unaryFilter:{field:gi(t.field),op:"IS_NAN"}};if(z_(t.value))return{unaryFilter:{field:gi(t.field),op:"IS_NULL"}}}else if(t.op==="!="){if(K_(t.value))return{unaryFilter:{field:gi(t.field),op:"IS_NOT_NAN"}};if(z_(t.value))return{unaryFilter:{field:gi(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:gi(t.field),op:JS(t.op),value:t.value}}}(n):n instanceof ue?function(t){let r=t.getFilters().map(i=>Ov(i));return r.length===1?r[0]:{compositeFilter:{op:XS(t.op),filters:r}}}(n):B()}function ZS(n){let e=[];return n.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function Fv(n){return n.length>=4&&n.get(0)==="projects"&&n.get(2)==="databases"}var Pi=class n{constructor(e,t,r,i,s=z.min(),o=z.min(),a=xe.EMPTY_BYTE_STRING,c=null){this.target=e,this.targetId=t,this.purpose=r,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=c}withSequenceNumber(e){return new n(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}};var vl=class{constructor(e){this.ct=e}};function e0(n,e){let t;if(e.document)t=xv(n.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){let r=U.fromSegments(e.noDocument.path),i=kr(e.noDocument.readTime);t=Fe.newNoDocument(r,i),e.hasCommittedMutations&&t.setHasCommittedMutations()}else{if(!e.unknownDocument)return B();{let r=U.fromSegments(e.unknownDocument.path),i=kr(e.unknownDocument.version);t=Fe.newUnknownDocument(r,i)}}return e.readTime&&t.setReadTime(function(i){let s=new we(i[0],i[1]);return z.fromTimestamp(s)}(e.readTime)),t}function cy(n,e){let t=e.key,r={prefixPath:t.getCollectionPath().popLast().toArray(),collectionGroup:t.collectionGroup,documentId:t.path.lastSegment(),readTime:wl(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(s,o){return{name:mo(s,o.key),fields:o.data.value.mapValue.fields,updateTime:Ri(s,o.version.toTimestamp()),createTime:Ri(s,o.createTime.toTimestamp())}}(n.ct,e);else if(e.isNoDocument())r.noDocument={path:t.path.toArray(),readTime:xr(e.version)};else{if(!e.isUnknownDocument())return B();r.unknownDocument={path:t.path.toArray(),version:xr(e.version)}}return r}function wl(n){let e=n.toTimestamp();return[e.seconds,e.nanoseconds]}function xr(n){let e=n.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function kr(n){let e=new we(n.seconds,n.nanoseconds);return z.fromTimestamp(e)}function wr(n,e){let t=(e.baseMutations||[]).map(s=>jh(n.ct,s));for(let s=0;s<e.mutations.length-1;++s){let o=e.mutations[s];if(s+1<e.mutations.length&&e.mutations[s+1].transform!==void 0){let a=e.mutations[s+1];o.updateTransforms=a.transform.fieldTransforms,e.mutations.splice(s+1,1),++s}}let r=e.mutations.map(s=>jh(n.ct,s)),i=we.fromMillis(e.localWriteTimeMs);return new ho(e.batchId,i,t,r)}function Xs(n){let e=kr(n.readTime),t=n.lastLimboFreeSnapshotVersion!==void 0?kr(n.lastLimboFreeSnapshotVersion):z.min(),r;return r=function(s){return s.documents!==void 0}(n.query)?function(s){return j(s.documents.length===1),rt(Bi(Rv(s.documents[0])))}(n.query):function(s){return rt(Dv(s))}(n.query),new Pi(r,n.targetId,"TargetPurposeListen",n.lastListenSequenceNumber,e,t,xe.fromBase64String(n.resumeToken))}function Mv(n,e){let t=xr(e.snapshotVersion),r=xr(e.lastLimboFreeSnapshotVersion),i;i=fl(e.target)?kv(n.ct,e.target):Nv(n.ct,e.target)._t;let s=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Rr(e.target),readTime:t,resumeToken:s,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function yf(n){let e=Dv({parent:n.parent,structuredQuery:n.structuredQuery});return n.limitType==="LAST"?gl(e,e.limit,"L"):e}function ih(n,e){return new fo(e.largestBatchId,jh(n.ct,e.overlayMutation))}function uy(n,e){let t=e.path.lastSegment();return[n,nt(e.path.popLast()),t]}function hy(n,e,t,r){return{indexId:n,uid:e,sequenceNumber:t,readTime:xr(r.readTime),documentKey:nt(r.documentKey.path),largestBatchId:r.largestBatchId}}var zh=class{getBundleMetadata(e,t){return dy(e).get(t).next(r=>{if(r)return function(s){return{id:s.bundleId,createTime:kr(s.createTime),version:s.version}}(r)})}saveBundleMetadata(e,t){return dy(e).put(function(i){return{bundleId:i.id,createTime:xr(Pe(i.createTime)),version:i.version}}(t))}getNamedQuery(e,t){return fy(e).get(t).next(r=>{if(r)return function(s){return{name:s.name,query:yf(s.bundledQuery),readTime:kr(s.readTime)}}(r)})}saveNamedQuery(e,t){return fy(e).put(function(i){return{name:i.name,readTime:xr(Pe(i.readTime)),bundledQuery:i.bundledQuery}}(t))}};function dy(n){return Ue(n,"bundles")}function fy(n){return Ue(n,"namedQueries")}var El=class n{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){let r=t.uid||"";return new n(e,r)}getOverlay(e,t){return $s(e).get(uy(this.userId,t)).next(r=>r?ih(this.serializer,r):null)}getOverlays(e,t){let r=Bt();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){let i=[];return r.forEach((s,o)=>{let a=new fo(t,o);i.push(this.ht(e,a))}),b.waitFor(i)}removeOverlaysForBatchId(e,t,r){let i=new Set;t.forEach(o=>i.add(nt(o.getCollectionPath())));let s=[];return i.forEach(o=>{let a=IDBKeyRange.bound([this.userId,o,r],[this.userId,o,r+1],!1,!0);s.push($s(e).j("collectionPathOverlayIndex",a))}),b.waitFor(s)}getOverlaysForCollection(e,t,r){let i=Bt(),s=nt(t),o=IDBKeyRange.bound([this.userId,s,r],[this.userId,s,Number.POSITIVE_INFINITY],!0);return $s(e).U("collectionPathOverlayIndex",o).next(a=>{for(let c of a){let u=ih(this.serializer,c);i.set(u.getKey(),u)}return i})}getOverlaysForCollectionGroup(e,t,r,i){let s=Bt(),o,a=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,Number.POSITIVE_INFINITY],!0);return $s(e).J({index:"collectionGroupOverlayIndex",range:a},(c,u,d)=>{let p=ih(this.serializer,u);s.size()<i||p.largestBatchId===o?(s.set(p.getKey(),p),o=p.largestBatchId):d.done()}).next(()=>s)}ht(e,t){return $s(e).put(function(i,s,o){let[a,c,u]=uy(s,o.mutation.key);return{userId:s,collectionPath:c,documentId:u,collectionGroup:o.mutation.key.getCollectionGroup(),largestBatchId:o.largestBatchId,overlayMutation:_o(i.ct,o.mutation)}}(this.serializer,this.userId,t))}};function $s(n){return Ue(n,"documentOverlays")}var Kh=class{Pt(e){return Ue(e,"globals")}getSessionToken(e){return this.Pt(e).get("sessionToken").next(t=>{let r=t?.value;return r?xe.fromUint8Array(r):xe.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Pt(e).put({name:"sessionToken",value:t.toUint8Array()})}};var ln=class{constructor(){}It(e,t){this.Tt(e,t),t.Et()}Tt(e,t){if("nullValue"in e)this.dt(t,5);else if("booleanValue"in e)this.dt(t,10),t.At(e.booleanValue?1:0);else if("integerValue"in e)this.dt(t,15),t.At(Ae(e.integerValue));else if("doubleValue"in e){let r=Ae(e.doubleValue);isNaN(r)?this.dt(t,13):(this.dt(t,15),so(r)?t.At(0):t.At(r))}else if("timestampValue"in e){let r=e.timestampValue;this.dt(t,20),typeof r=="string"&&(r=un(r)),t.Rt(`${r.seconds||""}`),t.At(r.nanos||0)}else if("stringValue"in e)this.Vt(e.stringValue,t),this.ft(t);else if("bytesValue"in e)this.dt(t,30),t.gt(jn(e.bytesValue)),this.ft(t);else if("referenceValue"in e)this.yt(e.referenceValue,t);else if("geoPointValue"in e){let r=e.geoPointValue;this.dt(t,45),t.At(r.latitude||0),t.At(r.longitude||0)}else"mapValue"in e?Zy(e)?this.dt(t,Number.MAX_SAFE_INTEGER):(this.wt(e.mapValue,t),this.ft(t)):"arrayValue"in e?(this.St(e.arrayValue,t),this.ft(t)):B()}Vt(e,t){this.dt(t,25),this.bt(e,t)}bt(e,t){t.Rt(e)}wt(e,t){let r=e.fields||{};this.dt(t,55);for(let i of Object.keys(r))this.Vt(i,t),this.Tt(r[i],t)}St(e,t){let r=e.values||[];this.dt(t,50);for(let i of r)this.Tt(i,t)}yt(e,t){this.dt(t,37),U.fromName(e).path.forEach(r=>{this.dt(t,60),this.bt(r,t)})}dt(e,t){e.At(t)}ft(e){e.At(2)}};ln.Dt=new ln;function t0(n){if(n===0)return 8;let e=0;return!(n>>4)&&(e+=4,n<<=4),!(n>>6)&&(e+=2,n<<=2),!(n>>7)&&(e+=1),e}function py(n){let e=64-function(r){let i=0;for(let s=0;s<8;++s){let o=t0(255&r[s]);if(i+=o,o!==8)break}return i}(n);return Math.ceil(e/8)}var Wh=class{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.vt(r.value),r=t.next();this.Ft()}Mt(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.xt(r.value),r=t.next();this.Ot()}Nt(e){for(let t of e){let r=t.charCodeAt(0);if(r<128)this.vt(r);else if(r<2048)this.vt(960|r>>>6),this.vt(128|63&r);else if(t<"\uD800"||"\uDBFF"<t)this.vt(480|r>>>12),this.vt(128|63&r>>>6),this.vt(128|63&r);else{let i=t.codePointAt(0);this.vt(240|i>>>18),this.vt(128|63&i>>>12),this.vt(128|63&i>>>6),this.vt(128|63&i)}}this.Ft()}Lt(e){for(let t of e){let r=t.charCodeAt(0);if(r<128)this.xt(r);else if(r<2048)this.xt(960|r>>>6),this.xt(128|63&r);else if(t<"\uD800"||"\uDBFF"<t)this.xt(480|r>>>12),this.xt(128|63&r>>>6),this.xt(128|63&r);else{let i=t.codePointAt(0);this.xt(240|i>>>18),this.xt(128|63&i>>>12),this.xt(128|63&i>>>6),this.xt(128|63&i)}}this.Ot()}Bt(e){let t=this.kt(e),r=py(t);this.qt(1+r),this.buffer[this.position++]=255&r;for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=255&t[i]}Qt(e){let t=this.kt(e),r=py(t);this.qt(1+r),this.buffer[this.position++]=~(255&r);for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=~(255&t[i])}Kt(){this.$t(255),this.$t(255)}Ut(){this.Wt(255),this.Wt(255)}reset(){this.position=0}seed(e){this.qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Gt(){return this.buffer.slice(0,this.position)}kt(e){let t=function(s){let o=new DataView(new ArrayBuffer(8));return o.setFloat64(0,s,!1),new Uint8Array(o.buffer)}(e),r=(128&t[0])!=0;t[0]^=r?255:128;for(let i=1;i<t.length;++i)t[i]^=r?255:0;return t}vt(e){let t=255&e;t===0?(this.$t(0),this.$t(255)):t===255?(this.$t(255),this.$t(0)):this.$t(t)}xt(e){let t=255&e;t===0?(this.Wt(0),this.Wt(255)):t===255?(this.Wt(255),this.Wt(0)):this.Wt(e)}Ft(){this.$t(0),this.$t(1)}Ot(){this.Wt(0),this.Wt(1)}$t(e){this.qt(1),this.buffer[this.position++]=e}Wt(e){this.qt(1),this.buffer[this.position++]=~e}qt(e){let t=e+this.position;if(t<=this.buffer.length)return;let r=2*this.buffer.length;r<t&&(r=t);let i=new Uint8Array(r);i.set(this.buffer),this.buffer=i}},$h=class{constructor(e){this.zt=e}gt(e){this.zt.Ct(e)}Rt(e){this.zt.Nt(e)}At(e){this.zt.Bt(e)}Et(){this.zt.Kt()}},Qh=class{constructor(e){this.zt=e}gt(e){this.zt.Mt(e)}Rt(e){this.zt.Lt(e)}At(e){this.zt.Qt(e)}Et(){this.zt.Ut()}},Er=class{constructor(){this.zt=new Wh,this.jt=new $h(this.zt),this.Ht=new Qh(this.zt)}seed(e){this.zt.seed(e)}Jt(e){return e===0?this.jt:this.Ht}Gt(){return this.zt.Gt()}reset(){this.zt.reset()}};var Tr=class n{constructor(e,t,r,i){this.indexId=e,this.documentKey=t,this.arrayValue=r,this.directionalValue=i}Yt(){let e=this.directionalValue.length,t=e===0||this.directionalValue[e-1]===255?e+1:e,r=new Uint8Array(t);return r.set(this.directionalValue,0),t!==e?r.set([0],this.directionalValue.length):++r[r.length-1],new n(this.indexId,this.documentKey,this.arrayValue,r)}};function On(n,e){let t=n.indexId-e.indexId;return t!==0?t:(t=gy(n.arrayValue,e.arrayValue),t!==0?t:(t=gy(n.directionalValue,e.directionalValue),t!==0?t:U.comparator(n.documentKey,e.documentKey)))}function gy(n,e){for(let t=0;t<n.length&&t<e.length;++t){let r=n[t]-e[t];if(r!==0)return r}return n.length-e.length}var Tl=class{constructor(e){this.Zt=new de((t,r)=>Re.comparator(t.field,r.field)),this.collectionId=e.collectionGroup!=null?e.collectionGroup:e.path.lastSegment(),this.Xt=e.orderBy,this.en=[];for(let t of e.filters){let r=t;r.isInequality()?this.Zt=this.Zt.add(r):this.en.push(r)}}get tn(){return this.Zt.size>1}nn(e){if(j(e.collectionGroup===this.collectionId),this.tn)return!1;let t=gh(e);if(t!==void 0&&!this.rn(t))return!1;let r=yr(e),i=new Set,s=0,o=0;for(;s<r.length&&this.rn(r[s]);++s)i=i.add(r[s].fieldPath.canonicalString());if(s===r.length)return!0;if(this.Zt.size>0){let a=this.Zt.getIterator().getNext();if(!i.has(a.field.canonicalString())){let c=r[s];if(!this.sn(a,c)||!this.on(this.Xt[o++],c))return!1}++s}for(;s<r.length;++s){let a=r[s];if(o>=this.Xt.length||!this.on(this.Xt[o++],a))return!1}return!0}_n(){if(this.tn)return null;let e=new de(Re.comparator),t=[];for(let r of this.en)if(!r.field.isKeyField())if(r.op==="array-contains"||r.op==="array-contains-any")t.push(new vi(r.field,2));else{if(e.has(r.field))continue;e=e.add(r.field),t.push(new vi(r.field,0))}for(let r of this.Xt)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new vi(r.field,r.dir==="asc"?0:1)));return new Ii(Ii.UNKNOWN_ID,this.collectionId,t,io.empty())}rn(e){for(let t of this.en)if(this.sn(t,e))return!0;return!1}sn(e,t){if(e===void 0||!e.field.isEqual(t.fieldPath))return!1;let r=e.op==="array-contains"||e.op==="array-contains-any";return t.kind===2===r}on(e,t){return!!e.field.isEqual(t.fieldPath)&&(t.kind===0&&e.dir==="asc"||t.kind===1&&e.dir==="desc")}};function Lv(n){var e,t;if(j(n instanceof re||n instanceof ue),n instanceof re){if(n instanceof dl){let i=((t=(e=n.value.arrayValue)===null||e===void 0?void 0:e.values)===null||t===void 0?void 0:t.map(s=>re.create(n.field,"==",s)))||[];return ue.create(i,"or")}return n}let r=n.filters.map(i=>Lv(i));return ue.create(r,n.op)}function n0(n){if(n.getFilters().length===0)return[];let e=Jh(Lv(n));return j(Uv(e)),Hh(e)||Yh(e)?[e]:e.getFilters()}function Hh(n){return n instanceof re}function Yh(n){return n instanceof ue&&pf(n)}function Uv(n){return Hh(n)||Yh(n)||function(t){if(t instanceof ue&&Ih(t)){for(let r of t.getFilters())if(!Hh(r)&&!Yh(r))return!1;return!0}return!1}(n)}function Jh(n){if(j(n instanceof re||n instanceof ue),n instanceof re)return n;if(n.filters.length===1)return Jh(n.filters[0]);let e=n.filters.map(r=>Jh(r)),t=ue.create(e,n.op);return t=Il(t),Uv(t)?t:(j(t instanceof ue),j(Si(t)),j(t.filters.length>1),t.filters.reduce((r,i)=>vf(r,i)))}function vf(n,e){let t;return j(n instanceof re||n instanceof ue),j(e instanceof re||e instanceof ue),t=n instanceof re?e instanceof re?function(i,s){return ue.create([i,s],"and")}(n,e):my(n,e):e instanceof re?my(e,n):function(i,s){if(j(i.filters.length>0&&s.filters.length>0),Si(i)&&Si(s))return rv(i,s.getFilters());let o=Ih(i)?i:s,a=Ih(i)?s:i,c=o.filters.map(u=>vf(u,a));return ue.create(c,"or")}(n,e),Il(t)}function my(n,e){if(Si(e))return rv(e,n.getFilters());{let t=e.filters.map(r=>vf(n,r));return ue.create(t,"or")}}function Il(n){if(j(n instanceof re||n instanceof ue),n instanceof re)return n;let e=n.getFilters();if(e.length===1)return Il(e[0]);if(tv(n))return n;let t=e.map(i=>Il(i)),r=[];return t.forEach(i=>{i instanceof re?r.push(i):i instanceof ue&&(i.op===n.op?r.push(...i.filters):r.push(i))}),r.length===1?r[0]:ue.create(r,n.op)}var Xh=class{constructor(){this.an=new yo}addToCollectionParentIndex(e,t){return this.an.add(t),b.resolve()}getCollectionParents(e,t){return b.resolve(this.an.getEntries(t))}addFieldIndex(e,t){return b.resolve()}deleteFieldIndex(e,t){return b.resolve()}deleteAllFieldIndexes(e){return b.resolve()}createTargetIndexes(e,t){return b.resolve()}getDocumentsMatchingTarget(e,t){return b.resolve(null)}getIndexType(e,t){return b.resolve(0)}getFieldIndexes(e,t){return b.resolve([])}getNextCollectionGroupToUpdate(e){return b.resolve(null)}getMinOffset(e,t){return b.resolve(Tt.min())}getMinOffsetFromCollectionGroup(e,t){return b.resolve(Tt.min())}updateCollectionGroup(e,t,r){return b.resolve()}updateIndexEntries(e,t){return b.resolve()}},yo=class{constructor(){this.index={}}add(e){let t=e.lastSegment(),r=e.popLast(),i=this.index[t]||new de(se.comparator),s=!i.has(r);return this.index[t]=i.add(r),s}has(e){let t=e.lastSegment(),r=e.popLast(),i=this.index[t];return i&&i.has(r)}getEntries(e){return(this.index[e]||new de(se.comparator)).toArray()}};var Qa=new Uint8Array(0),Zh=class{constructor(e,t){this.databaseId=t,this.un=new yo,this.cn=new Wt(r=>Rr(r),(r,i)=>Ro(r,i)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.un.has(t)){let r=t.lastSegment(),i=t.popLast();e.addOnCommittedListener(()=>{this.un.add(t)});let s={collectionId:r,parent:nt(i)};return _y(e).put(s)}return b.resolve()}getCollectionParents(e,t){let r=[],i=IDBKeyRange.bound([t,""],[qy(t),""],!1,!0);return _y(e).U(i).next(s=>{for(let o of s){if(o.collectionId!==t)break;r.push(Ut(o.parent))}return r})}addFieldIndex(e,t){let r=Qs(e),i=function(a){return{indexId:a.indexId,collectionGroup:a.collectionGroup,fields:a.fields.map(c=>[c.fieldPath.canonicalString(),c.kind])}}(t);delete i.indexId;let s=r.add(i);if(t.indexState){let o=hi(e);return s.next(a=>{o.put(hy(a,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){let r=Qs(e),i=hi(e),s=ui(e);return r.delete(t.indexId).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=Qs(e),r=ui(e),i=hi(e);return t.j().next(()=>r.j()).next(()=>i.j())}createTargetIndexes(e,t){return b.forEach(this.ln(t),r=>this.getIndexType(e,r).next(i=>{if(i===0||i===1){let s=new Tl(r)._n();if(s!=null)return this.addFieldIndex(e,s)}}))}getDocumentsMatchingTarget(e,t){let r=ui(e),i=!0,s=new Map;return b.forEach(this.ln(t),o=>this.hn(e,o).next(a=>{i&&(i=!!a),s.set(o,a)})).next(()=>{if(i){let o=X(),a=[];return b.forEach(s,(c,u)=>{V("IndexedDbIndexManager",`Using index ${function(F){return`id=${F.indexId}|cg=${F.collectionGroup}|f=${F.fields.map(K=>`${K.fieldPath}:${K.kind}`).join(",")}`}(c)} to execute ${Rr(t)}`);let d=function(F,K){let Q=gh(K);if(Q===void 0)return null;for(let H of pl(F,Q.fieldPath))switch(H.op){case"array-contains-any":return H.value.arrayValue.values||[];case"array-contains":return[H.value]}return null}(u,c),p=function(F,K){let Q=new Map;for(let H of yr(K))for(let E of pl(F,H.fieldPath))switch(E.op){case"==":case"in":Q.set(H.fieldPath.canonicalString(),E.value);break;case"not-in":case"!=":return Q.set(H.fieldPath.canonicalString(),E.value),Array.from(Q.values())}return null}(u,c),g=function(F,K){let Q=[],H=!0;for(let E of yr(K)){let _=E.kind===0?Y_(F,E.fieldPath,F.startAt):J_(F,E.fieldPath,F.startAt);Q.push(_.value),H&&(H=_.inclusive)}return new Kt(Q,H)}(u,c),y=function(F,K){let Q=[],H=!0;for(let E of yr(K)){let _=E.kind===0?J_(F,E.fieldPath,F.endAt):Y_(F,E.fieldPath,F.endAt);Q.push(_.value),H&&(H=_.inclusive)}return new Kt(Q,H)}(u,c),S=this.Pn(c,u,g),k=this.Pn(c,u,y),N=this.In(c,u,p),q=this.Tn(c.indexId,d,S,g.inclusive,k,y.inclusive,N);return b.forEach(q,G=>r.G(G,t.limit).next(F=>{F.forEach(K=>{let Q=U.fromSegments(K.documentKey);o.has(Q)||(o=o.add(Q),a.push(Q))})}))}).next(()=>a)}return b.resolve(null)})}ln(e){let t=this.cn.get(e);return t||(e.filters.length===0?t=[e]:t=n0(ue.create(e.filters,"and")).map(r=>Nh(e.path,e.collectionGroup,e.orderBy,r.getFilters(),e.limit,e.startAt,e.endAt)),this.cn.set(e,t),t)}Tn(e,t,r,i,s,o,a){let c=(t!=null?t.length:1)*Math.max(r.length,s.length),u=c/(t!=null?t.length:1),d=[];for(let p=0;p<c;++p){let g=t?this.En(t[p/u]):Qa,y=this.dn(e,g,r[p%u],i),S=this.An(e,g,s[p%u],o),k=a.map(N=>this.dn(e,g,N,!0));d.push(...this.createRange(y,S,k))}return d}dn(e,t,r,i){let s=new Tr(e,U.empty(),t,r);return i?s:s.Yt()}An(e,t,r,i){let s=new Tr(e,U.empty(),t,r);return i?s.Yt():s}hn(e,t){let r=new Tl(t),i=t.collectionGroup!=null?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,i).next(s=>{let o=null;for(let a of s)r.nn(a)&&(!o||a.fields.length>o.fields.length)&&(o=a);return o})}getIndexType(e,t){let r=2,i=this.ln(t);return b.forEach(i,s=>this.hn(e,s).next(o=>{o?r!==0&&o.fields.length<function(c){let u=new de(Re.comparator),d=!1;for(let p of c.filters)for(let g of p.getFlattenedFilters())g.field.isKeyField()||(g.op==="array-contains"||g.op==="array-contains-any"?d=!0:u=u.add(g.field));for(let p of c.orderBy)p.field.isKeyField()||(u=u.add(p.field));return u.size+(d?1:0)}(s)&&(r=1):r=0})).next(()=>function(o){return o.limit!==null}(t)&&i.length>1&&r===2?1:r)}Rn(e,t){let r=new Er;for(let i of yr(e)){let s=t.data.field(i.fieldPath);if(s==null)return null;let o=r.Jt(i.kind);ln.Dt.It(s,o)}return r.Gt()}En(e){let t=new Er;return ln.Dt.It(e,t.Jt(0)),t.Gt()}Vn(e,t){let r=new Er;return ln.Dt.It(Cr(this.databaseId,t),r.Jt(function(s){let o=yr(s);return o.length===0?0:o[o.length-1].kind}(e))),r.Gt()}In(e,t,r){if(r===null)return[];let i=[];i.push(new Er);let s=0;for(let o of yr(e)){let a=r[s++];for(let c of i)if(this.mn(t,o.fieldPath)&&co(a))i=this.fn(i,o,a);else{let u=c.Jt(o.kind);ln.Dt.It(a,u)}}return this.gn(i)}Pn(e,t,r){return this.In(e,t,r.position)}gn(e){let t=[];for(let r=0;r<e.length;++r)t[r]=e[r].Gt();return t}fn(e,t,r){let i=[...e],s=[];for(let o of r.arrayValue.values||[])for(let a of i){let c=new Er;c.seed(a.Gt()),ln.Dt.It(o,c.Jt(t.kind)),s.push(c)}return s}mn(e,t){return!!e.filters.find(r=>r instanceof re&&r.field.isEqual(t)&&(r.op==="in"||r.op==="not-in"))}getFieldIndexes(e,t){let r=Qs(e),i=hi(e);return(t?r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):r.U()).next(s=>{let o=[];return b.forEach(s,a=>i.get([a.indexId,this.uid]).next(c=>{o.push(function(d,p){let g=p?new io(p.sequenceNumber,new Tt(kr(p.readTime),new U(Ut(p.documentKey)),p.largestBatchId)):io.empty(),y=d.fields.map(([S,k])=>new vi(Re.fromServerFormat(S),k));return new Ii(d.indexId,d.collectionGroup,y,g)}(a,c))})).next(()=>o)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(t=>t.length===0?null:(t.sort((r,i)=>{let s=r.indexState.sequenceNumber-i.indexState.sequenceNumber;return s!==0?s:Y(r.collectionGroup,i.collectionGroup)}),t[0].collectionGroup))}updateCollectionGroup(e,t,r){let i=Qs(e),s=hi(e);return this.pn(e).next(o=>i.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(a=>b.forEach(a,c=>s.put(hy(c.indexId,this.uid,o,r)))))}updateIndexEntries(e,t){let r=new Map;return b.forEach(t,(i,s)=>{let o=r.get(i.collectionGroup);return(o?b.resolve(o):this.getFieldIndexes(e,i.collectionGroup)).next(a=>(r.set(i.collectionGroup,a),b.forEach(a,c=>this.yn(e,i,c).next(u=>{let d=this.wn(s,c);return u.isEqual(d)?b.resolve():this.Sn(e,s,c,u,d)}))))})}bn(e,t,r,i){return ui(e).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.Vn(r,t.key),documentKey:t.key.path.toArray()})}Dn(e,t,r,i){return ui(e).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.Vn(r,t.key),t.key.path.toArray()])}yn(e,t,r){let i=ui(e),s=new de(On);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.Vn(r,t)])},(o,a)=>{s=s.add(new Tr(r.indexId,t,a.arrayValue,a.directionalValue))}).next(()=>s)}wn(e,t){let r=new de(On),i=this.Rn(t,e);if(i==null)return r;let s=gh(t);if(s!=null){let o=e.data.field(s.fieldPath);if(co(o))for(let a of o.arrayValue.values||[])r=r.add(new Tr(t.indexId,e.key,this.En(a),i))}else r=r.add(new Tr(t.indexId,e.key,Qa,i));return r}Sn(e,t,r,i,s){V("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);let o=[];return function(c,u,d,p,g){let y=c.getIterator(),S=u.getIterator(),k=ci(y),N=ci(S);for(;k||N;){let q=!1,G=!1;if(k&&N){let F=d(k,N);F<0?G=!0:F>0&&(q=!0)}else k!=null?G=!0:q=!0;q?(p(N),N=ci(S)):G?(g(k),k=ci(y)):(k=ci(y),N=ci(S))}}(i,s,On,a=>{o.push(this.bn(e,t,r,a))},a=>{o.push(this.Dn(e,t,r,a))}),b.waitFor(o)}pn(e){let t=1;return hi(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(r,i,s)=>{s.done(),t=i.sequenceNumber+1}).next(()=>t)}createRange(e,t,r){r=r.sort((o,a)=>On(o,a)).filter((o,a,c)=>!a||On(o,c[a-1])!==0);let i=[];i.push(e);for(let o of r){let a=On(o,e),c=On(o,t);if(a===0)i[0]=e.Yt();else if(a>0&&c<0)i.push(o),i.push(o.Yt());else if(c>0)break}i.push(t);let s=[];for(let o=0;o<i.length;o+=2){if(this.Cn(i[o],i[o+1]))return[];let a=[i[o].indexId,this.uid,i[o].arrayValue,i[o].directionalValue,Qa,[]],c=[i[o+1].indexId,this.uid,i[o+1].arrayValue,i[o+1].directionalValue,Qa,[]];s.push(IDBKeyRange.bound(a,c))}return s}Cn(e,t){return On(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(yy)}getMinOffset(e,t){return b.mapArray(this.ln(t),r=>this.hn(e,r).next(i=>i||B())).next(yy)}};function _y(n){return Ue(n,"collectionParents")}function ui(n){return Ue(n,"indexEntries")}function Qs(n){return Ue(n,"indexConfiguration")}function hi(n){return Ue(n,"indexState")}function yy(n){j(n.length!==0);let e=n[0].indexState.offset,t=e.largestBatchId;for(let r=1;r<n.length;r++){let i=n[r].indexState.offset;uf(i,e)<0&&(e=i),t<i.largestBatchId&&(t=i.largestBatchId)}return new Tt(e.readTime,e.documentKey,t)}var vy={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},wt=class n{constructor(e,t,r){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=r}static withCacheSize(e){return new n(e,n.DEFAULT_COLLECTION_PERCENTILE,n.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};function Bv(n,e,t){let r=n.store("mutations"),i=n.store("documentMutations"),s=[],o=IDBKeyRange.only(t.batchId),a=0,c=r.J({range:o},(d,p,g)=>(a++,g.delete()));s.push(c.next(()=>{j(a===1)}));let u=[];for(let d of t.mutations){let p=$y(e,d.key.path,t.batchId);s.push(i.delete(p)),u.push(d.key)}return b.waitFor(s).next(()=>u)}function Al(n){if(!n)return 0;let e;if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw B();e=n.noDocument}return JSON.stringify(e).length}wt.DEFAULT_COLLECTION_PERCENTILE=10,wt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,wt.DEFAULT=new wt(41943040,wt.DEFAULT_COLLECTION_PERCENTILE,wt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),wt.DISABLED=new wt(-1,0,0);var Sl=class n{constructor(e,t,r,i){this.userId=e,this.serializer=t,this.indexManager=r,this.referenceDelegate=i,this.vn={}}static lt(e,t,r,i){j(e.uid!=="");let s=e.isAuthenticated()?e.uid:"";return new n(s,t,r,i)}checkEmpty(e){let t=!0,r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Fn(e).J({index:"userMutationsIndex",range:r},(i,s,o)=>{t=!1,o.done()}).next(()=>t)}addMutationBatch(e,t,r,i){let s=_i(e),o=Fn(e);return o.add({}).next(a=>{j(typeof a=="number");let c=new ho(a,t,r,i),u=function(y,S,k){let N=k.baseMutations.map(G=>_o(y.ct,G)),q=k.mutations.map(G=>_o(y.ct,G));return{userId:S,batchId:k.batchId,localWriteTimeMs:k.localWriteTime.toMillis(),baseMutations:N,mutations:q}}(this.serializer,this.userId,c),d=[],p=new de((g,y)=>Y(g.canonicalString(),y.canonicalString()));for(let g of i){let y=$y(this.userId,g.key.path,a);p=p.add(g.key.path.popLast()),d.push(o.put(u)),d.push(s.put(y,lS))}return p.forEach(g=>{d.push(this.indexManager.addToCollectionParentIndex(e,g))}),e.addOnCommittedListener(()=>{this.vn[a]=c.keys()}),b.waitFor(d).next(()=>c)})}lookupMutationBatch(e,t){return Fn(e).get(t).next(r=>r?(j(r.userId===this.userId),wr(this.serializer,r)):null)}Fn(e,t){return this.vn[t]?b.resolve(this.vn[t]):this.lookupMutationBatch(e,t).next(r=>{if(r){let i=r.keys();return this.vn[t]=i,i}return null})}getNextMutationBatchAfterBatchId(e,t){let r=t+1,i=IDBKeyRange.lowerBound([this.userId,r]),s=null;return Fn(e).J({index:"userMutationsIndex",range:i},(o,a,c)=>{a.userId===this.userId&&(j(a.batchId>=r),s=wr(this.serializer,a)),c.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return Fn(e).J({index:"userMutationsIndex",range:t,reverse:!0},(i,s,o)=>{r=s.batchId,o.done()}).next(()=>r)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Fn(e).U("userMutationsIndex",t).next(r=>r.map(i=>wr(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(e,t){let r=Xa(this.userId,t.path),i=IDBKeyRange.lowerBound(r),s=[];return _i(e).J({range:i},(o,a,c)=>{let[u,d,p]=o,g=Ut(d);if(u===this.userId&&t.path.isEqual(g))return Fn(e).get(p).next(y=>{if(!y)throw B();j(y.userId===this.userId),s.push(wr(this.serializer,y))});c.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new de(Y),i=[];return t.forEach(s=>{let o=Xa(this.userId,s.path),a=IDBKeyRange.lowerBound(o),c=_i(e).J({range:a},(u,d,p)=>{let[g,y,S]=u,k=Ut(y);g===this.userId&&s.path.isEqual(k)?r=r.add(S):p.done()});i.push(c)}),b.waitFor(i).next(()=>this.Mn(e,r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,i=r.length+1,s=Xa(this.userId,r),o=IDBKeyRange.lowerBound(s),a=new de(Y);return _i(e).J({range:o},(c,u,d)=>{let[p,g,y]=c,S=Ut(g);p===this.userId&&r.isPrefixOf(S)?S.length===i&&(a=a.add(y)):d.done()}).next(()=>this.Mn(e,a))}Mn(e,t){let r=[],i=[];return t.forEach(s=>{i.push(Fn(e).get(s).next(o=>{if(o===null)throw B();j(o.userId===this.userId),r.push(wr(this.serializer,o))}))}),b.waitFor(i).next(()=>r)}removeMutationBatch(e,t){return Bv(e._e,this.userId,t).next(r=>(e.addOnCommittedListener(()=>{this.xn(t.batchId)}),b.forEach(r,i=>this.referenceDelegate.markPotentiallyOrphaned(e,i))))}xn(e){delete this.vn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return b.resolve();let r=IDBKeyRange.lowerBound(function(o){return[o]}(this.userId)),i=[];return _i(e).J({range:r},(s,o,a)=>{if(s[0]===this.userId){let c=Ut(s[1]);i.push(c)}else a.done()}).next(()=>{j(i.length===0)})})}containsKey(e,t){return qv(e,this.userId,t)}On(e){return Gv(e).get(this.userId).next(t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}};function qv(n,e,t){let r=Xa(e,t.path),i=r[1],s=IDBKeyRange.lowerBound(r),o=!1;return _i(n).J({range:s,H:!0},(a,c,u)=>{let[d,p,g]=a;d===e&&p===i&&(o=!0),u.done()}).next(()=>o)}function Fn(n){return Ue(n,"mutations")}function _i(n){return Ue(n,"documentMutations")}function Gv(n){return Ue(n,"mutationQueues")}var xi=class n{constructor(e){this.Nn=e}next(){return this.Nn+=2,this.Nn}static Ln(){return new n(0)}static Bn(){return new n(-1)}};var ed=class{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.kn(e).next(t=>{let r=new xi(t.highestTargetId);return t.highestTargetId=r.next(),this.qn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.kn(e).next(t=>z.fromTimestamp(new we(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.kn(e).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,t,r){return this.kn(e).next(i=>(i.highestListenSequenceNumber=t,r&&(i.lastRemoteSnapshotVersion=r.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),this.qn(e,i)))}addTargetData(e,t){return this.Qn(e,t).next(()=>this.kn(e).next(r=>(r.targetCount+=1,this.Kn(t,r),this.qn(e,r))))}updateTargetData(e,t){return this.Qn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>di(e).delete(t.targetId)).next(()=>this.kn(e)).next(r=>(j(r.targetCount>0),r.targetCount-=1,this.qn(e,r)))}removeTargets(e,t,r){let i=0,s=[];return di(e).J((o,a)=>{let c=Xs(a);c.sequenceNumber<=t&&r.get(c.targetId)===null&&(i++,s.push(this.removeTargetData(e,c)))}).next(()=>b.waitFor(s)).next(()=>i)}forEachTarget(e,t){return di(e).J((r,i)=>{let s=Xs(i);t(s)})}kn(e){return wy(e).get("targetGlobalKey").next(t=>(j(t!==null),t))}qn(e,t){return wy(e).put("targetGlobalKey",t)}Qn(e,t){return di(e).put(Mv(this.serializer,t))}Kn(e,t){let r=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,r=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,r=!0),r}getTargetCount(e){return this.kn(e).next(t=>t.targetCount)}getTargetData(e,t){let r=Rr(t),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),s=null;return di(e).J({range:i,index:"queryTargetsIndex"},(o,a,c)=>{let u=Xs(a);Ro(t,u.target)&&(s=u,c.done())}).next(()=>s)}addMatchingKeys(e,t,r){let i=[],s=Mn(e);return t.forEach(o=>{let a=nt(o.path);i.push(s.put({targetId:r,path:a})),i.push(this.referenceDelegate.addReference(e,r,o))}),b.waitFor(i)}removeMatchingKeys(e,t,r){let i=Mn(e);return b.forEach(t,s=>{let o=nt(s.path);return b.waitFor([i.delete([r,o]),this.referenceDelegate.removeReference(e,r,s)])})}removeMatchingKeysForTargetId(e,t){let r=Mn(e),i=IDBKeyRange.bound([t],[t+1],!1,!0);return r.delete(i)}getMatchingKeysForTargetId(e,t){let r=IDBKeyRange.bound([t],[t+1],!1,!0),i=Mn(e),s=X();return i.J({range:r,H:!0},(o,a,c)=>{let u=Ut(o[1]),d=new U(u);s=s.add(d)}).next(()=>s)}containsKey(e,t){let r=nt(t.path),i=IDBKeyRange.bound([r],[qy(r)],!1,!0),s=0;return Mn(e).J({index:"documentTargetsIndex",H:!0,range:i},([o,a],c,u)=>{o!==0&&(s++,u.done())}).next(()=>s>0)}ot(e,t){return di(e).get(t).next(r=>r?Xs(r):null)}};function di(n){return Ue(n,"targets")}function wy(n){return Ue(n,"targetGlobal")}function Mn(n){return Ue(n,"targetDocuments")}function Ey([n,e],[t,r]){let i=Y(n,t);return i===0?Y(e,r):i}var td=class{constructor(e){this.$n=e,this.buffer=new de(Ey),this.Un=0}Wn(){return++this.Un}Gn(e){let t=[e,this.Wn()];if(this.buffer.size<this.$n)this.buffer=this.buffer.add(t);else{let r=this.buffer.last();Ey(t,r)<0&&(this.buffer=this.buffer.delete(r).add(t))}}get maxValue(){return this.buffer.last()[0]}},nd=class{constructor(e,t,r){this.garbageCollector=e,this.asyncQueue=t,this.localStore=r,this.zn=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.jn(6e4)}stop(){this.zn&&(this.zn.cancel(),this.zn=null)}get started(){return this.zn!==null}jn(e){V("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.zn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,()=>x(this,null,function*(){this.zn=null;try{yield this.localStore.collectGarbage(this.garbageCollector)}catch(t){Xn(t)?V("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):yield Jn(t)}yield this.jn(3e5)}))}},rd=class{constructor(e,t){this.Hn=e,this.params=t}calculateTargetCount(e,t){return this.Hn.Jn(e).next(r=>Math.floor(t/100*r))}nthSequenceNumber(e,t){if(t===0)return b.resolve(dt.oe);let r=new td(t);return this.Hn.forEachTarget(e,i=>r.Gn(i.sequenceNumber)).next(()=>this.Hn.Yn(e,i=>r.Gn(i))).next(()=>r.maxValue)}removeTargets(e,t,r){return this.Hn.removeTargets(e,t,r)}removeOrphanedDocuments(e,t){return this.Hn.removeOrphanedDocuments(e,t)}collect(e,t){return this.params.cacheSizeCollectionThreshold===-1?(V("LruGarbageCollector","Garbage collection skipped; disabled"),b.resolve(vy)):this.getCacheSize(e).next(r=>r<this.params.cacheSizeCollectionThreshold?(V("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),vy):this.Zn(e,t))}getCacheSize(e){return this.Hn.getCacheSize(e)}Zn(e,t){let r,i,s,o,a,c,u,d=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(p=>(p>this.params.maximumSequenceNumbersToCollect?(V("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${p}`),i=this.params.maximumSequenceNumbersToCollect):i=p,o=Date.now(),this.nthSequenceNumber(e,i))).next(p=>(r=p,a=Date.now(),this.removeTargets(e,r,t))).next(p=>(s=p,c=Date.now(),this.removeOrphanedDocuments(e,r))).next(p=>(u=Date.now(),fi()<=vt.DEBUG&&V("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-d}ms
	Determined least recently used ${i} in `+(a-o)+`ms
	Removed ${s} targets in `+(c-a)+`ms
	Removed ${p} documents in `+(u-c)+`ms
Total Duration: ${u-d}ms`),b.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:p})))}};function r0(n,e){return new rd(n,e)}var id=class{constructor(e,t){this.db=e,this.garbageCollector=r0(this,t)}Jn(e){let t=this.Xn(e);return this.db.getTargetCache().getTargetCount(e).next(r=>t.next(i=>r+i))}Xn(e){let t=0;return this.Yn(e,r=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Yn(e,t){return this.er(e,(r,i)=>t(i))}addReference(e,t,r){return Ha(e,r)}removeReference(e,t,r){return Ha(e,r)}removeTargets(e,t,r){return this.db.getTargetCache().removeTargets(e,t,r)}markPotentiallyOrphaned(e,t){return Ha(e,t)}tr(e,t){return function(i,s){let o=!1;return Gv(i).Y(a=>qv(i,a,s).next(c=>(c&&(o=!0),b.resolve(!c)))).next(()=>o)}(e,t)}removeOrphanedDocuments(e,t){let r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],s=0;return this.er(e,(o,a)=>{if(a<=t){let c=this.tr(e,o).next(u=>{if(!u)return s++,r.getEntry(e,o).next(()=>(r.removeEntry(o,z.min()),Mn(e).delete(function(p){return[0,nt(p.path)]}(o))))});i.push(c)}}).next(()=>b.waitFor(i)).next(()=>r.apply(e)).next(()=>s)}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,r)}updateLimboDocument(e,t){return Ha(e,t)}er(e,t){let r=Mn(e),i,s=dt.oe;return r.J({index:"documentTargetsIndex"},([o,a],{path:c,sequenceNumber:u})=>{o===0?(s!==dt.oe&&t(new U(Ut(i)),s),s=u,i=c):s=dt.oe}).next(()=>{s!==dt.oe&&t(new U(Ut(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}};function Ha(n,e){return Mn(n).put(function(r,i){return{targetId:0,path:nt(r.path),sequenceNumber:i}}(e,n.currentSequenceNumber))}var Cl=class{constructor(){this.changes=new Wt(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Fe.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let r=this.changes.get(t);return r!==void 0?b.resolve(r):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}};var sd=class{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,r){return _r(e).put(r)}removeEntry(e,t,r){return _r(e).delete(function(s,o){let a=s.path.toArray();return[a.slice(0,a.length-2),a[a.length-2],wl(o),a[a.length-1]]}(t,r))}updateMetadata(e,t){return this.getMetadata(e).next(r=>(r.byteSize+=t,this.nr(e,r)))}getEntry(e,t){let r=Fe.newInvalidDocument(t);return _r(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Hs(t))},(i,s)=>{r=this.rr(t,s)}).next(()=>r)}ir(e,t){let r={size:0,document:Fe.newInvalidDocument(t)};return _r(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Hs(t))},(i,s)=>{r={document:this.rr(t,s),size:Al(s)}}).next(()=>r)}getEntries(e,t){let r=ct();return this.sr(e,t,(i,s)=>{let o=this.rr(i,s);r=r.insert(i,o)}).next(()=>r)}_r(e,t){let r=ct(),i=new _e(U.comparator);return this.sr(e,t,(s,o)=>{let a=this.rr(s,o);r=r.insert(s,a),i=i.insert(s,Al(o))}).next(()=>({documents:r,ar:i}))}sr(e,t,r){if(t.isEmpty())return b.resolve();let i=new de(Ay);t.forEach(c=>i=i.add(c));let s=IDBKeyRange.bound(Hs(i.first()),Hs(i.last())),o=i.getIterator(),a=o.getNext();return _r(e).J({index:"documentKeyIndex",range:s},(c,u,d)=>{let p=U.fromSegments([...u.prefixPath,u.collectionGroup,u.documentId]);for(;a&&Ay(a,p)<0;)r(a,null),a=o.getNext();a&&a.isEqual(p)&&(r(a,u),a=o.hasNext()?o.getNext():null),a?d.$(Hs(a)):d.done()}).next(()=>{for(;a;)r(a,null),a=o.hasNext()?o.getNext():null})}getDocumentsMatchingQuery(e,t,r,i,s){let o=t.path,a=[o.popLast().toArray(),o.lastSegment(),wl(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],c=[o.popLast().toArray(),o.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return _r(e).U(IDBKeyRange.bound(a,c,!0)).next(u=>{s?.incrementDocumentReadCount(u.length);let d=ct();for(let p of u){let g=this.rr(U.fromSegments(p.prefixPath.concat(p.collectionGroup,p.documentId)),p);g.isFoundDocument()&&(xo(t,g)||i.has(g.key))&&(d=d.insert(g.key,g))}return d})}getAllFromCollectionGroup(e,t,r,i){let s=ct(),o=Iy(t,r),a=Iy(t,Tt.max());return _r(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(o,a,!0)},(c,u,d)=>{let p=this.rr(U.fromSegments(u.prefixPath.concat(u.collectionGroup,u.documentId)),u);s=s.insert(p.key,p),s.size===i&&d.done()}).next(()=>s)}newChangeBuffer(e){return new od(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(t=>t.byteSize)}getMetadata(e){return Ty(e).get("remoteDocumentGlobalKey").next(t=>(j(!!t),t))}nr(e,t){return Ty(e).put("remoteDocumentGlobalKey",t)}rr(e,t){if(t){let r=e0(this.serializer,t);if(!(r.isNoDocument()&&r.version.isEqual(z.min())))return r}return Fe.newInvalidDocument(e)}};function jv(n){return new sd(n)}var od=class extends Cl{constructor(e,t){super(),this.ur=e,this.trackRemovals=t,this.cr=new Wt(r=>r.toString(),(r,i)=>r.isEqual(i))}applyChanges(e){let t=[],r=0,i=new de((s,o)=>Y(s.canonicalString(),o.canonicalString()));return this.changes.forEach((s,o)=>{let a=this.cr.get(s);if(t.push(this.ur.removeEntry(e,s,a.readTime)),o.isValidDocument()){let c=cy(this.ur.serializer,o);i=i.add(s.path.popLast());let u=Al(c);r+=u-a.size,t.push(this.ur.addEntry(e,s,c))}else if(r-=a.size,this.trackRemovals){let c=cy(this.ur.serializer,o.convertToNoDocument(z.min()));t.push(this.ur.addEntry(e,s,c))}}),i.forEach(s=>{t.push(this.ur.indexManager.addToCollectionParentIndex(e,s))}),t.push(this.ur.updateMetadata(e,r)),b.waitFor(t)}getFromCache(e,t){return this.ur.ir(e,t).next(r=>(this.cr.set(t,{size:r.size,readTime:r.document.readTime}),r.document))}getAllFromCache(e,t){return this.ur._r(e,t).next(({documents:r,ar:i})=>(i.forEach((s,o)=>{this.cr.set(s,{size:o,readTime:r.get(s).readTime})}),r))}};function Ty(n){return Ue(n,"remoteDocumentGlobal")}function _r(n){return Ue(n,"remoteDocumentsV14")}function Hs(n){let e=n.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Iy(n,e){let t=e.documentKey.path.toArray();return[n,wl(e.readTime),t.slice(0,t.length-2),t.length>0?t[t.length-1]:""]}function Ay(n,e){let t=n.path.toArray(),r=e.path.toArray(),i=0;for(let s=0;s<t.length-2&&s<r.length-2;++s)if(i=Y(t[s],r[s]),i)return i;return i=Y(t.length,r.length),i||(i=Y(t[t.length-2],r[r.length-2]),i||Y(t[t.length-1],r[r.length-1]))}var ad=class{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}};var bl=class{constructor(e,t,r,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=r,this.indexManager=i}getDocument(e,t){let r=null;return this.documentOverlayCache.getOverlay(e,t).next(i=>(r=i,this.remoteDocumentCache.getEntry(e,t))).next(i=>(r!==null&&to(r.mutation,i,ft.empty(),we.now()),i))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.getLocalViewOfDocuments(e,r,X()).next(()=>r))}getLocalViewOfDocuments(e,t,r=X()){let i=Bt();return this.populateOverlays(e,i,t).next(()=>this.computeViews(e,t,i,r).next(s=>{let o=Js();return s.forEach((a,c)=>{o=o.insert(a,c.overlayedDocument)}),o}))}getOverlayedDocuments(e,t){let r=Bt();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,X()))}populateOverlays(e,t,r){let i=[];return r.forEach(s=>{t.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(e,i).next(s=>{s.forEach((o,a)=>{t.set(o,a)})})}computeViews(e,t,r,i){let s=ct(),o=eo(),a=function(){return eo()}();return t.forEach((c,u)=>{let d=r.get(u.key);i.has(u.key)&&(d===void 0||d.mutation instanceof kt)?s=s.insert(u.key,u):d!==void 0?(o.set(u.key,d.mutation.getFieldMask()),to(d.mutation,u,d.mutation.getFieldMask(),we.now())):o.set(u.key,ft.empty())}),this.recalculateAndSaveOverlays(e,s).next(c=>(c.forEach((u,d)=>o.set(u,d)),t.forEach((u,d)=>{var p;return a.set(u,new ad(d,(p=o.get(u))!==null&&p!==void 0?p:null))}),a))}recalculateAndSaveOverlays(e,t){let r=eo(),i=new _e((o,a)=>o-a),s=X();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(o=>{for(let a of o)a.keys().forEach(c=>{let u=t.get(c);if(u===null)return;let d=r.get(c)||ft.empty();d=a.applyToLocalView(u,d),r.set(c,d);let p=(i.get(a.batchId)||X()).add(c);i=i.insert(a.batchId,p)})}).next(()=>{let o=[],a=i.getReverseIterator();for(;a.hasNext();){let c=a.getNext(),u=c.key,d=c.value,p=dv();d.forEach(g=>{if(!s.has(g)){let y=wv(t.get(g),r.get(g));y!==null&&p.set(g,y),s=s.add(g)}}),o.push(this.documentOverlayCache.saveOverlays(e,u,p))}return b.waitFor(o)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.recalculateAndSaveOverlays(e,r))}getDocumentsMatchingQuery(e,t,r,i){return function(o){return U.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):gf(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,r,i):this.getDocumentsMatchingCollectionQuery(e,t,r,i)}getNextDocuments(e,t,r,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,r,i).next(s=>{let o=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,r.largestBatchId,i-s.size):b.resolve(Bt()),a=-1,c=s;return o.next(u=>b.forEach(u,(d,p)=>(a<p.largestBatchId&&(a=p.largestBatchId),s.get(d)?b.resolve():this.remoteDocumentCache.getEntry(e,d).next(g=>{c=c.insert(d,g)}))).next(()=>this.populateOverlays(e,u,s)).next(()=>this.computeViews(e,c,u,X())).next(d=>({batchId:a,changes:hv(d)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new U(t)).next(r=>{let i=Js();return r.isFoundDocument()&&(i=i.insert(r.key,r)),i})}getDocumentsMatchingCollectionGroupQuery(e,t,r,i){let s=t.collectionGroup,o=Js();return this.indexManager.getCollectionParents(e,s).next(a=>b.forEach(a,c=>{let u=function(p,g){return new xt(g,null,p.explicitOrderBy.slice(),p.filters.slice(),p.limit,p.limitType,p.startAt,p.endAt)}(t,c.child(s));return this.getDocumentsMatchingCollectionQuery(e,u,r,i).next(d=>{d.forEach((p,g)=>{o=o.insert(p,g)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(e,t,r,i){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,r.largestBatchId).next(o=>(s=o,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,r,s,i))).next(o=>{s.forEach((c,u)=>{let d=u.getKey();o.get(d)===null&&(o=o.insert(d,Fe.newInvalidDocument(d)))});let a=Js();return o.forEach((c,u)=>{let d=s.get(c);d!==void 0&&to(d.mutation,u,ft.empty(),we.now()),xo(t,u)&&(a=a.insert(c,u))}),a})}};var ld=class{constructor(e){this.serializer=e,this.lr=new Map,this.hr=new Map}getBundleMetadata(e,t){return b.resolve(this.lr.get(t))}saveBundleMetadata(e,t){return this.lr.set(t.id,function(i){return{id:i.id,version:i.version,createTime:Pe(i.createTime)}}(t)),b.resolve()}getNamedQuery(e,t){return b.resolve(this.hr.get(t))}saveNamedQuery(e,t){return this.hr.set(t.name,function(i){return{name:i.name,query:yf(i.bundledQuery),readTime:Pe(i.readTime)}}(t)),b.resolve()}};var cd=class{constructor(){this.overlays=new _e(U.comparator),this.Pr=new Map}getOverlay(e,t){return b.resolve(this.overlays.get(t))}getOverlays(e,t){let r=Bt();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){return r.forEach((i,s)=>{this.ht(e,t,s)}),b.resolve()}removeOverlaysForBatchId(e,t,r){let i=this.Pr.get(r);return i!==void 0&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.Pr.delete(r)),b.resolve()}getOverlaysForCollection(e,t,r){let i=Bt(),s=t.length+1,o=new U(t.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){let c=a.getNext().value,u=c.getKey();if(!t.isPrefixOf(u.path))break;u.path.length===s&&c.largestBatchId>r&&i.set(c.getKey(),c)}return b.resolve(i)}getOverlaysForCollectionGroup(e,t,r,i){let s=new _e((u,d)=>u-d),o=this.overlays.getIterator();for(;o.hasNext();){let u=o.getNext().value;if(u.getKey().getCollectionGroup()===t&&u.largestBatchId>r){let d=s.get(u.largestBatchId);d===null&&(d=Bt(),s=s.insert(u.largestBatchId,d)),d.set(u.getKey(),u)}}let a=Bt(),c=s.getIterator();for(;c.hasNext()&&(c.getNext().value.forEach((u,d)=>a.set(u,d)),!(a.size()>=i)););return b.resolve(a)}ht(e,t,r){let i=this.overlays.get(r.key);if(i!==null){let o=this.Pr.get(i.largestBatchId).delete(r.key);this.Pr.set(i.largestBatchId,o)}this.overlays=this.overlays.insert(r.key,new fo(t,r));let s=this.Pr.get(t);s===void 0&&(s=X(),this.Pr.set(t,s)),this.Pr.set(t,s.add(r.key))}};var ud=class{constructor(){this.sessionToken=xe.EMPTY_BYTE_STRING}getSessionToken(e){return b.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,b.resolve()}};var vo=class{constructor(){this.Ir=new de(De.Tr),this.Er=new de(De.dr)}isEmpty(){return this.Ir.isEmpty()}addReference(e,t){let r=new De(e,t);this.Ir=this.Ir.add(r),this.Er=this.Er.add(r)}Ar(e,t){e.forEach(r=>this.addReference(r,t))}removeReference(e,t){this.Rr(new De(e,t))}Vr(e,t){e.forEach(r=>this.removeReference(r,t))}mr(e){let t=new U(new se([])),r=new De(t,e),i=new De(t,e+1),s=[];return this.Er.forEachInRange([r,i],o=>{this.Rr(o),s.push(o.key)}),s}gr(){this.Ir.forEach(e=>this.Rr(e))}Rr(e){this.Ir=this.Ir.delete(e),this.Er=this.Er.delete(e)}pr(e){let t=new U(new se([])),r=new De(t,e),i=new De(t,e+1),s=X();return this.Er.forEachInRange([r,i],o=>{s=s.add(o.key)}),s}containsKey(e){let t=new De(e,0),r=this.Ir.firstAfterOrEqual(t);return r!==null&&e.isEqual(r.key)}},De=class{constructor(e,t){this.key=e,this.yr=t}static Tr(e,t){return U.comparator(e.key,t.key)||Y(e.yr,t.yr)}static dr(e,t){return Y(e.yr,t.yr)||U.comparator(e.key,t.key)}};var hd=class{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.wr=1,this.Sr=new de(De.Tr)}checkEmpty(e){return b.resolve(this.mutationQueue.length===0)}addMutationBatch(e,t,r,i){let s=this.wr;this.wr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let o=new ho(s,t,r,i);this.mutationQueue.push(o);for(let a of i)this.Sr=this.Sr.add(new De(a.key,s)),this.indexManager.addToCollectionParentIndex(e,a.key.path.popLast());return b.resolve(o)}lookupMutationBatch(e,t){return b.resolve(this.br(t))}getNextMutationBatchAfterBatchId(e,t){let r=t+1,i=this.Dr(r),s=i<0?0:i;return b.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return b.resolve(this.mutationQueue.length===0?-1:this.wr-1)}getAllMutationBatches(e){return b.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let r=new De(t,0),i=new De(t,Number.POSITIVE_INFINITY),s=[];return this.Sr.forEachInRange([r,i],o=>{let a=this.br(o.yr);s.push(a)}),b.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new de(Y);return t.forEach(i=>{let s=new De(i,0),o=new De(i,Number.POSITIVE_INFINITY);this.Sr.forEachInRange([s,o],a=>{r=r.add(a.yr)})}),b.resolve(this.Cr(r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,i=r.length+1,s=r;U.isDocumentKey(s)||(s=s.child(""));let o=new De(new U(s),0),a=new de(Y);return this.Sr.forEachWhile(c=>{let u=c.key.path;return!!r.isPrefixOf(u)&&(u.length===i&&(a=a.add(c.yr)),!0)},o),b.resolve(this.Cr(a))}Cr(e){let t=[];return e.forEach(r=>{let i=this.br(r);i!==null&&t.push(i)}),t}removeMutationBatch(e,t){j(this.vr(t.batchId,"removed")===0),this.mutationQueue.shift();let r=this.Sr;return b.forEach(t.mutations,i=>{let s=new De(i.key,t.batchId);return r=r.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)}).next(()=>{this.Sr=r})}xn(e){}containsKey(e,t){let r=new De(t,0),i=this.Sr.firstAfterOrEqual(r);return b.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return this.mutationQueue.length,b.resolve()}vr(e,t){return this.Dr(e)}Dr(e){return this.mutationQueue.length===0?0:e-this.mutationQueue[0].batchId}br(e){let t=this.Dr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}};var dd=class{constructor(e){this.Fr=e,this.docs=function(){return new _e(U.comparator)}(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let r=t.key,i=this.docs.get(r),s=i?i.size:0,o=this.Fr(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:o}),this.size+=o-s,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let r=this.docs.get(t);return b.resolve(r?r.document.mutableCopy():Fe.newInvalidDocument(t))}getEntries(e,t){let r=ct();return t.forEach(i=>{let s=this.docs.get(i);r=r.insert(i,s?s.document.mutableCopy():Fe.newInvalidDocument(i))}),b.resolve(r)}getDocumentsMatchingQuery(e,t,r,i){let s=ct(),o=t.path,a=new U(o.child("")),c=this.docs.getIteratorFrom(a);for(;c.hasNext();){let{key:u,value:{document:d}}=c.getNext();if(!o.isPrefixOf(u.path))break;u.path.length>o.length+1||uf(jy(d),r)<=0||(i.has(d.key)||xo(t,d))&&(s=s.insert(d.key,d.mutableCopy()))}return b.resolve(s)}getAllFromCollectionGroup(e,t,r,i){B()}Mr(e,t){return b.forEach(this.docs,r=>t(r))}newChangeBuffer(e){return new fd(this)}getSize(e){return b.resolve(this.size)}},fd=class extends Cl{constructor(e){super(),this.ur=e}applyChanges(e){let t=[];return this.changes.forEach((r,i)=>{i.isValidDocument()?t.push(this.ur.addEntry(e,i)):this.ur.removeEntry(r)}),b.waitFor(t)}getFromCache(e,t){return this.ur.getEntry(e,t)}getAllFromCache(e,t){return this.ur.getEntries(e,t)}};var pd=class{constructor(e){this.persistence=e,this.Or=new Wt(t=>Rr(t),Ro),this.lastRemoteSnapshotVersion=z.min(),this.highestTargetId=0,this.Nr=0,this.Lr=new vo,this.targetCount=0,this.Br=xi.Ln()}forEachTarget(e,t){return this.Or.forEach((r,i)=>t(i)),b.resolve()}getLastRemoteSnapshotVersion(e){return b.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return b.resolve(this.Nr)}allocateTargetId(e){return this.highestTargetId=this.Br.next(),b.resolve(this.highestTargetId)}setTargetsMetadata(e,t,r){return r&&(this.lastRemoteSnapshotVersion=r),t>this.Nr&&(this.Nr=t),b.resolve()}Qn(e){this.Or.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.Br=new xi(t),this.highestTargetId=t),e.sequenceNumber>this.Nr&&(this.Nr=e.sequenceNumber)}addTargetData(e,t){return this.Qn(t),this.targetCount+=1,b.resolve()}updateTargetData(e,t){return this.Qn(t),b.resolve()}removeTargetData(e,t){return this.Or.delete(t.target),this.Lr.mr(t.targetId),this.targetCount-=1,b.resolve()}removeTargets(e,t,r){let i=0,s=[];return this.Or.forEach((o,a)=>{a.sequenceNumber<=t&&r.get(a.targetId)===null&&(this.Or.delete(o),s.push(this.removeMatchingKeysForTargetId(e,a.targetId)),i++)}),b.waitFor(s).next(()=>i)}getTargetCount(e){return b.resolve(this.targetCount)}getTargetData(e,t){let r=this.Or.get(t)||null;return b.resolve(r)}addMatchingKeys(e,t,r){return this.Lr.Ar(t,r),b.resolve()}removeMatchingKeys(e,t,r){this.Lr.Vr(t,r);let i=this.persistence.referenceDelegate,s=[];return i&&t.forEach(o=>{s.push(i.markPotentiallyOrphaned(e,o))}),b.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Lr.mr(t),b.resolve()}getMatchingKeysForTargetId(e,t){let r=this.Lr.pr(t);return b.resolve(r)}containsKey(e,t){return b.resolve(this.Lr.containsKey(t))}};var Rl=class{constructor(e,t){this.kr={},this.overlays={},this.qr=new dt(0),this.Qr=!1,this.Qr=!0,this.Kr=new ud,this.referenceDelegate=e(this),this.$r=new pd(this),this.indexManager=new Xh,this.remoteDocumentCache=function(i){return new dd(i)}(r=>this.referenceDelegate.Ur(r)),this.serializer=new vl(t),this.Wr=new ld(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Qr=!1,Promise.resolve()}get started(){return this.Qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new cd,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let r=this.kr[e.toKey()];return r||(r=new hd(t,this.referenceDelegate),this.kr[e.toKey()]=r),r}getGlobalsCache(){return this.Kr}getTargetCache(){return this.$r}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Wr}runTransaction(e,t,r){V("MemoryPersistence","Starting transaction:",e);let i=new gd(this.qr.next());return this.referenceDelegate.Gr(),r(i).next(s=>this.referenceDelegate.zr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}jr(e,t){return b.or(Object.values(this.kr).map(r=>()=>r.containsKey(e,t)))}},gd=class extends al{constructor(e){super(),this.currentSequenceNumber=e}},Pl=class n{constructor(e){this.persistence=e,this.Hr=new vo,this.Jr=null}static Yr(e){return new n(e)}get Zr(){if(this.Jr)return this.Jr;throw B()}addReference(e,t,r){return this.Hr.addReference(r,t),this.Zr.delete(r.toString()),b.resolve()}removeReference(e,t,r){return this.Hr.removeReference(r,t),this.Zr.add(r.toString()),b.resolve()}markPotentiallyOrphaned(e,t){return this.Zr.add(t.toString()),b.resolve()}removeTarget(e,t){this.Hr.mr(t.targetId).forEach(i=>this.Zr.add(i.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(i=>{i.forEach(s=>this.Zr.add(s.toString()))}).next(()=>r.removeTargetData(e,t))}Gr(){this.Jr=new Set}zr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return b.forEach(this.Zr,r=>{let i=U.fromPath(r);return this.Xr(e,i).next(s=>{s||t.removeEntry(i,z.min())})}).next(()=>(this.Jr=null,t.apply(e)))}updateLimboDocument(e,t){return this.Xr(e,t).next(r=>{r?this.Zr.delete(t.toString()):this.Zr.add(t.toString())})}Ur(e){return 0}Xr(e,t){return b.or([()=>b.resolve(this.Hr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.jr(e,t)])}};var md=class{constructor(e){this.serializer=e}O(e,t,r,i){let s=new ll("createOrUpgrade",t);r<1&&i>=1&&(function(c){c.createObjectStore("owner")}(e),function(c){c.createObjectStore("mutationQueues",{keyPath:"userId"}),c.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",q_,{unique:!0}),c.createObjectStore("documentMutations")}(e),Sy(e),function(c){c.createObjectStore("remoteDocuments")}(e));let o=b.resolve();return r<3&&i>=3&&(r!==0&&(function(c){c.deleteObjectStore("targetDocuments"),c.deleteObjectStore("targets"),c.deleteObjectStore("targetGlobal")}(e),Sy(e)),o=o.next(()=>function(c){let u=c.store("targetGlobal"),d={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:z.min().toTimestamp(),targetCount:0};return u.put("targetGlobalKey",d)}(s))),r<4&&i>=4&&(r!==0&&(o=o.next(()=>function(c,u){return u.store("mutations").U().next(d=>{c.deleteObjectStore("mutations"),c.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",q_,{unique:!0});let p=u.store("mutations"),g=d.map(y=>p.put(y));return b.waitFor(g)})}(e,s))),o=o.next(()=>{(function(c){c.createObjectStore("clientMetadata",{keyPath:"clientId"})})(e)})),r<5&&i>=5&&(o=o.next(()=>this.ti(s))),r<6&&i>=6&&(o=o.next(()=>(function(c){c.createObjectStore("remoteDocumentGlobal")}(e),this.ni(s)))),r<7&&i>=7&&(o=o.next(()=>this.ri(s))),r<8&&i>=8&&(o=o.next(()=>this.ii(e,s))),r<9&&i>=9&&(o=o.next(()=>{(function(c){c.objectStoreNames.contains("remoteDocumentChanges")&&c.deleteObjectStore("remoteDocumentChanges")})(e)})),r<10&&i>=10&&(o=o.next(()=>this.si(s))),r<11&&i>=11&&(o=o.next(()=>{(function(c){c.createObjectStore("bundles",{keyPath:"bundleId"})})(e),function(c){c.createObjectStore("namedQueries",{keyPath:"name"})}(e)})),r<12&&i>=12&&(o=o.next(()=>{(function(c){let u=c.createObjectStore("documentOverlays",{keyPath:wS});u.createIndex("collectionPathOverlayIndex",ES,{unique:!1}),u.createIndex("collectionGroupOverlayIndex",TS,{unique:!1})})(e)})),r<13&&i>=13&&(o=o.next(()=>function(c){let u=c.createObjectStore("remoteDocumentsV14",{keyPath:cS});u.createIndex("documentKeyIndex",uS),u.createIndex("collectionGroupIndex",hS)}(e)).next(()=>this.oi(e,s)).next(()=>e.deleteObjectStore("remoteDocuments"))),r<14&&i>=14&&(o=o.next(()=>this._i(e,s))),r<15&&i>=15&&(o=o.next(()=>function(c){c.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),c.createObjectStore("indexState",{keyPath:mS}).createIndex("sequenceNumberIndex",_S,{unique:!1}),c.createObjectStore("indexEntries",{keyPath:yS}).createIndex("documentKeyIndex",vS,{unique:!1})}(e))),r<16&&i>=16&&(o=o.next(()=>{t.objectStore("indexState").clear()}).next(()=>{t.objectStore("indexEntries").clear()})),r<17&&i>=17&&(o=o.next(()=>{(function(c){c.createObjectStore("globals",{keyPath:"name"})})(e)})),o}ni(e){let t=0;return e.store("remoteDocuments").J((r,i)=>{t+=Al(i)}).next(()=>{let r={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",r)})}ti(e){let t=e.store("mutationQueues"),r=e.store("mutations");return t.U().next(i=>b.forEach(i,s=>{let o=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return r.U("userMutationsIndex",o).next(a=>b.forEach(a,c=>{j(c.userId===s.userId);let u=wr(this.serializer,c);return Bv(e,s.userId,u).next(()=>{})}))}))}ri(e){let t=e.store("targetDocuments"),r=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{let s=[];return r.J((o,a)=>{let c=new se(o),u=function(p){return[0,nt(p)]}(c);s.push(t.get(u).next(d=>d?b.resolve():(p=>t.put({targetId:0,path:nt(p),sequenceNumber:i.highestListenSequenceNumber}))(c)))}).next(()=>b.waitFor(s))})}ii(e,t){e.createObjectStore("collectionParents",{keyPath:gS});let r=t.store("collectionParents"),i=new yo,s=o=>{if(i.add(o)){let a=o.lastSegment(),c=o.popLast();return r.put({collectionId:a,parent:nt(c)})}};return t.store("remoteDocuments").J({H:!0},(o,a)=>{let c=new se(o);return s(c.popLast())}).next(()=>t.store("documentMutations").J({H:!0},([o,a,c],u)=>{let d=Ut(a);return s(d.popLast())}))}si(e){let t=e.store("targets");return t.J((r,i)=>{let s=Xs(i),o=Mv(this.serializer,s);return t.put(o)})}oi(e,t){let r=t.store("remoteDocuments"),i=[];return r.J((s,o)=>{let a=t.store("remoteDocumentsV14"),c=function(p){return p.document?new U(se.fromString(p.document.name).popFirst(5)):p.noDocument?U.fromSegments(p.noDocument.path):p.unknownDocument?U.fromSegments(p.unknownDocument.path):B()}(o).path.toArray(),u={prefixPath:c.slice(0,c.length-2),collectionGroup:c[c.length-2],documentId:c[c.length-1],readTime:o.readTime||[0,0],unknownDocument:o.unknownDocument,noDocument:o.noDocument,document:o.document,hasCommittedMutations:!!o.hasCommittedMutations};i.push(a.put(u))}).next(()=>b.waitFor(i))}_i(e,t){let r=t.store("mutations"),i=jv(this.serializer),s=new Rl(Pl.Yr,this.serializer.ct);return r.U().next(o=>{let a=new Map;return o.forEach(c=>{var u;let d=(u=a.get(c.userId))!==null&&u!==void 0?u:X();wr(this.serializer,c).keys().forEach(p=>d=d.add(p)),a.set(c.userId,d)}),b.forEach(a,(c,u)=>{let d=new Ve(u),p=El.lt(this.serializer,d),g=s.getIndexManager(d),y=Sl.lt(d,this.serializer,g,s.referenceDelegate);return new bl(i,y,p,g).recalculateAndSaveOverlaysForDocumentKeys(new oo(t,dt.oe),c).next()})})}};function Sy(n){n.createObjectStore("targetDocuments",{keyPath:fS}).createIndex("documentTargetsIndex",pS,{unique:!0}),n.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",dS,{unique:!0}),n.createObjectStore("targetGlobal")}var sh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",_d=class n{constructor(e,t,r,i,s,o,a,c,u,d,p=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=r,this.ai=s,this.window=o,this.document=a,this.ui=u,this.ci=d,this.li=p,this.qr=null,this.Qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.hi=null,this.inForeground=!1,this.Pi=null,this.Ii=null,this.Ti=Number.NEGATIVE_INFINITY,this.Ei=g=>Promise.resolve(),!n.D())throw new D(R.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new id(this,i),this.di=t+"main",this.serializer=new vl(c),this.Ai=new Gn(this.di,this.li,new md(this.serializer)),this.Kr=new Kh,this.$r=new ed(this.referenceDelegate,this.serializer),this.remoteDocumentCache=jv(this.serializer),this.Wr=new zh,this.window&&this.window.localStorage?this.Ri=this.window.localStorage:(this.Ri=null,d===!1&&be("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Vi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new D(R.FAILED_PRECONDITION,sh);return this.mi(),this.fi(),this.gi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.$r.getHighestSequenceNumber(e))}).then(e=>{this.qr=new dt(e,this.ui)}).then(()=>{this.Qr=!0}).catch(e=>(this.Ai&&this.Ai.close(),Promise.reject(e)))}pi(e){return this.Ei=t=>x(this,null,function*(){if(this.started)return e(t)}),e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ai.L(t=>x(this,null,function*(){t.newVersion===null&&(yield e())}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ai.enqueueAndForget(()=>x(this,null,function*(){this.started&&(yield this.Vi())})))}Vi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>Ya(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.yi(e).next(t=>{t||(this.isPrimary=!1,this.ai.enqueueRetryable(()=>this.Ei(!1)))})}).next(()=>this.wi(e)).next(t=>this.isPrimary&&!t?this.Si(e).next(()=>!1):!!t&&this.bi(e).next(()=>!0))).catch(e=>{if(Xn(e))return V("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return V("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ai.enqueueRetryable(()=>this.Ei(e)),this.isPrimary=e})}yi(e){return Ys(e).get("owner").next(t=>b.resolve(this.Di(t)))}Ci(e){return Ya(e).delete(this.clientId)}vi(){return x(this,null,function*(){if(this.isPrimary&&!this.Fi(this.Ti,18e5)){this.Ti=Date.now();let e=yield this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",t=>{let r=Ue(t,"clientMetadata");return r.U().next(i=>{let s=this.Mi(i,18e5),o=i.filter(a=>s.indexOf(a)===-1);return b.forEach(o,a=>r.delete(a.clientId)).next(()=>o)})}).catch(()=>[]);if(this.Ri)for(let t of e)this.Ri.removeItem(this.xi(t.clientId))}})}gi(){this.Ii=this.ai.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Vi().then(()=>this.vi()).then(()=>this.gi()))}Di(e){return!!e&&e.ownerId===this.clientId}wi(e){return this.ci?b.resolve(!0):Ys(e).get("owner").next(t=>{if(t!==null&&this.Fi(t.leaseTimestampMs,5e3)&&!this.Oi(t.ownerId)){if(this.Di(t)&&this.networkEnabled)return!0;if(!this.Di(t)){if(!t.allowTabSynchronization)throw new D(R.FAILED_PRECONDITION,sh);return!1}}return!(!this.networkEnabled||!this.inForeground)||Ya(e).U().next(r=>this.Mi(r,5e3).find(i=>{if(this.clientId!==i.clientId){let s=!this.networkEnabled&&i.networkEnabled,o=!this.inForeground&&i.inForeground,a=this.networkEnabled===i.networkEnabled;if(s||o&&a)return!0}return!1})===void 0)}).next(t=>(this.isPrimary!==t&&V("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}shutdown(){return x(this,null,function*(){this.Qr=!1,this.Ni(),this.Ii&&(this.Ii.cancel(),this.Ii=null),this.Li(),this.Bi(),yield this.Ai.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{let t=new oo(e,dt.oe);return this.Si(t).next(()=>this.Ci(t))}),this.Ai.close(),this.ki()})}Mi(e,t){return e.filter(r=>this.Fi(r.updateTimeMs,t)&&!this.Oi(r.clientId))}qi(){return this.runTransaction("getActiveClients","readonly",e=>Ya(e).U().next(t=>this.Mi(t,18e5).map(r=>r.clientId)))}get started(){return this.Qr}getGlobalsCache(){return this.Kr}getMutationQueue(e,t){return Sl.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.$r}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Zh(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return El.lt(this.serializer,e)}getBundleCache(){return this.Wr}runTransaction(e,t,r){V("IndexedDbPersistence","Starting transaction:",e);let i=t==="readonly"?"readonly":"readwrite",s=function(c){return c===17?SS:c===16?AS:c===15?df:c===14?Yy:c===13?Hy:c===12?IS:c===11?Qy:void B()}(this.li),o;return this.Ai.runTransaction(e,i,s,a=>(o=new oo(a,this.qr?this.qr.next():dt.oe),t==="readwrite-primary"?this.yi(o).next(c=>!!c||this.wi(o)).next(c=>{if(!c)throw be(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ai.enqueueRetryable(()=>this.Ei(!1)),new D(R.FAILED_PRECONDITION,zy);return r(o)}).next(c=>this.bi(o).next(()=>c)):this.Qi(o).next(()=>r(o)))).then(a=>(o.raiseOnCommittedEvent(),a))}Qi(e){return Ys(e).get("owner").next(t=>{if(t!==null&&this.Fi(t.leaseTimestampMs,5e3)&&!this.Oi(t.ownerId)&&!this.Di(t)&&!(this.ci||this.allowTabSynchronization&&t.allowTabSynchronization))throw new D(R.FAILED_PRECONDITION,sh)})}bi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Ys(e).put("owner",t)}static D(){return Gn.D()}Si(e){let t=Ys(e);return t.get("owner").next(r=>this.Di(r)?(V("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):b.resolve())}Fi(e,t){let r=Date.now();return!(e<r-t)&&(!(e>r)||(be(`Detected an update time that is in the future: ${e} > ${r}`),!1))}mi(){this.document!==null&&typeof this.document.addEventListener=="function"&&(this.Pi=()=>{this.ai.enqueueAndForget(()=>(this.inForeground=this.document.visibilityState==="visible",this.Vi()))},this.document.addEventListener("visibilitychange",this.Pi),this.inForeground=this.document.visibilityState==="visible")}Li(){this.Pi&&(this.document.removeEventListener("visibilitychange",this.Pi),this.Pi=null)}fi(){var e;typeof((e=this.window)===null||e===void 0?void 0:e.addEventListener)=="function"&&(this.hi=()=>{this.Ni();let t=/(?:Version|Mobile)\/1[456]/;Mu()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.ai.enterRestrictedMode(!0),this.ai.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.hi))}Bi(){this.hi&&(this.window.removeEventListener("pagehide",this.hi),this.hi=null)}Oi(e){var t;try{let r=((t=this.Ri)===null||t===void 0?void 0:t.getItem(this.xi(e)))!==null;return V("IndexedDbPersistence",`Client '${e}' ${r?"is":"is not"} zombied in LocalStorage`),r}catch(r){return be("IndexedDbPersistence","Failed to get zombied client id.",r),!1}}Ni(){if(this.Ri)try{this.Ri.setItem(this.xi(this.clientId),String(Date.now()))}catch(e){be("Failed to set zombie client id.",e)}}ki(){if(this.Ri)try{this.Ri.removeItem(this.xi(this.clientId))}catch{}}xi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}};function Ys(n){return Ue(n,"owner")}function Ya(n){return Ue(n,"clientMetadata")}function wf(n,e){let t=n.projectId;return n.isDefaultDatabase||(t+="."+n.database),"firestore/"+e+"/"+t+"/"}var yd=class n{constructor(e,t,r,i){this.targetId=e,this.fromCache=t,this.Ki=r,this.$i=i}static Ui(e,t){let r=X(),i=X();for(let s of t.docChanges)switch(s.type){case 0:r=r.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new n(e,t.fromCache,r,i)}};var vd=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}};var xl=class{constructor(){this.Wi=!1,this.Gi=!1,this.zi=100,this.ji=function(){return Mu()?8:Ky(Vs())>0?6:4}()}initialize(e,t){this.Hi=e,this.indexManager=t,this.Wi=!0}getDocumentsMatchingQuery(e,t,r,i){let s={result:null};return this.Ji(e,t).next(o=>{s.result=o}).next(()=>{if(!s.result)return this.Yi(e,t,i,r).next(o=>{s.result=o})}).next(()=>{if(s.result)return;let o=new vd;return this.Zi(e,t,o).next(a=>{if(s.result=a,this.Gi)return this.Xi(e,t,o,a.size)})}).next(()=>s.result)}Xi(e,t,r,i){return r.documentReadCount<this.zi?(fi()<=vt.DEBUG&&V("QueryEngine","SDK will not create cache indexes for query:",pi(t),"since it only creates cache indexes for collection contains","more than or equal to",this.zi,"documents"),b.resolve()):(fi()<=vt.DEBUG&&V("QueryEngine","Query:",pi(t),"scans",r.documentReadCount,"local documents and returns",i,"documents as results."),r.documentReadCount>this.ji*i?(fi()<=vt.DEBUG&&V("QueryEngine","The SDK decides to create cache indexes for query:",pi(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,rt(t))):b.resolve())}Ji(e,t){if(X_(t))return b.resolve(null);let r=rt(t);return this.indexManager.getIndexType(e,r).next(i=>i===0?null:(t.limit!==null&&i===1&&(t=gl(t,null,"F"),r=rt(t)),this.indexManager.getDocumentsMatchingTarget(e,r).next(s=>{let o=X(...s);return this.Hi.getDocuments(e,o).next(a=>this.indexManager.getMinOffset(e,r).next(c=>{let u=this.es(t,a);return this.ts(t,u,o,c.readTime)?this.Ji(e,gl(t,null,"F")):this.ns(e,u,t,c)}))})))}Yi(e,t,r,i){return X_(t)||i.isEqual(z.min())?b.resolve(null):this.Hi.getDocuments(e,r).next(s=>{let o=this.es(t,s);return this.ts(t,o,r,i)?b.resolve(null):(fi()<=vt.DEBUG&&V("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),pi(t)),this.ns(e,o,t,Gy(i,-1)).next(a=>a))})}es(e,t){let r=new de(cv(e));return t.forEach((i,s)=>{xo(e,s)&&(r=r.add(s))}),r}ts(e,t,r,i){if(e.limit===null)return!1;if(r.size!==t.size)return!0;let s=e.limitType==="F"?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Zi(e,t,r){return fi()<=vt.DEBUG&&V("QueryEngine","Using full collection scan to execute query:",pi(t)),this.Hi.getDocumentsMatchingQuery(e,t,Tt.min(),r)}ns(e,t,r,i){return this.Hi.getDocumentsMatchingQuery(e,r,i).next(s=>(t.forEach(o=>{s=s.insert(o.key,o)}),s))}};var wd=class{constructor(e,t,r,i){this.persistence=e,this.rs=t,this.serializer=i,this.ss=new _e(Y),this.os=new Wt(s=>Rr(s),Ro),this._s=new Map,this.us=e.getRemoteDocumentCache(),this.$r=e.getTargetCache(),this.Wr=e.getBundleCache(),this.cs(r)}cs(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new bl(this.us,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.us.setIndexManager(this.indexManager),this.rs.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.ss))}};function zv(n,e,t,r){return new wd(n,e,t,r)}function Kv(n,e){return x(this,null,function*(){let t=L(n);return yield t.persistence.runTransaction("Handle user change","readonly",r=>{let i;return t.mutationQueue.getAllMutationBatches(r).next(s=>(i=s,t.cs(e),t.mutationQueue.getAllMutationBatches(r))).next(s=>{let o=[],a=[],c=X();for(let u of i){o.push(u.batchId);for(let d of u.mutations)c=c.add(d.key)}for(let u of s){a.push(u.batchId);for(let d of u.mutations)c=c.add(d.key)}return t.localDocuments.getDocuments(r,c).next(u=>({ls:u,removedBatchIds:o,addedBatchIds:a}))})})})}function i0(n,e){let t=L(n);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",r=>{let i=e.batch.keys(),s=t.us.newChangeBuffer({trackRemovals:!0});return function(a,c,u,d){let p=u.batch,g=p.keys(),y=b.resolve();return g.forEach(S=>{y=y.next(()=>d.getEntry(c,S)).next(k=>{let N=u.docVersions.get(S);j(N!==null),k.version.compareTo(N)<0&&(p.applyToRemoteDocument(k,u),k.isValidDocument()&&(k.setReadTime(u.commitVersion),d.addEntry(k)))})}),y.next(()=>a.mutationQueue.removeMutationBatch(c,p))}(t,r,e,s).next(()=>s.apply(r)).next(()=>t.mutationQueue.performConsistencyCheck(r)).next(()=>t.documentOverlayCache.removeOverlaysForBatchId(r,i,e.batch.batchId)).next(()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(r,function(a){let c=X();for(let u=0;u<a.mutationResults.length;++u)a.mutationResults[u].transformResults.length>0&&(c=c.add(a.batch.mutations[u].key));return c}(e))).next(()=>t.localDocuments.getDocuments(r,i))})}function Wv(n){let e=L(n);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.$r.getLastRemoteSnapshotVersion(t))}function s0(n,e){let t=L(n),r=e.snapshotVersion,i=t.ss;return t.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{let o=t.us.newChangeBuffer({trackRemovals:!0});i=t.ss;let a=[];e.targetChanges.forEach((d,p)=>{let g=i.get(p);if(!g)return;a.push(t.$r.removeMatchingKeys(s,d.removedDocuments,p).next(()=>t.$r.addMatchingKeys(s,d.addedDocuments,p)));let y=g.withSequenceNumber(s.currentSequenceNumber);e.targetMismatches.get(p)!==null?y=y.withResumeToken(xe.EMPTY_BYTE_STRING,z.min()).withLastLimboFreeSnapshotVersion(z.min()):d.resumeToken.approximateByteSize()>0&&(y=y.withResumeToken(d.resumeToken,r)),i=i.insert(p,y),function(k,N,q){return k.resumeToken.approximateByteSize()===0||N.snapshotVersion.toMicroseconds()-k.snapshotVersion.toMicroseconds()>=3e8?!0:q.addedDocuments.size+q.modifiedDocuments.size+q.removedDocuments.size>0}(g,y,d)&&a.push(t.$r.updateTargetData(s,y))});let c=ct(),u=X();if(e.documentUpdates.forEach(d=>{e.resolvedLimboDocuments.has(d)&&a.push(t.persistence.referenceDelegate.updateLimboDocument(s,d))}),a.push($v(s,o,e.documentUpdates).next(d=>{c=d.hs,u=d.Ps})),!r.isEqual(z.min())){let d=t.$r.getLastRemoteSnapshotVersion(s).next(p=>t.$r.setTargetsMetadata(s,s.currentSequenceNumber,r));a.push(d)}return b.waitFor(a).next(()=>o.apply(s)).next(()=>t.localDocuments.getLocalViewOfDocuments(s,c,u)).next(()=>c)}).then(s=>(t.ss=i,s))}function $v(n,e,t){let r=X(),i=X();return t.forEach(s=>r=r.add(s)),e.getEntries(n,r).next(s=>{let o=ct();return t.forEach((a,c)=>{let u=s.get(a);c.isFoundDocument()!==u.isFoundDocument()&&(i=i.add(a)),c.isNoDocument()&&c.version.isEqual(z.min())?(e.removeEntry(a,c.readTime),o=o.insert(a,c)):!u.isValidDocument()||c.version.compareTo(u.version)>0||c.version.compareTo(u.version)===0&&u.hasPendingWrites?(e.addEntry(c),o=o.insert(a,c)):V("LocalStore","Ignoring outdated watch update for ",a,". Current version:",u.version," Watch version:",c.version)}),{hs:o,Ps:i}})}function o0(n,e){let t=L(n);return t.persistence.runTransaction("Get next mutation batch","readonly",r=>(e===void 0&&(e=-1),t.mutationQueue.getNextMutationBatchAfterBatchId(r,e)))}function ki(n,e){let t=L(n);return t.persistence.runTransaction("Allocate target","readwrite",r=>{let i;return t.$r.getTargetData(r,e).next(s=>s?(i=s,b.resolve(i)):t.$r.allocateTargetId(r).next(o=>(i=new Pi(e,o,"TargetPurposeListen",r.currentSequenceNumber),t.$r.addTargetData(r,i).next(()=>i))))}).then(r=>{let i=t.ss.get(r.targetId);return(i===null||r.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(t.ss=t.ss.insert(r.targetId,r),t.os.set(e,r.targetId)),r})}function Ni(n,e,t){return x(this,null,function*(){let r=L(n),i=r.ss.get(e),s=t?"readwrite":"readwrite-primary";try{t||(yield r.persistence.runTransaction("Release target",s,o=>r.persistence.referenceDelegate.removeTarget(o,i)))}catch(o){if(!Xn(o))throw o;V("LocalStore",`Failed to update sequence numbers for target ${e}: ${o}`)}r.ss=r.ss.remove(e),r.os.delete(i.target)})}function kl(n,e,t){let r=L(n),i=z.min(),s=X();return r.persistence.runTransaction("Execute query","readwrite",o=>function(c,u,d){let p=L(c),g=p.os.get(d);return g!==void 0?b.resolve(p.ss.get(g)):p.$r.getTargetData(u,d)}(r,o,rt(e)).next(a=>{if(a)return i=a.lastLimboFreeSnapshotVersion,r.$r.getMatchingKeysForTargetId(o,a.targetId).next(c=>{s=c})}).next(()=>r.rs.getDocumentsMatchingQuery(o,e,t?i:z.min(),t?s:X())).next(a=>(Yv(r,lv(e),a),{documents:a,Is:s})))}function Qv(n,e){let t=L(n),r=L(t.$r),i=t.ss.get(e);return i?Promise.resolve(i.target):t.persistence.runTransaction("Get target data","readonly",s=>r.ot(s,e).next(o=>o?o.target:null))}function Hv(n,e){let t=L(n),r=t._s.get(e)||z.min();return t.persistence.runTransaction("Get new document changes","readonly",i=>t.us.getAllFromCollectionGroup(i,e,Gy(r,-1),Number.MAX_SAFE_INTEGER)).then(i=>(Yv(t,e,i),i))}function Yv(n,e,t){let r=n._s.get(e)||z.min();t.forEach((i,s)=>{s.readTime.compareTo(r)>0&&(r=s.readTime)}),n._s.set(e,r)}function a0(n,e,t,r){return x(this,null,function*(){let i=L(n),s=X(),o=ct();for(let u of t){let d=e.Ts(u.metadata.name);u.document&&(s=s.add(d));let p=e.Es(u);p.setReadTime(e.ds(u.metadata.readTime)),o=o.insert(d,p)}let a=i.us.newChangeBuffer({trackRemovals:!0}),c=yield ki(i,function(d){return rt(Bi(se.fromString(`__bundle__/docs/${d}`)))}(r));return i.persistence.runTransaction("Apply bundle documents","readwrite",u=>$v(u,a,o).next(d=>(a.apply(u),d)).next(d=>i.$r.removeMatchingKeysForTargetId(u,c.targetId).next(()=>i.$r.addMatchingKeys(u,s,c.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(u,d.hs,d.Ps)).next(()=>d.hs)))})}function l0(r,i){return x(this,arguments,function*(n,e,t=X()){let s=yield ki(n,rt(yf(e.bundledQuery))),o=L(n);return o.persistence.runTransaction("Save named query","readwrite",a=>{let c=Pe(e.readTime);if(s.snapshotVersion.compareTo(c)>=0)return o.Wr.saveNamedQuery(a,e);let u=s.withResumeToken(xe.EMPTY_BYTE_STRING,c);return o.ss=o.ss.insert(u.targetId,u),o.$r.updateTargetData(a,u).next(()=>o.$r.removeMatchingKeysForTargetId(a,s.targetId)).next(()=>o.$r.addMatchingKeys(a,t,s.targetId)).next(()=>o.Wr.saveNamedQuery(a,e))})})}function Cy(n,e){return`firestore_clients_${n}_${e}`}function by(n,e,t){let r=`firestore_mutations_${n}_${t}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function oh(n,e){return`firestore_targets_${n}_${e}`}var Nl=class n{constructor(e,t,r,i){this.user=e,this.batchId=t,this.state=r,this.error=i}static As(e,t,r){let i=JSON.parse(r),s,o=typeof i=="object"&&["pending","acknowledged","rejected"].indexOf(i.state)!==-1&&(i.error===void 0||typeof i.error=="object");return o&&i.error&&(o=typeof i.error.message=="string"&&typeof i.error.code=="string",o&&(s=new D(i.error.code,i.error.message))),o?new n(e,t,i.state,s):(be("SharedClientState",`Failed to parse mutation state for ID '${t}': ${r}`),null)}Rs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}},no=class n{constructor(e,t,r){this.targetId=e,this.state=t,this.error=r}static As(e,t){let r=JSON.parse(t),i,s=typeof r=="object"&&["not-current","current","rejected"].indexOf(r.state)!==-1&&(r.error===void 0||typeof r.error=="object");return s&&r.error&&(s=typeof r.error.message=="string"&&typeof r.error.code=="string",s&&(i=new D(r.error.code,r.error.message))),s?new n(e,r.state,i):(be("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Rs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}},Dl=class n{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static As(e,t){let r=JSON.parse(t),i=typeof r=="object"&&r.activeTargetIds instanceof Array,s=mf();for(let o=0;i&&o<r.activeTargetIds.length;++o)i=Wy(r.activeTargetIds[o]),s=s.add(r.activeTargetIds[o]);return i?new n(e,s):(be("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}},Ed=class n{constructor(e,t){this.clientId=e,this.onlineState=t}static As(e){let t=JSON.parse(e);return typeof t=="object"&&["Unknown","Online","Offline"].indexOf(t.onlineState)!==-1&&typeof t.clientId=="string"?new n(t.clientId,t.onlineState):(be("SharedClientState",`Failed to parse online state: ${e}`),null)}},wo=class{constructor(){this.activeTargetIds=mf()}Vs(e){this.activeTargetIds=this.activeTargetIds.add(e)}fs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Rs(){let e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}},ro=class{constructor(e,t,r,i,s){this.window=e,this.ai=t,this.persistenceKey=r,this.gs=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ps=this.ys.bind(this),this.ws=new _e(Y),this.started=!1,this.Ss=[];let o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.bs=Cy(this.persistenceKey,this.gs),this.Ds=function(c){return`firestore_sequence_number_${c}`}(this.persistenceKey),this.ws=this.ws.insert(this.gs,new wo),this.Cs=new RegExp(`^firestore_clients_${o}_([^_]*)$`),this.vs=new RegExp(`^firestore_mutations_${o}_(\\d+)(?:_(.*))?$`),this.Fs=new RegExp(`^firestore_targets_${o}_(\\d+)$`),this.Ms=function(c){return`firestore_online_state_${c}`}(this.persistenceKey),this.xs=function(c){return`firestore_bundle_loaded_v2_${c}`}(this.persistenceKey),this.window.addEventListener("storage",this.ps)}static D(e){return!(!e||!e.localStorage)}start(){return x(this,null,function*(){let e=yield this.syncEngine.qi();for(let r of e){if(r===this.gs)continue;let i=this.getItem(Cy(this.persistenceKey,r));if(i){let s=Dl.As(r,i);s&&(this.ws=this.ws.insert(s.clientId,s))}}this.Os();let t=this.storage.getItem(this.Ms);if(t){let r=this.Ns(t);r&&this.Ls(r)}for(let r of this.Ss)this.ys(r);this.Ss=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0})}writeSequenceNumber(e){this.setItem(this.Ds,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Bs(this.ws)}isActiveQueryTarget(e){let t=!1;return this.ws.forEach((r,i)=>{i.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.ks(e,"pending")}updateMutationState(e,t,r){this.ks(e,t,r),this.qs(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){let r=this.storage.getItem(oh(this.persistenceKey,e));if(r){let i=no.As(e,r);i&&(t=i.state)}}return this.Qs.Vs(e),this.Os(),t}removeLocalQueryTarget(e){this.Qs.fs(e),this.Os()}isLocalQueryTarget(e){return this.Qs.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(oh(this.persistenceKey,e))}updateQueryState(e,t,r){this.Ks(e,t,r)}handleUserChange(e,t,r){t.forEach(i=>{this.qs(i)}),this.currentUser=e,r.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(e){this.$s(e)}notifyBundleLoaded(e){this.Us(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ps),this.removeItem(this.bs),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return V("SharedClientState","READ",e,t),t}setItem(e,t){V("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){V("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ys(e){let t=e;if(t.storageArea===this.storage){if(V("SharedClientState","EVENT",t.key,t.newValue),t.key===this.bs)return void be("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ai.enqueueRetryable(()=>x(this,null,function*(){if(this.started){if(t.key!==null){if(this.Cs.test(t.key)){if(t.newValue==null){let r=this.Ws(t.key);return this.Gs(r,null)}{let r=this.zs(t.key,t.newValue);if(r)return this.Gs(r.clientId,r)}}else if(this.vs.test(t.key)){if(t.newValue!==null){let r=this.js(t.key,t.newValue);if(r)return this.Hs(r)}}else if(this.Fs.test(t.key)){if(t.newValue!==null){let r=this.Js(t.key,t.newValue);if(r)return this.Ys(r)}}else if(t.key===this.Ms){if(t.newValue!==null){let r=this.Ns(t.newValue);if(r)return this.Ls(r)}}else if(t.key===this.Ds){let r=function(s){let o=dt.oe;if(s!=null)try{let a=JSON.parse(s);j(typeof a=="number"),o=a}catch(a){be("SharedClientState","Failed to read sequence number from WebStorage",a)}return o}(t.newValue);r!==dt.oe&&this.sequenceNumberHandler(r)}else if(t.key===this.xs){let r=this.Zs(t.newValue);yield Promise.all(r.map(i=>this.syncEngine.Xs(i)))}}}else this.Ss.push(t)}))}}get Qs(){return this.ws.get(this.gs)}Os(){this.setItem(this.bs,this.Qs.Rs())}ks(e,t,r){let i=new Nl(this.currentUser,e,t,r),s=by(this.persistenceKey,this.currentUser,e);this.setItem(s,i.Rs())}qs(e){let t=by(this.persistenceKey,this.currentUser,e);this.removeItem(t)}$s(e){let t={clientId:this.gs,onlineState:e};this.storage.setItem(this.Ms,JSON.stringify(t))}Ks(e,t,r){let i=oh(this.persistenceKey,e),s=new no(e,t,r);this.setItem(i,s.Rs())}Us(e){let t=JSON.stringify(Array.from(e));this.setItem(this.xs,t)}Ws(e){let t=this.Cs.exec(e);return t?t[1]:null}zs(e,t){let r=this.Ws(e);return Dl.As(r,t)}js(e,t){let r=this.vs.exec(e),i=Number(r[1]),s=r[2]!==void 0?r[2]:null;return Nl.As(new Ve(s),i,t)}Js(e,t){let r=this.Fs.exec(e),i=Number(r[1]);return no.As(i,t)}Ns(e){return Ed.As(e)}Zs(e){return JSON.parse(e)}Hs(e){return x(this,null,function*(){if(e.user.uid===this.currentUser.uid)return this.syncEngine.eo(e.batchId,e.state,e.error);V("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)})}Ys(e){return this.syncEngine.no(e.targetId,e.state,e.error)}Gs(e,t){let r=t?this.ws.insert(e,t):this.ws.remove(e),i=this.Bs(this.ws),s=this.Bs(r),o=[],a=[];return s.forEach(c=>{i.has(c)||o.push(c)}),i.forEach(c=>{s.has(c)||a.push(c)}),this.syncEngine.ro(o,a).then(()=>{this.ws=r})}Ls(e){this.ws.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Bs(e){let t=mf();return e.forEach((r,i)=>{t=t.unionWith(i.activeTargetIds)}),t}},Vl=class{constructor(){this.io=new wo,this.so={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,r){}addLocalQueryTarget(e){return this.io.Vs(e),this.so[e]||"not-current"}updateQueryState(e,t,r){this.so[e]=t}removeLocalQueryTarget(e){this.io.fs(e)}isLocalQueryTarget(e){return this.io.activeTargetIds.has(e)}clearQueryState(e){delete this.so[e]}getAllActiveQueryTargets(){return this.io.activeTargetIds}isActiveQueryTarget(e){return this.io.activeTargetIds.has(e)}start(){return this.io=new wo,Promise.resolve()}handleUserChange(e,t,r){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}};var Td=class{oo(e){}shutdown(){}};var Ol=class{constructor(){this._o=()=>this.ao(),this.uo=()=>this.co(),this.lo=[],this.ho()}oo(e){this.lo.push(e)}shutdown(){window.removeEventListener("online",this._o),window.removeEventListener("offline",this.uo)}ho(){window.addEventListener("online",this._o),window.addEventListener("offline",this.uo)}ao(){V("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let e of this.lo)e(0)}co(){V("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let e of this.lo)e(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var Ja=null;function ah(){return Ja===null?Ja=function(){return 268435456+Math.round(2147483648*Math.random())}():Ja++,"0x"+Ja.toString(16)}var c0={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var Id=class{constructor(e){this.Po=e.Po,this.Io=e.Io}To(e){this.Eo=e}Ao(e){this.Ro=e}Vo(e){this.mo=e}onMessage(e){this.fo=e}close(){this.Io()}send(e){this.Po(e)}po(){this.Eo()}yo(){this.Ro()}wo(e){this.mo(e)}So(e){this.fo(e)}};var Je="WebChannelConnection",Ad=class extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;let r=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.bo=r+"://"+t.host,this.Do=`projects/${i}/databases/${s}`,this.Co=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get vo(){return!1}Fo(t,r,i,s,o){let a=ah(),c=this.Mo(t,r.toUriEncodedString());V("RestConnection",`Sending RPC '${t}' ${a}:`,c,i);let u={"google-cloud-resource-prefix":this.Do,"x-goog-request-params":this.Co};return this.xo(u,s,o),this.Oo(t,c,u,i).then(d=>(V("RestConnection",`Received RPC '${t}' ${a}: `,d),d),d=>{throw Et("RestConnection",`RPC '${t}' ${a} failed with error: `,d,"url: ",c,"request:",i),d})}No(t,r,i,s,o,a){return this.Fo(t,r,i,s,o)}xo(t,r,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Ui}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),r&&r.headers.forEach((s,o)=>t[o]=s),i&&i.headers.forEach((s,o)=>t[o]=s)}Mo(t,r){let i=c0[t];return`${this.bo}/v1/${r}:${i}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Oo(e,t,r,i){let s=ah();return new Promise((o,a)=>{let c=new Xu;c.setWithCredentials(!0),c.listenOnce(eh.COMPLETE,()=>{try{switch(c.getLastErrorCode()){case Ws.NO_ERROR:let d=c.getResponseJson();V(Je,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(d)),o(d);break;case Ws.TIMEOUT:V(Je,`RPC '${e}' ${s} timed out`),a(new D(R.DEADLINE_EXCEEDED,"Request time out"));break;case Ws.HTTP_ERROR:let p=c.getStatus();if(V(Je,`RPC '${e}' ${s} failed with status:`,p,"response text:",c.getResponseText()),p>0){let g=c.getResponseJson();Array.isArray(g)&&(g=g[0]);let y=g?.error;if(y&&y.status&&y.message){let S=function(N){let q=N.toLowerCase().replace(/_/g,"-");return Object.values(R).indexOf(q)>=0?q:R.UNKNOWN}(y.status);a(new D(S,y.message))}else a(new D(R.UNKNOWN,"Server responded with status "+c.getStatus()))}else a(new D(R.UNAVAILABLE,"Connection failed."));break;default:B()}}finally{V(Je,`RPC '${e}' ${s} completed.`)}});let u=JSON.stringify(i);V(Je,`RPC '${e}' ${s} sending request:`,i),c.send(t,"POST",u,r,15)})}Lo(e,t,r){let i=ah(),s=[this.bo,"/","google.firestore.v1.Firestore","/",e,"/channel"],o=rh(),a=nh(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;u!==void 0&&(c.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(c.xmlHttpFactory=new Zu({})),this.xo(c.initMessageHeaders,t,r),c.encodeInitMessageHeaders=!0;let d=s.join("");V(Je,`Creating RPC '${e}' stream ${i}: ${d}`,c);let p=o.createWebChannel(d,c),g=!1,y=!1,S=new Id({Po:N=>{y?V(Je,`Not sending because RPC '${e}' stream ${i} is closed:`,N):(g||(V(Je,`Opening RPC '${e}' stream ${i} transport.`),p.open(),g=!0),V(Je,`RPC '${e}' stream ${i} sending:`,N),p.send(N))},Io:()=>p.close()}),k=(N,q,G)=>{N.listen(q,F=>{try{G(F)}catch(K){setTimeout(()=>{throw K},0)}})};return k(p,li.EventType.OPEN,()=>{y||(V(Je,`RPC '${e}' stream ${i} transport opened.`),S.po())}),k(p,li.EventType.CLOSE,()=>{y||(y=!0,V(Je,`RPC '${e}' stream ${i} transport closed`),S.wo())}),k(p,li.EventType.ERROR,N=>{y||(y=!0,Et(Je,`RPC '${e}' stream ${i} transport errored:`,N),S.wo(new D(R.UNAVAILABLE,"The operation could not be completed")))}),k(p,li.EventType.MESSAGE,N=>{var q;if(!y){let G=N.data[0];j(!!G);let F=G,K=F.error||((q=F[0])===null||q===void 0?void 0:q.error);if(K){V(Je,`RPC '${e}' stream ${i} received error:`,K);let Q=K.status,H=function(w){let T=Ne[w];if(T!==void 0)return Iv(T)}(Q),E=K.message;H===void 0&&(H=R.INTERNAL,E="Unknown error status: "+Q+" with message "+K.message),y=!0,S.wo(new D(H,E)),p.close()}else V(Je,`RPC '${e}' stream ${i} received:`,G),S.So(G)}}),k(a,th.STAT_EVENT,N=>{N.stat===$a.PROXY?V(Je,`RPC '${e}' stream ${i} detected buffering proxy`):N.stat===$a.NOPROXY&&V(Je,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{S.yo()},0),S}};function Jv(){return typeof window<"u"?window:null}function nl(){return typeof document<"u"?document:null}function ko(n){return new Uh(n,!0)}var Eo=class{constructor(e,t,r=1e3,i=1.5,s=6e4){this.ai=e,this.timerId=t,this.Bo=r,this.ko=i,this.qo=s,this.Qo=0,this.Ko=null,this.$o=Date.now(),this.reset()}reset(){this.Qo=0}Uo(){this.Qo=this.qo}Wo(e){this.cancel();let t=Math.floor(this.Qo+this.Go()),r=Math.max(0,Date.now()-this.$o),i=Math.max(0,t-r);i>0&&V("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.Qo} ms, delay with jitter: ${t} ms, last attempt: ${r} ms ago)`),this.Ko=this.ai.enqueueAfterDelay(this.timerId,i,()=>(this.$o=Date.now(),e())),this.Qo*=this.ko,this.Qo<this.Bo&&(this.Qo=this.Bo),this.Qo>this.qo&&(this.Qo=this.qo)}zo(){this.Ko!==null&&(this.Ko.skipDelay(),this.Ko=null)}cancel(){this.Ko!==null&&(this.Ko.cancel(),this.Ko=null)}Go(){return(Math.random()-.5)*this.Qo}};var Fl=class{constructor(e,t,r,i,s,o,a,c){this.ai=e,this.jo=r,this.Ho=i,this.connection=s,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=c,this.state=0,this.Jo=0,this.Yo=null,this.Zo=null,this.stream=null,this.Xo=0,this.e_=new Eo(e,t)}t_(){return this.state===1||this.state===5||this.n_()}n_(){return this.state===2||this.state===3}start(){this.Xo=0,this.state!==4?this.auth():this.r_()}stop(){return x(this,null,function*(){this.t_()&&(yield this.close(0))})}i_(){this.state=0,this.e_.reset()}s_(){this.n_()&&this.Yo===null&&(this.Yo=this.ai.enqueueAfterDelay(this.jo,6e4,()=>this.o_()))}__(e){this.a_(),this.stream.send(e)}o_(){return x(this,null,function*(){if(this.n_())return this.close(0)})}a_(){this.Yo&&(this.Yo.cancel(),this.Yo=null)}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}close(e,t){return x(this,null,function*(){this.a_(),this.u_(),this.e_.cancel(),this.Jo++,e!==4?this.e_.reset():t&&t.code===R.RESOURCE_EXHAUSTED?(be(t.toString()),be("Using maximum backoff delay to prevent overloading the backend."),this.e_.Uo()):t&&t.code===R.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.c_(),this.stream.close(),this.stream=null),this.state=e,yield this.listener.Vo(t)})}c_(){}auth(){this.state=1;let e=this.l_(this.Jo),t=this.Jo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([r,i])=>{this.Jo===t&&this.h_(r,i)},r=>{e(()=>{let i=new D(R.UNKNOWN,"Fetching auth token failed: "+r.message);return this.P_(i)})})}h_(e,t){let r=this.l_(this.Jo);this.stream=this.I_(e,t),this.stream.To(()=>{r(()=>this.listener.To())}),this.stream.Ao(()=>{r(()=>(this.state=2,this.Zo=this.ai.enqueueAfterDelay(this.Ho,1e4,()=>(this.n_()&&(this.state=3),Promise.resolve())),this.listener.Ao()))}),this.stream.Vo(i=>{r(()=>this.P_(i))}),this.stream.onMessage(i=>{r(()=>++this.Xo==1?this.T_(i):this.onNext(i))})}r_(){this.state=5,this.e_.Wo(()=>x(this,null,function*(){this.state=0,this.start()}))}P_(e){return V("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}l_(e){return t=>{this.ai.enqueueAndForget(()=>this.Jo===e?t():(V("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},Sd=class extends Fl{constructor(e,t,r,i,s,o){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s}I_(e,t){return this.connection.Lo("Listen",e,t)}T_(e){return this.onNext(e)}onNext(e){this.e_.reset();let t=$S(this.serializer,e),r=function(s){if(!("targetChange"in s))return z.min();let o=s.targetChange;return o.targetIds&&o.targetIds.length?z.min():o.readTime?Pe(o.readTime):z.min()}(e);return this.listener.E_(t,r)}d_(e){let t={};t.database=Gh(this.serializer),t.addTarget=function(s,o){let a,c=o.target;if(a=fl(c)?{documents:kv(s,c)}:{query:Nv(s,c)._t},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=Sv(s,o.resumeToken);let u=Bh(s,o.expectedCount);u!==null&&(a.expectedCount=u)}else if(o.snapshotVersion.compareTo(z.min())>0){a.readTime=Ri(s,o.snapshotVersion.toTimestamp());let u=Bh(s,o.expectedCount);u!==null&&(a.expectedCount=u)}return a}(this.serializer,e);let r=HS(this.serializer,e);r&&(t.labels=r),this.__(t)}A_(e){let t={};t.database=Gh(this.serializer),t.removeTarget=e,this.__(t)}},Cd=class extends Fl{constructor(e,t,r,i,s,o){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s}get R_(){return this.Xo>0}start(){this.lastStreamToken=void 0,super.start()}c_(){this.R_&&this.V_([])}I_(e,t){return this.connection.Lo("Write",e,t)}T_(e){return j(!!e.streamToken),this.lastStreamToken=e.streamToken,j(!e.writeResults||e.writeResults.length===0),this.listener.m_()}onNext(e){j(!!e.streamToken),this.lastStreamToken=e.streamToken,this.e_.reset();let t=QS(e.writeResults,e.commitTime),r=Pe(e.commitTime);return this.listener.f_(r,t)}g_(){let e={};e.database=Gh(this.serializer),this.__(e)}V_(e){let t={streamToken:this.lastStreamToken,writes:e.map(r=>_o(this.serializer,r))};this.__(t)}};var bd=class extends class{}{constructor(e,t,r,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=r,this.serializer=i,this.p_=!1}y_(){if(this.p_)throw new D(R.FAILED_PRECONDITION,"The client has already been terminated.")}Fo(e,t,r,i){return this.y_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,o])=>this.connection.Fo(e,qh(t,r),i,s,o)).catch(s=>{throw s.name==="FirebaseError"?(s.code===R.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new D(R.UNKNOWN,s.toString())})}No(e,t,r,i,s){return this.y_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.No(e,qh(t,r),i,o,a,s)).catch(o=>{throw o.name==="FirebaseError"?(o.code===R.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new D(R.UNKNOWN,o.toString())})}terminate(){this.p_=!0,this.connection.terminate()}},Rd=class{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.w_=0,this.S_=null,this.b_=!0}D_(){this.w_===0&&(this.C_("Unknown"),this.S_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.S_=null,this.v_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}F_(e){this.state==="Online"?this.C_("Unknown"):(this.w_++,this.w_>=1&&(this.M_(),this.v_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.M_(),this.w_=0,e==="Online"&&(this.b_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}v_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.b_?(be(t),this.b_=!1):V("OnlineStateTracker",t)}M_(){this.S_!==null&&(this.S_.cancel(),this.S_=null)}};var Pd=class{constructor(e,t,r,i,s){this.localStore=e,this.datastore=t,this.asyncQueue=r,this.remoteSyncer={},this.x_=[],this.O_=new Map,this.N_=new Set,this.L_=[],this.B_=s,this.B_.oo(o=>{r.enqueueAndForget(()=>x(this,null,function*(){Zn(this)&&(V("RemoteStore","Restarting streams for network reachability change."),yield function(c){return x(this,null,function*(){let u=L(c);u.N_.add(4),yield qi(u),u.k_.set("Unknown"),u.N_.delete(4),yield No(u)})}(this))}))}),this.k_=new Rd(r,i)}};function No(n){return x(this,null,function*(){if(Zn(n))for(let e of n.L_)yield e(!0)})}function qi(n){return x(this,null,function*(){for(let e of n.L_)yield e(!1)})}function tc(n,e){let t=L(n);t.O_.has(e.targetId)||(t.O_.set(e.targetId,e),If(t)?Tf(t):ji(t).n_()&&Ef(t,e))}function Di(n,e){let t=L(n),r=ji(t);t.O_.delete(e),r.n_()&&Xv(t,e),t.O_.size===0&&(r.n_()?r.s_():Zn(t)&&t.k_.set("Unknown"))}function Ef(n,e){if(n.q_.xe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(z.min())>0){let t=n.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(t)}ji(n).d_(e)}function Xv(n,e){n.q_.xe(e),ji(n).A_(e)}function Tf(n){n.q_=new Lh({getRemoteKeysForTarget:e=>n.remoteSyncer.getRemoteKeysForTarget(e),ot:e=>n.O_.get(e)||null,tt:()=>n.datastore.serializer.databaseId}),ji(n).start(),n.k_.D_()}function If(n){return Zn(n)&&!ji(n).t_()&&n.O_.size>0}function Zn(n){return L(n).N_.size===0}function Zv(n){n.q_=void 0}function u0(n){return x(this,null,function*(){n.k_.set("Online")})}function h0(n){return x(this,null,function*(){n.O_.forEach((e,t)=>{Ef(n,e)})})}function d0(n,e){return x(this,null,function*(){Zv(n),If(n)?(n.k_.F_(e),Tf(n)):n.k_.set("Unknown")})}function f0(n,e,t){return x(this,null,function*(){if(n.k_.set("Online"),e instanceof _l&&e.state===2&&e.cause)try{yield function(i,s){return x(this,null,function*(){let o=s.cause;for(let a of s.targetIds)i.O_.has(a)&&(yield i.remoteSyncer.rejectListen(a,o),i.O_.delete(a),i.q_.removeTarget(a))})}(n,e)}catch(r){V("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),r),yield Ml(n,r)}else if(e instanceof Ei?n.q_.Ke(e):e instanceof ml?n.q_.He(e):n.q_.We(e),!t.isEqual(z.min()))try{let r=yield Wv(n.localStore);t.compareTo(r)>=0&&(yield function(s,o){let a=s.q_.rt(o);return a.targetChanges.forEach((c,u)=>{if(c.resumeToken.approximateByteSize()>0){let d=s.O_.get(u);d&&s.O_.set(u,d.withResumeToken(c.resumeToken,o))}}),a.targetMismatches.forEach((c,u)=>{let d=s.O_.get(c);if(!d)return;s.O_.set(c,d.withResumeToken(xe.EMPTY_BYTE_STRING,d.snapshotVersion)),Xv(s,c);let p=new Pi(d.target,c,u,d.sequenceNumber);Ef(s,p)}),s.remoteSyncer.applyRemoteEvent(a)}(n,t))}catch(r){V("RemoteStore","Failed to raise snapshot:",r),yield Ml(n,r)}})}function Ml(n,e,t){return x(this,null,function*(){if(!Xn(e))throw e;n.N_.add(1),yield qi(n),n.k_.set("Offline"),t||(t=()=>Wv(n.localStore)),n.asyncQueue.enqueueRetryable(()=>x(this,null,function*(){V("RemoteStore","Retrying IndexedDB access"),yield t(),n.N_.delete(1),yield No(n)}))})}function ew(n,e){return e().catch(t=>Ml(n,t,e))}function Gi(n){return x(this,null,function*(){let e=L(n),t=Yn(e),r=e.x_.length>0?e.x_[e.x_.length-1].batchId:-1;for(;p0(e);)try{let i=yield o0(e.localStore,r);if(i===null){e.x_.length===0&&t.s_();break}r=i.batchId,g0(e,i)}catch(i){yield Ml(e,i)}tw(e)&&nw(e)})}function p0(n){return Zn(n)&&n.x_.length<10}function g0(n,e){n.x_.push(e);let t=Yn(n);t.n_()&&t.R_&&t.V_(e.mutations)}function tw(n){return Zn(n)&&!Yn(n).t_()&&n.x_.length>0}function nw(n){Yn(n).start()}function m0(n){return x(this,null,function*(){Yn(n).g_()})}function _0(n){return x(this,null,function*(){let e=Yn(n);for(let t of n.x_)e.V_(t.mutations)})}function y0(n,e,t){return x(this,null,function*(){let r=n.x_.shift(),i=Oh.from(r,e,t);yield ew(n,()=>n.remoteSyncer.applySuccessfulWrite(i)),yield Gi(n)})}function v0(n,e){return x(this,null,function*(){e&&Yn(n).R_&&(yield function(r,i){return x(this,null,function*(){if(function(o){return Tv(o)&&o!==R.ABORTED}(i.code)){let s=r.x_.shift();Yn(r).i_(),yield ew(r,()=>r.remoteSyncer.rejectFailedWrite(s.batchId,i)),yield Gi(r)}})}(n,e)),tw(n)&&nw(n)})}function Ry(n,e){return x(this,null,function*(){let t=L(n);t.asyncQueue.verifyOperationInProgress(),V("RemoteStore","RemoteStore received new credentials");let r=Zn(t);t.N_.add(3),yield qi(t),r&&t.k_.set("Unknown"),yield t.remoteSyncer.handleCredentialChange(e),t.N_.delete(3),yield No(t)})}function xd(n,e){return x(this,null,function*(){let t=L(n);e?(t.N_.delete(2),yield No(t)):e||(t.N_.add(2),yield qi(t),t.k_.set("Unknown"))})}function ji(n){return n.Q_||(n.Q_=function(t,r,i){let s=L(t);return s.y_(),new Sd(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{To:u0.bind(null,n),Ao:h0.bind(null,n),Vo:d0.bind(null,n),E_:f0.bind(null,n)}),n.L_.push(e=>x(this,null,function*(){e?(n.Q_.i_(),If(n)?Tf(n):n.k_.set("Unknown")):(yield n.Q_.stop(),Zv(n))}))),n.Q_}function Yn(n){return n.K_||(n.K_=function(t,r,i){let s=L(t);return s.y_(),new Cd(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{To:()=>Promise.resolve(),Ao:m0.bind(null,n),Vo:v0.bind(null,n),m_:_0.bind(null,n),f_:y0.bind(null,n)}),n.L_.push(e=>x(this,null,function*(){e?(n.K_.i_(),yield Gi(n)):(yield n.K_.stop(),n.x_.length>0&&(V("RemoteStore",`Stopping write stream with ${n.x_.length} pending writes`),n.x_=[]))}))),n.K_}var kd=class n{constructor(e,t,r,i,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=r,this.op=i,this.removalCallback=s,this.deferred=new Oe,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,r,i,s){let o=Date.now()+r,a=new n(e,t,o,i,s);return a.start(r),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new D(R.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function zi(n,e){if(be("AsyncQueue",`${e}: ${n}`),Xn(n))return new D(R.UNAVAILABLE,`${e}: ${n}`);throw n}var Ll=class n{constructor(e){this.comparator=e?(t,r)=>e(t,r)||U.comparator(t.key,r.key):(t,r)=>U.comparator(t.key,r.key),this.keyedMap=Js(),this.sortedSet=new _e(this.comparator)}static emptySet(e){return new n(e.comparator)}has(e){return this.keyedMap.get(e)!=null}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,r)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();for(;t.hasNext();){let i=t.getNext().key,s=r.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),e.length===0?"DocumentSet ()":`DocumentSet (
  `+e.join(`  
`)+`
)`}copy(e,t){let r=new n;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=t,r}};var Ul=class{constructor(){this.U_=new _e(U.comparator)}track(e){let t=e.doc.key,r=this.U_.get(t);r?e.type!==0&&r.type===3?this.U_=this.U_.insert(t,e):e.type===3&&r.type!==1?this.U_=this.U_.insert(t,{type:r.type,doc:e.doc}):e.type===2&&r.type===2?this.U_=this.U_.insert(t,{type:2,doc:e.doc}):e.type===2&&r.type===0?this.U_=this.U_.insert(t,{type:0,doc:e.doc}):e.type===1&&r.type===0?this.U_=this.U_.remove(t):e.type===1&&r.type===2?this.U_=this.U_.insert(t,{type:1,doc:r.doc}):e.type===0&&r.type===1?this.U_=this.U_.insert(t,{type:2,doc:e.doc}):B():this.U_=this.U_.insert(t,e)}W_(){let e=[];return this.U_.inorderTraversal((t,r)=>{e.push(r)}),e}},Vi=class n{constructor(e,t,r,i,s,o,a,c,u){this.query=e,this.docs=t,this.oldDocs=r,this.docChanges=i,this.mutatedKeys=s,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=c,this.hasCachedResults=u}static fromInitialDocuments(e,t,r,i,s){let o=[];return t.forEach(a=>{o.push({type:0,doc:a})}),new n(e,t,Ll.emptySet(t),o,r,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Po(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,r=e.docChanges;if(t.length!==r.length)return!1;for(let i=0;i<t.length;i++)if(t[i].type!==r[i].type||!t[i].doc.isEqual(r[i].doc))return!1;return!0}};var Nd=class{constructor(){this.G_=void 0,this.z_=[]}j_(){return this.z_.some(e=>e.H_())}},Dd=class{constructor(){this.queries=Py(),this.onlineState="Unknown",this.J_=new Set}terminate(){(function(t,r){let i=L(t),s=i.queries;i.queries=Py(),s.forEach((o,a)=>{for(let c of a.z_)c.onError(r)})})(this,new D(R.ABORTED,"Firestore shutting down"))}};function Py(){return new Wt(n=>av(n),Po)}function Af(n,e){return x(this,null,function*(){let t=L(n),r=3,i=e.query,s=t.queries.get(i);s?!s.j_()&&e.H_()&&(r=2):(s=new Nd,r=e.H_()?0:1);try{switch(r){case 0:s.G_=yield t.onListen(i,!0);break;case 1:s.G_=yield t.onListen(i,!1);break;case 2:yield t.onFirstRemoteStoreListen(i)}}catch(o){let a=zi(o,`Initialization of query '${pi(e.query)}' failed`);return void e.onError(a)}t.queries.set(i,s),s.z_.push(e),e.Y_(t.onlineState),s.G_&&e.Z_(s.G_)&&Cf(t)})}function Sf(n,e){return x(this,null,function*(){let t=L(n),r=e.query,i=3,s=t.queries.get(r);if(s){let o=s.z_.indexOf(e);o>=0&&(s.z_.splice(o,1),s.z_.length===0?i=e.H_()?0:1:!s.j_()&&e.H_()&&(i=2))}switch(i){case 0:return t.queries.delete(r),t.onUnlisten(r,!0);case 1:return t.queries.delete(r),t.onUnlisten(r,!1);case 2:return t.onLastRemoteStoreUnlisten(r);default:return}})}function w0(n,e){let t=L(n),r=!1;for(let i of e){let s=i.query,o=t.queries.get(s);if(o){for(let a of o.z_)a.Z_(i)&&(r=!0);o.G_=i}}r&&Cf(t)}function E0(n,e,t){let r=L(n),i=r.queries.get(e);if(i)for(let s of i.z_)s.onError(t);r.queries.delete(e)}function Cf(n){n.J_.forEach(e=>{e.next()})}var Vd,xy;(xy=Vd||(Vd={})).X_="default",xy.Cache="cache";var To=class{constructor(e,t,r){this.query=e,this.ea=t,this.ta=!1,this.na=null,this.onlineState="Unknown",this.options=r||{}}Z_(e){if(!this.options.includeMetadataChanges){let r=[];for(let i of e.docChanges)i.type!==3&&r.push(i);e=new Vi(e.query,e.docs,e.oldDocs,r,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.ta?this.ra(e)&&(this.ea.next(e),t=!0):this.ia(e,this.onlineState)&&(this.sa(e),t=!0),this.na=e,t}onError(e){this.ea.error(e)}Y_(e){this.onlineState=e;let t=!1;return this.na&&!this.ta&&this.ia(this.na,e)&&(this.sa(this.na),t=!0),t}ia(e,t){if(!e.fromCache||!this.H_())return!0;let r=t!=="Offline";return(!this.options.oa||!r)&&(!e.docs.isEmpty()||e.hasCachedResults||t==="Offline")}ra(e){if(e.docChanges.length>0)return!0;let t=this.na&&this.na.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&this.options.includeMetadataChanges===!0}sa(e){e=Vi.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.ta=!0,this.ea.next(e)}H_(){return this.options.source!==Vd.Cache}};var Od=class{constructor(e,t){this._a=e,this.byteLength=t}aa(){return"metadata"in this._a}};var Bl=class{constructor(e){this.serializer=e}Ts(e){return Gt(this.serializer,e)}Es(e){return e.metadata.exists?xv(this.serializer,e.document,!1):Fe.newNoDocument(this.Ts(e.metadata.name),this.ds(e.metadata.readTime))}ds(e){return Pe(e)}},Fd=class{constructor(e,t,r){this.ua=e,this.localStore=t,this.serializer=r,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=rw(e)}ca(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e._a.namedQuery)this.queries.push(e._a.namedQuery);else if(e._a.documentMetadata){this.documents.push({metadata:e._a.documentMetadata}),e._a.documentMetadata.exists||++t;let r=se.fromString(e._a.documentMetadata.name);this.collectionGroups.add(r.get(r.length-2))}else e._a.document&&(this.documents[this.documents.length-1].document=e._a.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}la(e){let t=new Map,r=new Bl(this.serializer);for(let i of e)if(i.metadata.queries){let s=r.Ts(i.metadata.name);for(let o of i.metadata.queries){let a=(t.get(o)||X()).add(s);t.set(o,a)}}return t}complete(){return x(this,null,function*(){let e=yield a0(this.localStore,new Bl(this.serializer),this.documents,this.ua.id),t=this.la(this.documents);for(let r of this.queries)yield l0(this.localStore,r,t.get(r.name));return this.progress.taskState="Success",{progress:this.progress,ha:this.collectionGroups,Pa:e}})}};function rw(n){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:n.totalDocuments,totalBytes:n.totalBytes}}var ql=class{constructor(e){this.key=e}},Gl=class{constructor(e){this.key=e}},jl=class{constructor(e,t){this.query=e,this.Ia=t,this.Ta=null,this.hasCachedResults=!1,this.current=!1,this.Ea=X(),this.mutatedKeys=X(),this.da=cv(e),this.Aa=new Ll(this.da)}get Ra(){return this.Ia}Va(e,t){let r=t?t.ma:new Ul,i=t?t.Aa:this.Aa,s=t?t.mutatedKeys:this.mutatedKeys,o=i,a=!1,c=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,u=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((d,p)=>{let g=i.get(d),y=xo(this.query,p)?p:null,S=!!g&&this.mutatedKeys.has(g.key),k=!!y&&(y.hasLocalMutations||this.mutatedKeys.has(y.key)&&y.hasCommittedMutations),N=!1;g&&y?g.data.isEqual(y.data)?S!==k&&(r.track({type:3,doc:y}),N=!0):this.fa(g,y)||(r.track({type:2,doc:y}),N=!0,(c&&this.da(y,c)>0||u&&this.da(y,u)<0)&&(a=!0)):!g&&y?(r.track({type:0,doc:y}),N=!0):g&&!y&&(r.track({type:1,doc:g}),N=!0,(c||u)&&(a=!0)),N&&(y?(o=o.add(y),s=k?s.add(d):s.delete(d)):(o=o.delete(d),s=s.delete(d)))}),this.query.limit!==null)for(;o.size>this.query.limit;){let d=this.query.limitType==="F"?o.last():o.first();o=o.delete(d.key),s=s.delete(d.key),r.track({type:1,doc:d})}return{Aa:o,ma:r,ts:a,mutatedKeys:s}}fa(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,r,i){let s=this.Aa;this.Aa=e.Aa,this.mutatedKeys=e.mutatedKeys;let o=e.ma.W_();o.sort((d,p)=>function(y,S){let k=N=>{switch(N){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return B()}};return k(y)-k(S)}(d.type,p.type)||this.da(d.doc,p.doc)),this.ga(r),i=i!=null&&i;let a=t&&!i?this.pa():[],c=this.Ea.size===0&&this.current&&!i?1:0,u=c!==this.Ta;return this.Ta=c,o.length!==0||u?{snapshot:new Vi(this.query,e.Aa,s,o,e.mutatedKeys,c===0,u,!1,!!r&&r.resumeToken.approximateByteSize()>0),ya:a}:{ya:a}}Y_(e){return this.current&&e==="Offline"?(this.current=!1,this.applyChanges({Aa:this.Aa,ma:new Ul,mutatedKeys:this.mutatedKeys,ts:!1},!1)):{ya:[]}}wa(e){return!this.Ia.has(e)&&!!this.Aa.has(e)&&!this.Aa.get(e).hasLocalMutations}ga(e){e&&(e.addedDocuments.forEach(t=>this.Ia=this.Ia.add(t)),e.modifiedDocuments.forEach(t=>{}),e.removedDocuments.forEach(t=>this.Ia=this.Ia.delete(t)),this.current=e.current)}pa(){if(!this.current)return[];let e=this.Ea;this.Ea=X(),this.Aa.forEach(r=>{this.wa(r.key)&&(this.Ea=this.Ea.add(r.key))});let t=[];return e.forEach(r=>{this.Ea.has(r)||t.push(new Gl(r))}),this.Ea.forEach(r=>{e.has(r)||t.push(new ql(r))}),t}Sa(e){this.Ia=e.Is,this.Ea=X();let t=this.Va(e.documents);return this.applyChanges(t,!0)}ba(){return Vi.fromInitialDocuments(this.query,this.Aa,this.mutatedKeys,this.Ta===0,this.hasCachedResults)}},Md=class{constructor(e,t,r){this.query=e,this.targetId=t,this.view=r}},Ld=class{constructor(e){this.key=e,this.Da=!1}},Ud=class{constructor(e,t,r,i,s,o){this.localStore=e,this.remoteStore=t,this.eventManager=r,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=o,this.Ca={},this.va=new Wt(a=>av(a),Po),this.Fa=new Map,this.Ma=new Set,this.xa=new _e(U.comparator),this.Oa=new Map,this.Na=new vo,this.La={},this.Ba=new Map,this.ka=xi.Bn(),this.onlineState="Unknown",this.qa=void 0}get isPrimaryClient(){return this.qa===!0}};function T0(n,e,t=!0){return x(this,null,function*(){let r=nc(n),i,s=r.va.get(e);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.ba()):i=yield iw(r,e,t,!0),i})}function I0(n,e){return x(this,null,function*(){let t=nc(n);yield iw(t,e,!0,!1)})}function iw(n,e,t,r){return x(this,null,function*(){let i=yield ki(n.localStore,rt(e)),s=i.targetId,o=t?n.sharedClientState.addLocalQueryTarget(s):"not-current",a;return r&&(a=yield bf(n,e,s,o==="current",i.resumeToken)),n.isPrimaryClient&&t&&tc(n.remoteStore,i),a})}function bf(n,e,t,r,i){return x(this,null,function*(){n.Qa=(p,g,y)=>function(k,N,q,G){return x(this,null,function*(){let F=N.view.Va(q);F.ts&&(F=yield kl(k.localStore,N.query,!1).then(({documents:E})=>N.view.Va(E,F)));let K=G&&G.targetChanges.get(N.targetId),Q=G&&G.targetMismatches.get(N.targetId)!=null,H=N.view.applyChanges(F,k.isPrimaryClient,K,Q);return Bd(k,N.targetId,H.ya),H.snapshot})}(n,p,g,y);let s=yield kl(n.localStore,e,!0),o=new jl(e,s.Is),a=o.Va(s.documents),c=go.createSynthesizedTargetChangeForCurrentChange(t,r&&n.onlineState!=="Offline",i),u=o.applyChanges(a,n.isPrimaryClient,c);Bd(n,t,u.ya);let d=new Md(e,t,o);return n.va.set(e,d),n.Fa.has(t)?n.Fa.get(t).push(e):n.Fa.set(t,[e]),u.snapshot})}function A0(n,e,t){return x(this,null,function*(){let r=L(n),i=r.va.get(e),s=r.Fa.get(i.targetId);if(s.length>1)return r.Fa.set(i.targetId,s.filter(o=>!Po(o,e))),void r.va.delete(e);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||(yield Ni(r.localStore,i.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(i.targetId),t&&Di(r.remoteStore,i.targetId),Oi(r,i.targetId)}).catch(Jn))):(Oi(r,i.targetId),yield Ni(r.localStore,i.targetId,!0))})}function S0(n,e){return x(this,null,function*(){let t=L(n),r=t.va.get(e),i=t.Fa.get(r.targetId);t.isPrimaryClient&&i.length===1&&(t.sharedClientState.removeLocalQueryTarget(r.targetId),Di(t.remoteStore,r.targetId))})}function C0(n,e,t){return x(this,null,function*(){let r=kf(n);try{let i=yield function(o,a){let c=L(o),u=we.now(),d=a.reduce((y,S)=>y.add(S.key),X()),p,g;return c.persistence.runTransaction("Locally write mutations","readwrite",y=>{let S=ct(),k=X();return c.us.getEntries(y,d).next(N=>{S=N,S.forEach((q,G)=>{G.isValidDocument()||(k=k.add(q))})}).next(()=>c.localDocuments.getOverlayedDocuments(y,S)).next(N=>{p=N;let q=[];for(let G of a){let F=BS(G,p.get(G.key).overlayedDocument);F!=null&&q.push(new kt(G.key,F,ev(F.value.mapValue),Se.exists(!0)))}return c.mutationQueue.addMutationBatch(y,u,q,a)}).next(N=>{g=N;let q=N.applyToLocalDocumentSet(p,k);return c.documentOverlayCache.saveOverlays(y,N.batchId,q)})}).then(()=>({batchId:g.batchId,changes:hv(p)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(i.batchId),function(o,a,c){let u=o.La[o.currentUser.toKey()];u||(u=new _e(Y)),u=u.insert(a,c),o.La[o.currentUser.toKey()]=u}(r,i.batchId,t),yield gn(r,i.changes),yield Gi(r.remoteStore)}catch(i){let s=zi(i,"Failed to persist write");t.reject(s)}})}function sw(n,e){return x(this,null,function*(){let t=L(n);try{let r=yield s0(t.localStore,e);e.targetChanges.forEach((i,s)=>{let o=t.Oa.get(s);o&&(j(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?o.Da=!0:i.modifiedDocuments.size>0?j(o.Da):i.removedDocuments.size>0&&(j(o.Da),o.Da=!1))}),yield gn(t,r,e)}catch(r){yield Jn(r)}})}function ky(n,e,t){let r=L(n);if(r.isPrimaryClient&&t===0||!r.isPrimaryClient&&t===1){let i=[];r.va.forEach((s,o)=>{let a=o.view.Y_(e);a.snapshot&&i.push(a.snapshot)}),function(o,a){let c=L(o);c.onlineState=a;let u=!1;c.queries.forEach((d,p)=>{for(let g of p.z_)g.Y_(a)&&(u=!0)}),u&&Cf(c)}(r.eventManager,e),i.length&&r.Ca.E_(i),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}function b0(n,e,t){return x(this,null,function*(){let r=L(n);r.sharedClientState.updateQueryState(e,"rejected",t);let i=r.Oa.get(e),s=i&&i.key;if(s){let o=new _e(U.comparator);o=o.insert(s,Fe.newNoDocument(s,z.min()));let a=X().add(s),c=new po(z.min(),new Map,new _e(Y),o,a);yield sw(r,c),r.xa=r.xa.remove(s),r.Oa.delete(e),xf(r)}else yield Ni(r.localStore,e,!1).then(()=>Oi(r,e,t)).catch(Jn)})}function R0(n,e){return x(this,null,function*(){let t=L(n),r=e.batch.batchId;try{let i=yield i0(t.localStore,e);Pf(t,r,null),Rf(t,r),t.sharedClientState.updateMutationState(r,"acknowledged"),yield gn(t,i)}catch(i){yield Jn(i)}})}function P0(n,e,t){return x(this,null,function*(){let r=L(n);try{let i=yield function(o,a){let c=L(o);return c.persistence.runTransaction("Reject batch","readwrite-primary",u=>{let d;return c.mutationQueue.lookupMutationBatch(u,a).next(p=>(j(p!==null),d=p.keys(),c.mutationQueue.removeMutationBatch(u,p))).next(()=>c.mutationQueue.performConsistencyCheck(u)).next(()=>c.documentOverlayCache.removeOverlaysForBatchId(u,d,a)).next(()=>c.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(u,d)).next(()=>c.localDocuments.getDocuments(u,d))})}(r.localStore,e);Pf(r,e,t),Rf(r,e),r.sharedClientState.updateMutationState(e,"rejected",t),yield gn(r,i)}catch(i){yield Jn(i)}})}function x0(n,e){return x(this,null,function*(){let t=L(n);Zn(t.remoteStore)||V("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=yield function(o){let a=L(o);return a.persistence.runTransaction("Get highest unacknowledged batch id","readonly",c=>a.mutationQueue.getHighestUnacknowledgedBatchId(c))}(t.localStore);if(r===-1)return void e.resolve();let i=t.Ba.get(r)||[];i.push(e),t.Ba.set(r,i)}catch(r){let i=zi(r,"Initialization of waitForPendingWrites() operation failed");e.reject(i)}})}function Rf(n,e){(n.Ba.get(e)||[]).forEach(t=>{t.resolve()}),n.Ba.delete(e)}function Pf(n,e,t){let r=L(n),i=r.La[r.currentUser.toKey()];if(i){let s=i.get(e);s&&(t?s.reject(t):s.resolve(),i=i.remove(e)),r.La[r.currentUser.toKey()]=i}}function Oi(n,e,t=null){n.sharedClientState.removeLocalQueryTarget(e);for(let r of n.Fa.get(e))n.va.delete(r),t&&n.Ca.Ka(r,t);n.Fa.delete(e),n.isPrimaryClient&&n.Na.mr(e).forEach(r=>{n.Na.containsKey(r)||ow(n,r)})}function ow(n,e){n.Ma.delete(e.path.canonicalString());let t=n.xa.get(e);t!==null&&(Di(n.remoteStore,t),n.xa=n.xa.remove(e),n.Oa.delete(t),xf(n))}function Bd(n,e,t){for(let r of t)r instanceof ql?(n.Na.addReference(r.key,e),k0(n,r)):r instanceof Gl?(V("SyncEngine","Document no longer in limbo: "+r.key),n.Na.removeReference(r.key,e),n.Na.containsKey(r.key)||ow(n,r.key)):B()}function k0(n,e){let t=e.key,r=t.path.canonicalString();n.xa.get(t)||n.Ma.has(r)||(V("SyncEngine","New document in limbo: "+t),n.Ma.add(r),xf(n))}function xf(n){for(;n.Ma.size>0&&n.xa.size<n.maxConcurrentLimboResolutions;){let e=n.Ma.values().next().value;n.Ma.delete(e);let t=new U(se.fromString(e)),r=n.ka.next();n.Oa.set(r,new Ld(t)),n.xa=n.xa.insert(t,r),tc(n.remoteStore,new Pi(rt(Bi(t.path)),r,"TargetPurposeLimboResolution",dt.oe))}}function gn(n,e,t){return x(this,null,function*(){let r=L(n),i=[],s=[],o=[];r.va.isEmpty()||(r.va.forEach((a,c)=>{o.push(r.Qa(c,e,t).then(u=>{var d;if((u||t)&&r.isPrimaryClient){let p=u?!u.fromCache:(d=t?.targetChanges.get(c.targetId))===null||d===void 0?void 0:d.current;r.sharedClientState.updateQueryState(c.targetId,p?"current":"not-current")}if(u){i.push(u);let p=yd.Ui(c.targetId,u);s.push(p)}}))}),yield Promise.all(o),r.Ca.E_(i),yield function(c,u){return x(this,null,function*(){let d=L(c);try{yield d.persistence.runTransaction("notifyLocalViewChanges","readwrite",p=>b.forEach(u,g=>b.forEach(g.Ki,y=>d.persistence.referenceDelegate.addReference(p,g.targetId,y)).next(()=>b.forEach(g.$i,y=>d.persistence.referenceDelegate.removeReference(p,g.targetId,y)))))}catch(p){if(!Xn(p))throw p;V("LocalStore","Failed to update sequence numbers: "+p)}for(let p of u){let g=p.targetId;if(!p.fromCache){let y=d.ss.get(g),S=y.snapshotVersion,k=y.withLastLimboFreeSnapshotVersion(S);d.ss=d.ss.insert(g,k)}}})}(r.localStore,s))})}function N0(n,e){return x(this,null,function*(){let t=L(n);if(!t.currentUser.isEqual(e)){V("SyncEngine","User change. New user:",e.toKey());let r=yield Kv(t.localStore,e);t.currentUser=e,function(s,o){s.Ba.forEach(a=>{a.forEach(c=>{c.reject(new D(R.CANCELLED,o))})}),s.Ba.clear()}(t,"'waitForPendingWrites' promise is rejected due to a user change."),t.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),yield gn(t,r.ls)}})}function D0(n,e){let t=L(n),r=t.Oa.get(e);if(r&&r.Da)return X().add(r.key);{let i=X(),s=t.Fa.get(e);if(!s)return i;for(let o of s){let a=t.va.get(o);i=i.unionWith(a.view.Ra)}return i}}function V0(n,e){return x(this,null,function*(){let t=L(n),r=yield kl(t.localStore,e.query,!0),i=e.view.Sa(r);return t.isPrimaryClient&&Bd(t,e.targetId,i.ya),i})}function O0(n,e){return x(this,null,function*(){let t=L(n);return Hv(t.localStore,e).then(r=>gn(t,r))})}function F0(n,e,t,r){return x(this,null,function*(){let i=L(n),s=yield function(a,c){let u=L(a),d=L(u.mutationQueue);return u.persistence.runTransaction("Lookup mutation documents","readonly",p=>d.Fn(p,c).next(g=>g?u.localDocuments.getDocuments(p,g):b.resolve(null)))}(i.localStore,e);s!==null?(t==="pending"?yield Gi(i.remoteStore):t==="acknowledged"||t==="rejected"?(Pf(i,e,r||null),Rf(i,e),function(a,c){L(L(a).mutationQueue).xn(c)}(i.localStore,e)):B(),yield gn(i,s)):V("SyncEngine","Cannot apply mutation batch with id: "+e)})}function M0(n,e){return x(this,null,function*(){let t=L(n);if(nc(t),kf(t),e===!0&&t.qa!==!0){let r=t.sharedClientState.getAllActiveQueryTargets(),i=yield Ny(t,r.toArray());t.qa=!0,yield xd(t.remoteStore,!0);for(let s of i)tc(t.remoteStore,s)}else if(e===!1&&t.qa!==!1){let r=[],i=Promise.resolve();t.Fa.forEach((s,o)=>{t.sharedClientState.isLocalQueryTarget(o)?r.push(o):i=i.then(()=>(Oi(t,o),Ni(t.localStore,o,!0))),Di(t.remoteStore,o)}),yield i,yield Ny(t,r),function(o){let a=L(o);a.Oa.forEach((c,u)=>{Di(a.remoteStore,u)}),a.Na.gr(),a.Oa=new Map,a.xa=new _e(U.comparator)}(t),t.qa=!1,yield xd(t.remoteStore,!1)}})}function Ny(n,e,t){return x(this,null,function*(){let r=L(n),i=[],s=[];for(let o of e){let a,c=r.Fa.get(o);if(c&&c.length!==0){a=yield ki(r.localStore,rt(c[0]));for(let u of c){let d=r.va.get(u),p=yield V0(r,d);p.snapshot&&s.push(p.snapshot)}}else{let u=yield Qv(r.localStore,o);a=yield ki(r.localStore,u),yield bf(r,aw(u),o,!1,a.resumeToken)}i.push(a)}return r.Ca.E_(s),i})}function aw(n){return ov(n.path,n.collectionGroup,n.orderBy,n.filters,n.limit,"F",n.startAt,n.endAt)}function L0(n){return function(t){return L(L(t).persistence).qi()}(L(n).localStore)}function U0(n,e,t,r){return x(this,null,function*(){let i=L(n);if(i.qa)return void V("SyncEngine","Ignoring unexpected query state notification.");let s=i.Fa.get(e);if(s&&s.length>0)switch(t){case"current":case"not-current":{let o=yield Hv(i.localStore,lv(s[0])),a=po.createSynthesizedRemoteEventForCurrentChange(e,t==="current",xe.EMPTY_BYTE_STRING);yield gn(i,o,a);break}case"rejected":yield Ni(i.localStore,e,!0),Oi(i,e,r);break;default:B()}})}function B0(n,e,t){return x(this,null,function*(){let r=nc(n);if(r.qa){for(let i of e){if(r.Fa.has(i)&&r.sharedClientState.isActiveQueryTarget(i)){V("SyncEngine","Adding an already active target "+i);continue}let s=yield Qv(r.localStore,i),o=yield ki(r.localStore,s);yield bf(r,aw(s),o.targetId,!1,o.resumeToken),tc(r.remoteStore,o)}for(let i of t)r.Fa.has(i)&&(yield Ni(r.localStore,i,!1).then(()=>{Di(r.remoteStore,i),Oi(r,i)}).catch(Jn))}})}function nc(n){let e=L(n);return e.remoteStore.remoteSyncer.applyRemoteEvent=sw.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=D0.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=b0.bind(null,e),e.Ca.E_=w0.bind(null,e.eventManager),e.Ca.Ka=E0.bind(null,e.eventManager),e}function kf(n){let e=L(n);return e.remoteStore.remoteSyncer.applySuccessfulWrite=R0.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=P0.bind(null,e),e}function q0(n,e,t){let r=L(n);(function(s,o,a){return x(this,null,function*(){try{let c=yield o.getMetadata();if(yield function(y,S){let k=L(y),N=Pe(S.createTime);return k.persistence.runTransaction("hasNewerBundle","readonly",q=>k.Wr.getBundleMetadata(q,S.id)).then(q=>!!q&&q.createTime.compareTo(N)>=0)}(s.localStore,c))return yield o.close(),a._completeWith(function(y){return{taskState:"Success",documentsLoaded:y.totalDocuments,bytesLoaded:y.totalBytes,totalDocuments:y.totalDocuments,totalBytes:y.totalBytes}}(c)),Promise.resolve(new Set);a._updateProgress(rw(c));let u=new Fd(c,s.localStore,o.serializer),d=yield o.$a();for(;d;){let g=yield u.ca(d);g&&a._updateProgress(g),d=yield o.$a()}let p=yield u.complete();return yield gn(s,p.Pa,void 0),yield function(y,S){let k=L(y);return k.persistence.runTransaction("Save bundle","readwrite",N=>k.Wr.saveBundleMetadata(N,S))}(s.localStore,c),a._completeWith(p.progress),Promise.resolve(p.ha)}catch(c){return Et("SyncEngine",`Loading bundle failed with ${c}`),a._failWith(c),Promise.resolve(new Set)}})})(r,e,t).then(i=>{r.sharedClientState.notifyBundleLoaded(i)})}var Io=class{constructor(){this.synchronizeTabs=!1}initialize(e){return x(this,null,function*(){this.serializer=ko(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),yield this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)})}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return zv(this.persistence,new xl,e.initialUser,this.serializer)}createPersistence(e){return new Rl(Pl.Yr,this.serializer)}createSharedClientState(e){return new Vl}terminate(){return x(this,null,function*(){var e,t;(e=this.gcScheduler)===null||e===void 0||e.stop(),(t=this.indexBackfillerScheduler)===null||t===void 0||t.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}};var zl=class n extends Io{constructor(e,t,r){super(),this.Ua=e,this.cacheSizeBytes=t,this.forceOwnership=r,this.synchronizeTabs=!1}initialize(e){return x(this,null,function*(){yield Nu(n.prototype,this,"initialize").call(this,e),yield this.Ua.initialize(this,e),yield kf(this.Ua.syncEngine),yield Gi(this.Ua.remoteStore),yield this.persistence.pi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))})}createLocalStore(e){return zv(this.persistence,new xl,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){let r=this.persistence.referenceDelegate.garbageCollector;return new nd(r,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){let r=new vh(t,this.persistence);return new yh(e.asyncQueue,r)}createPersistence(e){let t=wf(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),r=this.cacheSizeBytes!==void 0?wt.withCacheSize(this.cacheSizeBytes):wt.DEFAULT;return new _d(this.synchronizeTabs,t,e.clientId,r,e.asyncQueue,Jv(),nl(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Vl}},qd=class n extends zl{constructor(e,t){super(e,t,!1),this.Ua=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}initialize(e){return x(this,null,function*(){yield Nu(n.prototype,this,"initialize").call(this,e);let t=this.Ua.syncEngine;this.sharedClientState instanceof ro&&(this.sharedClientState.syncEngine={eo:F0.bind(null,t),no:U0.bind(null,t),ro:B0.bind(null,t),qi:L0.bind(null,t),Xs:O0.bind(null,t)},yield this.sharedClientState.start()),yield this.persistence.pi(r=>x(this,null,function*(){yield M0(this.Ua.syncEngine,r),this.gcScheduler&&(r&&!this.gcScheduler.started?this.gcScheduler.start():r||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(r&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():r||this.indexBackfillerScheduler.stop())}))})}createSharedClientState(e){let t=Jv();if(!ro.D(t))throw new D(R.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let r=wf(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new ro(t,e.asyncQueue,r,e.clientId,e.initialUser)}},Ao=class{initialize(e,t){return x(this,null,function*(){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=r=>ky(this.syncEngine,r,1),this.remoteStore.remoteSyncer.handleCredentialChange=N0.bind(null,this.syncEngine),yield xd(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(e){return function(){return new Dd}()}createDatastore(e){let t=ko(e.databaseInfo.databaseId),r=function(s){return new Ad(s)}(e.databaseInfo);return function(s,o,a,c){return new bd(s,o,a,c)}(e.authCredentials,e.appCheckCredentials,r,t)}createRemoteStore(e){return function(r,i,s,o,a){return new Pd(r,i,s,o,a)}(this.localStore,this.datastore,e.asyncQueue,t=>ky(this.syncEngine,t,0),function(){return Ol.D()?new Ol:new Td}())}createSyncEngine(e,t){return function(i,s,o,a,c,u,d){let p=new Ud(i,s,o,a,c,u);return d&&(p.qa=!0),p}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return x(this,null,function*(){var e,t;yield function(i){return x(this,null,function*(){let s=L(i);V("RemoteStore","RemoteStore shutting down."),s.N_.add(5),yield qi(s),s.B_.shutdown(),s.k_.set("Unknown")})}(this.remoteStore),(e=this.datastore)===null||e===void 0||e.terminate(),(t=this.eventManager)===null||t===void 0||t.terminate()})}};function Dy(n,e=10240){let t=0;return{read(){return x(this,null,function*(){if(t<n.byteLength){let i={value:n.slice(t,t+e),done:!1};return t+=e,i}return{done:!0}})},cancel(){return x(this,null,function*(){})},releaseLock(){},closed:Promise.resolve()}}var Fi=class{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Wa(this.observer.next,e)}error(e){this.observer.error?this.Wa(this.observer.error,e):be("Uncaught Error in snapshot listener:",e.toString())}Ga(){this.muted=!0}Wa(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}};var Gd=class{constructor(e,t){this.za=e,this.serializer=t,this.metadata=new Oe,this.buffer=new Uint8Array,this.ja=function(){return new TextDecoder("utf-8")}(),this.Ha().then(r=>{r&&r.aa()?this.metadata.resolve(r._a.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(r?._a)}`))},r=>this.metadata.reject(r))}close(){return this.za.cancel()}getMetadata(){return x(this,null,function*(){return this.metadata.promise})}$a(){return x(this,null,function*(){return yield this.getMetadata(),this.Ha()})}Ha(){return x(this,null,function*(){let e=yield this.Ja();if(e===null)return null;let t=this.ja.decode(e),r=Number(t);isNaN(r)&&this.Ya(`length string (${t}) is not valid number`);let i=yield this.Za(r);return new Od(JSON.parse(i),e.length+r)})}Xa(){return this.buffer.findIndex(e=>e===123)}Ja(){return x(this,null,function*(){for(;this.Xa()<0&&!(yield this.eu()););if(this.buffer.length===0)return null;let e=this.Xa();e<0&&this.Ya("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t})}Za(e){return x(this,null,function*(){for(;this.buffer.length<e;)(yield this.eu())&&this.Ya("Reached the end of bundle when more is expected.");let t=this.ja.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t})}Ya(e){throw this.za.cancel(),new Error(`Invalid bundle format: ${e}`)}eu(){return x(this,null,function*(){let e=yield this.za.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done})}};var jd=class{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(e){return x(this,null,function*(){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new D(R.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=yield function(i,s){return x(this,null,function*(){let o=L(i),a={documents:s.map(p=>mo(o.serializer,p))},c=yield o.No("BatchGetDocuments",o.serializer.databaseId,se.emptyPath(),a,s.length),u=new Map;c.forEach(p=>{let g=WS(o.serializer,p);u.set(g.key.toString(),g)});let d=[];return s.forEach(p=>{let g=u.get(p.toString());j(!!g),d.push(g)}),d})}(this.datastore,e);return t.forEach(r=>this.recordVersion(r)),t})}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(r){this.lastTransactionError=r}this.writtenDocs.add(e.toString())}delete(e){this.write(new Hn(e,this.precondition(e))),this.writtenDocs.add(e.toString())}commit(){return x(this,null,function*(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((t,r)=>{let i=U.fromPath(r);this.mutations.push(new uo(i,this.precondition(i)))}),yield function(r,i){return x(this,null,function*(){let s=L(r),o={writes:i.map(a=>_o(s.serializer,a))};yield s.Fo("Commit",s.serializer.databaseId,se.emptyPath(),o)})}(this.datastore,this.mutations),this.committed=!0})}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw B();t=z.min()}let r=this.readVersions.get(e.key.toString());if(r){if(!t.isEqual(r))throw new D(R.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(z.min())?Se.exists(!1):Se.updateTime(t):Se.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(z.min()))throw new D(R.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Se.updateTime(t)}return Se.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}};var zd=class{constructor(e,t,r,i,s){this.asyncQueue=e,this.datastore=t,this.options=r,this.updateFunction=i,this.deferred=s,this.tu=r.maxAttempts,this.e_=new Eo(this.asyncQueue,"transaction_retry")}nu(){this.tu-=1,this.ru()}ru(){this.e_.Wo(()=>x(this,null,function*(){let e=new jd(this.datastore),t=this.iu(e);t&&t.then(r=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(r)}).catch(i=>{this.su(i)}))}).catch(r=>{this.su(r)})}))}iu(e){try{let t=this.updateFunction(e);return!bo(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}su(e){this.tu>0&&this.ou(e)?(this.tu-=1,this.asyncQueue.enqueueAndForget(()=>(this.ru(),Promise.resolve()))):this.deferred.reject(e)}ou(e){if(e.name==="FirebaseError"){let t=e.code;return t==="aborted"||t==="failed-precondition"||t==="already-exists"||!Tv(t)}return!1}};var Kd=class{constructor(e,t,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=r,this.databaseInfo=i,this.user=Ve.UNAUTHENTICATED,this.clientId=sl.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(r,s=>x(this,null,function*(){V("FirestoreClient","Received user=",s.uid),yield this.authCredentialListener(s),this.user=s})),this.appCheckCredentials.start(r,s=>(V("FirestoreClient","Received new app check token=",s),this.appCheckCredentialListener(s,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new D(R.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();let e=new Oe;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>x(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){let r=zi(t,"Failed to shutdown persistence");e.reject(r)}})),e.promise}};function rl(n,e){return x(this,null,function*(){n.asyncQueue.verifyOperationInProgress(),V("FirestoreClient","Initializing OfflineComponentProvider");let t=n.configuration;yield e.initialize(t);let r=t.initialUser;n.setCredentialChangeListener(i=>x(this,null,function*(){r.isEqual(i)||(yield Kv(e.localStore,i),r=i)})),e.persistence.setDatabaseDeletedListener(()=>n.terminate()),n._offlineComponents=e})}function Wd(n,e){return x(this,null,function*(){n.asyncQueue.verifyOperationInProgress();let t=yield Nf(n);V("FirestoreClient","Initializing OnlineComponentProvider"),yield e.initialize(t,n.configuration),n.setCredentialChangeListener(r=>Ry(e.remoteStore,r)),n.setAppCheckTokenChangeListener((r,i)=>Ry(e.remoteStore,i)),n._onlineComponents=e})}function lw(n){return n.name==="FirebaseError"?n.code===R.FAILED_PRECONDITION||n.code===R.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}function Nf(n){return x(this,null,function*(){if(!n._offlineComponents)if(n._uninitializedComponentsProvider){V("FirestoreClient","Using user provided OfflineComponentProvider");try{yield rl(n,n._uninitializedComponentsProvider._offline)}catch(e){let t=e;if(!lw(t))throw t;Et("Error using user provided cache. Falling back to memory cache: "+t),yield rl(n,new Io)}}else V("FirestoreClient","Using default OfflineComponentProvider"),yield rl(n,new Io);return n._offlineComponents})}function rc(n){return x(this,null,function*(){return n._onlineComponents||(n._uninitializedComponentsProvider?(V("FirestoreClient","Using user provided OnlineComponentProvider"),yield Wd(n,n._uninitializedComponentsProvider._online)):(V("FirestoreClient","Using default OnlineComponentProvider"),yield Wd(n,new Ao))),n._onlineComponents})}function cw(n){return Nf(n).then(e=>e.persistence)}function Df(n){return Nf(n).then(e=>e.localStore)}function uw(n){return rc(n).then(e=>e.remoteStore)}function Vf(n){return rc(n).then(e=>e.syncEngine)}function G0(n){return rc(n).then(e=>e.datastore)}function Mi(n){return x(this,null,function*(){let e=yield rc(n),t=e.eventManager;return t.onListen=T0.bind(null,e.syncEngine),t.onUnlisten=A0.bind(null,e.syncEngine),t.onFirstRemoteStoreListen=I0.bind(null,e.syncEngine),t.onLastRemoteStoreUnlisten=S0.bind(null,e.syncEngine),t})}function j0(n){return n.asyncQueue.enqueue(()=>x(this,null,function*(){let e=yield cw(n),t=yield uw(n);return e.setNetworkEnabled(!0),function(i){let s=L(i);return s.N_.delete(0),No(s)}(t)}))}function z0(n){return n.asyncQueue.enqueue(()=>x(this,null,function*(){let e=yield cw(n),t=yield uw(n);return e.setNetworkEnabled(!1),function(i){return x(this,null,function*(){let s=L(i);s.N_.add(0),yield qi(s),s.k_.set("Offline")})}(t)}))}function K0(n,e){let t=new Oe;return n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(i,s,o){return x(this,null,function*(){try{let a=yield function(u,d){let p=L(u);return p.persistence.runTransaction("read document","readonly",g=>p.localDocuments.getDocument(g,d))}(i,s);a.isFoundDocument()?o.resolve(a):a.isNoDocument()?o.resolve(null):o.reject(new D(R.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(a){let c=zi(a,`Failed to get document '${s} from cache`);o.reject(c)}})}(yield Df(n),e,t)})),t.promise}function hw(n,e,t={}){let r=new Oe;return n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(s,o,a,c,u){let d=new Fi({next:g=>{o.enqueueAndForget(()=>Sf(s,p));let y=g.docs.has(a);!y&&g.fromCache?u.reject(new D(R.UNAVAILABLE,"Failed to get document because the client is offline.")):y&&g.fromCache&&c&&c.source==="server"?u.reject(new D(R.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):u.resolve(g)},error:g=>u.reject(g)}),p=new To(Bi(a.path),d,{includeMetadataChanges:!0,oa:!0});return Af(s,p)}(yield Mi(n),n.asyncQueue,e,t,r)})),r.promise}function W0(n,e){let t=new Oe;return n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(i,s,o){return x(this,null,function*(){try{let a=yield kl(i,s,!0),c=new jl(s,a.Is),u=c.Va(a.documents),d=c.applyChanges(u,!1);o.resolve(d.snapshot)}catch(a){let c=zi(a,`Failed to execute query '${s} against cache`);o.reject(c)}})}(yield Df(n),e,t)})),t.promise}function dw(n,e,t={}){let r=new Oe;return n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(s,o,a,c,u){let d=new Fi({next:g=>{o.enqueueAndForget(()=>Sf(s,p)),g.fromCache&&c.source==="server"?u.reject(new D(R.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):u.resolve(g)},error:g=>u.reject(g)}),p=new To(a,d,{includeMetadataChanges:!0,oa:!0});return Af(s,p)}(yield Mi(n),n.asyncQueue,e,t,r)})),r.promise}function $0(n,e){let t=new Fi(e);return n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(i,s){L(i).J_.add(s),s.next()}(yield Mi(n),t)})),()=>{t.Ga(),n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(i,s){L(i).J_.delete(s)}(yield Mi(n),t)}))}}function Q0(n,e,t,r){let i=function(o,a){let c;return c=typeof o=="string"?Av().encode(o):o,function(d,p){return new Gd(d,p)}(function(d,p){if(d instanceof Uint8Array)return Dy(d,p);if(d instanceof ArrayBuffer)return Dy(new Uint8Array(d),p);if(d instanceof ReadableStream)return d.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(c),a)}(t,ko(e));n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){q0(yield Vf(n),i,r)}))}function H0(n,e){return n.asyncQueue.enqueue(()=>x(this,null,function*(){return function(r,i){let s=L(r);return s.persistence.runTransaction("Get named query","readonly",o=>s.Wr.getNamedQuery(o,i))}(yield Df(n),e)}))}function fw(n){let e={};return n.timeoutSeconds!==void 0&&(e.timeoutSeconds=n.timeoutSeconds),e}var Vy=new Map;function Of(n,e,t){if(!t)throw new D(R.INVALID_ARGUMENT,`Function ${n}() cannot be called with an empty ${e}.`)}function Ff(n,e,t,r){if(e===!0&&r===!0)throw new D(R.INVALID_ARGUMENT,`${n} and ${t} cannot be used together.`)}function Oy(n){if(!U.isDocumentKey(n))throw new D(R.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${n} has ${n.length}.`)}function Fy(n){if(U.isDocumentKey(n))throw new D(R.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${n} has ${n.length}.`)}function ic(n){if(n===void 0)return"undefined";if(n===null)return"null";if(typeof n=="string")return n.length>20&&(n=`${n.substring(0,20)}...`),JSON.stringify(n);if(typeof n=="number"||typeof n=="boolean")return""+n;if(typeof n=="object"){if(n instanceof Array)return"an array";{let e=function(r){return r.constructor?r.constructor.name:null}(n);return e?`a custom ${e} object`:"an object"}}return typeof n=="function"?"a function":B()}function oe(n,e){if("_delegate"in n&&(n=n._delegate),!(n instanceof e)){if(e.name===n.constructor.name)throw new D(R.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let t=ic(n);throw new D(R.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return n}function pw(n,e){if(e<=0)throw new D(R.INVALID_ARGUMENT,`Function ${n}() requires a positive number, but it was: ${e}.`)}var Kl=class{constructor(e){var t,r;if(e.host===void 0){if(e.ssl!==void 0)throw new D(R.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=(t=e.ssl)===null||t===void 0||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,e.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(e.cacheSizeBytes!==-1&&e.cacheSizeBytes<1048576)throw new D(R.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Ff("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:e.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=fw((r=e.experimentalLongPollingOptions)!==null&&r!==void 0?r:{}),function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new D(R.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new D(R.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new D(R.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(r,i){return r.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}},Nr=class{constructor(e,t,r,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=r,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Kl({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new D(R.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!==void 0}_setSettings(e){if(this._settingsFrozen)throw new D(R.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Kl(e),e.credentials!==void 0&&(this._authCredentials=function(r){if(!r)return new lh;switch(r.type){case"firstParty":return new dh(r.sessionIndex||"0",r.iamToken||null,r.authTokenFactory||null);case"provider":return r.client;default:throw new D(R.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){let r=Vy.get(t);r&&(V("ComponentProvider","Removing Datastore"),Vy.delete(t),r.terminate())}(this),Promise.resolve()}};function gw(n,e,t,r={}){var i;let s=(n=oe(n,Nr))._getSettings(),o=`${e}:${t}`;if(s.host!=="firestore.googleapis.com"&&s.host!==o&&Et("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:o,ssl:!1})),r.mockUserToken){let a,c;if(typeof r.mockUserToken=="string")a=r.mockUserToken,c=Ve.MOCK_USER;else{a=Fa(r.mockUserToken,(i=n._app)===null||i===void 0?void 0:i.options.projectId);let u=r.mockUserToken.sub||r.mockUserToken.user_id;if(!u)throw new D(R.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");c=new Ve(u)}n._authCredentials=new ch(new il(a,c))}}var We=class n{constructor(e,t,r){this.converter=t,this._query=r,this.type="query",this.firestore=e}withConverter(e){return new n(this.firestore,e,this._query)}},pe=class n{constructor(e,t,r){this.converter=t,this._key=r,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new jt(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new n(this.firestore,e,this._key)}},jt=class n extends We{constructor(e,t,r){super(e,t,Bi(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new pe(this.firestore,null,new U(e))}withConverter(e){return new n(this.firestore,e,this._path)}};function Mf(n,e,...t){if(n=ne(n),Of("collection","path",e),n instanceof Nr){let r=se.fromString(e,...t);return Fy(r),new jt(n,null,r)}{if(!(n instanceof pe||n instanceof jt))throw new D(R.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(se.fromString(e,...t));return Fy(r),new jt(n.firestore,null,r)}}function mw(n,e){if(n=oe(n,Nr),Of("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new D(R.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new We(n,null,function(r){return new xt(se.emptyPath(),r)}(e))}function Do(n,e,...t){if(n=ne(n),arguments.length===1&&(e=sl.newId()),Of("doc","path",e),n instanceof Nr){let r=se.fromString(e,...t);return Oy(r),new pe(n,null,new U(r))}{if(!(n instanceof pe||n instanceof jt))throw new D(R.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(se.fromString(e,...t));return Oy(r),new pe(n.firestore,n instanceof jt?n.converter:null,new U(r))}}function Lf(n,e){return n=ne(n),e=ne(e),(n instanceof pe||n instanceof jt)&&(e instanceof pe||e instanceof jt)&&n.firestore===e.firestore&&n.path===e.path&&n.converter===e.converter}function Uf(n,e){return n=ne(n),e=ne(e),n instanceof We&&e instanceof We&&n.firestore===e.firestore&&Po(n._query,e._query)&&n.converter===e.converter}var $d=class{constructor(){this._u=Promise.resolve(),this.au=[],this.uu=!1,this.cu=[],this.lu=null,this.hu=!1,this.Pu=!1,this.Iu=[],this.e_=new Eo(this,"async_queue_retry"),this.Tu=()=>{let t=nl();t&&V("AsyncQueue","Visibility state changed to "+t.visibilityState),this.e_.zo()};let e=nl();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.Tu)}get isShuttingDown(){return this.uu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Eu(),this.du(e)}enterRestrictedMode(e){if(!this.uu){this.uu=!0,this.Pu=e||!1;let t=nl();t&&typeof t.removeEventListener=="function"&&t.removeEventListener("visibilitychange",this.Tu)}}enqueue(e){if(this.Eu(),this.uu)return new Promise(()=>{});let t=new Oe;return this.du(()=>this.uu&&this.Pu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.au.push(e),this.Au()))}Au(){return x(this,null,function*(){if(this.au.length!==0){try{yield this.au[0](),this.au.shift(),this.e_.reset()}catch(e){if(!Xn(e))throw e;V("AsyncQueue","Operation failed with retryable error: "+e)}this.au.length>0&&this.e_.Wo(()=>this.Au())}})}du(e){let t=this._u.then(()=>(this.hu=!0,e().catch(r=>{this.lu=r,this.hu=!1;let i=function(o){let a=o.message||"";return o.stack&&(a=o.stack.includes(o.message)?o.stack:o.message+`
`+o.stack),a}(r);throw be("INTERNAL UNHANDLED ERROR: ",i),r}).then(r=>(this.hu=!1,r))));return this._u=t,t}enqueueAfterDelay(e,t,r){this.Eu(),this.Iu.indexOf(e)>-1&&(t=0);let i=kd.createAndSchedule(this,e,t,r,s=>this.Ru(s));return this.cu.push(i),i}Eu(){this.lu&&B()}verifyOperationInProgress(){}Vu(){return x(this,null,function*(){let e;do e=this._u,yield e;while(e!==this._u)})}mu(e){for(let t of this.cu)if(t.timerId===e)return!0;return!1}fu(e){return this.Vu().then(()=>{this.cu.sort((t,r)=>t.targetTimeMs-r.targetTimeMs);for(let t of this.cu)if(t.skipDelay(),e!=="all"&&t.timerId===e)break;return this.Vu()})}gu(e){this.Iu.push(e)}Ru(e){let t=this.cu.indexOf(e);this.cu.splice(t,1)}};function Qd(n){return function(t,r){if(typeof t!="object"||t===null)return!1;let i=t;for(let s of r)if(s in i&&typeof i[s]=="function")return!0;return!1}(n,["next","error","complete"])}var Hd=class{constructor(){this._progressObserver={},this._taskCompletionResolver=new Oe,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,r){this._progressObserver={next:e,error:t,complete:r}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}};var _w=-1,ye=class extends Nr{constructor(e,t,r,i){super(e,t,r,i),this.type="firestore",this._queue=function(){return new $d}(),this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return this._firestoreClient||yw(this),this._firestoreClient.terminate()}};function Be(n){return n._firestoreClient||yw(n),n._firestoreClient.verifyNotTerminated(),n._firestoreClient}function yw(n){var e,t,r;let i=n._freezeSettings(),s=function(a,c,u,d){return new wh(a,c,u,d.host,d.ssl,d.experimentalForceLongPolling,d.experimentalAutoDetectLongPolling,fw(d.experimentalLongPollingOptions),d.useFetchStreams)}(n._databaseId,((e=n._app)===null||e===void 0?void 0:e.options.appId)||"",n._persistenceKey,i);n._firestoreClient=new Kd(n._authCredentials,n._appCheckCredentials,n._queue,s),!((t=i.localCache)===null||t===void 0)&&t._offlineComponentProvider&&(!((r=i.localCache)===null||r===void 0)&&r._onlineComponentProvider)&&(n._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function vw(n,e){Rw(n=oe(n,ye));let t=Be(n);if(t._uninitializedComponentsProvider)throw new D(R.FAILED_PRECONDITION,"SDK cache is already specified.");Et("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let r=n._freezeSettings(),i=new Ao;return Ew(t,i,new zl(i,r.cacheSizeBytes,e?.forceOwnership))}function ww(n){Rw(n=oe(n,ye));let e=Be(n);if(e._uninitializedComponentsProvider)throw new D(R.FAILED_PRECONDITION,"SDK cache is already specified.");Et("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=n._freezeSettings(),r=new Ao;return Ew(e,r,new qd(r,t.cacheSizeBytes))}function Ew(n,e,t){let r=new Oe;return n.asyncQueue.enqueue(()=>x(this,null,function*(){try{yield rl(n,t),yield Wd(n,e),r.resolve()}catch(i){let s=i;if(!lw(s))throw s;Et("Error enabling indexeddb cache. Falling back to memory cache: "+s),r.reject(s)}})).then(()=>r.promise)}function Tw(n){if(n._initialized&&!n._terminated)throw new D(R.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let e=new Oe;return n._queue.enqueueAndForgetEvenWhileRestricted(()=>x(this,null,function*(){try{yield function(r){return x(this,null,function*(){if(!Gn.D())return Promise.resolve();let i=r+"main";yield Gn.delete(i)})}(wf(n._databaseId,n._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function Iw(n){return function(t){let r=new Oe;return t.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return x0(yield Vf(t),r)})),r.promise}(Be(n=oe(n,ye)))}function Aw(n){return j0(Be(n=oe(n,ye)))}function Sw(n){return z0(Be(n=oe(n,ye)))}function Cw(n,e){let t=Be(n=oe(n,ye)),r=new Hd;return Q0(t,n._databaseId,e,r),r}function bw(n,e){return H0(Be(n=oe(n,ye)),e).then(t=>t?new We(n,null,t.query):null)}function Rw(n){if(n._initialized||n._terminated)throw new D(R.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var $t=class n{constructor(e){this._byteString=e}static fromBase64String(e){try{return new n(xe.fromBase64String(e))}catch(t){throw new D(R.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new n(xe.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}};var Nt=class{constructor(...e){for(let t=0;t<e.length;++t)if(e[t].length===0)throw new D(R.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Re(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}};var fn=class{constructor(e){this._methodName=e}};var Dr=class{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new D(R.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new D(R.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Y(this._lat,e._lat)||Y(this._long,e._long)}};var Y0=/^__.*__$/,Yd=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return this.fieldMask!==null?new kt(e,this.data,this.fieldMask,t,this.fieldTransforms):new Qn(e,this.data,t,this.fieldTransforms)}},Wl=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return new kt(e,this.data,this.fieldMask,t,this.fieldTransforms)}};function Pw(n){switch(n){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw B()}}var $l=class n{constructor(e,t,r,i,s,o){this.settings=e,this.databaseId=t,this.serializer=r,this.ignoreUndefinedProperties=i,s===void 0&&this.pu(),this.fieldTransforms=s||[],this.fieldMask=o||[]}get path(){return this.settings.path}get yu(){return this.settings.yu}wu(e){return new n(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Su(e){var t;let r=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.wu({path:r,bu:!1});return i.Du(e),i}Cu(e){var t;let r=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.wu({path:r,bu:!1});return i.pu(),i}vu(e){return this.wu({path:void 0,bu:!0})}Fu(e){return Ql(e,this.settings.methodName,this.settings.Mu||!1,this.path,this.settings.xu)}contains(e){return this.fieldMask.find(t=>e.isPrefixOf(t))!==void 0||this.fieldTransforms.find(t=>e.isPrefixOf(t.field))!==void 0}pu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Du(this.path.get(e))}Du(e){if(e.length===0)throw this.Fu("Document fields must not be empty");if(Pw(this.yu)&&Y0.test(e))throw this.Fu('Document fields cannot begin and end with "__"')}},Jd=class{constructor(e,t,r){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=r||ko(e)}Ou(e,t,r,i=!1){return new $l({yu:e,methodName:t,xu:r,path:Re.emptyPath(),bu:!1,Mu:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function Mr(n){let e=n._freezeSettings(),t=ko(n._databaseId);return new Jd(n._databaseId,!!e.ignoreUndefinedProperties,t)}function sc(n,e,t,r,i,s={}){let o=n.Ou(s.merge||s.mergeFields?2:0,e,t,i);Gf("Data must be an object, but it was:",o,r);let a=Nw(r,o),c,u;if(s.merge)c=new ft(o.fieldMask),u=o.fieldTransforms;else if(s.mergeFields){let d=[];for(let p of s.mergeFields){let g=nf(e,p,t);if(!o.contains(g))throw new D(R.INVALID_ARGUMENT,`Field '${g}' is specified in your field mask but missing from your input data.`);Vw(d,g)||d.push(g)}c=new ft(d),u=o.fieldTransforms.filter(p=>c.covers(p.field))}else c=null,u=o.fieldTransforms;return new Yd(new Xe(a),c,u)}var So=class n extends fn{_toFieldTransform(e){if(e.yu!==2)throw e.yu===1?e.Fu(`${this._methodName}() can only appear at the top level of your update data`):e.Fu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof n}};function xw(n,e,t){return new $l({yu:3,xu:e.settings.xu,methodName:n._methodName,bu:t},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}var Xd=class n extends fn{_toFieldTransform(e){return new Pr(e.path,new Wn)}isEqual(e){return e instanceof n}},Zd=class n extends fn{constructor(e,t){super(e),this.Nu=t}_toFieldTransform(e){let t=xw(this,e,!0),r=this.Nu.map(s=>Lr(s,t)),i=new hn(r);return new Pr(e.path,i)}isEqual(e){return e instanceof n&&Lu(this.Nu,e.Nu)}},ef=class n extends fn{constructor(e,t){super(e),this.Nu=t}_toFieldTransform(e){let t=xw(this,e,!0),r=this.Nu.map(s=>Lr(s,t)),i=new dn(r);return new Pr(e.path,i)}isEqual(e){return e instanceof n&&Lu(this.Nu,e.Nu)}},tf=class n extends fn{constructor(e,t){super(e),this.Lu=t}_toFieldTransform(e){let t=new $n(e.serializer,gv(e.serializer,this.Lu));return new Pr(e.path,t)}isEqual(e){return e instanceof n&&this.Lu===e.Lu}};function Bf(n,e,t,r){let i=n.Ou(1,e,t);Gf("Data must be an object, but it was:",i,r);let s=[],o=Xe.empty();Fr(r,(c,u)=>{let d=jf(e,c,t);u=ne(u);let p=i.Cu(d);if(u instanceof So)s.push(d);else{let g=Lr(u,p);g!=null&&(s.push(d),o.set(d,g))}});let a=new ft(s);return new Wl(o,a,i.fieldTransforms)}function qf(n,e,t,r,i,s){let o=n.Ou(1,e,t),a=[nf(e,r,t)],c=[i];if(s.length%2!=0)throw new D(R.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let g=0;g<s.length;g+=2)a.push(nf(e,s[g])),c.push(s[g+1]);let u=[],d=Xe.empty();for(let g=a.length-1;g>=0;--g)if(!Vw(u,a[g])){let y=a[g],S=c[g];S=ne(S);let k=o.Cu(y);if(S instanceof So)u.push(y);else{let N=Lr(S,k);N!=null&&(u.push(y),d.set(y,N))}}let p=new ft(u);return new Wl(d,p,o.fieldTransforms)}function kw(n,e,t,r=!1){return Lr(t,n.Ou(r?4:3,e))}function Lr(n,e){if(Dw(n=ne(n)))return Gf("Unsupported field value:",e,n),Nw(n,e);if(n instanceof fn)return function(r,i){if(!Pw(i.yu))throw i.Fu(`${r._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Fu(`${r._methodName}() is not currently supported inside arrays`);let s=r._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(n,e),null;if(n===void 0&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),n instanceof Array){if(e.settings.bu&&e.yu!==4)throw e.Fu("Nested arrays are not supported");return function(r,i){let s=[],o=0;for(let a of r){let c=Lr(a,i.vu(o));c==null&&(c={nullValue:"NULL_VALUE"}),s.push(c),o++}return{arrayValue:{values:s}}}(n,e)}return function(r,i){if((r=ne(r))===null)return{nullValue:"NULL_VALUE"};if(typeof r=="number")return gv(i.serializer,r);if(typeof r=="boolean")return{booleanValue:r};if(typeof r=="string")return{stringValue:r};if(r instanceof Date){let s=we.fromDate(r);return{timestampValue:Ri(i.serializer,s)}}if(r instanceof we){let s=new we(r.seconds,1e3*Math.floor(r.nanoseconds/1e3));return{timestampValue:Ri(i.serializer,s)}}if(r instanceof Dr)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof $t)return{bytesValue:Sv(i.serializer,r._byteString)};if(r instanceof pe){let s=i.databaseId,o=r.firestore._databaseId;if(!o.isEqual(s))throw i.Fu(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:_f(r.firestore._databaseId||i.databaseId,r._key.path)}}throw i.Fu(`Unsupported field value: ${ic(r)}`)}(n,e)}function Nw(n,e){let t={};return Jy(n)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):Fr(n,(r,i)=>{let s=Lr(i,e.Su(r));s!=null&&(t[r]=s)}),{mapValue:{fields:t}}}function Dw(n){return!(typeof n!="object"||n===null||n instanceof Array||n instanceof Date||n instanceof we||n instanceof Dr||n instanceof $t||n instanceof pe||n instanceof fn)}function Gf(n,e,t){if(!Dw(t)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(t)){let r=ic(t);throw r==="an object"?e.Fu(n+" a custom object"):e.Fu(n+" "+r)}}function nf(n,e,t){if((e=ne(e))instanceof Nt)return e._internalPath;if(typeof e=="string")return jf(n,e);throw Ql("Field path arguments must be of type string or ",n,!1,void 0,t)}var J0=new RegExp("[~\\*/\\[\\]]");function jf(n,e,t){if(e.search(J0)>=0)throw Ql(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,n,!1,void 0,t);try{return new Nt(...e.split("."))._internalPath}catch{throw Ql(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,n,!1,void 0,t)}}function Ql(n,e,t,r,i){let s=r&&!r.isEmpty(),o=i!==void 0,a=`Function ${e}() called with invalid data`;t&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(s||o)&&(c+=" (found",s&&(c+=` in field ${r}`),o&&(c+=` in document ${i}`),c+=")"),new D(R.INVALID_ARGUMENT,a+n+c)}function Vw(n,e){return n.some(t=>t.isEqual(e))}var Vr=class{constructor(e,t,r,i,s){this._firestore=e,this._userDataWriter=t,this._key=r,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new pe(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let e=new rf(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(oc("DocumentSnapshot.get",e));if(t!==null)return this._userDataWriter.convertValue(t)}}},rf=class extends Vr{data(){return super.data()}};function oc(n,e){return typeof e=="string"?jf(n,e):e instanceof Nt?e._internalPath:e._delegate._internalPath}function Ow(n){if(n.limitType==="L"&&n.explicitOrderBy.length===0)throw new D(R.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var Co=class{},Or=class extends Co{};function mn(n,e,...t){let r=[];e instanceof Co&&r.push(e),r=r.concat(t),function(s){let o=s.filter(c=>c instanceof sf).length,a=s.filter(c=>c instanceof Hl).length;if(o>1||o>0&&a>0)throw new D(R.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(let i of r)n=i._apply(n);return n}var Hl=class n extends Or{constructor(e,t,r){super(),this._field=e,this._op=t,this._value=r,this.type="where"}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=this._parse(e);return Kw(e._query,t),new We(e.firestore,e.converter,Dh(e._query,t))}_parse(e){let t=Mr(e.firestore);return function(s,o,a,c,u,d,p){let g;if(u.isKeyField()){if(d==="array-contains"||d==="array-contains-any")throw new D(R.INVALID_ARGUMENT,`Invalid Query. You can't perform '${d}' queries on documentId().`);if(d==="in"||d==="not-in"){Ly(p,d);let y=[];for(let S of p)y.push(My(c,s,S));g={arrayValue:{values:y}}}else g=My(c,s,p)}else d!=="in"&&d!=="not-in"&&d!=="array-contains-any"||Ly(p,d),g=kw(a,o,p,d==="in"||d==="not-in");return re.create(u,d,g)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}};function Fw(n,e,t){let r=e,i=oc("where",n);return Hl._create(i,r,t)}var sf=class n extends Co{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new n(e,t)}_parse(e){let t=this._queryConstraints.map(r=>r._parse(e)).filter(r=>r.getFilters().length>0);return t.length===1?t[0]:ue.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return t.getFilters().length===0?e:(function(i,s){let o=i,a=s.getFlattenedFilters();for(let c of a)Kw(o,c),o=Dh(o,c)}(e._query,t),new We(e.firestore,e.converter,Dh(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}};var of=class n extends Or{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new n(e,t)}_apply(e){let t=function(i,s,o){if(i.startAt!==null)throw new D(R.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new D(R.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new br(s,o)}(e._query,this._field,this._direction);return new We(e.firestore,e.converter,function(i,s){let o=i.explicitOrderBy.concat([s]);return new xt(i.path,i.collectionGroup,o,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(e._query,t))}};function Mw(n,e="asc"){let t=e,r=oc("orderBy",n);return of._create(r,t)}var Yl=class n extends Or{constructor(e,t,r){super(),this.type=e,this._limit=t,this._limitType=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){return new We(e.firestore,e.converter,gl(e._query,this._limit,this._limitType))}};function Lw(n){return pw("limit",n),Yl._create("limit",n,"F")}function Uw(n){return pw("limitToLast",n),Yl._create("limitToLast",n,"L")}var Jl=class n extends Or{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=zw(e,this.type,this._docOrFields,this._inclusive);return new We(e.firestore,e.converter,function(i,s){return new xt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)}(e._query,t))}};function Bw(...n){return Jl._create("startAt",n,!0)}function qw(...n){return Jl._create("startAfter",n,!1)}var Xl=class n extends Or{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=zw(e,this.type,this._docOrFields,this._inclusive);return new We(e.firestore,e.converter,function(i,s){return new xt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)}(e._query,t))}};function Gw(...n){return Xl._create("endBefore",n,!1)}function jw(...n){return Xl._create("endAt",n,!0)}function zw(n,e,t,r){if(t[0]=ne(t[0]),t[0]instanceof Vr)return function(s,o,a,c,u){if(!c)throw new D(R.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${a}().`);let d=[];for(let p of wi(s))if(p.field.isKeyField())d.push(Cr(o,c.key));else{let g=c.data.field(p.field);if(ec(g))throw new D(R.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+p.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(g===null){let y=p.field.canonicalString();throw new D(R.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${y}' (used as the orderBy) does not exist.`)}d.push(g)}return new Kt(d,u)}(n._query,n.firestore._databaseId,e,t[0]._document,r);{let i=Mr(n.firestore);return function(o,a,c,u,d,p){let g=o.explicitOrderBy;if(d.length>g.length)throw new D(R.INVALID_ARGUMENT,`Too many arguments provided to ${u}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let y=[];for(let S=0;S<d.length;S++){let k=d[S];if(g[S].field.isKeyField()){if(typeof k!="string")throw new D(R.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${u}(), but got a ${typeof k}`);if(!gf(o)&&k.indexOf("/")!==-1)throw new D(R.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${u}() must be a plain document ID, but '${k}' contains a slash.`);let N=o.path.child(se.fromString(k));if(!U.isDocumentKey(N))throw new D(R.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${u}() must result in a valid document path, but '${N}' is not because it contains an odd number of segments.`);let q=new U(N);y.push(Cr(a,q))}else{let N=kw(c,u,k);y.push(N)}}return new Kt(y,p)}(n._query,n.firestore._databaseId,i,e,t,r)}}function My(n,e,t){if(typeof(t=ne(t))=="string"){if(t==="")throw new D(R.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!gf(e)&&t.indexOf("/")!==-1)throw new D(R.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${t}' contains a '/' character.`);let r=e.path.child(se.fromString(t));if(!U.isDocumentKey(r))throw new D(R.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Cr(n,new U(r))}if(t instanceof pe)return Cr(n,t._key);throw new D(R.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${ic(t)}.`)}function Ly(n,e){if(!Array.isArray(n)||n.length===0)throw new D(R.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function Kw(n,e){let t=function(i,s){for(let o of i)for(let a of o.getFlattenedFilters())if(s.indexOf(a.op)>=0)return a.op;return null}(n.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(t!==null)throw t===e.op?new D(R.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new D(R.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${t.toString()}' filters.`)}var Li=class{convertValue(e,t="none"){switch(Sr(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Ae(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(jn(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw B()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let r={};return Fr(e,(i,s)=>{r[i]=this.convertValue(s,t)}),r}convertGeoPoint(e){return new Dr(Ae(e.latitude),Ae(e.longitude))}convertArray(e,t){return(e.values||[]).map(r=>this.convertValue(r,t))}convertServerTimestamp(e,t){switch(t){case"previous":let r=ff(e);return r==null?null:this.convertValue(r,t);case"estimate":return this.convertTimestamp(ao(e));default:return null}}convertTimestamp(e){let t=un(e);return new we(t.seconds,t.nanos)}convertDocumentKey(e,t){let r=se.fromString(e);j(Fv(r));let i=new zn(r.get(1),r.get(3)),s=new U(r.popFirst(5));return i.isEqual(t)||be(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}};function ac(n,e,t){let r;return r=n?t&&(t.merge||t.mergeFields)?n.toFirestore(e,t):n.toFirestore(e):e,r}var af=class extends Li{constructor(e){super(),this.firestore=e}convertBytes(e){return new $t(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new pe(this.firestore,null,t)}};var cn=class{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}},It=class extends Vr{constructor(e,t,r,i,s,o){super(e,t,r,i,o),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new Bn(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let r=this._document.data.field(oc("DocumentSnapshot.get",e));if(r!==null)return this._userDataWriter.convertValue(r,t.serverTimestamps)}}},Bn=class extends It{data(e={}){return super.data(e)}},Dt=class{constructor(e,t,r,i){this._firestore=e,this._userDataWriter=t,this._snapshot=i,this.metadata=new cn(i.hasPendingWrites,i.fromCache),this.query=r}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(e,t){this._snapshot.docs.forEach(r=>{e.call(t,new Bn(this._firestore,this._userDataWriter,r.key,r,new cn(this._snapshot.mutatedKeys.has(r.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new D(R.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let o=0;return i._snapshot.docChanges.map(a=>{let c=new Bn(i._firestore,i._userDataWriter,a.doc.key,a.doc,new cn(i._snapshot.mutatedKeys.has(a.doc.key),i._snapshot.fromCache),i.query.converter);return a.doc,{type:"added",doc:c,oldIndex:-1,newIndex:o++}})}{let o=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(a=>s||a.type!==3).map(a=>{let c=new Bn(i._firestore,i._userDataWriter,a.doc.key,a.doc,new cn(i._snapshot.mutatedKeys.has(a.doc.key),i._snapshot.fromCache),i.query.converter),u=-1,d=-1;return a.type!==0&&(u=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),d=o.indexOf(a.doc.key)),{type:X0(a.type),doc:c,oldIndex:u,newIndex:d}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}};function X0(n){switch(n){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return B()}}function zf(n,e){return n instanceof It&&e instanceof It?n._firestore===e._firestore&&n._key.isEqual(e._key)&&(n._document===null?e._document===null:n._document.isEqual(e._document))&&n._converter===e._converter:n instanceof Dt&&e instanceof Dt&&n._firestore===e._firestore&&Uf(n.query,e.query)&&n.metadata.isEqual(e.metadata)&&n._snapshot.isEqual(e._snapshot)}function Ww(n){n=oe(n,pe);let e=oe(n.firestore,ye);return hw(Be(e),n._key).then(t=>Qf(e,n,t))}var pn=class extends Li{constructor(e){super(),this.firestore=e}convertBytes(e){return new $t(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new pe(this.firestore,null,t)}};function $w(n){n=oe(n,pe);let e=oe(n.firestore,ye),t=Be(e),r=new pn(e);return K0(t,n._key).then(i=>new It(e,r,n._key,i,new cn(i!==null&&i.hasLocalMutations,!0),n.converter))}function Qw(n){n=oe(n,pe);let e=oe(n.firestore,ye);return hw(Be(e),n._key,{source:"server"}).then(t=>Qf(e,n,t))}function Hw(n){n=oe(n,We);let e=oe(n.firestore,ye),t=Be(e),r=new pn(e);return Ow(n._query),dw(t,n._query).then(i=>new Dt(e,r,n,i))}function Yw(n){n=oe(n,We);let e=oe(n.firestore,ye),t=Be(e),r=new pn(e);return W0(t,n._query).then(i=>new Dt(e,r,n,i))}function Jw(n){n=oe(n,We);let e=oe(n.firestore,ye),t=Be(e),r=new pn(e);return dw(t,n._query,{source:"server"}).then(i=>new Dt(e,r,n,i))}function Kf(n,e,t){n=oe(n,pe);let r=oe(n.firestore,ye),i=ac(n.converter,e,t);return Ki(r,[sc(Mr(r),"setDoc",n._key,i,n.converter!==null,t).toMutation(n._key,Se.none())])}function Wf(n,e,t,...r){n=oe(n,pe);let i=oe(n.firestore,ye),s=Mr(i),o;return o=typeof(e=ne(e))=="string"||e instanceof Nt?qf(s,"updateDoc",n._key,e,t,r):Bf(s,"updateDoc",n._key,e),Ki(i,[o.toMutation(n._key,Se.exists(!0))])}function Xw(n){return Ki(oe(n.firestore,ye),[new Hn(n._key,Se.none())])}function Zw(n,e){let t=oe(n.firestore,ye),r=Do(n),i=ac(n.converter,e);return Ki(t,[sc(Mr(n.firestore),"addDoc",r._key,i,n.converter!==null,{}).toMutation(r._key,Se.exists(!1))]).then(()=>r)}function $f(n,...e){var t,r,i;n=ne(n);let s={includeMetadataChanges:!1,source:"default"},o=0;typeof e[o]!="object"||Qd(e[o])||(s=e[o],o++);let a={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(Qd(e[o])){let p=e[o];e[o]=(t=p.next)===null||t===void 0?void 0:t.bind(p),e[o+1]=(r=p.error)===null||r===void 0?void 0:r.bind(p),e[o+2]=(i=p.complete)===null||i===void 0?void 0:i.bind(p)}let c,u,d;if(n instanceof pe)u=oe(n.firestore,ye),d=Bi(n._key.path),c={next:p=>{e[o]&&e[o](Qf(u,n,p))},error:e[o+1],complete:e[o+2]};else{let p=oe(n,We);u=oe(p.firestore,ye),d=p._query;let g=new pn(u);c={next:y=>{e[o]&&e[o](new Dt(u,g,p,y))},error:e[o+1],complete:e[o+2]},Ow(n._query)}return function(g,y,S,k){let N=new Fi(k),q=new To(y,N,S);return g.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return Af(yield Mi(g),q)})),()=>{N.Ga(),g.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return Sf(yield Mi(g),q)}))}}(Be(u),d,a,c)}function eE(n,e){return $0(Be(n=oe(n,ye)),Qd(e)?e:{next:e})}function Ki(n,e){return function(r,i){let s=new Oe;return r.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return C0(yield Vf(r),i,s)})),s.promise}(Be(n),e)}function Qf(n,e,t){let r=t.docs.get(e._key),i=new pn(n);return new It(n,i,e._key,r,new cn(t.hasPendingWrites,t.fromCache),e.converter)}var Z0={maxAttempts:5};var Zl=class{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Mr(e)}set(e,t,r){this._verifyNotCommitted();let i=Ln(e,this._firestore),s=ac(i.converter,t,r),o=sc(this._dataReader,"WriteBatch.set",i._key,s,i.converter!==null,r);return this._mutations.push(o.toMutation(i._key,Se.none())),this}update(e,t,r,...i){this._verifyNotCommitted();let s=Ln(e,this._firestore),o;return o=typeof(t=ne(t))=="string"||t instanceof Nt?qf(this._dataReader,"WriteBatch.update",s._key,t,r,i):Bf(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(o.toMutation(s._key,Se.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=Ln(e,this._firestore);return this._mutations=this._mutations.concat(new Hn(t._key,Se.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new D(R.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function Ln(n,e){if((n=ne(n)).firestore!==e)throw new D(R.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return n}var lf=class extends class{constructor(t,r){this._firestore=t,this._transaction=r,this._dataReader=Mr(t)}get(t){let r=Ln(t,this._firestore),i=new af(this._firestore);return this._transaction.lookup([r._key]).then(s=>{if(!s||s.length!==1)return B();let o=s[0];if(o.isFoundDocument())return new Vr(this._firestore,i,o.key,o,r.converter);if(o.isNoDocument())return new Vr(this._firestore,i,r._key,null,r.converter);throw B()})}set(t,r,i){let s=Ln(t,this._firestore),o=ac(s.converter,r,i),a=sc(this._dataReader,"Transaction.set",s._key,o,s.converter!==null,i);return this._transaction.set(s._key,a),this}update(t,r,i,...s){let o=Ln(t,this._firestore),a;return a=typeof(r=ne(r))=="string"||r instanceof Nt?qf(this._dataReader,"Transaction.update",o._key,r,i,s):Bf(this._dataReader,"Transaction.update",o._key,r),this._transaction.update(o._key,a),this}delete(t){let r=Ln(t,this._firestore);return this._transaction.delete(r._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=Ln(e,this._firestore),r=new pn(this._firestore);return super.get(e).then(i=>new It(this._firestore,r,t._key,i._document,new cn(!1,!1),t.converter))}};function tE(n,e,t){n=oe(n,ye);let r=Object.assign(Object.assign({},Z0),t);return function(s){if(s.maxAttempts<1)throw new D(R.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(s,o,a){let c=new Oe;return s.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){let u=yield G0(s);new zd(s.asyncQueue,u,a,o,c).nu()})),c.promise}(Be(n),i=>e(new lf(n,i)),r)}function nE(){return new So("deleteField")}function rE(){return new Xd("serverTimestamp")}function iE(...n){return new Zd("arrayUnion",n)}function sE(...n){return new ef("arrayRemove",n)}function oE(n){return new tf("increment",n)}(function(e,t=!0){(function(i){Ui=i})(qa),gr(new ht("firestore",(r,{instanceIdentifier:i,options:s})=>{let o=r.getProvider("app").getImmediate(),a=new ye(new uh(r.getProvider("auth-internal")),new ph(r.getProvider("app-check-internal")),function(u,d){if(!Object.prototype.hasOwnProperty.apply(u.options,["projectId"]))throw new D(R.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new zn(u.options.projectId,d)}(o,i),o);return s=Object.assign({useFetchStreams:t},s),a._setSettings(s),a},"PUBLIC").setMultipleInstances(!0)),Rt(L_,"4.6.5",e),Rt(L_,"4.6.5","esm2017")})();var eC="@firebase/firestore-compat",tC="0.3.34";function ep(n,e){if(e===void 0)return{merge:!1};if(e.mergeFields!==void 0&&e.merge!==void 0)throw new D("invalid-argument",`Invalid options passed to function ${n}(): You cannot specify both "merge" and "mergeFields".`);return e}function aE(){if(typeof Uint8Array>"u")throw new D("unimplemented","Uint8Arrays are not available in this environment.")}function lE(){if(!Xy())throw new D("unimplemented","Blobs are unavailable in Firestore in this environment.")}var lc=class n{constructor(e){this._delegate=e}static fromBase64String(e){return lE(),new n($t.fromBase64String(e))}static fromUint8Array(e){return aE(),new n($t.fromUint8Array(e))}toBase64(){return lE(),this._delegate.toBase64()}toUint8Array(){return aE(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}};function Hf(n){return nC(n,["next","error","complete"])}function nC(n,e){if(typeof n!="object"||n===null)return!1;let t=n;for(let r of e)if(r in t&&typeof t[r]=="function")return!0;return!1}var Yf=class{enableIndexedDbPersistence(e,t){return vw(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return ww(e._delegate)}clearIndexedDbPersistence(e){return Tw(e._delegate)}},cc=class{constructor(e,t,r){this._delegate=t,this._persistenceProvider=r,this.INTERNAL={delete:()=>this.terminate()},e instanceof zn||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){let t=this._delegate._getSettings();!e.merge&&t.host!==e.host&&Et("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&(e=Object.assign(Object.assign({},t),e),delete e.merge),this._delegate._setSettings(e)}useEmulator(e,t,r={}){gw(this._delegate,e,t,r)}enableNetwork(){return Aw(this._delegate)}disableNetwork(){return Sw(this._delegate)}enablePersistence(e){let t=!1,r=!1;return e&&(t=!!e.synchronizeTabs,r=!!e.experimentalForceOwningTab,Ff("synchronizeTabs",t,"experimentalForceOwningTab",r)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,r)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return Iw(this._delegate)}onSnapshotsInSync(e){return eE(this._delegate,e)}get app(){if(!this._appCompat)throw new D("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new Qi(this,Mf(this._delegate,e))}catch(t){throw it(t,"collection()","Firestore.collection()")}}doc(e){try{return new Qt(this,Do(this._delegate,e))}catch(t){throw it(t,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Gr(this,mw(this._delegate,e))}catch(t){throw it(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return tE(this._delegate,t=>e(new uc(this,t)))}batch(){return Be(this._delegate),new hc(new Zl(this._delegate,e=>Ki(this._delegate,e)))}loadBundle(e){return Cw(this._delegate,e)}namedQuery(e){return bw(this._delegate,e).then(t=>t?new Gr(this,t):null)}},Wi=class extends Li{constructor(e){super(),this.firestore=e}convertBytes(e){return new lc(new $t(e))}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return Qt.forKey(t,this.firestore,null)}};function rC(n){Uy(n)}var uc=class{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Wi(e)}get(e){let t=Ur(e);return this._delegate.get(t).then(r=>new Br(this._firestore,new It(this._firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,t.converter)))}set(e,t,r){let i=Ur(e);return r?(ep("Transaction.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){let s=Ur(e);return arguments.length===2?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){let t=Ur(e);return this._delegate.delete(t),this}},hc=class{constructor(e){this._delegate=e}set(e,t,r){let i=Ur(e);return r?(ep("WriteBatch.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){let s=Ur(e);return arguments.length===2?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){let t=Ur(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}},$i=class n{constructor(e,t,r){this._firestore=e,this._userDataWriter=t,this._delegate=r}fromFirestore(e,t){let r=new Bn(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new qr(this._firestore,r),t??{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){let r=n.INSTANCES,i=r.get(e);i||(i=new WeakMap,r.set(e,i));let s=i.get(t);return s||(s=new n(e,new Wi(e),t),i.set(t,s)),s}};$i.INSTANCES=new WeakMap;var Qt=class n{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Wi(e)}static forPath(e,t,r){if(e.length%2!==0)throw new D("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${e.canonicalString()} has ${e.length}`);return new n(t,new pe(t._delegate,r,new U(e)))}static forKey(e,t,r){return new n(t,new pe(t._delegate,r,e))}get id(){return this._delegate.id}get parent(){return new Qi(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new Qi(this.firestore,Mf(this._delegate,e))}catch(t){throw it(t,"collection()","DocumentReference.collection()")}}isEqual(e){return e=ne(e),e instanceof pe?Lf(this._delegate,e):!1}set(e,t){t=ep("DocumentReference.set",t);try{return t?Kf(this._delegate,e,t):Kf(this._delegate,e)}catch(r){throw it(r,"setDoc()","DocumentReference.set()")}}update(e,t,...r){try{return arguments.length===1?Wf(this._delegate,e):Wf(this._delegate,e,t,...r)}catch(i){throw it(i,"updateDoc()","DocumentReference.update()")}}delete(){return Xw(this._delegate)}onSnapshot(...e){let t=cE(e),r=uE(e,i=>new Br(this.firestore,new It(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return $f(this._delegate,t,r)}get(e){let t;return e?.source==="cache"?t=$w(this._delegate):e?.source==="server"?t=Qw(this._delegate):t=Ww(this._delegate),t.then(r=>new Br(this.firestore,new It(this.firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,this._delegate.converter)))}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter($i.getInstance(this.firestore,e)):this._delegate.withConverter(null))}};function it(n,e,t){return n.message=n.message.replace(e,t),n}function cE(n){for(let e of n)if(typeof e=="object"&&!Hf(e))return e;return{}}function uE(n,e){var t,r;let i;return Hf(n[0])?i=n[0]:Hf(n[1])?i=n[1]:typeof n[0]=="function"?i={next:n[0],error:n[1],complete:n[2]}:i={next:n[1],error:n[2],complete:n[3]},{next:s=>{i.next&&i.next(e(s))},error:(t=i.error)===null||t===void 0?void 0:t.bind(i),complete:(r=i.complete)===null||r===void 0?void 0:r.bind(i)}}var Br=class{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Qt(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return zf(this._delegate,e._delegate)}},qr=class extends Br{data(e){let t=this._delegate.data(e);return this._delegate._converter||By(t!==void 0,"Document in a QueryDocumentSnapshot should exist"),t}},Gr=class n{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Wi(e)}where(e,t,r){try{return new n(this.firestore,mn(this._delegate,Fw(e,t,r)))}catch(i){throw it(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(e,t){try{return new n(this.firestore,mn(this._delegate,Mw(e,t)))}catch(r){throw it(r,/(orderBy|where)\(\)/,"Query.$1()")}}limit(e){try{return new n(this.firestore,mn(this._delegate,Lw(e)))}catch(t){throw it(t,"limit()","Query.limit()")}}limitToLast(e){try{return new n(this.firestore,mn(this._delegate,Uw(e)))}catch(t){throw it(t,"limitToLast()","Query.limitToLast()")}}startAt(...e){try{return new n(this.firestore,mn(this._delegate,Bw(...e)))}catch(t){throw it(t,"startAt()","Query.startAt()")}}startAfter(...e){try{return new n(this.firestore,mn(this._delegate,qw(...e)))}catch(t){throw it(t,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new n(this.firestore,mn(this._delegate,Gw(...e)))}catch(t){throw it(t,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new n(this.firestore,mn(this._delegate,jw(...e)))}catch(t){throw it(t,"endAt()","Query.endAt()")}}isEqual(e){return Uf(this._delegate,e._delegate)}get(e){let t;return e?.source==="cache"?t=Yw(this._delegate):e?.source==="server"?t=Jw(this._delegate):t=Hw(this._delegate),t.then(r=>new Vo(this.firestore,new Dt(this.firestore._delegate,this._userDataWriter,this._delegate,r._snapshot)))}onSnapshot(...e){let t=cE(e),r=uE(e,i=>new Vo(this.firestore,new Dt(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return $f(this._delegate,t,r)}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter($i.getInstance(this.firestore,e)):this._delegate.withConverter(null))}},Jf=class{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new qr(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}},Vo=class{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Gr(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new qr(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(t=>new Jf(this._firestore,t))}forEach(e,t){this._delegate.forEach(r=>{e.call(t,new qr(this._firestore,r))})}isEqual(e){return zf(this._delegate,e._delegate)}},Qi=class n extends Gr{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){let e=this._delegate.parent;return e?new Qt(this.firestore,e):null}doc(e){try{return e===void 0?new Qt(this.firestore,Do(this._delegate)):new Qt(this.firestore,Do(this._delegate,e))}catch(t){throw it(t,"doc()","CollectionReference.doc()")}}add(e){return Zw(this._delegate,e).then(t=>new Qt(this.firestore,t))}isEqual(e){return Lf(this._delegate,e._delegate)}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter($i.getInstance(this.firestore,e)):this._delegate.withConverter(null))}};function Ur(n){return oe(n,pe)}var Xf=class n{constructor(...e){this._delegate=new Nt(...e)}static documentId(){return new n(Re.keyField().canonicalString())}isEqual(e){return e=ne(e),e instanceof Nt?this._delegate._internalPath.isEqual(e._internalPath):!1}};var Zf=class n{constructor(e){this._delegate=e}static serverTimestamp(){let e=rE();return e._methodName="FieldValue.serverTimestamp",new n(e)}static delete(){let e=nE();return e._methodName="FieldValue.delete",new n(e)}static arrayUnion(...e){let t=iE(...e);return t._methodName="FieldValue.arrayUnion",new n(t)}static arrayRemove(...e){let t=sE(...e);return t._methodName="FieldValue.arrayRemove",new n(t)}static increment(e){let t=oE(e);return t._methodName="FieldValue.increment",new n(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}};var iC={Firestore:cc,GeoPoint:Dr,Timestamp:we,Blob:lc,Transaction:uc,WriteBatch:hc,DocumentReference:Qt,DocumentSnapshot:Br,Query:Gr,QueryDocumentSnapshot:qr,QuerySnapshot:Vo,CollectionReference:Qi,FieldPath:Xf,FieldValue:Zf,setLogLevel:rC,CACHE_SIZE_UNLIMITED:_w};function sC(n,e){n.INTERNAL.registerComponent(new ht("firestore-compat",t=>{let r=t.getProvider("app-compat").getImmediate(),i=t.getProvider("firestore").getImmediate();return e(r,i)},"PUBLIC").setServiceProps(Object.assign({},iC)))}function oC(n){sC(n,(e,t)=>new cc(e,t,new Yf)),n.registerVersion(eC,tC)}oC(Le);function aC(n,e=ri){return new In(t=>{let r;return e!=null?e.schedule(()=>{r=n.onSnapshot({includeMetadataChanges:!0},t)}):r=n.onSnapshot({includeMetadataChanges:!0},t),()=>{r?.()}})}function hE(n,e){return aC(n,e)}function lC(n,e){return hE(n,e).pipe(Da(void 0),Na(),Ie(t=>{let[r,i]=t;return i.exists?r?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}function rp(n,e){return hE(n,e).pipe(Ie(t=>({payload:t,type:"query"})))}var dc=class{ref;afs;constructor(e,t){this.ref=e,this.afs=t}set(e,t){return this.ref.set(e,t)}update(e){return this.ref.update(e)}delete(){return this.ref.delete()}collection(e,t){let r=this.ref.collection(e),{ref:i,query:s}=mE(r,t);return new pc(i,s,this.afs)}snapshotChanges(){return lC(this.ref,this.afs.schedulers.outsideAngular).pipe(Ce)}valueChanges(e={}){return this.snapshotChanges().pipe(Ie(({payload:t})=>e.idField?ks(ni({},t.data()),{[e.idField]:t.id}):t.data()))}get(e){return An(this.ref.get(e)).pipe(Ce)}};function fc(n,e){return rp(n,e).pipe(Da(void 0),Na(),Ie(t=>{let[r,i]=t,s=i.payload.docChanges(),o=s.map(a=>({type:a.type,payload:a}));return r&&JSON.stringify(r.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((a,c)=>{let u=s.find(p=>p.doc.ref.isEqual(a.ref)),d=r?.payload.docs.find(p=>p.ref.isEqual(a.ref));u&&JSON.stringify(u.doc.metadata)===JSON.stringify(a.metadata)||!u&&d&&JSON.stringify(d.metadata)===JSON.stringify(a.metadata)||o.push({type:"modified",payload:{oldIndex:c,newIndex:c,type:"modified",doc:a}})}),o}))}function dE(n,e,t){return fc(n,t).pipe(pr((r,i)=>cC(r,i.map(s=>s.payload),e),[]),ka(),Ie(r=>r.map(i=>({type:i.type,payload:i}))))}function cC(n,e,t){return e.forEach(r=>{t.indexOf(r.type)>-1&&(n=uC(n,r))}),n}function tp(n,e,t,...r){let i=n.slice();return i.splice(e,t,...r),i}function uC(n,e){switch(e.type){case"added":if(!(n[e.newIndex]&&n[e.newIndex].doc.ref.isEqual(e.doc.ref)))return tp(n,e.newIndex,0,e);break;case"modified":if(n[e.oldIndex]==null||n[e.oldIndex].doc.ref.isEqual(e.doc.ref))if(e.oldIndex!==e.newIndex){let t=n.slice();return t.splice(e.oldIndex,1),t.splice(e.newIndex,0,e),t}else return tp(n,e.newIndex,1,e);break;case"removed":if(n[e.oldIndex]&&n[e.oldIndex].doc.ref.isEqual(e.doc.ref))return tp(n,e.oldIndex,1);break}return n}function fE(n){return(!n||n.length===0)&&(n=["added","removed","modified"]),n}var pc=class{ref;query;afs;constructor(e,t,r){this.ref=e,this.query=t,this.afs=r}stateChanges(e){let t=fc(this.query,this.afs.schedulers.outsideAngular);return e&&e.length>0&&(t=t.pipe(Ie(r=>r.filter(i=>e.indexOf(i.type)>-1)))),t.pipe(Da(void 0),Na(),Ds(([r,i])=>i.length>0||!r),Ie(([,r])=>r),Ce)}auditTrail(e){return this.stateChanges(e).pipe(pr((t,r)=>[...t,...r],[]))}snapshotChanges(e){let t=fE(e);return dE(this.query,t,this.afs.schedulers.outsideAngular).pipe(Ce)}valueChanges(e={}){return rp(this.query,this.afs.schedulers.outsideAngular).pipe(Ie(t=>t.payload.docs.map(r=>e.idField?ks(ni({},r.data()),{[e.idField]:r.id}):r.data())),Ce)}get(e){return An(this.query.get(e)).pipe(Ce)}add(e){return this.ref.add(e)}doc(e){return new dc(this.ref.doc(e),this.afs)}},np=class{query;afs;constructor(e,t){this.query=e,this.afs=t}stateChanges(e){return!e||e.length===0?fc(this.query,this.afs.schedulers.outsideAngular).pipe(Ce):fc(this.query,this.afs.schedulers.outsideAngular).pipe(Ie(t=>t.filter(r=>e.indexOf(r.type)>-1)),Ds(t=>t.length>0),Ce)}auditTrail(e){return this.stateChanges(e).pipe(pr((t,r)=>[...t,...r],[]))}snapshotChanges(e){let t=fE(e);return dE(this.query,t,this.afs.schedulers.outsideAngular).pipe(Ce)}valueChanges(e={}){return rp(this.query,this.afs.schedulers.outsideAngular).pipe(Ie(r=>r.payload.docs.map(i=>e.idField?ni({[e.idField]:i.id},i.data()):i.data())),Ce)}get(e){return An(this.query.get(e)).pipe(Ce)}},pE=new qe("angularfire2.enableFirestorePersistence"),gE=new qe("angularfire2.firestore.persistenceSettings"),hC=new qe("angularfire2.firestore.settings"),dC=new qe("angularfire2.firestore.use-emulator");function mE(n,e=t=>t){return{query:e(n),ref:n}}var fC=(()=>{class n{schedulers;firestore;persistenceEnabled$;constructor(t,r,i,s,o,a,c,u,d,p,g,y,S,k,N,q,G){this.schedulers=c;let F=mr(t,a,r),K=d;p&&zs(F,a,g,S,k,N,y,q),[this.firestore,this.persistenceEnabled$]=ai(`${F.name}.firestore`,"AngularFirestore",F.name,()=>{let Q=a.runOutsideAngular(()=>F.firestore());if(s&&Q.settings(s),K&&Q.useEmulator(...K),i&&!Va(o)){let H=()=>{try{return An(Q.enablePersistence(u||void 0).then(()=>!0,()=>!1))}catch(E){return typeof console<"u"&&console.warn(E),Ft(!1)}};return[Q,a.runOutsideAngular(H)]}else return[Q,Ft(!1)]},[s,K,i])}collection(t,r){let i;typeof t=="string"?i=this.firestore.collection(t):i=t;let{ref:s,query:o}=mE(i,r),a=this.schedulers.ngZone.run(()=>s);return new pc(a,o,this)}collectionGroup(t,r){let i=r||(o=>o),s=this.firestore.collectionGroup(t);return new np(i(s),this)}doc(t){let r;typeof t=="string"?r=this.firestore.doc(t):r=t;let i=this.schedulers.ngZone.run(()=>r);return new dc(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(r){return new(r||n)(W(kn),W(Nn,8),W(pE,8),W(hC,8),W(Rn),W(Mt),W(oi),W(gE,8),W(dC,8),W(Ks,8),W(Ls,8),W(Us,8),W(Bs,8),W(qs,8),W(Gs,8),W(js,8),W(sn,8))};static \u0275prov=Sn({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),ek=(()=>{class n{constructor(){Le.registerVersion("angularfire",on.full,"fst-compat")}static enablePersistence(t){return{ngModule:n,providers:[{provide:pE,useValue:!0},{provide:gE,useValue:t}]}}static \u0275fac=function(r){return new(r||n)};static \u0275mod=bn({type:n});static \u0275inj=Cn({providers:[fC]})}return n})();var _E="@firebase/database",yE="1.0.7";var gg="";function mg(n){gg=n}var hp=class{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),ke(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:La(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}};var dp=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return yt(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}};var HE=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){let e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new hp(e)}}catch{}return new dp},zr=HE("localStorage"),fp=HE("sessionStorage");var Xi=new xn("@firebase/database"),YE=function(){let n=1;return function(){return n++}}(),JE=function(n){let e=y_(n),t=new __;t.update(e);let r=t.digest();return Oa.encodeByteArray(r)},ia=function(...n){let e="";for(let t=0;t<n.length;t++){let r=n[t];Array.isArray(r)||r&&typeof r=="object"&&typeof r.length=="number"?e+=ia.apply(null,r):typeof r=="object"?e+=ke(r):e+=r,e+=" "}return e},Kr=null,vE=!0,XE=function(n,e){O(!e||n===!0||n===!1,"Can't turn on custom loggers persistently."),n===!0?(Xi.logLevel=vt.VERBOSE,Kr=Xi.log.bind(Xi),e&&fp.set("logging_enabled",!0)):typeof n=="function"?Kr=n:(Kr=null,fp.remove("logging_enabled"))},je=function(...n){if(vE===!0&&(vE=!1,Kr===null&&fp.get("logging_enabled")===!0&&XE(!0)),Kr){let e=ia.apply(null,n);Kr(e)}},sa=function(n){return function(...e){je(n,...e)}},pp=function(...n){let e="FIREBASE INTERNAL ERROR: "+ia(...n);Xi.error(e)},Jt=function(...n){let e=`FIREBASE FATAL ERROR: ${ia(...n)}`;throw Xi.error(e),new Error(e)},Ze=function(...n){let e="FIREBASE WARNING: "+ia(...n);Xi.warn(e)},pC=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&Ze("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},Gc=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},gC=function(n){if(Lt()||document.readyState==="complete")n();else{let e=!1,t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},rr="[MIN_NAME]",_n="[MAX_NAME]",$r=function(n,e){if(n===e)return 0;if(n===rr||e===_n)return-1;if(e===rr||n===_n)return 1;{let t=wE(n),r=wE(e);return t!==null?r!==null?t-r===0?n.length-e.length:t-r:-1:r!==null?1:n<e?-1:1}},mC=function(n,e){return n===e?0:n<e?-1:1},Oo=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+ke(e))},_g=function(n){if(typeof n!="object"||n===null)return ke(n);let e=[];for(let r in n)e.push(r);e.sort();let t="{";for(let r=0;r<e.length;r++)r!==0&&(t+=","),t+=ke(e[r]),t+=":",t+=_g(n[e[r]]);return t+="}",t},ZE=function(n,e){let t=n.length;if(t<=e)return[n];let r=[];for(let i=0;i<t;i+=e)i+e>t?r.push(n.substring(i,t)):r.push(n.substring(i,i+e));return r};function ze(n,e){for(let t in n)n.hasOwnProperty(t)&&e(t,n[t])}var eT=function(n){O(!Gc(n),"Invalid JSON number");let e=11,t=52,r=(1<<e-1)-1,i,s,o,a,c;n===0?(s=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-r)?(a=Math.min(Math.floor(Math.log(n)/Math.LN2),r),s=a+r,o=Math.round(n*Math.pow(2,t-a)-Math.pow(2,t))):(s=0,o=Math.round(n/Math.pow(2,1-r-t))));let u=[];for(c=t;c;c-=1)u.push(o%2?1:0),o=Math.floor(o/2);for(c=e;c;c-=1)u.push(s%2?1:0),s=Math.floor(s/2);u.push(i?1:0),u.reverse();let d=u.join(""),p="";for(c=0;c<64;c+=8){let g=parseInt(d.substr(c,8),2).toString(16);g.length===1&&(g="0"+g),p=p+g}return p.toLowerCase()},_C=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},yC=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function vC(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");let r=new Error(n+" at "+e._path.toString()+": "+t);return r.code=n.toUpperCase(),r}var wC=new RegExp("^-?(0*)\\d{1,10}$"),EC=-2147483648,TC=2147483647,wE=function(n){if(wC.test(n)){let e=Number(n);if(e>=EC&&e<=TC)return e}return null},as=function(n){try{n()}catch(e){setTimeout(()=>{let t=e.stack||"";throw Ze("Exception was thrown by user callback.",t),e},Math.floor(0))}},IC=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},Uo=function(n,e){let t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};var gp=class{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(r=>this.appCheck=r)}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise((t,r)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,r):t(null)},0)})}addTokenChangeListener(e){var t;(t=this.appCheckProvider)===null||t===void 0||t.get().then(r=>r.addTokenListener(e))}notifyForInvalidToken(){Ze(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}};var mp=class{constructor(e,t,r){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=r,this.auth_=null,this.auth_=r.getImmediate({optional:!0}),this.auth_||r.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(je("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,r)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,r):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',Ze(e)}},Bo=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}n.OWNER="owner";return n})(),mc="5",tT="v",nT="s",rT="r",iT="f",sT=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,oT="ls",aT="p",_p="ac",lT="websocket",cT="long_polling";var _c=class{constructor(e,t,r,i,s=!1,o="",a=!1,c=!1){this.secure=t,this.namespace=r,this.webSocketOnly=i,this.nodeAdmin=s,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=zr.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&zr.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){let e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}};function AC(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function uT(n,e,t){O(typeof e=="string","typeof type must == string"),O(typeof t=="object","typeof params must == object");let r;if(e===lT)r=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===cT)r=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);AC(n)&&(t.ns=n.namespace);let i=[];return ze(t,(s,o)=>{i.push(s+"="+o)}),r+i.join("&")}var yp=class{constructor(){this.counters_={}}incrementCounter(e,t=1){yt(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return u_(this.counters_)}};var ip={},sp={};function yg(n){let e=n.toString();return ip[e]||(ip[e]=new yp),ip[e]}function SC(n,e){let t=n.toString();return sp[t]||(sp[t]=e()),sp[t]}var vp=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let r=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<r.length;++i)r[i]&&as(()=>{this.onMessage_(r[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}};var EE="start",CC="close",bC="pLPCommand",RC="pRTLPCB",hT="id",dT="pw",fT="ser",PC="cb",xC="seg",kC="ts",NC="d",DC="dframe",pT=1870,gT=30,VC=pT-gT,OC=25e3,FC=3e4,zo=class n{constructor(e,t,r,i,s,o,a){this.connId=e,this.repoInfo=t,this.applicationId=r,this.appCheckToken=i,this.authToken=s,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=sa(e),this.stats_=yg(t),this.urlFn=c=>(this.appCheckToken&&(c[_p]=this.appCheckToken),uT(t,cT,c))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new vp(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(FC)),gC(()=>{if(this.isClosed_)return;this.scriptTagHolder=new wp((...s)=>{let[o,a,c,u,d]=s;if(this.incrementIncomingBytes_(s),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===EE)this.id=a,this.password=c;else if(o===CC)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...s)=>{let[o,a]=s;this.incrementIncomingBytes_(s),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);let r={};r[EE]="t",r[fT]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(r[PC]=this.scriptTagHolder.uniqueCallbackIdentifier),r[tT]=mc,this.transportSessionId&&(r[nT]=this.transportSessionId),this.lastSessionId&&(r[oT]=this.lastSessionId),this.applicationId&&(r[aT]=this.applicationId),this.appCheckToken&&(r[_p]=this.appCheckToken),typeof location<"u"&&location.hostname&&sT.test(location.hostname)&&(r[rT]=iT);let i=this.urlFn(r);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){n.forceAllow_=!0}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){return Lt()?!1:n.forceAllow_?!0:!n.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!_C()&&!yC()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){let t=ke(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);let r=c_(t),i=ZE(r,VC);for(let s=0;s<i.length;s++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[s]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(Lt())return;this.myDisconnFrame=document.createElement("iframe");let r={};r[DC]="t",r[hT]=e,r[dT]=t,this.myDisconnFrame.src=this.urlFn(r),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=ke(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}},wp=class n{constructor(e,t,r,i){if(this.onDisconnect=r,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,Lt())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=YE(),window[bC+this.uniqueCallbackIdentifier]=e,window[RC+this.uniqueCallbackIdentifier]=t,this.myIFrame=n.createIFrame_();let s="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(s='<script>document.domain="'+document.domain+'";<\/script>');let o="<html><body>"+s+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){je("frame writing exception"),a.stack&&je(a.stack),je(a)}}}static createIFrame_(){let e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||je("No IE domain setting required")}catch{let r=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+r+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[hT]=this.myID,e[dT]=this.myPW,e[fT]=this.currentSerial;let t=this.urlFn(e),r="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+gT+r.length<=pT;){let o=this.pendingSegs.shift();r=r+"&"+xC+i+"="+o.seg+"&"+kC+i+"="+o.ts+"&"+NC+i+"="+o.d,i++}return t=t+r,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,r){this.pendingSegs.push({seg:e,ts:t,d:r}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let r=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(r,Math.floor(OC)),s=()=>{clearTimeout(i),r()};this.addTag(e,s)}addTag(e,t){Lt()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let r=this.myIFrame.doc.createElement("script");r.type="text/javascript",r.async=!0,r.src=e,r.onload=r.onreadystatechange=function(){let i=r.readyState;(!i||i==="loaded"||i==="complete")&&(r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),t())},r.onerror=()=>{je("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(r)}catch{}},Math.floor(1))}};var MC=16384,LC=45e3,yc=null;typeof MozWebSocket<"u"?yc=MozWebSocket:typeof WebSocket<"u"&&(yc=WebSocket);var Yi=(()=>{class n{constructor(t,r,i,s,o,a,c){this.connId=t,this.applicationId=i,this.appCheckToken=s,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=sa(this.connId),this.stats_=yg(r),this.connURL=n.connectionURL_(r,a,c,s,i),this.nodeAdmin=r.nodeAdmin}static connectionURL_(t,r,i,s,o){let a={};return a[tT]=mc,!Lt()&&typeof location<"u"&&location.hostname&&sT.test(location.hostname)&&(a[rT]=iT),r&&(a[nT]=r),i&&(a[oT]=i),s&&(a[_p]=s),o&&(a[aT]=o),uT(t,lT,a)}open(t,r){this.onDisconnect=r,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,zr.set("previous_websocket_failure",!0);try{let i;if(Lt()){let s=this.nodeAdmin?"AdminNode":"Node";i={headers:{"User-Agent":`Firebase/${mc}/${gg}/${process.platform}/${s}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(i.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);let o=process.env,a=this.connURL.indexOf("wss://")===0?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;a&&(i.proxy={origin:a})}this.mySock=new yc(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");let s=i.message||i.data;s&&this.log_(s),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");let s=i.message||i.data;s&&this.log_(s),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){let r=/Android ([0-9]{0,}\.[0-9]{0,})/,i=navigator.userAgent.match(r);i&&i.length>1&&parseFloat(i[1])<4.4&&(t=!0)}return!t&&yc!==null&&!n.forceDisallow_}static previouslyFailed(){return zr.isInMemoryStorage||zr.get("previous_websocket_failure")===!0}markConnectionHealthy(){zr.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){let r=this.frames.join("");this.frames=null;let i=La(r);this.onMessage(i)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if(O(this.frames===null,"We already have a frame buffer"),t.length<=6){let r=Number(t);if(!isNaN(r))return this.handleNewFrameCount_(r),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(this.mySock===null)return;let r=t.data;if(this.bytesReceived+=r.length,this.stats_.incrementCounter("bytes_received",r.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(r);else{let i=this.extractFrameCount_(r);i!==null&&this.appendFrame_(i)}}send(t){this.resetKeepAlive();let r=ke(t);this.bytesSent+=r.length,this.stats_.incrementCounter("bytes_sent",r.length);let i=ZE(r,MC);i.length>1&&this.sendString_(String(i.length));for(let s=0;s<i.length;s++)this.sendString_(i[s])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(LC))}sendString_(t){try{this.mySock.send(t)}catch(r){this.log_("Exception thrown from WebSocket.send():",r.message||r.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4;return n})(),mT=(()=>{class n{constructor(t){this.initTransports_(t)}static get ALL_TRANSPORTS(){return[zo,Yi]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(t){let r=Yi&&Yi.isAvailable(),i=r&&!Yi.previouslyFailed();if(t.webSocketOnly&&(r||Ze("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[Yi];else{let s=this.transports_=[];for(let o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&s.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}n.globalTransportInitialized_=!1;return n})(),UC=6e4,BC=5e3,qC=10*1024,GC=100*1024,op="t",TE="d",jC="s",IE="r",zC="e",AE="o",SE="a",CE="n",bE="p",KC="h",Ep=class{constructor(e,t,r,i,s,o,a,c,u,d){this.id=e,this.repoInfo_=t,this.applicationId_=r,this.appCheckToken_=i,this.authToken_=s,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=c,this.onKill_=u,this.lastSessionId=d,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=sa("c:"+this.id+":"),this.transportManager_=new mT(t),this.log_("Connection created"),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),r=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,r)},Math.floor(0));let i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=Uo(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>GC?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>qC?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){let t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(op in e){let t=e[op];t===SE?this.upgradeIfSecondaryHealthy_():t===IE?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===AE&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=Oo("t",e),r=Oo("d",e);if(t==="c")this.onSecondaryControl_(r);else if(t==="d")this.pendingDataMessages.push(r);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:bE,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:SE,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:CE,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=Oo("t",e),r=Oo("d",e);t==="c"?this.onControl_(r):t==="d"&&this.onDataMessage_(r)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=Oo(op,e);if(TE in e){let r=e[TE];if(t===KC){let i=Object.assign({},r);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===CE){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===jC?this.onConnectionShutdown_(r):t===IE?this.onReset_(r):t===zC?pp("Server Error: "+r):t===AE?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):pp("Unknown control packet command: "+t)}}onHandshake_(e){let t=e.ts,r=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),mc!==r&&Ze("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),r=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,r),Uo(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(UC))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):Uo(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(BC))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:bE,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(zr.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}};var vc=class{put(e,t,r,i){}merge(e,t,r,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,r){}onDisconnectMerge(e,t,r){}onDisconnectCancel(e,t){}reportStats(e){}};var wc=class{constructor(e){this.allowedEvents_=e,this.listeners_={},O(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let r=[...this.listeners_[e]];for(let i=0;i<r.length;i++)r[i].callback.apply(r[i].context,t)}}on(e,t,r){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:r});let i=this.getInitialEvent(e);i&&t.apply(r,i)}off(e,t,r){this.validateEventType_(e);let i=this.listeners_[e]||[];for(let s=0;s<i.length;s++)if(i[s].callback===t&&(!r||r===i[s].context)){i.splice(s,1);return}}validateEventType_(e){O(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}};var Ec=class n extends wc{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!Fu()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new n}getInitialEvent(e){return O(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}};var RE=32,PE=768,ce=class{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let r=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[r]=this.pieces_[i],r++);this.pieces_.length=r,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}};function le(){return new ce("")}function Z(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function ir(n){return n.pieces_.length-n.pieceNum_}function fe(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new ce(n.pieces_,e)}function vg(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function WC(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function Ko(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function _T(n){if(n.pieceNum_>=n.pieces_.length)return null;let e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new ce(e,0)}function ve(n,e){let t=[];for(let r=n.pieceNum_;r<n.pieces_.length;r++)t.push(n.pieces_[r]);if(e instanceof ce)for(let r=e.pieceNum_;r<e.pieces_.length;r++)t.push(e.pieces_[r]);else{let r=e.split("/");for(let i=0;i<r.length;i++)r[i].length>0&&t.push(r[i])}return new ce(t,0)}function ee(n){return n.pieceNum_>=n.pieces_.length}function st(n,e){let t=Z(n),r=Z(e);if(t===null)return e;if(t===r)return st(fe(n),fe(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function $C(n,e){let t=Ko(n,0),r=Ko(e,0);for(let i=0;i<t.length&&i<r.length;i++){let s=$r(t[i],r[i]);if(s!==0)return s}return t.length===r.length?0:t.length<r.length?-1:1}function wg(n,e){if(ir(n)!==ir(e))return!1;for(let t=n.pieceNum_,r=e.pieceNum_;t<=n.pieces_.length;t++,r++)if(n.pieces_[t]!==e.pieces_[r])return!1;return!0}function At(n,e){let t=n.pieceNum_,r=e.pieceNum_;if(ir(n)>ir(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[r])return!1;++t,++r}return!0}var Tp=class{constructor(e,t){this.errorPrefix_=t,this.parts_=Ko(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let r=0;r<this.parts_.length;r++)this.byteLength_+=Fs(this.parts_[r]);yT(this)}};function QC(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=Fs(e),yT(n)}function HC(n){let e=n.parts_.pop();n.byteLength_-=Fs(e),n.parts_.length>0&&(n.byteLength_-=1)}function yT(n){if(n.byteLength_>PE)throw new Error(n.errorPrefix_+"has a key path longer than "+PE+" bytes ("+n.byteLength_+").");if(n.parts_.length>RE)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+RE+") or object contains a cycle "+jr(n))}function jr(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}var Ip=class n extends wc{constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{let r=!document[e];r!==this.visible_&&(this.visible_=r,this.trigger("visible",r))},!1)}static getInstance(){return new n}getInitialEvent(e){return O(e==="visible","Unknown event type: "+e),[this.visible_]}};var Fo=1e3,YC=60*5*1e3,xE=30*1e3,JC=1.3,XC=3e4,ZC="server_kill",kE=3,Eg=(()=>{class n extends vc{constructor(t,r,i,s,o,a,c,u){if(super(),this.repoInfo_=t,this.applicationId_=r,this.onDataUpdate_=i,this.onConnectStatus_=s,this.onServerInfoUpdate_=o,this.authTokenProvider_=a,this.appCheckTokenProvider_=c,this.authOverride_=u,this.id=n.nextPersistentConnectionId_++,this.log_=sa("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Fo,this.maxReconnectDelay_=YC,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,u&&!Lt())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");Ip.getInstance().on("visible",this.onVisible_,this),t.host.indexOf("fblocal")===-1&&Ec.getInstance().on("online",this.onOnline_,this)}sendRequest(t,r,i){let s=++this.requestNumber_,o={r:s,a:t,b:r};this.log_(ke(o)),O(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),i&&(this.requestCBHash_[s]=i)}get(t){this.initConnection_();let r=new Ge,s={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:a=>{let c=a.d;a.s==="ok"?r.resolve(c):r.reject(c)}};this.outstandingGets_.push(s),this.outstandingGetCount_++;let o=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(o),r.promise}listen(t,r,i,s){this.initConnection_();let o=t._queryIdentifier,a=t._path.toString();this.log_("Listen called for "+a+" "+o),this.listens.has(a)||this.listens.set(a,new Map),O(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),O(!this.listens.get(a).has(o),"listen() called twice for same path/queryId.");let c={onComplete:s,hashFn:r,query:t,tag:i};this.listens.get(a).set(o,c),this.connected_&&this.sendListen_(c)}sendGet_(t){let r=this.outstandingGets_[t];this.sendRequest("g",r.request,i=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),r.onComplete&&r.onComplete(i)})}sendListen_(t){let r=t.query,i=r._path.toString(),s=r._queryIdentifier;this.log_("Listen on "+i+" for "+s);let o={p:i},a="q";t.tag&&(o.q=r._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest(a,o,c=>{let u=c.d,d=c.s;n.warnOnListenWarnings_(u,r),(this.listens.get(i)&&this.listens.get(i).get(s))===t&&(this.log_("listen response",c),d!=="ok"&&this.removeListen_(i,s),t.onComplete&&t.onComplete(d,u))})}static warnOnListenWarnings_(t,r){if(t&&typeof t=="object"&&yt(t,"w")){let i=Pn(t,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){let s='".indexOn": "'+r._queryParams.getIndex().toString()+'"',o=r._path.toString();Ze(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${s} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&t.length===40||g_(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=xE)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let t=this.authToken_,r=p_(t)?"auth":"gauth",i={cred:t};this.authOverride_===null?i.noauth=!0:typeof this.authOverride_=="object"&&(i.authvar=this.authOverride_),this.sendRequest(r,i,s=>{let o=s.s,a=s.d||"error";this.authToken_===t&&(o==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,a))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{let r=t.s,i=t.d||"error";r==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(r,i)})}unlisten(t,r){let i=t._path.toString(),s=t._queryIdentifier;this.log_("Unlisten called for "+i+" "+s),O(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,s)&&this.connected_&&this.sendUnlisten_(i,s,t._queryObject,r)}sendUnlisten_(t,r,i,s){this.log_("Unlisten on "+t+" for "+r);let o={p:t},a="n";s&&(o.q=i,o.t=s),this.sendRequest(a,o)}onDisconnectPut(t,r,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,r,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:r,onComplete:i})}onDisconnectMerge(t,r,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,r,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:r,onComplete:i})}onDisconnectCancel(t,r){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,r):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:r})}sendOnDisconnect_(t,r,i,s){let o={p:r,d:i};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,a=>{s&&setTimeout(()=>{s(a.s,a.d)},Math.floor(0))})}put(t,r,i,s){this.putInternal("p",t,r,i,s)}merge(t,r,i,s){this.putInternal("m",t,r,i,s)}putInternal(t,r,i,s,o){this.initConnection_();let a={p:r,d:i};o!==void 0&&(a.h=o),this.outstandingPuts_.push({action:t,request:a,onComplete:s}),this.outstandingPutCount_++;let c=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(c):this.log_("Buffering put: "+r)}sendPut_(t){let r=this.outstandingPuts_[t].action,i=this.outstandingPuts_[t].request,s=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(r,i,o=>{this.log_(r+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),s&&s(o.s,o.d)})}reportStats(t){if(this.connected_){let r={c:t};this.log_("reportStats",r),this.sendRequest("s",r,i=>{if(i.s!=="ok"){let o=i.d;this.log_("reportStats","Error sending stats: "+o)}})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+ke(t));let r=t.r,i=this.requestCBHash_[r];i&&(delete this.requestCBHash_[r],i(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,r){this.log_("handleServerMessage",t,r),t==="d"?this.onDataUpdate_(r.p,r.d,!1,r.t):t==="m"?this.onDataUpdate_(r.p,r.d,!0,r.t):t==="c"?this.onListenRevoked_(r.p,r.q):t==="ac"?this.onAuthRevoked_(r.s,r.d):t==="apc"?this.onAppCheckRevoked_(r.s,r.d):t==="sd"?this.onSecurityDebugPacket_(r):pp("Unrecognized action received from server: "+ke(t)+`
Are you using the latest client?`)}onReady_(t,r){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(t),this.lastSessionId=r,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){O(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Fo,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=Fo,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>XC&&(this.reconnectDelay_=Fo),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let t=new Date().getTime()-this.lastConnectionAttemptTime_,r=Math.max(0,this.reconnectDelay_-t);r=Math.random()*r,this.log_("Trying to reconnect in "+r+"ms"),this.scheduleConnect_(r),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*JC)}this.onConnectStatus_(!1)}establishConnection_(){return x(this,null,function*(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),r=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),s=this.id+":"+n.nextConnectionId_++,o=this.lastSessionId,a=!1,c=null,u=function(){c?c.close():(a=!0,i())},d=function(g){O(c,"sendRequest call when we're not connected not allowed."),c.sendRequest(g)};this.realtime_={close:u,sendRequest:d};let p=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[g,y]=yield Promise.all([this.authTokenProvider_.getToken(p),this.appCheckTokenProvider_.getToken(p)]);a?je("getToken() completed but was canceled"):(je("getToken() completed. Creating connection."),this.authToken_=g&&g.accessToken,this.appCheckToken_=y&&y.token,c=new Ep(s,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,r,i,S=>{Ze(S+" ("+this.repoInfo_.toString()+")"),this.interrupt(ZC)},o))}catch(g){this.log_("Failed to get token: "+g),a||(this.repoInfo_.nodeAdmin&&Ze(g),u())}}})}interrupt(t){je("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){je("Resuming connection for reason: "+t),delete this.interruptReasons_[t],Ua(this.interruptReasons_)&&(this.reconnectDelay_=Fo,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){let r=t-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:r})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){let r=this.outstandingPuts_[t];r&&"h"in r.request&&r.queued&&(r.onComplete&&r.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(t,r){let i;r?i=r.map(o=>_g(o)).join("$"):i="default";let s=this.removeListen_(t,i);s&&s.onComplete&&s.onComplete("permission_denied")}removeListen_(t,r){let i=new ce(t).toString(),s;if(this.listens.has(i)){let o=this.listens.get(i);s=o.get(r),o.delete(r),o.size===0&&this.listens.delete(i)}else s=void 0;return s}onAuthRevoked_(t,r){je("Auth token revoked: "+t+"/"+r),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(t==="invalid_token"||t==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=kE&&(this.reconnectDelay_=xE,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,r){je("App check token revoked: "+t+"/"+r),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(t==="invalid_token"||t==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=kE&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let t of this.listens.values())for(let r of t.values())this.sendListen_(r);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){let t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){let t={},r="js";Lt()&&(this.repoInfo_.nodeAdmin?r="admin_node":r="node"),t["sdk."+r+"."+gg.replace(/\./g,"-")]=1,Fu()?t["framework.cordova"]=1:h_()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){let t=Ec.getInstance().currentlyOnline();return Ua(this.interruptReasons_)&&t}}n.nextPersistentConnectionId_=0,n.nextConnectionId_=0;return n})(),te=class n{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new n(e,t)}};var Zi=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let r=new te(rr,e),i=new te(rr,t);return this.compare(r,i)!==0}minPost(){return te.MIN}};var gc,Tc=class extends Zi{static get __EMPTY_NODE(){return gc}static set __EMPTY_NODE(e){gc=e}compare(e,t){return $r(e.name,t.name)}isDefinedOn(e){throw si("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return te.MIN}maxPost(){return new te(_n,gc)}makePost(e,t){return O(typeof e=="string","KeyIndex indexValue must always be a string."),new te(e,gc)}toString(){return".key"}},Yt=new Tc;var Ji=class{constructor(e,t,r,i,s=null){this.isReverse_=i,this.resultGenerator_=s,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?r(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},Vt=(()=>{class n{constructor(t,r,i,s,o){this.key=t,this.value=r,this.color=i??n.RED,this.left=s??St.EMPTY_NODE,this.right=o??St.EMPTY_NODE}copy(t,r,i,s,o){return new n(t??this.key,r??this.value,i??this.color,s??this.left,o??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,r,i){let s=this,o=i(t,s.key);return o<0?s=s.copy(null,null,null,s.left.insert(t,r,i),null):o===0?s=s.copy(null,r,null,null,null):s=s.copy(null,null,null,null,s.right.insert(t,r,i)),s.fixUp_()}removeMin_(){if(this.left.isEmpty())return St.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,r){let i,s;if(i=this,r(t,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(t,r),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),r(t,i.key)===0){if(i.right.isEmpty())return St.EMPTY_NODE;s=i.right.min_(),i=i.copy(s.key,s.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(t,r))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let t=this.left.copy(null,null,!this.left.color,null,null),r=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,r)}checkMaxDepth_(){let t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");let t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})(),Ap=class{copy(e,t,r,i,s){return this}insert(e,t,r){return new Vt(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},St=class n{constructor(e,t=n.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new n(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,Vt.BLACK,null,null))}remove(e){return new n(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,Vt.BLACK,null,null))}get(e){let t,r=this.root_;for(;!r.isEmpty();){if(t=this.comparator_(e,r.key),t===0)return r.value;t<0?r=r.left:t>0&&(r=r.right)}return null}getPredecessorKey(e){let t,r=this.root_,i=null;for(;!r.isEmpty();)if(t=this.comparator_(e,r.key),t===0){if(r.left.isEmpty())return i?i.key:null;for(r=r.left;!r.right.isEmpty();)r=r.right;return r.key}else t<0?r=r.left:t>0&&(i=r,r=r.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Ji(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Ji(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Ji(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Ji(this.root_,null,this.comparator_,!0,e)}};St.EMPTY_NODE=new Ap;function eb(n,e){return $r(n.name,e.name)}function Tg(n,e){return $r(n,e)}var Sp;function tb(n){Sp=n}var vT=function(n){return typeof n=="number"?"number:"+eT(n):"string:"+n},wT=function(n){if(n.isLeafNode()){let e=n.val();O(typeof e=="string"||typeof e=="number"||typeof e=="object"&&yt(e,".sv"),"Priority must be a string or number.")}else O(n===Sp||n.isEmpty(),"priority of unexpected type.");O(n===Sp||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};var NE,es=(()=>{class n{constructor(t,r=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=r,this.lazyHash_=null,O(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),wT(this.priorityNode_)}static set __childrenNodeConstructor(t){NE=t}static get __childrenNodeConstructor(){return NE}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return t===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return ee(t)?this:Z(t)===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,r){return null}updateImmediateChild(t,r){return t===".priority"?this.updatePriority(r):r.isEmpty()&&t!==".priority"?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,r).updatePriority(this.priorityNode_)}updateChild(t,r){let i=Z(t);return i===null?r:r.isEmpty()&&i!==".priority"?this:(O(i!==".priority"||ir(t)===1,".priority must be the last token in a path"),this.updateImmediateChild(i,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(fe(t),r)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,r){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+vT(this.priorityNode_.val())+":");let r=typeof this.value_;t+=r+":",r==="number"?t+=eT(this.value_):t+=this.value_,this.lazyHash_=JE(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:(O(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){let r=typeof t.value_,i=typeof this.value_,s=n.VALUE_TYPE_ORDER.indexOf(r),o=n.VALUE_TYPE_ORDER.indexOf(i);return O(s>=0,"Unknown leaf type: "+r),O(o>=0,"Unknown leaf type: "+i),s===o?i==="object"?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-s}withIndex(){return this}isIndexed(){return!0}equals(t){if(t===this)return!0;if(t.isLeafNode()){let r=t;return this.value_===r.value_&&this.priorityNode_.equals(r.priorityNode_)}else return!1}}n.VALUE_TYPE_ORDER=["object","boolean","number","string"];return n})(),ET,TT;function nb(n){ET=n}function rb(n){TT=n}var Cp=class extends Zi{compare(e,t){let r=e.node.getPriority(),i=t.node.getPriority(),s=r.compareTo(i);return s===0?$r(e.name,t.name):s}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return te.MIN}maxPost(){return new te(_n,new es("[PRIORITY-POST]",TT))}makePost(e,t){let r=ET(e);return new te(t,new es("[PRIORITY-POST]",r))}toString(){return".priority"}},ge=new Cp;var ib=Math.log(2),bp=class{constructor(e){let t=s=>parseInt(Math.log(s)/ib,10),r=s=>parseInt(Array(s+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;let i=r(this.count);this.bits_=e+1&i}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},Ic=function(n,e,t,r){n.sort(e);let i=function(c,u){let d=u-c,p,g;if(d===0)return null;if(d===1)return p=n[c],g=t?t(p):p,new Vt(g,p.node,Vt.BLACK,null,null);{let y=parseInt(d/2,10)+c,S=i(c,y),k=i(y+1,u);return p=n[y],g=t?t(p):p,new Vt(g,p.node,Vt.BLACK,S,k)}},s=function(c){let u=null,d=null,p=n.length,g=function(S,k){let N=p-S,q=p;p-=S;let G=i(N+1,q),F=n[N],K=t?t(F):F;y(new Vt(K,F.node,k,null,G))},y=function(S){u?(u.left=S,u=S):(d=S,u=S)};for(let S=0;S<c.count;++S){let k=c.nextBitIsOne(),N=Math.pow(2,c.count-(S+1));k?g(N,Vt.BLACK):(g(N,Vt.BLACK),g(N,Vt.RED))}return d},o=new bp(n.length),a=s(o);return new St(r||e,a)};var ap,Hi={},ts=class n{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return O(Hi&&ge,"ChildrenNode.ts has not been loaded"),ap=ap||new n({".priority":Hi},{".priority":ge}),ap}get(e){let t=Pn(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof St?t:null}hasIndex(e){return yt(this.indexSet_,e.toString())}addIndex(e,t){O(e!==Yt,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let r=[],i=!1,s=t.getIterator(te.Wrap),o=s.getNext();for(;o;)i=i||e.isDefinedOn(o.node),r.push(o),o=s.getNext();let a;i?a=Ic(r,e.getCompare()):a=Hi;let c=e.toString(),u=Object.assign({},this.indexSet_);u[c]=e;let d=Object.assign({},this.indexes_);return d[c]=a,new n(d,u)}addToIndexes(e,t){let r=Os(this.indexes_,(i,s)=>{let o=Pn(this.indexSet_,s);if(O(o,"Missing index implementation for "+s),i===Hi)if(o.isDefinedOn(e.node)){let a=[],c=t.getIterator(te.Wrap),u=c.getNext();for(;u;)u.name!==e.name&&a.push(u),u=c.getNext();return a.push(e),Ic(a,o.getCompare())}else return Hi;else{let a=t.get(e.name),c=i;return a&&(c=c.remove(new te(e.name,a))),c.insert(e,e.node)}});return new n(r,this.indexSet_)}removeFromIndexes(e,t){let r=Os(this.indexes_,i=>{if(i===Hi)return i;{let s=t.get(e.name);return s?i.remove(new te(e.name,s)):i}});return new n(r,this.indexSet_)}};var Mo,J=(()=>{class n{constructor(t,r,i){this.children_=t,this.priorityNode_=r,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&wT(this.priorityNode_),this.children_.isEmpty()&&O(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return Mo||(Mo=new n(new St(Tg),null,ts.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||Mo}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(t===".priority")return this.getPriority();{let r=this.children_.get(t);return r===null?Mo:r}}getChild(t){let r=Z(t);return r===null?this:this.getImmediateChild(r).getChild(fe(t))}hasChild(t){return this.children_.get(t)!==null}updateImmediateChild(t,r){if(O(r,"We should always be passing snapshot nodes"),t===".priority")return this.updatePriority(r);{let i=new te(t,r),s,o;r.isEmpty()?(s=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(i,this.children_)):(s=this.children_.insert(t,r),o=this.indexMap_.addToIndexes(i,this.children_));let a=s.isEmpty()?Mo:this.priorityNode_;return new n(s,a,o)}}updateChild(t,r){let i=Z(t);if(i===null)return r;{O(Z(t)!==".priority"||ir(t)===1,".priority must be the last token in a path");let s=this.getImmediateChild(i).updateChild(fe(t),r);return this.updateImmediateChild(i,s)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let r={},i=0,s=0,o=!0;if(this.forEachChild(ge,(a,c)=>{r[a]=c.val(t),i++,o&&n.INTEGER_REGEXP_.test(a)?s=Math.max(s,Number(a)):o=!1}),!t&&o&&s<2*i){let a=[];for(let c in r)a[c]=r[c];return a}else return t&&!this.getPriority().isEmpty()&&(r[".priority"]=this.getPriority().val()),r}hash(){if(this.lazyHash_===null){let t="";this.getPriority().isEmpty()||(t+="priority:"+vT(this.getPriority().val())+":"),this.forEachChild(ge,(r,i)=>{let s=i.hash();s!==""&&(t+=":"+r+":"+s)}),this.lazyHash_=t===""?"":JE(t)}return this.lazyHash_}getPredecessorChildName(t,r,i){let s=this.resolveIndex_(i);if(s){let o=s.getPredecessorKey(new te(t,r));return o?o.name:null}else return this.children_.getPredecessorKey(t)}getFirstChildName(t){let r=this.resolveIndex_(t);if(r){let i=r.minKey();return i&&i.name}else return this.children_.minKey()}getFirstChild(t){let r=this.getFirstChildName(t);return r?new te(r,this.children_.get(r)):null}getLastChildName(t){let r=this.resolveIndex_(t);if(r){let i=r.maxKey();return i&&i.name}else return this.children_.maxKey()}getLastChild(t){let r=this.getLastChildName(t);return r?new te(r,this.children_.get(r)):null}forEachChild(t,r){let i=this.resolveIndex_(t);return i?i.inorderTraversal(s=>r(s.name,s.node)):this.children_.inorderTraversal(r)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,r){let i=this.resolveIndex_(r);if(i)return i.getIteratorFrom(t,s=>s);{let s=this.children_.getIteratorFrom(t.name,te.Wrap),o=s.peek();for(;o!=null&&r.compare(o,t)<0;)s.getNext(),o=s.peek();return s}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,r){let i=this.resolveIndex_(r);if(i)return i.getReverseIteratorFrom(t,s=>s);{let s=this.children_.getReverseIteratorFrom(t.name,te.Wrap),o=s.peek();for(;o!=null&&r.compare(o,t)>0;)s.getNext(),o=s.peek();return s}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===oa?-1:0}withIndex(t){if(t===Yt||this.indexMap_.hasIndex(t))return this;{let r=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,r)}}isIndexed(t){return t===Yt||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{let r=t;if(this.getPriority().equals(r.getPriority()))if(this.children_.count()===r.children_.count()){let i=this.getIterator(ge),s=r.getIterator(ge),o=i.getNext(),a=s.getNext();for(;o&&a;){if(o.name!==a.name||!o.node.equals(a.node))return!1;o=i.getNext(),a=s.getNext()}return o===null&&a===null}else return!1;else return!1}}resolveIndex_(t){return t===Yt?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})(),Rp=class extends J{constructor(){super(new St(Tg),J.EMPTY_NODE,ts.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return J.EMPTY_NODE}isEmpty(){return!1}},oa=new Rp;Object.defineProperties(te,{MIN:{value:new te(rr,J.EMPTY_NODE)},MAX:{value:new te(_n,oa)}});Tc.__EMPTY_NODE=J.EMPTY_NODE;es.__childrenNodeConstructor=J;tb(oa);rb(oa);var sb=!0;function Ee(n,e=null){if(n===null)return J.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),O(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){let t=n;return new es(t,Ee(e))}if(!(n instanceof Array)&&sb){let t=[],r=!1;if(ze(n,(o,a)=>{if(o.substring(0,1)!=="."){let c=Ee(a);c.isEmpty()||(r=r||!c.getPriority().isEmpty(),t.push(new te(o,c)))}}),t.length===0)return J.EMPTY_NODE;let s=Ic(t,eb,o=>o.name,Tg);if(r){let o=Ic(t,ge.getCompare());return new J(s,Ee(e),new ts({".priority":o},{".priority":ge}))}else return new J(s,Ee(e),ts.Default)}else{let t=J.EMPTY_NODE;return ze(n,(r,i)=>{if(yt(n,r)&&r.substring(0,1)!=="."){let s=Ee(i);(s.isLeafNode()||!s.isEmpty())&&(t=t.updateImmediateChild(r,s))}}),t.updatePriority(Ee(e))}}nb(Ee);var Wo=class extends Zi{constructor(e){super(),this.indexPath_=e,O(!ee(e)&&Z(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let r=this.extractChild(e.node),i=this.extractChild(t.node),s=r.compareTo(i);return s===0?$r(e.name,t.name):s}makePost(e,t){let r=Ee(e),i=J.EMPTY_NODE.updateChild(this.indexPath_,r);return new te(t,i)}maxPost(){let e=J.EMPTY_NODE.updateChild(this.indexPath_,oa);return new te(_n,e)}toString(){return Ko(this.indexPath_,0).join("/")}};var Pp=class extends Zi{compare(e,t){let r=e.node.compareTo(t.node);return r===0?$r(e.name,t.name):r}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return te.MIN}maxPost(){return te.MAX}makePost(e,t){let r=Ee(e);return new te(t,r)}toString(){return".value"}},Ig=new Pp;function IT(n){return{type:"value",snapshotNode:n}}function ns(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function $o(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function Qo(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function ob(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}var Ho=class{constructor(e){this.index_=e}updateChild(e,t,r,i,s,o){O(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");let a=e.getImmediateChild(t);return a.getChild(i).equals(r.getChild(i))&&a.isEmpty()===r.isEmpty()||(o!=null&&(r.isEmpty()?e.hasChild(t)?o.trackChildChange($o(t,a)):O(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(ns(t,r)):o.trackChildChange(Qo(t,r,a))),e.isLeafNode()&&r.isEmpty())?e:e.updateImmediateChild(t,r).withIndex(this.index_)}updateFullNode(e,t,r){return r!=null&&(e.isLeafNode()||e.forEachChild(ge,(i,s)=>{t.hasChild(i)||r.trackChildChange($o(i,s))}),t.isLeafNode()||t.forEachChild(ge,(i,s)=>{if(e.hasChild(i)){let o=e.getImmediateChild(i);o.equals(s)||r.trackChildChange(Qo(i,s,o))}else r.trackChildChange(ns(i,s))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?J.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}};var Ac=class n{constructor(e){this.indexedFilter_=new Ho(e.getIndex()),this.index_=e.getIndex(),this.startPost_=n.getStartPost_(e),this.endPost_=n.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,r=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&r}updateChild(e,t,r,i,s,o){return this.matches(new te(t,r))||(r=J.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,r,i,s,o)}updateFullNode(e,t,r){t.isLeafNode()&&(t=J.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(J.EMPTY_NODE);let s=this;return t.forEachChild(ge,(o,a)=>{s.matches(new te(o,a))||(i=i.updateImmediateChild(o,J.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,r)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}};var xp=class{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{let r=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?r<=0:r<0},this.withinEndPost=t=>{let r=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?r<=0:r<0},this.rangedFilter_=new Ac(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,r,i,s,o){return this.rangedFilter_.matches(new te(t,r))||(r=J.EMPTY_NODE),e.getImmediateChild(t).equals(r)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,r,i,s,o):this.fullLimitUpdateChild_(e,t,r,s,o)}updateFullNode(e,t,r){let i;if(t.isLeafNode()||t.isEmpty())i=J.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=J.EMPTY_NODE.withIndex(this.index_);let s;this.reverse_?s=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):s=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;s.hasNext()&&o<this.limit_;){let a=s.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))i=i.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(J.EMPTY_NODE);let s;this.reverse_?s=i.getReverseIterator(this.index_):s=i.getIterator(this.index_);let o=0;for(;s.hasNext();){let a=s.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:i=i.updateImmediateChild(a.name,J.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,r)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,r,i,s){let o;if(this.reverse_){let p=this.index_.getCompare();o=(g,y)=>p(y,g)}else o=this.index_.getCompare();let a=e;O(a.numChildren()===this.limit_,"");let c=new te(t,r),u=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),d=this.rangedFilter_.matches(c);if(a.hasChild(t)){let p=a.getImmediateChild(t),g=i.getChildAfterChild(this.index_,u,this.reverse_);for(;g!=null&&(g.name===t||a.hasChild(g.name));)g=i.getChildAfterChild(this.index_,g,this.reverse_);let y=g==null?1:o(g,c);if(d&&!r.isEmpty()&&y>=0)return s?.trackChildChange(Qo(t,r,p)),a.updateImmediateChild(t,r);{s?.trackChildChange($o(t,p));let k=a.updateImmediateChild(t,J.EMPTY_NODE);return g!=null&&this.rangedFilter_.matches(g)?(s?.trackChildChange(ns(g.name,g.node)),k.updateImmediateChild(g.name,g.node)):k}}else return r.isEmpty()?e:d&&o(u,c)>=0?(s!=null&&(s.trackChildChange($o(u.name,u.node)),s.trackChildChange(ns(t,r))),a.updateImmediateChild(t,r).updateImmediateChild(u.name,J.EMPTY_NODE)):e}};var Yo=class n{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=ge}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return O(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return O(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:rr}hasEnd(){return this.endSet_}getIndexEndValue(){return O(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return O(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:_n}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return O(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===ge}copy(){let e=new n;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}};function ab(n){return n.loadsAllData()?new Ho(n.getIndex()):n.hasLimit()?new xp(n):new Ac(n)}function lb(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}function cb(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}function kp(n,e,t){let r=n.copy();return r.startSet_=!0,e===void 0&&(e=null),r.indexStartValue_=e,t!=null?(r.startNameSet_=!0,r.indexStartName_=t):(r.startNameSet_=!1,r.indexStartName_=""),r}function ub(n,e,t){let r;return n.index_===Yt||t?r=kp(n,e,t):r=kp(n,e,_n),r.startAfterSet_=!0,r}function Np(n,e,t){let r=n.copy();return r.endSet_=!0,e===void 0&&(e=null),r.indexEndValue_=e,t!==void 0?(r.endNameSet_=!0,r.indexEndName_=t):(r.endNameSet_=!1,r.indexEndName_=""),r}function hb(n,e,t){let r;return n.index_===Yt||t?r=Np(n,e,t):r=Np(n,e,rr),r.endBeforeSet_=!0,r}function jc(n,e){let t=n.copy();return t.index_=e,t}function DE(n){let e={};if(n.isDefault())return e;let t;if(n.index_===ge?t="$priority":n.index_===Ig?t="$value":n.index_===Yt?t="$key":(O(n.index_ instanceof Wo,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=ke(t),n.startSet_){let r=n.startAfterSet_?"startAfter":"startAt";e[r]=ke(n.indexStartValue_),n.startNameSet_&&(e[r]+=","+ke(n.indexStartName_))}if(n.endSet_){let r=n.endBeforeSet_?"endBefore":"endAt";e[r]=ke(n.indexEndValue_),n.endNameSet_&&(e[r]+=","+ke(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function VE(n){let e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==ge&&(e.i=n.index_.toString()),e}var Dp=class n extends vc{constructor(e,t,r,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=r,this.appCheckTokenProvider_=i,this.log_=sa("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(O(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,r,i){let s=e._path.toString();this.log_("Listen called for "+s+" "+e._queryIdentifier);let o=n.getListenId_(e,r),a={};this.listens_[o]=a;let c=DE(e._queryParams);this.restRequest_(s+".json",c,(u,d)=>{let p=d;if(u===404&&(p=null,u=null),u===null&&this.onDataUpdate_(s,p,!1,r),Pn(this.listens_,o)===a){let g;u?u===401?g="permission_denied":g="rest_error:"+u:g="ok",i(g,null)}})}unlisten(e,t){let r=n.getListenId_(e,t);delete this.listens_[r]}get(e){let t=DE(e._queryParams),r=e._path.toString(),i=new Ge;return this.restRequest_(r+".json",t,(s,o)=>{let a=o;s===404&&(a=null,s=null),s===null?(this.onDataUpdate_(r,a,!1,null),i.resolve(a)):i.reject(new Error(a))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},r){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,s])=>{i&&i.accessToken&&(t.auth=i.accessToken),s&&s.token&&(t.ac=s.token);let o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+m_(t);this.log_("Sending REST request for "+o);let a=new XMLHttpRequest;a.onreadystatechange=()=>{if(r&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let c=null;if(a.status>=200&&a.status<300){try{c=La(a.responseText)}catch{Ze("Failed to parse JSON response for "+o+": "+a.responseText)}r(null,c)}else a.status!==401&&a.status!==404&&Ze("Got unsuccessful REST response for "+o+" Status: "+a.status),r(a.status);r=null}},a.open("GET",o,!0),a.send()})}};var Vp=class{constructor(){this.rootNode_=J.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};function Sc(){return{value:null,children:new Map}}function ls(n,e,t){if(ee(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{let r=Z(e);n.children.has(r)||n.children.set(r,Sc());let i=n.children.get(r);e=fe(e),ls(i,e,t)}}function Op(n,e){if(ee(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{let t=n.value;return n.value=null,t.forEachChild(ge,(r,i)=>{ls(n,new ce(r),i)}),Op(n,e)}}else if(n.children.size>0){let t=Z(e);return e=fe(e),n.children.has(t)&&Op(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function Fp(n,e,t){n.value!==null?t(e,n.value):db(n,(r,i)=>{let s=new ce(e.toString()+"/"+r);Fp(i,s,t)})}function db(n,e){n.children.forEach((t,r)=>{e(r,t)})}var Mp=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t=Object.assign({},e);return this.last_&&ze(this.last_,(r,i)=>{t[r]=t[r]-i}),this.last_=e,t}};var OE=10*1e3,fb=30*1e3,pb=5*60*1e3,Lp=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new Mp(e);let r=OE+(fb-OE)*Math.random();Uo(this.reportStats_.bind(this),Math.floor(r))}reportStats_(){let e=this.statsListener_.get(),t={},r=!1;ze(e,(i,s)=>{s>0&&yt(this.statsToReport_,i)&&(t[i]=s,r=!0)}),r&&this.server_.reportStats(t),Uo(this.reportStats_.bind(this),Math.floor(Math.random()*2*pb))}};var Ht=function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n}(Ht||{});function Ag(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function Sg(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function Cg(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}var Up=class n{constructor(e,t,r){this.path=e,this.affectedTree=t,this.revert=r,this.type=Ht.ACK_USER_WRITE,this.source=Ag()}operationForChild(e){if(ee(this.path)){if(this.affectedTree.value!=null)return O(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let t=this.affectedTree.subtree(new ce(e));return new n(le(),t,this.revert)}}else return O(Z(this.path)===e,"operationForChild called for unrelated child."),new n(fe(this.path),this.affectedTree,this.revert)}};var Cc=class n{constructor(e,t){this.source=e,this.path=t,this.type=Ht.LISTEN_COMPLETE}operationForChild(e){return ee(this.path)?new n(this.source,le()):new n(this.source,fe(this.path))}};var rs=class n{constructor(e,t,r){this.source=e,this.path=t,this.snap=r,this.type=Ht.OVERWRITE}operationForChild(e){return ee(this.path)?new n(this.source,le(),this.snap.getImmediateChild(e)):new n(this.source,fe(this.path),this.snap)}};var Jo=class n{constructor(e,t,r){this.source=e,this.path=t,this.children=r,this.type=Ht.MERGE}operationForChild(e){if(ee(this.path)){let t=this.children.subtree(new ce(e));return t.isEmpty()?null:t.value?new rs(this.source,le(),t.value):new n(this.source,le(),t)}else return O(Z(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new n(this.source,fe(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}};var Xt=class{constructor(e,t,r){this.node_=e,this.fullyInitialized_=t,this.filtered_=r}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(ee(e))return this.isFullyInitialized()&&!this.filtered_;let t=Z(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}};var Bp=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function gb(n,e,t,r){let i=[],s=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&s.push(ob(o.childName,o.snapshotNode))}),Lo(n,i,"child_removed",e,r,t),Lo(n,i,"child_added",e,r,t),Lo(n,i,"child_moved",s,r,t),Lo(n,i,"child_changed",e,r,t),Lo(n,i,"value",e,r,t),i}function Lo(n,e,t,r,i,s){let o=r.filter(a=>a.type===t);o.sort((a,c)=>_b(n,a,c)),o.forEach(a=>{let c=mb(n,a,s);i.forEach(u=>{u.respondsTo(a.type)&&e.push(u.createEvent(c,n.query_))})})}function mb(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function _b(n,e,t){if(e.childName==null||t.childName==null)throw si("Should only compare child_ events.");let r=new te(e.childName,e.snapshotNode),i=new te(t.childName,t.snapshotNode);return n.index_.compare(r,i)}function zc(n,e){return{eventCache:n,serverCache:e}}function qo(n,e,t,r){return zc(new Xt(e,t,r),n.serverCache)}function AT(n,e,t,r){return zc(n.eventCache,new Xt(e,t,r))}function bc(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function Wr(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}var lp,yb=()=>(lp||(lp=new St(mC)),lp),ot=class n{constructor(e,t=yb()){this.value=e,this.children=t}static fromObject(e){let t=new n(null);return ze(e,(r,i)=>{t=t.set(new ce(r),i)}),t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:le(),value:this.value};if(ee(e))return null;{let r=Z(e),i=this.children.get(r);if(i!==null){let s=i.findRootMostMatchingPathAndValue(fe(e),t);return s!=null?{path:ve(new ce(r),s.path),value:s.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(ee(e))return this;{let t=Z(e),r=this.children.get(t);return r!==null?r.subtree(fe(e)):new n(null)}}set(e,t){if(ee(e))return new n(t,this.children);{let r=Z(e),s=(this.children.get(r)||new n(null)).set(fe(e),t),o=this.children.insert(r,s);return new n(this.value,o)}}remove(e){if(ee(e))return this.children.isEmpty()?new n(null):new n(null,this.children);{let t=Z(e),r=this.children.get(t);if(r){let i=r.remove(fe(e)),s;return i.isEmpty()?s=this.children.remove(t):s=this.children.insert(t,i),this.value===null&&s.isEmpty()?new n(null):new n(this.value,s)}else return this}}get(e){if(ee(e))return this.value;{let t=Z(e),r=this.children.get(t);return r?r.get(fe(e)):null}}setTree(e,t){if(ee(e))return t;{let r=Z(e),s=(this.children.get(r)||new n(null)).setTree(fe(e),t),o;return s.isEmpty()?o=this.children.remove(r):o=this.children.insert(r,s),new n(this.value,o)}}fold(e){return this.fold_(le(),e)}fold_(e,t){let r={};return this.children.inorderTraversal((i,s)=>{r[i]=s.fold_(ve(e,i),t)}),t(e,this.value,r)}findOnPath(e,t){return this.findOnPath_(e,le(),t)}findOnPath_(e,t,r){let i=this.value?r(t,this.value):!1;if(i)return i;if(ee(e))return null;{let s=Z(e),o=this.children.get(s);return o?o.findOnPath_(fe(e),ve(t,s),r):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,le(),t)}foreachOnPath_(e,t,r){if(ee(e))return this;{this.value&&r(t,this.value);let i=Z(e),s=this.children.get(i);return s?s.foreachOnPath_(fe(e),ve(t,i),r):new n(null)}}foreach(e){this.foreach_(le(),e)}foreach_(e,t){this.children.inorderTraversal((r,i)=>{i.foreach_(ve(e,r),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,r)=>{r.value&&e(t,r.value)})}};var Ot=class n{constructor(e){this.writeTree_=e}static empty(){return new n(new ot(null))}};function Go(n,e,t){if(ee(e))return new Ot(new ot(t));{let r=n.writeTree_.findRootMostValueAndPath(e);if(r!=null){let i=r.path,s=r.value,o=st(i,e);return s=s.updateChild(o,t),new Ot(n.writeTree_.set(i,s))}else{let i=new ot(t),s=n.writeTree_.setTree(e,i);return new Ot(s)}}}function qp(n,e,t){let r=n;return ze(t,(i,s)=>{r=Go(r,ve(e,i),s)}),r}function FE(n,e){if(ee(e))return Ot.empty();{let t=n.writeTree_.setTree(e,new ot(null));return new Ot(t)}}function Gp(n,e){return Qr(n,e)!=null}function Qr(n,e){let t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(st(t.path,e)):null}function ME(n){let e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(ge,(r,i)=>{e.push(new te(r,i))}):n.writeTree_.children.inorderTraversal((r,i)=>{i.value!=null&&e.push(new te(r,i.value))}),e}function tr(n,e){if(ee(e))return n;{let t=Qr(n,e);return t!=null?new Ot(new ot(t)):new Ot(n.writeTree_.subtree(e))}}function jp(n){return n.writeTree_.isEmpty()}function is(n,e){return ST(le(),n.writeTree_,e)}function ST(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let r=null;return e.children.inorderTraversal((i,s)=>{i===".priority"?(O(s.value!==null,"Priority writes must always be leaf nodes"),r=s.value):t=ST(ve(n,i),s,t)}),!t.getChild(n).isEmpty()&&r!==null&&(t=t.updateChild(ve(n,".priority"),r)),t}}function Kc(n,e){return PT(e,n)}function vb(n,e,t,r,i){O(r>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:r,visible:i}),i&&(n.visibleWrites=Go(n.visibleWrites,e,t)),n.lastWriteId=r}function wb(n,e,t,r){O(r>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:r,visible:!0}),n.visibleWrites=qp(n.visibleWrites,e,t),n.lastWriteId=r}function Eb(n,e){for(let t=0;t<n.allWrites.length;t++){let r=n.allWrites[t];if(r.writeId===e)return r}return null}function Tb(n,e){let t=n.allWrites.findIndex(a=>a.writeId===e);O(t>=0,"removeWrite called with nonexistent writeId.");let r=n.allWrites[t];n.allWrites.splice(t,1);let i=r.visible,s=!1,o=n.allWrites.length-1;for(;i&&o>=0;){let a=n.allWrites[o];a.visible&&(o>=t&&Ib(a,r.path)?i=!1:At(r.path,a.path)&&(s=!0)),o--}if(i){if(s)return Ab(n),!0;if(r.snap)n.visibleWrites=FE(n.visibleWrites,r.path);else{let a=r.children;ze(a,c=>{n.visibleWrites=FE(n.visibleWrites,ve(r.path,c))})}return!0}else return!1}function Ib(n,e){if(n.snap)return At(n.path,e);for(let t in n.children)if(n.children.hasOwnProperty(t)&&At(ve(n.path,t),e))return!0;return!1}function Ab(n){n.visibleWrites=CT(n.allWrites,Sb,le()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function Sb(n){return n.visible}function CT(n,e,t){let r=Ot.empty();for(let i=0;i<n.length;++i){let s=n[i];if(e(s)){let o=s.path,a;if(s.snap)At(t,o)?(a=st(t,o),r=Go(r,a,s.snap)):At(o,t)&&(a=st(o,t),r=Go(r,le(),s.snap.getChild(a)));else if(s.children){if(At(t,o))a=st(t,o),r=qp(r,a,s.children);else if(At(o,t))if(a=st(o,t),ee(a))r=qp(r,le(),s.children);else{let c=Pn(s.children,Z(a));if(c){let u=c.getChild(fe(a));r=Go(r,le(),u)}}}else throw si("WriteRecord should have .snap or .children")}}return r}function bT(n,e,t,r,i){if(!r&&!i){let s=Qr(n.visibleWrites,e);if(s!=null)return s;{let o=tr(n.visibleWrites,e);if(jp(o))return t;if(t==null&&!Gp(o,le()))return null;{let a=t||J.EMPTY_NODE;return is(o,a)}}}else{let s=tr(n.visibleWrites,e);if(!i&&jp(s))return t;if(!i&&t==null&&!Gp(s,le()))return null;{let o=function(u){return(u.visible||i)&&(!r||!~r.indexOf(u.writeId))&&(At(u.path,e)||At(e,u.path))},a=CT(n.allWrites,o,e),c=t||J.EMPTY_NODE;return is(a,c)}}}function Cb(n,e,t){let r=J.EMPTY_NODE,i=Qr(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(ge,(s,o)=>{r=r.updateImmediateChild(s,o)}),r;if(t){let s=tr(n.visibleWrites,e);return t.forEachChild(ge,(o,a)=>{let c=is(tr(s,new ce(o)),a);r=r.updateImmediateChild(o,c)}),ME(s).forEach(o=>{r=r.updateImmediateChild(o.name,o.node)}),r}else{let s=tr(n.visibleWrites,e);return ME(s).forEach(o=>{r=r.updateImmediateChild(o.name,o.node)}),r}}function bb(n,e,t,r,i){O(r||i,"Either existingEventSnap or existingServerSnap must exist");let s=ve(e,t);if(Gp(n.visibleWrites,s))return null;{let o=tr(n.visibleWrites,s);return jp(o)?i.getChild(t):is(o,i.getChild(t))}}function Rb(n,e,t,r){let i=ve(e,t),s=Qr(n.visibleWrites,i);if(s!=null)return s;if(r.isCompleteForChild(t)){let o=tr(n.visibleWrites,i);return is(o,r.getNode().getImmediateChild(t))}else return null}function Pb(n,e){return Qr(n.visibleWrites,e)}function xb(n,e,t,r,i,s,o){let a,c=tr(n.visibleWrites,e),u=Qr(c,le());if(u!=null)a=u;else if(t!=null)a=is(c,t);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){let d=[],p=o.getCompare(),g=s?a.getReverseIteratorFrom(r,o):a.getIteratorFrom(r,o),y=g.getNext();for(;y&&d.length<i;)p(y,r)!==0&&d.push(y),y=g.getNext();return d}else return[]}function kb(){return{visibleWrites:Ot.empty(),allWrites:[],lastWriteId:-1}}function Rc(n,e,t,r){return bT(n.writeTree,n.treePath,e,t,r)}function bg(n,e){return Cb(n.writeTree,n.treePath,e)}function LE(n,e,t,r){return bb(n.writeTree,n.treePath,e,t,r)}function Pc(n,e){return Pb(n.writeTree,ve(n.treePath,e))}function Nb(n,e,t,r,i,s){return xb(n.writeTree,n.treePath,e,t,r,i,s)}function Rg(n,e,t){return Rb(n.writeTree,n.treePath,e,t)}function RT(n,e){return PT(ve(n.treePath,e),n.writeTree)}function PT(n,e){return{treePath:n,writeTree:e}}var zp=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,r=e.childName;O(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),O(r!==".priority","Only non-priority child changes can be tracked.");let i=this.changeMap.get(r);if(i){let s=i.type;if(t==="child_added"&&s==="child_removed")this.changeMap.set(r,Qo(r,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&s==="child_added")this.changeMap.delete(r);else if(t==="child_removed"&&s==="child_changed")this.changeMap.set(r,$o(r,i.oldSnap));else if(t==="child_changed"&&s==="child_added")this.changeMap.set(r,ns(r,e.snapshotNode));else if(t==="child_changed"&&s==="child_changed")this.changeMap.set(r,Qo(r,e.snapshotNode,i.oldSnap));else throw si("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(r,e)}getChanges(){return Array.from(this.changeMap.values())}};var Kp=class{getCompleteChild(e){return null}getChildAfterChild(e,t,r){return null}},xT=new Kp,Xo=class{constructor(e,t,r=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=r}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let r=this.optCompleteServerCache_!=null?new Xt(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Rg(this.writes_,e,r)}}getChildAfterChild(e,t,r){let i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:Wr(this.viewCache_),s=Nb(this.writes_,i,t,1,r,e);return s.length===0?null:s[0]}};function Db(n){return{filter:n}}function Vb(n,e){O(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),O(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function Ob(n,e,t,r,i){let s=new zp,o,a;if(t.type===Ht.OVERWRITE){let u=t;u.source.fromUser?o=Wp(n,e,u.path,u.snap,r,i,s):(O(u.source.fromServer,"Unknown source."),a=u.source.tagged||e.serverCache.isFiltered()&&!ee(u.path),o=xc(n,e,u.path,u.snap,r,i,a,s))}else if(t.type===Ht.MERGE){let u=t;u.source.fromUser?o=Mb(n,e,u.path,u.children,r,i,s):(O(u.source.fromServer,"Unknown source."),a=u.source.tagged||e.serverCache.isFiltered(),o=$p(n,e,u.path,u.children,r,i,a,s))}else if(t.type===Ht.ACK_USER_WRITE){let u=t;u.revert?o=Bb(n,e,u.path,r,i,s):o=Lb(n,e,u.path,u.affectedTree,r,i,s)}else if(t.type===Ht.LISTEN_COMPLETE)o=Ub(n,e,t.path,r,s);else throw si("Unknown operation type: "+t.type);let c=s.getChanges();return Fb(e,o,c),{viewCache:o,changes:c}}function Fb(n,e,t){let r=e.eventCache;if(r.isFullyInitialized()){let i=r.getNode().isLeafNode()||r.getNode().isEmpty(),s=bc(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!r.getNode().equals(s)||!r.getNode().getPriority().equals(s.getPriority()))&&t.push(IT(bc(e)))}}function kT(n,e,t,r,i,s){let o=e.eventCache;if(Pc(r,t)!=null)return e;{let a,c;if(ee(t))if(O(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){let u=Wr(e),d=u instanceof J?u:J.EMPTY_NODE,p=bg(r,d);a=n.filter.updateFullNode(e.eventCache.getNode(),p,s)}else{let u=Rc(r,Wr(e));a=n.filter.updateFullNode(e.eventCache.getNode(),u,s)}else{let u=Z(t);if(u===".priority"){O(ir(t)===1,"Can't have a priority with additional path components");let d=o.getNode();c=e.serverCache.getNode();let p=LE(r,t,d,c);p!=null?a=n.filter.updatePriority(d,p):a=o.getNode()}else{let d=fe(t),p;if(o.isCompleteForChild(u)){c=e.serverCache.getNode();let g=LE(r,t,o.getNode(),c);g!=null?p=o.getNode().getImmediateChild(u).updateChild(d,g):p=o.getNode().getImmediateChild(u)}else p=Rg(r,u,e.serverCache);p!=null?a=n.filter.updateChild(o.getNode(),u,p,d,i,s):a=o.getNode()}}return qo(e,a,o.isFullyInitialized()||ee(t),n.filter.filtersNodes())}}function xc(n,e,t,r,i,s,o,a){let c=e.serverCache,u,d=o?n.filter:n.filter.getIndexedFilter();if(ee(t))u=d.updateFullNode(c.getNode(),r,null);else if(d.filtersNodes()&&!c.isFiltered()){let y=c.getNode().updateChild(t,r);u=d.updateFullNode(c.getNode(),y,null)}else{let y=Z(t);if(!c.isCompleteForPath(t)&&ir(t)>1)return e;let S=fe(t),N=c.getNode().getImmediateChild(y).updateChild(S,r);y===".priority"?u=d.updatePriority(c.getNode(),N):u=d.updateChild(c.getNode(),y,N,S,xT,null)}let p=AT(e,u,c.isFullyInitialized()||ee(t),d.filtersNodes()),g=new Xo(i,p,s);return kT(n,p,t,i,g,a)}function Wp(n,e,t,r,i,s,o){let a=e.eventCache,c,u,d=new Xo(i,e,s);if(ee(t))u=n.filter.updateFullNode(e.eventCache.getNode(),r,o),c=qo(e,u,!0,n.filter.filtersNodes());else{let p=Z(t);if(p===".priority")u=n.filter.updatePriority(e.eventCache.getNode(),r),c=qo(e,u,a.isFullyInitialized(),a.isFiltered());else{let g=fe(t),y=a.getNode().getImmediateChild(p),S;if(ee(g))S=r;else{let k=d.getCompleteChild(p);k!=null?vg(g)===".priority"&&k.getChild(_T(g)).isEmpty()?S=k:S=k.updateChild(g,r):S=J.EMPTY_NODE}if(y.equals(S))c=e;else{let k=n.filter.updateChild(a.getNode(),p,S,g,d,o);c=qo(e,k,a.isFullyInitialized(),n.filter.filtersNodes())}}}return c}function UE(n,e){return n.eventCache.isCompleteForChild(e)}function Mb(n,e,t,r,i,s,o){let a=e;return r.foreach((c,u)=>{let d=ve(t,c);UE(e,Z(d))&&(a=Wp(n,a,d,u,i,s,o))}),r.foreach((c,u)=>{let d=ve(t,c);UE(e,Z(d))||(a=Wp(n,a,d,u,i,s,o))}),a}function BE(n,e,t){return t.foreach((r,i)=>{e=e.updateChild(r,i)}),e}function $p(n,e,t,r,i,s,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let c=e,u;ee(t)?u=r:u=new ot(null).setTree(t,r);let d=e.serverCache.getNode();return u.children.inorderTraversal((p,g)=>{if(d.hasChild(p)){let y=e.serverCache.getNode().getImmediateChild(p),S=BE(n,y,g);c=xc(n,c,new ce(p),S,i,s,o,a)}}),u.children.inorderTraversal((p,g)=>{let y=!e.serverCache.isCompleteForChild(p)&&g.value===null;if(!d.hasChild(p)&&!y){let S=e.serverCache.getNode().getImmediateChild(p),k=BE(n,S,g);c=xc(n,c,new ce(p),k,i,s,o,a)}}),c}function Lb(n,e,t,r,i,s,o){if(Pc(i,t)!=null)return e;let a=e.serverCache.isFiltered(),c=e.serverCache;if(r.value!=null){if(ee(t)&&c.isFullyInitialized()||c.isCompleteForPath(t))return xc(n,e,t,c.getNode().getChild(t),i,s,a,o);if(ee(t)){let u=new ot(null);return c.getNode().forEachChild(Yt,(d,p)=>{u=u.set(new ce(d),p)}),$p(n,e,t,u,i,s,a,o)}else return e}else{let u=new ot(null);return r.foreach((d,p)=>{let g=ve(t,d);c.isCompleteForPath(g)&&(u=u.set(d,c.getNode().getChild(g)))}),$p(n,e,t,u,i,s,a,o)}}function Ub(n,e,t,r,i){let s=e.serverCache,o=AT(e,s.getNode(),s.isFullyInitialized()||ee(t),s.isFiltered());return kT(n,o,t,r,xT,i)}function Bb(n,e,t,r,i,s){let o;if(Pc(r,t)!=null)return e;{let a=new Xo(r,e,i),c=e.eventCache.getNode(),u;if(ee(t)||Z(t)===".priority"){let d;if(e.serverCache.isFullyInitialized())d=Rc(r,Wr(e));else{let p=e.serverCache.getNode();O(p instanceof J,"serverChildren would be complete if leaf node"),d=bg(r,p)}d=d,u=n.filter.updateFullNode(c,d,s)}else{let d=Z(t),p=Rg(r,d,e.serverCache);p==null&&e.serverCache.isCompleteForChild(d)&&(p=c.getImmediateChild(d)),p!=null?u=n.filter.updateChild(c,d,p,fe(t),a,s):e.eventCache.getNode().hasChild(d)?u=n.filter.updateChild(c,d,J.EMPTY_NODE,fe(t),a,s):u=c,u.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=Rc(r,Wr(e)),o.isLeafNode()&&(u=n.filter.updateFullNode(u,o,s)))}return o=e.serverCache.isFullyInitialized()||Pc(r,le())!=null,qo(e,u,o,n.filter.filtersNodes())}}var Qp=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let r=this.query_._queryParams,i=new Ho(r.getIndex()),s=ab(r);this.processor_=Db(s);let o=t.serverCache,a=t.eventCache,c=i.updateFullNode(J.EMPTY_NODE,o.getNode(),null),u=s.updateFullNode(J.EMPTY_NODE,a.getNode(),null),d=new Xt(c,o.isFullyInitialized(),i.filtersNodes()),p=new Xt(u,a.isFullyInitialized(),s.filtersNodes());this.viewCache_=zc(p,d),this.eventGenerator_=new Bp(this.query_)}get query(){return this.query_}};function qb(n){return n.viewCache_.serverCache.getNode()}function Gb(n){return bc(n.viewCache_)}function jb(n,e){let t=Wr(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!ee(e)&&!t.getImmediateChild(Z(e)).isEmpty())?t.getChild(e):null}function qE(n){return n.eventRegistrations_.length===0}function zb(n,e){n.eventRegistrations_.push(e)}function GE(n,e,t){let r=[];if(t){O(e==null,"A cancel should cancel all event registrations.");let i=n.query._path;n.eventRegistrations_.forEach(s=>{let o=s.createCancelEvent(t,i);o&&r.push(o)})}if(e){let i=[];for(let s=0;s<n.eventRegistrations_.length;++s){let o=n.eventRegistrations_[s];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(s+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return r}function jE(n,e,t,r){e.type===Ht.MERGE&&e.source.queryId!==null&&(O(Wr(n.viewCache_),"We should always have a full cache before handling merges"),O(bc(n.viewCache_),"Missing event cache, even though we have a server cache"));let i=n.viewCache_,s=Ob(n.processor_,i,e,t,r);return Vb(n.processor_,s.viewCache),O(s.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=s.viewCache,NT(n,s.changes,s.viewCache.eventCache.getNode(),null)}function Kb(n,e){let t=n.viewCache_.eventCache,r=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(ge,(s,o)=>{r.push(ns(s,o))}),t.isFullyInitialized()&&r.push(IT(t.getNode())),NT(n,r,t.getNode(),e)}function NT(n,e,t,r){let i=r?[r]:n.eventRegistrations_;return gb(n.eventGenerator_,e,t,i)}var kc,Nc=class{constructor(){this.views=new Map}};function Wb(n){O(!kc,"__referenceConstructor has already been defined"),kc=n}function $b(){return O(kc,"Reference.ts has not been loaded"),kc}function Qb(n){return n.views.size===0}function Pg(n,e,t,r){let i=e.source.queryId;if(i!==null){let s=n.views.get(i);return O(s!=null,"SyncTree gave us an op for an invalid query."),jE(s,e,t,r)}else{let s=[];for(let o of n.views.values())s=s.concat(jE(o,e,t,r));return s}}function DT(n,e,t,r,i){let s=e._queryIdentifier,o=n.views.get(s);if(!o){let a=Rc(t,i?r:null),c=!1;a?c=!0:r instanceof J?(a=bg(t,r),c=!1):(a=J.EMPTY_NODE,c=!1);let u=zc(new Xt(a,c,!1),new Xt(r,i,!1));return new Qp(e,u)}return o}function Hb(n,e,t,r,i,s){let o=DT(n,e,r,i,s);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),zb(o,t),Kb(o,t)}function Yb(n,e,t,r){let i=e._queryIdentifier,s=[],o=[],a=sr(n);if(i==="default")for(let[c,u]of n.views.entries())o=o.concat(GE(u,t,r)),qE(u)&&(n.views.delete(c),u.query._queryParams.loadsAllData()||s.push(u.query));else{let c=n.views.get(i);c&&(o=o.concat(GE(c,t,r)),qE(c)&&(n.views.delete(i),c.query._queryParams.loadsAllData()||s.push(c.query)))}return a&&!sr(n)&&s.push(new($b())(e._repo,e._path)),{removed:s,events:o}}function VT(n){let e=[];for(let t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function nr(n,e){let t=null;for(let r of n.views.values())t=t||jb(r,e);return t}function OT(n,e){if(e._queryParams.loadsAllData())return Wc(n);{let r=e._queryIdentifier;return n.views.get(r)}}function FT(n,e){return OT(n,e)!=null}function sr(n){return Wc(n)!=null}function Wc(n){for(let e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}var Dc;function Jb(n){O(!Dc,"__referenceConstructor has already been defined"),Dc=n}function Xb(){return O(Dc,"Reference.ts has not been loaded"),Dc}var Zb=1,Vc=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new ot(null),this.pendingWriteTree_=kb(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function xg(n,e,t,r,i){return vb(n.pendingWriteTree_,e,t,r,i),i?cs(n,new rs(Ag(),e,t)):[]}function eR(n,e,t,r){wb(n.pendingWriteTree_,e,t,r);let i=ot.fromObject(t);return cs(n,new Jo(Ag(),e,i))}function er(n,e,t=!1){let r=Eb(n.pendingWriteTree_,e);if(Tb(n.pendingWriteTree_,e)){let s=new ot(null);return r.snap!=null?s=s.set(le(),!0):ze(r.children,o=>{s=s.set(new ce(o),!0)}),cs(n,new Up(r.path,s,t))}else return[]}function aa(n,e,t){return cs(n,new rs(Sg(),e,t))}function tR(n,e,t){let r=ot.fromObject(t);return cs(n,new Jo(Sg(),e,r))}function nR(n,e){return cs(n,new Cc(Sg(),e))}function rR(n,e,t){let r=kg(n,t);if(r){let i=Ng(r),s=i.path,o=i.queryId,a=st(s,e),c=new Cc(Cg(o),a);return Dg(n,s,c)}else return[]}function Oc(n,e,t,r,i=!1){let s=e._path,o=n.syncPointTree_.get(s),a=[];if(o&&(e._queryIdentifier==="default"||FT(o,e))){let c=Yb(o,e,t,r);Qb(o)&&(n.syncPointTree_=n.syncPointTree_.remove(s));let u=c.removed;if(a=c.events,!i){let d=u.findIndex(g=>g._queryParams.loadsAllData())!==-1,p=n.syncPointTree_.findOnPath(s,(g,y)=>sr(y));if(d&&!p){let g=n.syncPointTree_.subtree(s);if(!g.isEmpty()){let y=oR(g);for(let S=0;S<y.length;++S){let k=y[S],N=k.query,q=BT(n,k);n.listenProvider_.startListening(jo(N),Zo(n,N),q.hashFn,q.onComplete)}}}!p&&u.length>0&&!r&&(d?n.listenProvider_.stopListening(jo(e),null):u.forEach(g=>{let y=n.queryToTagMap.get(Qc(g));n.listenProvider_.stopListening(jo(g),y)}))}aR(n,u)}return a}function MT(n,e,t,r){let i=kg(n,r);if(i!=null){let s=Ng(i),o=s.path,a=s.queryId,c=st(o,e),u=new rs(Cg(a),c,t);return Dg(n,o,u)}else return[]}function iR(n,e,t,r){let i=kg(n,r);if(i){let s=Ng(i),o=s.path,a=s.queryId,c=st(o,e),u=ot.fromObject(t),d=new Jo(Cg(a),c,u);return Dg(n,o,d)}else return[]}function Hp(n,e,t,r=!1){let i=e._path,s=null,o=!1;n.syncPointTree_.foreachOnPath(i,(g,y)=>{let S=st(g,i);s=s||nr(y,S),o=o||sr(y)});let a=n.syncPointTree_.get(i);a?(o=o||sr(a),s=s||nr(a,le())):(a=new Nc,n.syncPointTree_=n.syncPointTree_.set(i,a));let c;s!=null?c=!0:(c=!1,s=J.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((y,S)=>{let k=nr(S,le());k&&(s=s.updateImmediateChild(y,k))}));let u=FT(a,e);if(!u&&!e._queryParams.loadsAllData()){let g=Qc(e);O(!n.queryToTagMap.has(g),"View does not exist, but we have a tag");let y=lR();n.queryToTagMap.set(g,y),n.tagToQueryMap.set(y,g)}let d=Kc(n.pendingWriteTree_,i),p=Hb(a,e,t,d,s,c);if(!u&&!o&&!r){let g=OT(a,e);p=p.concat(cR(n,e,g))}return p}function $c(n,e,t){let i=n.pendingWriteTree_,s=n.syncPointTree_.findOnPath(e,(o,a)=>{let c=st(o,e),u=nr(a,c);if(u)return u});return bT(i,e,s,t,!0)}function sR(n,e){let t=e._path,r=null;n.syncPointTree_.foreachOnPath(t,(u,d)=>{let p=st(u,t);r=r||nr(d,p)});let i=n.syncPointTree_.get(t);i?r=r||nr(i,le()):(i=new Nc,n.syncPointTree_=n.syncPointTree_.set(t,i));let s=r!=null,o=s?new Xt(r,!0,!1):null,a=Kc(n.pendingWriteTree_,e._path),c=DT(i,e,a,s?o.getNode():J.EMPTY_NODE,s);return Gb(c)}function cs(n,e){return LT(e,n.syncPointTree_,null,Kc(n.pendingWriteTree_,le()))}function LT(n,e,t,r){if(ee(n.path))return UT(n,e,t,r);{let i=e.get(le());t==null&&i!=null&&(t=nr(i,le()));let s=[],o=Z(n.path),a=n.operationForChild(o),c=e.children.get(o);if(c&&a){let u=t?t.getImmediateChild(o):null,d=RT(r,o);s=s.concat(LT(a,c,u,d))}return i&&(s=s.concat(Pg(i,n,r,t))),s}}function UT(n,e,t,r){let i=e.get(le());t==null&&i!=null&&(t=nr(i,le()));let s=[];return e.children.inorderTraversal((o,a)=>{let c=t?t.getImmediateChild(o):null,u=RT(r,o),d=n.operationForChild(o);d&&(s=s.concat(UT(d,a,c,u)))}),i&&(s=s.concat(Pg(i,n,r,t))),s}function BT(n,e){let t=e.query,r=Zo(n,t);return{hashFn:()=>(qb(e)||J.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return r?rR(n,t._path,r):nR(n,t._path);{let s=vC(i,t);return Oc(n,t,null,s)}}}}function Zo(n,e){let t=Qc(e);return n.queryToTagMap.get(t)}function Qc(n){return n._path.toString()+"$"+n._queryIdentifier}function kg(n,e){return n.tagToQueryMap.get(e)}function Ng(n){let e=n.indexOf("$");return O(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new ce(n.substr(0,e))}}function Dg(n,e,t){let r=n.syncPointTree_.get(e);O(r,"Missing sync point for query tag that we're tracking");let i=Kc(n.pendingWriteTree_,e);return Pg(r,t,i,null)}function oR(n){return n.fold((e,t,r)=>{if(t&&sr(t))return[Wc(t)];{let i=[];return t&&(i=VT(t)),ze(r,(s,o)=>{i=i.concat(o)}),i}})}function jo(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(Xb())(n._repo,n._path):n}function aR(n,e){for(let t=0;t<e.length;++t){let r=e[t];if(!r._queryParams.loadsAllData()){let i=Qc(r),s=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(s)}}}function lR(){return Zb++}function cR(n,e,t){let r=e._path,i=Zo(n,e),s=BT(n,t),o=n.listenProvider_.startListening(jo(e),i,s.hashFn,s.onComplete),a=n.syncPointTree_.subtree(r);if(i)O(!sr(a.value),"If we're adding a query, it shouldn't be shadowed");else{let c=a.fold((u,d,p)=>{if(!ee(u)&&d&&sr(d))return[Wc(d).query];{let g=[];return d&&(g=g.concat(VT(d).map(y=>y.query))),ze(p,(y,S)=>{g=g.concat(S)}),g}});for(let u=0;u<c.length;++u){let d=c[u];n.listenProvider_.stopListening(jo(d),Zo(n,d))}}return o}var Yp=class n{constructor(e){this.node_=e}getImmediateChild(e){let t=this.node_.getImmediateChild(e);return new n(t)}node(){return this.node_}},Jp=class n{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){let t=ve(this.path_,e);return new n(this.syncTree_,t)}node(){return $c(this.syncTree_,this.path_)}},uR=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},zE=function(n,e,t){if(!n||typeof n!="object")return n;if(O(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return hR(n[".sv"],e,t);if(typeof n[".sv"]=="object")return dR(n[".sv"],e);O(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},hR=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:O(!1,"Unexpected server value: "+n)}},dR=function(n,e,t){n.hasOwnProperty("increment")||O(!1,"Unexpected server value: "+JSON.stringify(n,null,2));let r=n.increment;typeof r!="number"&&O(!1,"Unexpected increment value: "+r);let i=e.node();if(O(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return r;let o=i.getValue();return typeof o!="number"?r:o+r},qT=function(n,e,t,r){return Og(e,new Jp(t,n),r)},Vg=function(n,e,t){return Og(n,new Yp(e),t)};function Og(n,e,t){let r=n.getPriority().val(),i=zE(r,e.getImmediateChild(".priority"),t),s;if(n.isLeafNode()){let o=n,a=zE(o.getValue(),e,t);return a!==o.getValue()||i!==o.getPriority().val()?new es(a,Ee(i)):n}else{let o=n;return s=o,i!==o.getPriority().val()&&(s=s.updatePriority(new es(i))),o.forEachChild(ge,(a,c)=>{let u=Og(c,e.getImmediateChild(a),t);u!==c&&(s=s.updateImmediateChild(a,u))}),s}}var ea=class{constructor(e="",t=null,r={children:{},childCount:0}){this.name=e,this.parent=t,this.node=r}};function Hc(n,e){let t=e instanceof ce?e:new ce(e),r=n,i=Z(t);for(;i!==null;){let s=Pn(r.node.children,i)||{children:{},childCount:0};r=new ea(i,r,s),t=fe(t),i=Z(t)}return r}function Hr(n){return n.node.value}function Fg(n,e){n.node.value=e,Xp(n)}function GT(n){return n.node.childCount>0}function fR(n){return Hr(n)===void 0&&!GT(n)}function Yc(n,e){ze(n.node.children,(t,r)=>{e(new ea(t,n,r))})}function jT(n,e,t,r){t&&!r&&e(n),Yc(n,i=>{jT(i,e,!0,r)}),t&&r&&e(n)}function pR(n,e,t){let r=t?n:n.parent;for(;r!==null;){if(e(r))return!0;r=r.parent}return!1}function la(n){return new ce(n.parent===null?n.name:la(n.parent)+"/"+n.name)}function Xp(n){n.parent!==null&&gR(n.parent,n.name,n)}function gR(n,e,t){let r=fR(t),i=yt(n.node.children,e);r&&i?(delete n.node.children[e],n.node.childCount--,Xp(n)):!r&&!i&&(n.node.children[e]=t.node,n.node.childCount++,Xp(n))}var mR=/[\[\].#$\/\u0000-\u001F\u007F]/,_R=/[\[\].#$\u0000-\u001F\u007F]/,cp=10*1024*1024,Jc=function(n){return typeof n=="string"&&n.length!==0&&!mR.test(n)},zT=function(n){return typeof n=="string"&&n.length!==0&&!_R.test(n)},yR=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),zT(n)},ta=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!Gc(n)||n&&typeof n=="object"&&yt(n,".sv")},Zt=function(n,e,t,r){r&&e===void 0||ca(lt(n,"value"),e,t)},ca=function(n,e,t){let r=t instanceof ce?new Tp(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+jr(r));if(typeof e=="function")throw new Error(n+"contains a function "+jr(r)+" with contents = "+e.toString());if(Gc(e))throw new Error(n+"contains "+e.toString()+" "+jr(r));if(typeof e=="string"&&e.length>cp/3&&Fs(e)>cp)throw new Error(n+"contains a string greater than "+cp+" utf8 bytes "+jr(r)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,s=!1;if(ze(e,(o,a)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(s=!0,!Jc(o)))throw new Error(n+" contains an invalid key ("+o+") "+jr(r)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);QC(r,o),ca(n,a,r),HC(r)}),i&&s)throw new Error(n+' contains ".value" child '+jr(r)+" in addition to actual children.")}},vR=function(n,e){let t,r;for(t=0;t<e.length;t++){r=e[t];let s=Ko(r);for(let o=0;o<s.length;o++)if(!(s[o]===".priority"&&o===s.length-1)){if(!Jc(s[o]))throw new Error(n+"contains an invalid key ("+s[o]+") in path "+r.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort($C);let i=null;for(t=0;t<e.length;t++){if(r=e[t],i!==null&&At(i,r))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+r.toString());i=r}},KT=function(n,e,t,r){if(r&&e===void 0)return;let i=lt(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");let s=[];ze(e,(o,a)=>{let c=new ce(o);if(ca(i,a,ve(t,c)),vg(c)===".priority"&&!ta(a))throw new Error(i+"contains an invalid value for '"+c.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");s.push(c)}),vR(i,s)},Mg=function(n,e,t){if(!(t&&e===void 0)){if(Gc(e))throw new Error(lt(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!ta(e))throw new Error(lt(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},ua=function(n,e,t,r){if(!(r&&t===void 0)&&!Jc(t))throw new Error(lt(n,e)+'was an invalid key = "'+t+`".  Firebase keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]").`)},us=function(n,e,t,r){if(!(r&&t===void 0)&&!zT(t))throw new Error(lt(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},wR=function(n,e,t,r){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),us(n,e,t,r)},pt=function(n,e){if(Z(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},WT=function(n,e){let t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!Jc(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!yR(t))throw new Error(lt(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};var Zp=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function Xc(n,e){let t=null;for(let r=0;r<e.length;r++){let i=e[r],s=i.getPath();t!==null&&!wg(s,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:s}),t.events.push(i)}t&&n.eventLists_.push(t)}function $T(n,e,t){Xc(n,t),QT(n,r=>wg(r,e))}function gt(n,e,t){Xc(n,t),QT(n,r=>At(r,e)||At(e,r))}function QT(n,e){n.recursionDepth_++;let t=!0;for(let r=0;r<n.eventLists_.length;r++){let i=n.eventLists_[r];if(i){let s=i.path;e(s)?(ER(n.eventLists_[r]),n.eventLists_[r]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function ER(n){for(let e=0;e<n.events.length;e++){let t=n.events[e];if(t!==null){n.events[e]=null;let r=t.getEventRunner();Kr&&je("event: "+t.toString()),as(r)}}}var HT="repo_interrupt",TR=25,eg=class{constructor(e,t,r,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=r,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Zp,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Sc(),this.transactionQueueTree_=new ea,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}};function IR(n,e,t){if(n.stats_=yg(n.repoInfo_),n.forceRestClient_||IC())n.server_=new Dp(n.repoInfo_,(r,i,s,o)=>{KE(n,r,i,s,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>WE(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{ke(t)}catch(r){throw new Error("Invalid authOverride provided: "+r)}}n.persistentConnection_=new Eg(n.repoInfo_,e,(r,i,s,o)=>{KE(n,r,i,s,o)},r=>{WE(n,r)},r=>{AR(n,r)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(r=>{n.server_.refreshAuthToken(r)}),n.appCheckProvider_.addTokenChangeListener(r=>{n.server_.refreshAppCheckToken(r.token)}),n.statsReporter_=SC(n.repoInfo_,()=>new Lp(n.stats_,n.server_)),n.infoData_=new Vp,n.infoSyncTree_=new Vc({startListening:(r,i,s,o)=>{let a=[],c=n.infoData_.getNode(r._path);return c.isEmpty()||(a=aa(n.infoSyncTree_,r._path,c),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),Lg(n,"connected",!1),n.serverSyncTree_=new Vc({startListening:(r,i,s,o)=>(n.server_.listen(r,s,i,(a,c)=>{let u=o(a,c);gt(n.eventQueue_,r._path,u)}),[]),stopListening:(r,i)=>{n.server_.unlisten(r,i)}})}function YT(n){let t=n.infoData_.getNode(new ce(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function ha(n){return uR({timestamp:YT(n)})}function KE(n,e,t,r,i){n.dataUpdateCount++;let s=new ce(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(r){let c=Os(t,u=>Ee(u));o=iR(n.serverSyncTree_,s,c,i)}else{let c=Ee(t);o=MT(n.serverSyncTree_,s,c,i)}else if(r){let c=Os(t,u=>Ee(u));o=tR(n.serverSyncTree_,s,c)}else{let c=Ee(t);o=aa(n.serverSyncTree_,s,c)}let a=s;o.length>0&&(a=ss(n,s)),gt(n.eventQueue_,a,o)}function WE(n,e){Lg(n,"connected",e),e===!1&&bR(n)}function AR(n,e){ze(e,(t,r)=>{Lg(n,t,r)})}function Lg(n,e,t){let r=new ce("/.info/"+e),i=Ee(t);n.infoData_.updateSnapshot(r,i);let s=aa(n.infoSyncTree_,r,i);gt(n.eventQueue_,r,s)}function Zc(n){return n.nextWriteId_++}function SR(n,e,t){let r=sR(n.serverSyncTree_,e);return r!=null?Promise.resolve(r):n.server_.get(e).then(i=>{let s=Ee(i).withIndex(e._queryParams.getIndex());Hp(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=aa(n.serverSyncTree_,e._path,s);else{let a=Zo(n.serverSyncTree_,e);o=MT(n.serverSyncTree_,e._path,s,a)}return gt(n.eventQueue_,e._path,o),Oc(n.serverSyncTree_,e,t,null,!0),s},i=>(hs(n,"get for query "+ke(e)+" failed: "+i),Promise.reject(new Error(i))))}function Ug(n,e,t,r,i){hs(n,"set",{path:e.toString(),value:t,priority:r});let s=ha(n),o=Ee(t,r),a=$c(n.serverSyncTree_,e),c=Vg(o,a,s),u=Zc(n),d=xg(n.serverSyncTree_,e,c,u,!0);Xc(n.eventQueue_,d),n.server_.put(e.toString(),o.val(!0),(g,y)=>{let S=g==="ok";S||Ze("set at "+e+" failed: "+g);let k=er(n.serverSyncTree_,u,!S);gt(n.eventQueue_,e,k),or(n,i,g,y)});let p=qg(n,e);ss(n,p),gt(n.eventQueue_,p,[])}function CR(n,e,t,r){hs(n,"update",{path:e.toString(),value:t});let i=!0,s=ha(n),o={};if(ze(t,(a,c)=>{i=!1,o[a]=qT(ve(e,a),Ee(c),n.serverSyncTree_,s)}),i)je("update() called with empty data.  Don't do anything."),or(n,r,"ok",void 0);else{let a=Zc(n),c=eR(n.serverSyncTree_,e,o,a);Xc(n.eventQueue_,c),n.server_.merge(e.toString(),t,(u,d)=>{let p=u==="ok";p||Ze("update at "+e+" failed: "+u);let g=er(n.serverSyncTree_,a,!p),y=g.length>0?ss(n,e):e;gt(n.eventQueue_,y,g),or(n,r,u,d)}),ze(t,u=>{let d=qg(n,ve(e,u));ss(n,d)}),gt(n.eventQueue_,e,[])}}function bR(n){hs(n,"onDisconnectEvents");let e=ha(n),t=Sc();Fp(n.onDisconnect_,le(),(i,s)=>{let o=qT(i,s,n.serverSyncTree_,e);ls(t,i,o)});let r=[];Fp(t,le(),(i,s)=>{r=r.concat(aa(n.serverSyncTree_,i,s));let o=qg(n,i);ss(n,o)}),n.onDisconnect_=Sc(),gt(n.eventQueue_,le(),r)}function RR(n,e,t){n.server_.onDisconnectCancel(e.toString(),(r,i)=>{r==="ok"&&Op(n.onDisconnect_,e),or(n,t,r,i)})}function $E(n,e,t,r){let i=Ee(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(s,o)=>{s==="ok"&&ls(n.onDisconnect_,e,i),or(n,r,s,o)})}function PR(n,e,t,r,i){let s=Ee(t,r);n.server_.onDisconnectPut(e.toString(),s.val(!0),(o,a)=>{o==="ok"&&ls(n.onDisconnect_,e,s),or(n,i,o,a)})}function xR(n,e,t,r){if(Ua(t)){je("onDisconnect().update() called with empty data.  Don't do anything."),or(n,r,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,s)=>{i==="ok"&&ze(t,(o,a)=>{let c=Ee(a);ls(n.onDisconnect_,ve(e,o),c)}),or(n,r,i,s)})}function kR(n,e,t){let r;Z(e._path)===".info"?r=Hp(n.infoSyncTree_,e,t):r=Hp(n.serverSyncTree_,e,t),$T(n.eventQueue_,e._path,r)}function tg(n,e,t){let r;Z(e._path)===".info"?r=Oc(n.infoSyncTree_,e,t):r=Oc(n.serverSyncTree_,e,t),$T(n.eventQueue_,e._path,r)}function JT(n){n.persistentConnection_&&n.persistentConnection_.interrupt(HT)}function NR(n){n.persistentConnection_&&n.persistentConnection_.resume(HT)}function hs(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),je(t,...e)}function or(n,e,t,r){e&&as(()=>{if(t==="ok")e(null);else{let i=(t||"error").toUpperCase(),s=i;r&&(s+=": "+r);let o=new Error(s);o.code=i,e(o)}})}function DR(n,e,t,r,i,s){hs(n,"transaction on "+e);let o={path:e,update:t,onComplete:r,status:null,order:YE(),applyLocally:s,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},a=Bg(n,e,void 0);o.currentInputSnapshot=a;let c=o.update(a.val());if(c===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{ca("transaction failed: Data returned ",c,o.path),o.status=0;let u=Hc(n.transactionQueueTree_,e),d=Hr(u)||[];d.push(o),Fg(u,d);let p;typeof c=="object"&&c!==null&&yt(c,".priority")?(p=Pn(c,".priority"),O(ta(p),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):p=($c(n.serverSyncTree_,e)||J.EMPTY_NODE).getPriority().val();let g=ha(n),y=Ee(c,p),S=Vg(y,a,g);o.currentOutputSnapshotRaw=y,o.currentOutputSnapshotResolved=S,o.currentWriteId=Zc(n);let k=xg(n.serverSyncTree_,e,S,o.currentWriteId,o.applyLocally);gt(n.eventQueue_,e,k),eu(n,n.transactionQueueTree_)}}function Bg(n,e,t){return $c(n.serverSyncTree_,e,t)||J.EMPTY_NODE}function eu(n,e=n.transactionQueueTree_){if(e||tu(n,e),Hr(e)){let t=ZT(n,e);O(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&VR(n,la(e),t)}else GT(e)&&Yc(e,t=>{eu(n,t)})}function VR(n,e,t){let r=t.map(u=>u.currentWriteId),i=Bg(n,e,r),s=i,o=i.hash();for(let u=0;u<t.length;u++){let d=t[u];O(d.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),d.status=1,d.retryCount++;let p=st(e,d.path);s=s.updateChild(p,d.currentOutputSnapshotRaw)}let a=s.val(!0),c=e;n.server_.put(c.toString(),a,u=>{hs(n,"transaction put response",{path:c.toString(),status:u});let d=[];if(u==="ok"){let p=[];for(let g=0;g<t.length;g++)t[g].status=2,d=d.concat(er(n.serverSyncTree_,t[g].currentWriteId)),t[g].onComplete&&p.push(()=>t[g].onComplete(null,!0,t[g].currentOutputSnapshotResolved)),t[g].unwatcher();tu(n,Hc(n.transactionQueueTree_,e)),eu(n,n.transactionQueueTree_),gt(n.eventQueue_,e,d);for(let g=0;g<p.length;g++)as(p[g])}else{if(u==="datastale")for(let p=0;p<t.length;p++)t[p].status===3?t[p].status=4:t[p].status=0;else{Ze("transaction at "+c.toString()+" failed: "+u);for(let p=0;p<t.length;p++)t[p].status=4,t[p].abortReason=u}ss(n,e)}},o)}function ss(n,e){let t=XT(n,e),r=la(t),i=ZT(n,t);return OR(n,i,r),r}function OR(n,e,t){if(e.length===0)return;let r=[],i=[],o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){let c=e[a],u=st(t,c.path),d=!1,p;if(O(u!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),c.status===4)d=!0,p=c.abortReason,i=i.concat(er(n.serverSyncTree_,c.currentWriteId,!0));else if(c.status===0)if(c.retryCount>=TR)d=!0,p="maxretry",i=i.concat(er(n.serverSyncTree_,c.currentWriteId,!0));else{let g=Bg(n,c.path,o);c.currentInputSnapshot=g;let y=e[a].update(g.val());if(y!==void 0){ca("transaction failed: Data returned ",y,c.path);let S=Ee(y);typeof y=="object"&&y!=null&&yt(y,".priority")||(S=S.updatePriority(g.getPriority()));let N=c.currentWriteId,q=ha(n),G=Vg(S,g,q);c.currentOutputSnapshotRaw=S,c.currentOutputSnapshotResolved=G,c.currentWriteId=Zc(n),o.splice(o.indexOf(N),1),i=i.concat(xg(n.serverSyncTree_,c.path,G,c.currentWriteId,c.applyLocally)),i=i.concat(er(n.serverSyncTree_,N,!0))}else d=!0,p="nodata",i=i.concat(er(n.serverSyncTree_,c.currentWriteId,!0))}gt(n.eventQueue_,t,i),i=[],d&&(e[a].status=2,function(g){setTimeout(g,Math.floor(0))}(e[a].unwatcher),e[a].onComplete&&(p==="nodata"?r.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):r.push(()=>e[a].onComplete(new Error(p),!1,null))))}tu(n,n.transactionQueueTree_);for(let a=0;a<r.length;a++)as(r[a]);eu(n,n.transactionQueueTree_)}function XT(n,e){let t,r=n.transactionQueueTree_;for(t=Z(e);t!==null&&Hr(r)===void 0;)r=Hc(r,t),e=fe(e),t=Z(e);return r}function ZT(n,e){let t=[];return eI(n,e,t),t.sort((r,i)=>r.order-i.order),t}function eI(n,e,t){let r=Hr(e);if(r)for(let i=0;i<r.length;i++)t.push(r[i]);Yc(e,i=>{eI(n,i,t)})}function tu(n,e){let t=Hr(e);if(t){let r=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[r]=t[i],r++);t.length=r,Fg(e,t.length>0?t:void 0)}Yc(e,r=>{tu(n,r)})}function qg(n,e){let t=la(XT(n,e)),r=Hc(n.transactionQueueTree_,e);return pR(r,i=>{up(n,i)}),up(n,r),jT(r,i=>{up(n,i)}),t}function up(n,e){let t=Hr(e);if(t){let r=[],i=[],s=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(O(s===o-1,"All SENT items should be at beginning of queue."),s=o,t[o].status=3,t[o].abortReason="set"):(O(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(er(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&r.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));s===-1?Fg(e,void 0):t.length=s+1,gt(n.eventQueue_,la(e),i);for(let o=0;o<r.length;o++)as(r[o])}}function FR(n){let e="",t=n.split("/");for(let r=0;r<t.length;r++)if(t[r].length>0){let i=t[r];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function MR(n){let e={};n.charAt(0)==="?"&&(n=n.substring(1));for(let t of n.split("&")){if(t.length===0)continue;let r=t.split("=");r.length===2?e[decodeURIComponent(r[0])]=decodeURIComponent(r[1]):Ze(`Invalid query segment '${t}' in query '${n}'`)}return e}var ng=function(n,e){let t=LR(n),r=t.namespace;t.domain==="firebase.com"&&Jt(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!r||r==="undefined")&&t.domain!=="localhost"&&Jt("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||pC();let i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new _c(t.host,t.secure,r,i,e,"",r!==t.subdomain),path:new ce(t.pathString)}},LR=function(n){let e="",t="",r="",i="",s="",o=!0,a="https",c=443;if(typeof n=="string"){let u=n.indexOf("//");u>=0&&(a=n.substring(0,u-1),n=n.substring(u+2));let d=n.indexOf("/");d===-1&&(d=n.length);let p=n.indexOf("?");p===-1&&(p=n.length),e=n.substring(0,Math.min(d,p)),d<p&&(i=FR(n.substring(d,p)));let g=MR(n.substring(Math.min(n.length,p)));u=e.indexOf(":"),u>=0?(o=a==="https"||a==="wss",c=parseInt(e.substring(u+1),10)):u=e.length;let y=e.slice(0,u);if(y.toLowerCase()==="localhost")t="localhost";else if(y.split(".").length<=2)t=y;else{let S=e.indexOf(".");r=e.substring(0,S).toLowerCase(),t=e.substring(S+1),s=r}"ns"in g&&(s=g.ns)}return{host:e,port:c,domain:t,subdomain:r,secure:o,scheme:a,pathString:i,namespace:s}};var QE="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",UR=function(){let n=0,e=[];return function(t){let r=t===n;n=t;let i,s=new Array(8);for(i=7;i>=0;i--)s[i]=QE.charAt(t%64),t=Math.floor(t/64);O(t===0,"Cannot push at time == 0");let o=s.join("");if(r){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=QE.charAt(e[i]);return O(o.length===20,"nextPushId: Length should be 20."),o}}();var Fc=class{constructor(e,t,r,i){this.eventType=e,this.eventRegistration=t,this.snapshot=r,this.prevName=i}getPath(){let e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+ke(this.snapshot.exportVal())}},Mc=class{constructor(e,t,r){this.eventRegistration=e,this.error=t,this.path=r}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}};var na=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return O(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}};var Lc=class{constructor(e,t){this._repo=e,this._path=t}cancel(){let e=new Ge;return RR(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){pt("OnDisconnect.remove",this._path);let e=new Ge;return $E(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){pt("OnDisconnect.set",this._path),Zt("OnDisconnect.set",e,this._path,!1);let t=new Ge;return $E(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){pt("OnDisconnect.setWithPriority",this._path),Zt("OnDisconnect.setWithPriority",e,this._path,!1),Mg("OnDisconnect.setWithPriority",t,!1);let r=new Ge;return PR(this._repo,this._path,e,t,r.wrapCallback(()=>{})),r.promise}update(e){pt("OnDisconnect.update",this._path),KT("OnDisconnect.update",e,this._path,!1);let t=new Ge;return xR(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}};var at=class n{constructor(e,t,r,i){this._repo=e,this._path=t,this._queryParams=r,this._orderByCalled=i}get key(){return ee(this._path)?null:vg(this._path)}get ref(){return new mt(this._repo,this._path)}get _queryIdentifier(){let e=VE(this._queryParams),t=_g(e);return t==="{}"?"default":t}get _queryObject(){return VE(this._queryParams)}isEqual(e){if(e=ne(e),!(e instanceof n))return!1;let t=this._repo===e._repo,r=wg(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&r&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+WC(this._path)}};function nu(n,e){if(n._orderByCalled===!0)throw new Error(e+": You can't combine multiple orderBy calls.")}function lr(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===Yt){let r="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==rr)throw new Error(r);if(typeof e!="string")throw new Error(i)}if(n.hasEnd()){if(n.getIndexEndName()!==_n)throw new Error(r);if(typeof t!="string")throw new Error(i)}}else if(n.getIndex()===ge){if(e!=null&&!ta(e)||t!=null&&!ta(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(O(n.getIndex()instanceof Wo||n.getIndex()===Ig,"unknown index type."),e!=null&&typeof e=="object"||t!=null&&typeof t=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function ru(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var mt=class n extends at{constructor(e,t){super(e,t,new Yo,!1)}get parent(){let e=_T(this._path);return e===null?null:new n(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},os=class n{constructor(e,t,r){this._node=e,this.ref=t,this._index=r}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){let t=new ce(e),r=ar(this.ref,e);return new n(this._node.getChild(t),r,ge)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(r,i)=>e(new n(i,ar(this.ref,r),ge)))}hasChild(e){let t=new ce(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function Gg(n,e){return n=ne(n),n._checkNotDeleted("ref"),e!==void 0?ar(n._root,e):n._root}function jg(n,e){n=ne(n),n._checkNotDeleted("refFromURL");let t=ng(e,n._repo.repoInfo_.nodeAdmin);WT("refFromURL",t);let r=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&r.host!==n._repo.repoInfo_.host&&Jt("refFromURL: Host name does not match the current database: (found "+r.host+" but expected "+n._repo.repoInfo_.host+")"),Gg(n,t.path.toString())}function ar(n,e){return n=ne(n),Z(n._path)===null?wR("child","path",e,!1):us("child","path",e,!1),new mt(n._repo,ve(n._path,e))}function tI(n,e){n=ne(n),pt("push",n._path),Zt("push",e,n._path,!0);let t=YT(n._repo),r=UR(t),i=ar(n,r),s=ar(n,r),o;return e!=null?o=iu(s,e).then(()=>s):o=Promise.resolve(s),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function nI(n){return pt("remove",n._path),iu(n,null)}function iu(n,e){n=ne(n),pt("set",n._path),Zt("set",e,n._path,!1);let t=new Ge;return Ug(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function rI(n,e){n=ne(n),pt("setPriority",n._path),Mg("setPriority",e,!1);let t=new Ge;return Ug(n._repo,ve(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}function iI(n,e,t){if(pt("setWithPriority",n._path),Zt("setWithPriority",e,n._path,!1),Mg("setWithPriority",t,!1),n.key===".length"||n.key===".keys")throw"setWithPriority failed: "+n.key+" is a read-only object.";let r=new Ge;return Ug(n._repo,n._path,e,t,r.wrapCallback(()=>{})),r.promise}function sI(n,e){KT("update",e,n._path,!1);let t=new Ge;return CR(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function oI(n){n=ne(n);let e=new na(()=>{}),t=new ra(e);return SR(n._repo,n,t).then(r=>new os(r,new mt(n._repo,n._path),n._queryParams.getIndex()))}var ra=class n{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){let r=t._queryParams.getIndex();return new Fc("value",this,new os(e.snapshotNode,new mt(t._repo,t._path),r))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Mc(this,e,t):null}matches(e){return e instanceof n?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},Uc=class n{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t=e==="children_added"?"child_added":e;return t=t==="children_removed"?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Mc(this,e,t):null}createEvent(e,t){O(e.childName!=null,"Child events should have a childName.");let r=ar(new mt(t._repo,t._path),e.childName),i=t._queryParams.getIndex();return new Fc(e.type,this,new os(e.snapshotNode,r,i),e.prevName)}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof n?this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function da(n,e,t,r,i){let s;if(typeof r=="object"&&(s=void 0,i=r),typeof r=="function"&&(s=r),i&&i.onlyOnce){let c=t,u=(d,p)=>{tg(n._repo,n,a),c(d,p)};u.userCallback=t.userCallback,u.context=t.context,t=u}let o=new na(t,s||void 0),a=e==="value"?new ra(o):new Uc(e,o);return kR(n._repo,n,a),()=>tg(n._repo,n,a)}function su(n,e,t,r){return da(n,"value",e,t,r)}function zg(n,e,t,r){return da(n,"child_added",e,t,r)}function Kg(n,e,t,r){return da(n,"child_changed",e,t,r)}function Wg(n,e,t,r){return da(n,"child_moved",e,t,r)}function $g(n,e,t,r){return da(n,"child_removed",e,t,r)}function Qg(n,e,t){let r=null,i=t?new na(t):null;e==="value"?r=new ra(i):e&&(r=new Uc(e,i)),tg(n._repo,n,r)}var _t=class{},Bc=class extends _t{constructor(e,t){super(),this._value=e,this._key=t,this.type="endAt"}_apply(e){Zt("endAt",this._value,e._path,!0);let t=Np(e._queryParams,this._value,this._key);if(ru(t),lr(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new at(e._repo,e._path,t,e._orderByCalled)}};function aI(n,e){return ua("endAt","key",e,!0),new Bc(n,e)}var rg=class extends _t{constructor(e,t){super(),this._value=e,this._key=t,this.type="endBefore"}_apply(e){Zt("endBefore",this._value,e._path,!1);let t=hb(e._queryParams,this._value,this._key);if(ru(t),lr(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new at(e._repo,e._path,t,e._orderByCalled)}};function lI(n,e){return ua("endBefore","key",e,!0),new rg(n,e)}var qc=class extends _t{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAt"}_apply(e){Zt("startAt",this._value,e._path,!0);let t=kp(e._queryParams,this._value,this._key);if(ru(t),lr(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new at(e._repo,e._path,t,e._orderByCalled)}};function cI(n=null,e){return ua("startAt","key",e,!0),new qc(n,e)}var ig=class extends _t{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAfter"}_apply(e){Zt("startAfter",this._value,e._path,!1);let t=ub(e._queryParams,this._value,this._key);if(ru(t),lr(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new at(e._repo,e._path,t,e._orderByCalled)}};function uI(n,e){return ua("startAfter","key",e,!0),new ig(n,e)}var sg=class extends _t{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new at(e._repo,e._path,lb(e._queryParams,this._limit),e._orderByCalled)}};function hI(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new sg(n)}var og=class extends _t{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new at(e._repo,e._path,cb(e._queryParams,this._limit),e._orderByCalled)}};function dI(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new og(n)}var ag=class extends _t{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){nu(e,"orderByChild");let t=new ce(this._path);if(ee(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");let r=new Wo(t),i=jc(e._queryParams,r);return lr(i),new at(e._repo,e._path,i,!0)}};function fI(n){if(n==="$key")throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if(n==="$priority")throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if(n==="$value")throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return us("orderByChild","path",n,!1),new ag(n)}var lg=class extends _t{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){nu(e,"orderByKey");let t=jc(e._queryParams,Yt);return lr(t),new at(e._repo,e._path,t,!0)}};function pI(){return new lg}var cg=class extends _t{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){nu(e,"orderByPriority");let t=jc(e._queryParams,ge);return lr(t),new at(e._repo,e._path,t,!0)}};function gI(){return new cg}var ug=class extends _t{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){nu(e,"orderByValue");let t=jc(e._queryParams,Ig);return lr(t),new at(e._repo,e._path,t,!0)}};function mI(){return new ug}var hg=class extends _t{constructor(e,t){super(),this._value=e,this._key=t,this.type="equalTo"}_apply(e){if(Zt("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new Bc(this._value,this._key)._apply(new qc(this._value,this._key)._apply(e))}};function _I(n,e){return ua("equalTo","key",e,!0),new hg(n,e)}function Ct(n,...e){let t=ne(n);for(let r of e)t=r._apply(t);return t}Wb(mt);Jb(mt);var BR="FIREBASE_DATABASE_EMULATOR_HOST",dg={},qR=!1;function GR(n,e,t,r){n.repoInfo_=new _c(`${e}:${t}`,!1,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0),r&&(n.authTokenProvider_=r)}function Hg(n,e,t,r,i){let s=r||n.options.databaseURL;s===void 0&&(n.options.projectId||Jt("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),je("Using default host for project ",n.options.projectId),s=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=ng(s,i),a=o.repoInfo,c,u;typeof process<"u"&&process.env&&(u=process.env[BR]),u?(c=!0,s=`http://${u}?ns=${a.namespace}`,o=ng(s,i),a=o.repoInfo):c=!o.repoInfo.secure;let d=i&&c?new Bo(Bo.OWNER):new mp(n.name,n.options,e);WT("Invalid Firebase Database URL",o),ee(o.path)||Jt("Database URL must point to the root of a Firebase Database (not including a child path).");let p=zR(a,n,d,new gp(n.name,t));return new fg(p,n)}function jR(n,e){let t=dg[e];(!t||t[n.key]!==n)&&Jt(`Database ${e}(${n.repoInfo_}) has already been deleted.`),JT(n),delete t[n.key]}function zR(n,e,t,r){let i=dg[e.name];i||(i={},dg[e.name]=i);let s=i[n.toURLString()];return s&&Jt("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),s=new eg(n,qR,t,r),i[n.toURLString()]=s,s}var fg=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(IR(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new mt(this._repo,le())),this._rootInternal}_delete(){return this._rootInternal!==null&&(jR(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&Jt("Cannot call "+e+" on a deleted database.")}};function yI(){mT.IS_TRANSPORT_INITIALIZED&&Ze("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function vI(){yI(),zo.forceDisallow()}function wI(){yI(),Yi.forceDisallow(),zo.forceAllow()}function EI(n,e,t,r={}){n=ne(n),n._checkNotDeleted("useEmulator"),n._instanceStarted&&Jt("Cannot call useEmulator() after instance has already been initialized.");let i=n._repoInternal,s;if(i.repoInfo_.nodeAdmin)r.mockUserToken&&Jt('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),s=new Bo(Bo.OWNER);else if(r.mockUserToken){let o=typeof r.mockUserToken=="string"?r.mockUserToken:Fa(r.mockUserToken,n.app.options.projectId);s=new Bo(o)}GR(i,e,t,s)}function TI(n){n=ne(n),n._checkNotDeleted("goOffline"),JT(n._repo)}function II(n){n=ne(n),n._checkNotDeleted("goOnline"),NR(n._repo)}function AI(n,e){XE(n,e)}function KR(n){mg(qa),gr(new ht("database",(e,{instanceIdentifier:t})=>{let r=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),s=e.getProvider("app-check-internal");return Hg(r,i,s,t)},"PUBLIC").setMultipleInstances(!0)),Rt(_E,yE,n),Rt(_E,yE,"esm2017")}var WR={".sv":"timestamp"};function SI(){return WR}function CI(n){return{".sv":{increment:n}}}var pg=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}};function bI(n,e,t){var r;if(n=ne(n),pt("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";let i=(r=t?.applyLocally)!==null&&r!==void 0?r:!0,s=new Ge,o=(c,u,d)=>{let p=null;c?s.reject(c):(p=new os(d,new mt(n._repo,n._path),ge),s.resolve(new pg(u,p)))},a=su(n,()=>{});return DR(n._repo,n._path,e,o,a,i),s.promise}Eg.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};Eg.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};KR();var $R="@firebase/database-compat",QR="1.0.7";var HR=new xn("@firebase/database-compat"),RI=function(n){let e="FIREBASE WARNING: "+n;HR.warn(e)};var YR=function(n,e,t,r){if(!(r&&t===void 0)&&typeof t!="boolean")throw new Error(lt(n,e)+"must be a boolean.")},JR=function(n,e,t){if(!(t&&e===void 0))switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(lt(n,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}};var Yg=class{constructor(e){this._delegate=e}cancel(e){$("OnDisconnect.cancel",0,1,arguments.length),Me("OnDisconnect.cancel","onComplete",e,!0);let t=this._delegate.cancel();return e&&t.then(()=>e(null),r=>e(r)),t}remove(e){$("OnDisconnect.remove",0,1,arguments.length),Me("OnDisconnect.remove","onComplete",e,!0);let t=this._delegate.remove();return e&&t.then(()=>e(null),r=>e(r)),t}set(e,t){$("OnDisconnect.set",1,2,arguments.length),Me("OnDisconnect.set","onComplete",t,!0);let r=this._delegate.set(e);return t&&r.then(()=>t(null),i=>t(i)),r}setWithPriority(e,t,r){$("OnDisconnect.setWithPriority",2,3,arguments.length),Me("OnDisconnect.setWithPriority","onComplete",r,!0);let i=this._delegate.setWithPriority(e,t);return r&&i.then(()=>r(null),s=>r(s)),i}update(e,t){if($("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let s=0;s<e.length;++s)i[""+s]=e[s];e=i,RI("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}Me("OnDisconnect.update","onComplete",t,!0);let r=this._delegate.update(e);return t&&r.then(()=>t(null),i=>t(i)),r}};var Jg=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return $("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}};var Yr=class n{constructor(e,t){this._database=e,this._delegate=t}val(){return $("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return $("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return $("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return $("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return $("DataSnapshot.child",0,1,arguments.length),e=String(e),us("DataSnapshot.child","path",e,!1),new n(this._database,this._delegate.child(e))}hasChild(e){return $("DataSnapshot.hasChild",1,1,arguments.length),us("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return $("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return $("DataSnapshot.forEach",1,1,arguments.length),Me("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new n(this._database,t)))}hasChildren(){return $("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return $("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return $("DataSnapshot.ref",0,0,arguments.length),new yn(this._database,this._delegate.ref)}get ref(){return this.getRef()}},ou=class n{constructor(e,t){this.database=e,this._delegate=t}on(e,t,r,i){var s;$("Query.on",2,4,arguments.length),Me("Query.on","callback",t,!1);let o=n.getCancelAndContextArgs_("Query.on",r,i),a=(u,d)=>{t.call(o.context,new Yr(this.database,u),d)};a.userCallback=t,a.context=o.context;let c=(s=o.cancel)===null||s===void 0?void 0:s.bind(o.context);switch(e){case"value":return su(this._delegate,a,c),t;case"child_added":return zg(this._delegate,a,c),t;case"child_removed":return $g(this._delegate,a,c),t;case"child_changed":return Kg(this._delegate,a,c),t;case"child_moved":return Wg(this._delegate,a,c),t;default:throw new Error(lt("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,r){if($("Query.off",0,3,arguments.length),JR("Query.off",e,!0),Me("Query.off","callback",t,!0),Uu("Query.off","context",r,!0),t){let i=()=>{};i.userCallback=t,i.context=r,Qg(this._delegate,e,i)}else Qg(this._delegate,e)}get(){return oI(this._delegate).then(e=>new Yr(this.database,e))}once(e,t,r,i){$("Query.once",1,4,arguments.length),Me("Query.once","callback",t,!0);let s=n.getCancelAndContextArgs_("Query.once",r,i),o=new Ge,a=(u,d)=>{let p=new Yr(this.database,u);t&&t.call(s.context,p,d),o.resolve(p)};a.userCallback=t,a.context=s.context;let c=u=>{s.cancel&&s.cancel.call(s.context,u),o.reject(u)};switch(e){case"value":su(this._delegate,a,c,{onlyOnce:!0});break;case"child_added":zg(this._delegate,a,c,{onlyOnce:!0});break;case"child_removed":$g(this._delegate,a,c,{onlyOnce:!0});break;case"child_changed":Kg(this._delegate,a,c,{onlyOnce:!0});break;case"child_moved":Wg(this._delegate,a,c,{onlyOnce:!0});break;default:throw new Error(lt("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return $("Query.limitToFirst",1,1,arguments.length),new n(this.database,Ct(this._delegate,hI(e)))}limitToLast(e){return $("Query.limitToLast",1,1,arguments.length),new n(this.database,Ct(this._delegate,dI(e)))}orderByChild(e){return $("Query.orderByChild",1,1,arguments.length),new n(this.database,Ct(this._delegate,fI(e)))}orderByKey(){return $("Query.orderByKey",0,0,arguments.length),new n(this.database,Ct(this._delegate,pI()))}orderByPriority(){return $("Query.orderByPriority",0,0,arguments.length),new n(this.database,Ct(this._delegate,gI()))}orderByValue(){return $("Query.orderByValue",0,0,arguments.length),new n(this.database,Ct(this._delegate,mI()))}startAt(e=null,t){return $("Query.startAt",0,2,arguments.length),new n(this.database,Ct(this._delegate,cI(e,t)))}startAfter(e=null,t){return $("Query.startAfter",0,2,arguments.length),new n(this.database,Ct(this._delegate,uI(e,t)))}endAt(e=null,t){return $("Query.endAt",0,2,arguments.length),new n(this.database,Ct(this._delegate,aI(e,t)))}endBefore(e=null,t){return $("Query.endBefore",0,2,arguments.length),new n(this.database,Ct(this._delegate,lI(e,t)))}equalTo(e,t){return $("Query.equalTo",1,2,arguments.length),new n(this.database,Ct(this._delegate,_I(e,t)))}toString(){return $("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return $("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if($("Query.isEqual",1,1,arguments.length),!(e instanceof n)){let t="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(t)}return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,r){let i={cancel:void 0,context:void 0};if(t&&r)i.cancel=t,Me(e,"cancel",i.cancel,!0),i.context=r,Uu(e,"context",i.context,!0);else if(t)if(typeof t=="object"&&t!==null)i.context=t;else if(typeof t=="function")i.cancel=t;else throw new Error(lt(e,"cancelOrContext")+" must either be a cancel callback or a context object.");return i}get ref(){return new yn(this.database,new mt(this._delegate._repo,this._delegate._path))}},yn=class n extends ou{constructor(e,t){super(e,new at(t._repo,t._path,new Yo,!1)),this.database=e,this._delegate=t}getKey(){return $("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return $("Reference.child",1,1,arguments.length),typeof e=="number"&&(e=String(e)),new n(this.database,ar(this._delegate,e))}getParent(){$("Reference.parent",0,0,arguments.length);let e=this._delegate.parent;return e?new n(this.database,e):null}getRoot(){return $("Reference.root",0,0,arguments.length),new n(this.database,this._delegate.root)}set(e,t){$("Reference.set",1,2,arguments.length),Me("Reference.set","onComplete",t,!0);let r=iu(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}update(e,t){if($("Reference.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let s=0;s<e.length;++s)i[""+s]=e[s];e=i,RI("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}pt("Reference.update",this._delegate._path),Me("Reference.update","onComplete",t,!0);let r=sI(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}setWithPriority(e,t,r){$("Reference.setWithPriority",2,3,arguments.length),Me("Reference.setWithPriority","onComplete",r,!0);let i=iI(this._delegate,e,t);return r&&i.then(()=>r(null),s=>r(s)),i}remove(e){$("Reference.remove",0,1,arguments.length),Me("Reference.remove","onComplete",e,!0);let t=nI(this._delegate);return e&&t.then(()=>e(null),r=>e(r)),t}transaction(e,t,r){$("Reference.transaction",1,3,arguments.length),Me("Reference.transaction","transactionUpdate",e,!1),Me("Reference.transaction","onComplete",t,!0),YR("Reference.transaction","applyLocally",r,!0);let i=bI(this._delegate,e,{applyLocally:r}).then(s=>new Jg(s.committed,new Yr(this.database,s.snapshot)));return t&&i.then(s=>t(null,s.committed,s.snapshot),s=>t(s,!1,null)),i}setPriority(e,t){$("Reference.setPriority",1,2,arguments.length),Me("Reference.setPriority","onComplete",t,!0);let r=rI(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}push(e,t){$("Reference.push",0,2,arguments.length),Me("Reference.push","onComplete",t,!0);let r=tI(this._delegate,e),i=r.then(o=>new n(this.database,o));t&&i.then(()=>t(null),o=>t(o));let s=new n(this.database,r);return s.then=i.then.bind(i),s.catch=i.catch.bind(i,void 0),s}onDisconnect(){return pt("Reference.onDisconnect",this._delegate._path),new Yg(new Lc(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}};var Jr=class{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:vI,forceLongPolling:wI}}useEmulator(e,t,r={}){EI(this._delegate,e,t,r)}ref(e){if($("database.ref",0,1,arguments.length),e instanceof yn){let t=jg(this._delegate,e.toString());return new yn(this,t)}else{let t=Gg(this._delegate,e);return new yn(this,t)}}refFromURL(e){$("database.refFromURL",1,1,arguments.length);let r=jg(this._delegate,e);return new yn(this,r)}goOffline(){return $("database.goOffline",0,0,arguments.length),TI(this._delegate)}goOnline(){return $("database.goOnline",0,0,arguments.length),II(this._delegate)}};Jr.ServerValue={TIMESTAMP:SI(),increment:n=>CI(n)};function XR({app:n,url:e,version:t,customAuthImpl:r,customAppCheckImpl:i,namespace:s,nodeAdmin:o=!1}){mg(t);let a=new Bu("database-standalone"),c=new Ba("auth-internal",a);c.setComponent(new ht("auth-internal",()=>r,"PRIVATE"));let u;return i&&(u=new Ba("app-check-internal",a),u.setComponent(new ht("app-check-internal",()=>i,"PRIVATE"))),{instance:new Jr(Hg(n,c,u,e,o),n),namespace:s}}var ZR=Object.freeze({__proto__:null,initStandalone:XR});var eP=Jr.ServerValue;function tP(n){n.INTERNAL.registerComponent(new ht("database-compat",(e,{instanceIdentifier:t})=>{let r=e.getProvider("app-compat").getImmediate(),i=e.getProvider("database").getImmediate({identifier:t});return new Jr(i,r)},"PUBLIC").setServiceProps({Reference:yn,Query:ou,Database:Jr,DataSnapshot:Yr,enableLogging:AI,INTERNAL:ZR,ServerValue:eP}).setMultipleInstances(!0)),n.registerVersion($R,QR)}tP(Le);function fa(n,e,t="on",r=ri){return new In(i=>{let s=null;return s=n[t](e,(o,a)=>{r.schedule(()=>{i.next({snapshot:o,prevKey:a})}),t==="once"&&r.schedule(()=>i.complete())},o=>{r.schedule(()=>i.error(o))}),t==="on"?{unsubscribe(){s!=null&&n.off(e,s)}}:{unsubscribe(){}}}).pipe(Ie(i=>{let{snapshot:s,prevKey:o}=i,a=null;return s.exists()&&(a=s.key),{type:e,payload:s,prevKey:o,key:a}}),n_())}function nP(n){return typeof n=="string"}function rP(n){return typeof n.exportVal=="function"}function DI(n){return n==null}function VI(n){return typeof n.set=="function"}function PI(n,e){return VI(e)?e:n.ref(e)}function OI(n,e){if(nP(n))return e.stringCase();if(VI(n))return e.firebaseCase();if(rP(n))return e.snapshotCase();throw new Error(`Expects a string, snapshot, or reference. Got: ${typeof n}`)}function FI(n){return(DI(n)||n.length===0)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function MI(n,e,t){e=FI(e);let r=e.map(i=>fa(n,i,"on",t));return Ns(...r)}function iP(n,e,t){let r=MI(n,e).pipe(pr((i,s)=>[...i,s],[]));return oP(n,r,t)}function sP(n,e){return fa(n,"value","on",e).pipe(Ie(t=>{let r;return t.payload.forEach(i=>(r=i.key,!1)),{data:t,lastKeyToLoad:r}}))}function oP(n,e,t){return sP(n,t).pipe(s_(e),Ie(([i,s])=>{let o=i.lastKeyToLoad,a=s.map(c=>c.key);return{actions:s,lastKeyToLoad:o,loadedKeys:a}}),r_(i=>i.loadedKeys.indexOf(i.lastKeyToLoad)===-1),Ie(i=>i.actions))}function xI(n,e){return function(r,i){return OI(r,{stringCase:()=>n.child(r)[e](i),firebaseCase:()=>r[e](i),snapshotCase:()=>r.ref[e](i)})}}function aP(n){return function(t){return t?OI(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function lP(n,e,t){return fa(n,"value","once",t).pipe(rn(r=>{let i=[Ft(r)];return e.forEach(s=>i.push(fa(n,s,"on",t))),Ns(...i).pipe(pr(uP,[]))}),ka())}function LI(n,e){let t=n.length;for(let r=0;r<t;r++)if(n[r].payload.key===e)return r;return-1}function cP(n,e){if(DI(e))return 0;{let t=LI(n,e);return t===-1?n.length:t+1}}function uP(n,e){let{payload:t,prevKey:r,key:i}=e,s=LI(n,i),o=cP(n,r);switch(e.type){case"value":if(e.payload?.exists()){let a=null;e.payload.forEach(c=>{let u={payload:c,type:"value",prevKey:a,key:c.key};return a=c.key,n=[...n,u],!1})}return n;case"child_added":if(s>-1)(n[s-1]?.key||null)!==r&&(n=n.filter(c=>c.payload.key!==t.key),n.splice(o,0,e));else{if(r==null)return[e,...n];n=n.slice(),n.splice(o,0,e)}return n;case"child_removed":return n.filter(a=>a.payload.key!==t.key);case"child_changed":return n.map(a=>a.payload.key===i?e:a);case"child_moved":if(s>-1){let a=n.splice(s,1)[0];return n=n.slice(),n.splice(o,0,a),n}return n;default:return n}}function kI(n,e,t){return e=FI(e),lP(n,e,t)}function hP(n,e){let t=e.schedulers.outsideAngular,r=e.schedulers.ngZone.run(()=>n.ref);return{query:n,update:xI(r,"update"),set:xI(r,"set"),push:i=>r.push(i),remove:aP(r),snapshotChanges(i){return kI(n,i,t).pipe(Ce)},stateChanges(i){return MI(n,i,t).pipe(Ce)},auditTrail(i){return iP(n,i,t).pipe(Ce)},valueChanges(i,s){return kI(n,i,t).pipe(Ie(a=>a.map(c=>s&&s.idField?ks(ni({},c.payload.val()),{[s.idField]:c.key}):c.payload.val())),Ce)}}}function NI(n,e){return function(){return fa(n,"value","on",e)}}function dP(n,e){return{query:n,snapshotChanges(){return NI(n,e.schedulers.outsideAngular)().pipe(Ce)},update(t){return n.ref.update(t)},set(t){return n.ref.set(t)},remove(){return n.ref.remove()},valueChanges(){return NI(n,e.schedulers.outsideAngular)().pipe(Ce,Ie(r=>r.payload.exists()?r.payload.val():null))}}}var fP=new qe("angularfire2.realtimeDatabaseURL"),pP=new qe("angularfire2.database.use-emulator"),gP=(()=>{class n{schedulers;database;constructor(t,r,i,s,o,a,c,u,d,p,g,y,S,k,N){this.schedulers=a;let q=c,G=mr(t,o,r);u&&zs(G,o,d,g,y,S,p,k),this.database=ai(`${G.name}.database.${i}`,"AngularFireDatabase",G.name,()=>{let F=o.runOutsideAngular(()=>G.database(i||void 0));return q&&F.useEmulator(...q),F},[q])}list(t,r){let i=this.schedulers.ngZone.runOutsideAngular(()=>PI(this.database,t)),s=i;return r&&(s=r(i)),hP(s,this)}object(t){let r=this.schedulers.ngZone.runOutsideAngular(()=>PI(this.database,t));return dP(r,this)}createPushId(){return this.schedulers.ngZone.runOutsideAngular(()=>this.database.ref()).push().key}static \u0275fac=function(r){return new(r||n)(W(kn),W(Nn,8),W(fP,8),W(Rn),W(Mt),W(oi),W(pP,8),W(Ks,8),W(Ls,8),W(Us,8),W(Bs,8),W(qs,8),W(Gs,8),W(js,8),W(sn,8))};static \u0275prov=Sn({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),Pk=(()=>{class n{constructor(){Le.registerVersion("angularfire",on.full,"rtdb-compat")}static \u0275fac=function(r){return new(r||n)};static \u0275mod=bn({type:n});static \u0275inj=Cn({providers:[gP]})}return n})();export{NP as a,Ks as b,mx as c,ek as d,Pk as e};
